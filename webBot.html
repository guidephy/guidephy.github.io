<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>隨身家教</title>
    <style>
        /* 主頁樣式 */
        body {
            margin: 0;
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column; 
            min-height: 100vh;
            background-color: #f7f6f2;
        }

        .container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 250px;
            background-color: #f0f0f0;
            color: #333;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 1000;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }

        /* 移動端初始隱藏側邊欄 */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                height: 100%;
                top: 0;
                left: 0;
                transform: translateX(-250px);
            }

            .sidebar.show {
                transform: translateX(0);
            }
        }

        .sidebar-header {
            padding: 20px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            background-color: #f0f0f0;
        }

        .sidebar-menu {
            flex: 1;
            padding: 10px;
        }

        .menu-item {
            padding: 10px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.2s ease, color 0.2s ease;
            color: #333;
        }

        .menu-item:hover {
            background-color: #d9d9d9;
            color: #000;
        }

        .menu-item.hidden {
            display: none;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #fafafa;
            overflow: hidden;
        }

        .header {
            position: relative; 
            z-index: 1001;     
            background-color: #8ab0ab;
            color: white;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header .menu-toggle {
            display: none;
            font-size: 24px;
            cursor: pointer;
        }

        .chat-window {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .external-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: none;
        }

        /* 整合的外部頁面樣式 */
        /* AI素養題產生器樣式 */
        .ai-generator-container {
            max-width: 800px;
            margin: 0 auto;
            background: linear-gradient(to bottom right, #ffffff, #f8f9fa);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        }

        .ai-generator-container h1 {
            text-align: center;
            color: #8ab0ab;
            margin-bottom: 30px;
            font-weight: bold;
        }

        .ai-generator-container .form-group {
            margin-bottom: 20px;
        }

        .ai-generator-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .ai-generator-container input[type="text"],
        .ai-generator-container textarea,
        .ai-generator-container select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .ai-generator-container textarea {
            min-height: 100px;
        }

        .ai-generator-container .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .ai-generator-container button {
            background-color: #8ab0ab;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.2s;
            font-size: 18px;
        }

        .ai-generator-container button:hover {
            background-color: #6e928b;
            transform: scale(1.05);
        }

        .ai-generator-container .result-area {
            display: none;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            background-color: #ffffff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .ai-generator-container .question-card {
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #ffffff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .ai-generator-container .question-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .ai-generator-container .question-options label {
            display: block;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }

        .ai-generator-container .question-options label:hover {
            background-color: #8ab0ab;
            color: white;
        }

        .ai-generator-container .correct-answer {
            color: #28a745;
            font-weight: bold;
        }

        .ai-generator-container .wrong-answer {
            color: #dc3545;
            font-weight: bold;
        }

        .ai-generator-container .explanation {
            margin-top: 10px;
            font-style: italic;
            color: #333;
        }

        .ai-generator-container .your-answer {
            margin-top: 5px;
        }

        .ai-generator-container .submit-button {
            display: block;
            margin: 30px auto;
            background-color: #8ab0ab;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.2s;
        }

        .ai-generator-container .submit-button:hover {
            background-color: #6e928b;
            transform: scale(1.05);
        }

        .ai-generator-container .loading {
            text-align: center;
            color: #333;
            font-weight: bold;
            font-size: 16px;
            margin-top: 20px;
        }

        /* 教我解題樣式 */
        .solve-problem-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .solve-problem-container h1 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-align: center;
            color: #8ab0ab;
        }

        .solve-problem-container .tab-switch {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
        }

        .solve-problem-container .tab-button {
            padding: 10px;
            flex-grow: 1;
            text-align: center;
            cursor: pointer;
            background-color: #e9e9e9;
            border: 1px solid #ccc;
            border-radius: 4px 4px 0 0;
            transition: background-color 0.3s;
        }

        .solve-problem-container .tab-button.active {
            background-color: #fff;
            border-bottom: 2px solid #8ab0ab;
        }

        .solve-problem-container .tab-content {
            display: none;
            padding: 15px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 8px 8px;
        }

        .solve-problem-container .tab-content.active {
            display: block;
        }

        .solve-problem-container .form-group {
            margin-bottom: 20px;
        }

        .solve-problem-container label {
            display: block;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .solve-problem-container input,
        .solve-problem-container textarea {
            width: 100%;
            padding: 10px;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .solve-problem-container .button-group {
            text-align: center;
            margin-top: 20px;
        }

        .solve-problem-container button {
            background-color: #8ab0ab;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s, transform 0.2s;
        }

        .solve-problem-container button:hover {
            background-color: #6e928b;
            transform: scale(1.05);
        }

        .solve-problem-container .result-area {
            margin-top: 20px;
            display: none;
        }

        .solve-problem-container .loading {
            font-style: italic;
            color: #888;
        }

        .solve-problem-container .question-card {
            background-color: #f1f1f1;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
        }

        /* 其他樣式 */
        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .input-area {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ddd;
            background-color: white;
            align-items: center;
            gap: 10px;
            flex-shrink: 0; 
        }

        .upload-button {
            background-color: #8ab0ab;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 15px;
            cursor: pointer;
        }

        .upload-button:hover {
            background-color: #6e928b;
        }

        #user-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }

        #send-button {
            padding: 10px 20px;
            background-color: #8ab0ab;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }

        #send-button:hover {
            background-color: #6e928b;
        }

        .image-preview {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }

        .image-preview img {
            max-width: 50px;
            border-radius: 10px;
        }

        .image-preview .delete-button {
            background-color: red;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .header .menu-toggle {
                display: block;
            }

            .main-content {
                flex: 1;
                margin-left: 0;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 防止樣式衝突的命名空間 */
        /* AI素養題產生器 */
        .ai-generator-container * {
            box-sizing: border-box;
        }

        /* 教我解題 */
        .solve-problem-container * {
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 側邊欄 -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">探索工具箱</div>
            <div class="sidebar-menu">
                <div class="menu-item" id="open-ai-generator">AI素養題產生器</div>
                <div class="menu-item" id="open-solve-problem">教我解題</div> 
                <div class="menu-item hidden" id="return-chat">返回聊天</div>
            </div>
        </div>
        <!-- 主內容區域 -->
        <div class="main-content">
            <!-- 頭部 -->
            <div class="header">
                <span class="menu-toggle" id="menu-toggle">☰</span>
                隨身家教
            </div>
            <!-- 聊天窗口 -->
            <div class="chat-window" id="chat-window"></div>
            <!-- AI素養題產生器 -->
            <div class="external-content" id="ai-generator-content">
                <div class="ai-generator-container">
                    <h1>AI素養題產生器</h1>

                    <div class="form-group">
                        <label for="topic">主題 (必填):</label>
                        <input type="text" id="topic" required>
                    </div>

                    <div class="form-group">
                        <label for="topicText">補充提詞或學習內容文本(選填):</label>
                        <textarea id="topicText"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="grade">題目程度:</label>
                        <select id="grade">
                            <option value="">請選擇年級</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="questionCount">題目數量:</label>
                        <select id="questionCount">
                            <option value="">請選擇題數</option>
                        </select>
                    </div>

                    <div class="button-group">
                        <button id="generateButton" onclick="generateQuestions()">生成題目</button>
                        <button id="copyContent" onclick="copyContent()" style="display:none;">複製題本</button>
                    </div>

                    <form id="quizForm" class="result-area" onsubmit="checkAnswers(event)">
                        <div id="questions"></div>
                        <button type="submit" class="submit-button">提交答案</button>
                    </form>
                </div>
            </div>
            <!-- 教我解題 -->
            <div class="external-content" id="solve-problem-content">
                <div class="solve-problem-container">
                    <h1>教我解題</h1>

                    <div class="tab-switch">
                        <div id="imageTab" class="tab-button active" onclick="switchTab('image')">圖片上傳</div>
                        <div id="textTab" class="tab-button" onclick="switchTab('text')">文字輸入</div>
                    </div>

                    <!-- 圖片上傳區域 -->
                    <div id="imageContent" class="tab-content active">
                        <div class="form-group">
                            <label for="uploadImage">上傳題目圖片：</label>
                            <input type="file" id="uploadImage" accept="image/*" onchange="previewImage(event)">
                            <div id="imagePreview" class="image-preview" style="margin-top: 15px; text-align: center;">
                                <!-- 圖片預覽區 -->
                            </div>
                        </div>
                    </div>

                    <!-- 文字輸入區域 -->
                    <div id="textContent" class="tab-content">
                        <div class="form-group">
                            <label for="textInput">輸入題目文字：</label>
                            <textarea id="textInput" rows="6" placeholder="請輸入題目內容"></textarea>
                        </div>
                    </div>

                    <div class="button-group">
                        <button id="analyzeButton" onclick="analyzeInput()">分析題目</button>
                    </div>

                    <div id="resultArea" class="result-area"></div>
                </div>
            </div>
            <!-- 嵌入的 iframe (已移除，因為整合後不再需要) -->
            <!-- <div class="iframe-container" id="iframe-container">
                <iframe id="tool-iframe" src=""></iframe>
            </div> -->
            <!-- 輸入區域 -->
            <div class="input-area">
                <label class="upload-button" style="display: none;">
                    上傳照片
                    <input type="file" id="upload-image" accept="image/*" style="display: none;">
                </label>
                <div id="image-preview-container" class="image-preview"></div>
                <input type="text" id="user-input" placeholder="輸入訊息...">
                <button id="send-button">傳送</button>
            </div>
        </div>
    </div>
    <script>
        // 主頁的 JavaScript
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('sidebar');
            const menuToggle = document.getElementById('menu-toggle');
            const openAIGenerator = document.getElementById('open-ai-generator');
            const openSolveProblem = document.getElementById('open-solve-problem'); 
            const returnChat = document.getElementById('return-chat');
            const chatWindow = document.getElementById('chat-window');
            const aiGeneratorContent = document.getElementById('ai-generator-content');
            const solveProblemContent = document.getElementById('solve-problem-content');
            const uploadImage = document.getElementById('upload-image');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const sendButton = document.getElementById('send-button');
            const userInput = document.getElementById('user-input');

            let selectedImage = null;

            // 切換到 AI 素養題產生器
            openAIGenerator.addEventListener('click', () => {
                chatWindow.style.display = 'none';
                aiGeneratorContent.style.display = 'block';
                solveProblemContent.style.display = 'none';
                returnChat.classList.remove('hidden');
                sidebar.classList.remove('show'); 
            });

            // 切換到 教我解題
            openSolveProblem.addEventListener('click', () => {
                chatWindow.style.display = 'none';
                aiGeneratorContent.style.display = 'none';
                solveProblemContent.style.display = 'block';
                returnChat.classList.remove('hidden');
                sidebar.classList.remove('show'); 
            });

            // 返回聊天
            returnChat.addEventListener('click', () => {
                chatWindow.style.display = 'flex';
                aiGeneratorContent.style.display = 'none';
                solveProblemContent.style.display = 'none';
                returnChat.classList.add('hidden');
                openAIGenerator.classList.remove('hidden');
                openSolveProblem.classList.remove('hidden');
                sidebar.classList.remove('show'); 
            });

            // 照片上傳
            uploadImage.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        selectedImage = e.target.result;
                        imagePreviewContainer.innerHTML = `
                            <img src="${selectedImage}" alt="圖片預覽">
                            <div class="delete-button" onclick="clearImage()">x</div>
                        `;
                    };
                    reader.readAsDataURL(file);
                }
            });

            window.clearImage = function() {
                selectedImage = null;
                imagePreviewContainer.innerHTML = '';
                uploadImage.value = '';
            }

            sendButton.addEventListener('click', () => {
                const message = userInput.value.trim();
                if (!message && !selectedImage) return;

                if (selectedImage) {
                    appendMessage(selectedImage, 'user-message', true);
                    clearImage();
                }

                if (message) {
                    appendMessage(message, 'user-message');
                }

                userInput.value = '';

                setTimeout(() => {
                    appendMessage('機器人回應：' + message, 'bot-message');
                }, 500);
            });

            function appendMessage(content, className, isImage = false) {
                const message = document.createElement('div');
                message.classList.add('message', className);

                if (isImage) {
                    const img = document.createElement('img');
                    img.src = content;
                    img.style.maxWidth = '150px';
                    img.style.borderRadius = '10px';
                    message.appendChild(img);
                } else {
                    message.textContent = content;
                }

                chatWindow.appendChild(message);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            // 添加漢堡菜單點擊事件
            menuToggle.addEventListener('click', (e) => {
                e.stopPropagation(); // 防止事件冒泡
                sidebar.classList.toggle('show');
            });

            // 點擊頁面其他部分時，關閉側邊欄（可選）
            document.addEventListener('click', (event) => {
                if (!sidebar.contains(event.target) && !menuToggle.contains(event.target)) {
                    sidebar.classList.remove('show');
                }
            });

            // 根據當前時間獲取問候語
            function getGreeting() {
                const now = new Date();
                const hour = now.getHours();
                if (hour < 12) {
                    return '早安！';
                } else if (hour < 18) {
                    return '午安！';
                } else {
                    return '晚安！';
                }
            }

            // 頁面加載時向用戶打招呼
            const greeting = getGreeting();
            appendMessage(`${greeting}今天想要討論什麼呢？`, 'bot-message');
        });

        // ----------- AI素養題產生器的 JavaScript -----------
        // 將原本在 AI素養題產生器頁面的 JavaScript 移植到主頁中
        // 為避免變數名稱衝突，使用命名空間
        const aiGenerator = (function() {
            let questions = [];

            window.generateQuestions = async function() {
                const topic = document.getElementById('topic').value;
                const button = document.getElementById('generateButton');
                button.innerText = '生成題目中，請稍候...';

                if (!topic) {
                    alert('請填寫主題！');
                    button.innerText = '生成題目';
                    return;
                }

                const topicText = document.getElementById('topicText').value;
                const conditions = "符合高中學科學習目標，並為該領域專家設計的符合使用者年級並結合生活情境之素養題";
                const grade = document.getElementById('grade').value;
                const questionCount = document.getElementById('questionCount').value;

                document.getElementById('questions').innerHTML = '<p class="loading">生成題目中，請稍候...</p>';
                document.getElementById('quizForm').style.display = 'none';

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=AIzaSyA5japu-01mqUn7EXxGDy1za098_leIxdQ`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: `生成${questionCount}題${topic}相關的選擇題，年級為${grade}年級。
                                    ${topicText ? `參考文本：${topicText}` : ''}
                                    附加條件：${conditions}
                                    請使用JSON格式回應，格式如下：
                                    {
                                        "questions": [
                                            {
                                                "question": "題目",
                                                "options": ["A選項", "B選項", "C選項", "D選項"],
                                                "answer": 0,
                                                "explanation": "解答說明"
                                            }
                                        ]
                                    }`
                                }]
                            }]
                        })
                    });

                    const data = await response.json();
                    if (data.candidates && data.candidates[0].content) {
                        const textContent = data.candidates[0].content.parts[0].text;
                        const jsonMatch = textContent.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            const parsedData = JSON.parse(jsonMatch[0]);
                            questions = parsedData.questions.map((q) => {
                                q.options = [...new Set(q.options)]; // 去重
                                return q;
                            });
                            displayQuestions(questions);
                            document.getElementById('quizForm').style.display = 'block';
                        } else {
                            throw new Error('無法解析回應格式');
                        }
                    } else {
                        throw new Error('API 回應格式不正確');
                    }
                } catch (error) {
                    document.getElementById('questions').innerHTML = `<p class="loading">錯誤：${error.message}</p>`;
                }

                button.innerText = '重新生成題目';
                document.getElementById('copyContent').style.display = 'block';
            }

            window.displayQuestions = function(questions) {
                const questionsDiv = document.getElementById('questions');
                questionsDiv.innerHTML = '';

                questions.forEach((q, i) => {
                    const uniqueOptions = [...new Set(q.options)]; // 去重

                    // 檢查選項是否已包含標籤，例如 "A. " 開頭
                    const formattedOptions = uniqueOptions.map((option, index) => {
                        if (/^[A-D]\.\s/.test(option)) {
                            // 選項已包含標籤，直接返回
                            return option;
                        }
                        // 否則，添加標籤
                        return `${['A', 'B', 'C', 'D'][index]}. ${option}`;
                    });

                    const questionHtml = `
                        <div class="question-card">
                            <p><strong>${i + 1}. ${q.question}</strong></p>
                            <div class="question-options">
                                ${formattedOptions.map((option, j) => `
                                    <label>
                                        <input type="radio" name="question${i}" value="${j}" required>
                                        ${option}
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    questionsDiv.innerHTML += questionHtml;
                });

                const submitButton = document.querySelector('.submit-button');
                submitButton.style.display = 'block';
            }

            window.checkAnswers = function(event) {
                event.preventDefault();

                const formData = new FormData(document.getElementById('quizForm'));
                const results = [];

                questions.forEach((q, i) => {
                    const userAnswer = formData.get(`question${i}`);
                    const correctAnswer = q.answer;
                    const isCorrect = userAnswer !== null && parseInt(userAnswer) === correctAnswer;

                    console.log(`Question ${i + 1}: User Answer - ${userAnswer}, Correct Answer - ${correctAnswer}, Is Correct - ${isCorrect}`);

                    results.push({
                        question: q.question,
                        options: q.options,
                        correct: isCorrect,
                        userAnswer: userAnswer !== null ? parseInt(userAnswer) : '未作答',
                        correctAnswer,
                        explanation: q.explanation
                    });
                });

                displayResults(results);

                const submitButton = document.querySelector('.submit-button');
                submitButton.style.display = 'none';
            }

            window.displayResults = function(results) {
                const questionsDiv = document.getElementById('questions');
                questionsDiv.innerHTML = results.map((result, i) => `
                    <div class="question-card">
                        <p><strong>${i + 1}. ${result.question}</strong></p>
                        <div class="question-options">
                            ${result.options.map((option, j) => `
                                <label style="background-color: ${j === result.correctAnswer ? '#28a745' : 
                                    (j === result.userAnswer ? '#dc3545' : '#ffffff')};
                                    color: ${j === result.correctAnswer || j === result.userAnswer ? 'white' : '#333'};">
                                    ${['A', 'B', 'C', 'D'][j]}. ${option}
                                </label>
                            `).join('')}
                        </div>
                        <p class="your-answer">您的答案：${result.userAnswer === '未作答' ? result.userAnswer : ['A', 'B', 'C', 'D'][result.userAnswer]} ${result.correct ? '✔️' : '❌'}</p>
                        ${!result.correct ? `<p class="correct-answer">正確答案：${['A', 'B', 'C', 'D'][result.correctAnswer]}</p>` : ''}
                        <p class="explanation">解答說明：${result.explanation}</p>
                    </div>
                `).join('');
            }

            window.copyContent = function() {
                if (questions.length === 0) {
                    alert('請先生成題目！');
                    return;
                }

                // 構造題目部分
                let content = '題目列表:\n';
                questions.forEach((q, index) => {
                    content += `${index + 1}. ${q.question}\n`;
                    q.options.forEach((option, i) => {
                        // 直接使用字母標籤 A、B、C、D，避免多餘的標點符號
                        content += `   ${['A', 'B', 'C', 'D'][i]} ${option}\n`;
                    });
                });

                // 構造答案與解答部分
                content += '\n正確答案與解答:\n';
                questions.forEach((q, index) => {
                    content += `${index + 1}. 正確答案: ${['A', 'B', 'C', 'D'][q.answer]}\n`;
                    content += `   解答說明: ${q.explanation}\n\n`;
                });

                // 使用 Clipboard API 複製內容到剪貼簿
                navigator.clipboard.writeText(content)
                    .then(() => alert('內容已複製到剪貼簿！'))
                    .catch(err => alert('複製失敗：' + err));
            }

            // 初始化年級和題數選項
            window.onload = function() {
                const gradeSelect = document.getElementById('grade');
                const questionCountSelect = document.getElementById('questionCount');

                for (let i = 1; i <= 12; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.text = `${i}年級`;
                    gradeSelect.appendChild(option);
                }

                for (let i = 1; i <= 10; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.text = `${i}題`;
                    questionCountSelect.appendChild(option);
                }
            }

            return {};
        })();

        // ----------- 教我解題的 JavaScript -----------
        // 將原本在 教我解題 頁面的 JavaScript 移植到主頁中
        // 使用命名空間避免衝突
        const solveProblem = (function() {
            // 切換標籤
            window.switchTab = function(tab) {
                document.getElementById('imageContent').classList.toggle('active', tab === 'image');
                document.getElementById('textContent').classList.toggle('active', tab === 'text');
                document.getElementById('imageTab').classList.toggle('active', tab === 'image');
                document.getElementById('textTab').classList.toggle('active', tab === 'text');
            }

            // 預覽圖片
            window.previewImage = function(event) {
                const file = event.target.files[0];
                const preview = document.getElementById('imagePreview');
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        preview.innerHTML = `<img src="${e.target.result}" alt="題目圖片" style="max-width: 100%; height: auto; border: 1px solid #ccc; border-radius: 8px;">`;
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.innerHTML = '';
                }
            }

            // 分析輸入
            window.analyzeInput = async function() {
                const imageInput = document.getElementById('uploadImage');
                const textInput = document.getElementById('textInput');
                const button = document.getElementById('analyzeButton');
                const resultArea = document.getElementById('resultArea');

                button.innerText = '分析中，請稍候...';
                button.disabled = true;
                resultArea.style.display = 'block';
                resultArea.innerHTML = '<p class="loading">正在處理...</p>';

                try {
                    let payload = {};
                    if (imageInput.files.length > 0 && document.getElementById('imageContent').classList.contains('active')) {
                        const base64Image = await convertImageToBase64(imageInput.files[0]);
                        payload = {
                            contents: [
                                {
                                    parts: [
                                        {
                                            text: '請扮演該領域且懂得有效學習的教師，按照以下格式進行解題並回答：\n1. 題意分析：\n[清楚描述題目內容，並標示關鍵資訊]\n2. 相關知識與理論：\n[說明解題需要的相關知識，包括定律、公式或理論]\n3. 解題流程：\n[逐步推導解答過程，分步驟詳細說明]\n4. 答案：\n[清晰呈現最終答案，並標註所用單位或條件]\n5.學習反思：\n[進一步對上述解題步驟和答案作教師回饋幫助學習]\n請按上述格式分段回應，確保清晰、條理分明。'
                                        },
                                        {
                                            inline_data: {
                                                mime_type: 'image/jpeg',
                                                data: base64Image
                                            }
                                        }
                                    ]
                                }
                            ]
                        };
                    } else if (textInput.value.trim()) {
                        payload = {
                            contents: [
                                {
                                    parts: [
                                        {
                                            text: `請扮演該領域且懂得有效學習的教師，按照以下格式進行解題並回答：\n1. 題意分析：\n[清楚描述題目內容，並標示關鍵資訊]\n2. 相關知識與理論：\n[說明解題需要的相關知識，包括定律、公式或理論]\n3. 解題流程：\n[逐步推導解答過程，分步驟詳細說明]\n4. 答案：\n[清晰呈現最終答案，並標註所用單位或條件]\n5. 學習反思：\n[進一步對上述解題步驟和答案作教師回饋幫助學習]\n\n題目內容：${textInput.value.trim()}`
                                        }
                                    ]
                                }
                            ]
                        };
                    } else {
                        alert('請提供圖片或文字內容！');
                        button.innerText = '分析題目';
                        button.disabled = false;
                        return;
                    }

                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=AIzaSyA5japu-01mqUn7EXxGDy1za098_leIxdQ`,
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(payload),
                        }
                    );

                    const responseData = await response.json();
                    const answer = getNestedValue(responseData, 'text') || '無法獲取解答';

                    // 格式化答案
                    const sections = answer.split(/\d\.\s/).filter((section) => section.trim() !== '');
                    const formattedAnswer = sections
                        .map((section, index) => {
                            return `<p>${section.trim().replace(/\n/g, '<br>')}</p>`;
                        })
                        .join('');

                    resultArea.innerHTML = `<div class="question-card">${formattedAnswer}</div>`;
                } catch (error) {
                    resultArea.innerHTML = `<p class="loading">錯誤：${error.message}</p>`;
                } finally {
                    button.innerText = '分析題目';
                    button.disabled = false;
                }
            }

            // 遞歸獲取 JSON 嵌套值
            function getNestedValue(data, key) {
                if (typeof data === 'object') {
                    for (const [k, v] of Object.entries(data)) {
                        if (k === key) return v;
                        const nestedValue = getNestedValue(v, key);
                        if (nestedValue) return nestedValue;
                    }
                }
                return null;
            }

            // 將圖片轉換為 Base64
            async function convertImageToBase64(imageFile) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]); // 返回Base64內容
                    reader.onerror = (error) => reject(error);
                    reader.readAsDataURL(imageFile);
                });
            }

            return {};
        })();
    </script>
</body>
</html>



