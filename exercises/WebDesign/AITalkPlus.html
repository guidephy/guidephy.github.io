<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>Gemini Chat â€“ Green Healing UI</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Markdown Parser -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- KaTeX (LaTeX support, HTML/CSS æ¨¡å¼) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>

<style>
  * { box-sizing: border-box; }

  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden; /* åªè®“èŠå¤©å€æ²å‹• */
  }

  body {
    font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    background: #eef5f0; /* æŸ”ç¶ èƒŒæ™¯ */
    display: flex;
    flex-direction: column;
  }

  /* Sticky top bar */
  .top-bar {
    padding: 12px 18px;
    background: #ffffff;
    border-bottom: 1px solid #cfe3d6;
    display: flex;
    flex-direction: column;
    gap: 6px;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  /* Chat å€åŸŸ */
  #chat {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    scroll-behavior: smooth;
  }

  .msg {
    max-width: 80%;
    padding: 12px 18px;
    border-radius: 18px;
    font-size: 15px;
    line-height: 1.6;
    word-break: break-word;
  }

  /* ä½¿ç”¨è€…è¨Šæ¯ï¼ˆå³å´ï¼‰ */
  .user-msg {
    align-self: flex-end;
    background: #8dd7a5;
    color: #083d18;
    border-bottom-right-radius: 6px;
  }

  /* AI è¨Šæ¯ï¼ˆå·¦å´ï¼‰ */
  .bot-msg {
    align-self: flex-start;
    background: #ffffff;
    border: 1px solid #d8e8df;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    border-bottom-left-radius: 6px;
    color: #1d3e2e;
  }

  /* æ€è€ƒä¸­è¨Šæ¯ */
  .thinking-msg {
    align-self: flex-start;
    background: #e3f2e7;
    color: #557562;
    font-style: italic;
  }

  /* åº•éƒ¨è¼¸å…¥åˆ— */
  .input-area {
    padding: 12px;
    display: flex;
    gap: 10px;
    border-top: 1px solid #cfe3d6;
    background: white;
    align-items: center;
  }

  #question {
    flex: 1;
    height: 60px;
    resize: none;
    padding: 12px;
    border-radius: 12px;
    border: 1px solid #badcc8;
    font-size: 16px;
    line-height: 1.5;
  }

  #send-btn {
    padding: 10px 18px;
    background: #4caf71;
    color: white;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
  }
  #send-btn:hover { background: #3a9a5d; }
  #send-btn:disabled { opacity: 0.6; }

  /* Markdown ç¶ è‰²ä¸»é¡Œ */
  .bot-msg h1 { color:#2e7d53; }
  .bot-msg h2 { color:#3a9a5d; }
  .bot-msg h3 { color:#4c9c6a; }

  .bot-msg blockquote {
    border-left: 4px solid #8dd7a5;
    padding-left: 12px;
    margin-left: 0;
    background: #f3fbf6;
    color: #2c4b39;
  }

  .bot-msg li { color: #264a38; }
  .bot-msg strong { color:#2e7d53; }

  .bot-msg code,
  .bot-msg pre {
    background: #e6f4ea;
    padding: 2px 4px;
    border-radius: 4px;
    color: #245f39;
    white-space: pre-wrap;
    word-break: break-word;
  }

  /* ===== ä¸€èˆ¬èŠå¤©æ¨¡å¼ï¼šè‡ªç„¶çš„æ®µè½/è¡Œè· ===== */

  /* æ®µè½ */
  .bot-msg p {
    margin: 10px 0 !important;
  }

  /* åˆ—è¡¨å®¹å™¨ */
  .bot-msg ul,
  .bot-msg ol {
    margin: 8px 0 8px 20px !important;
  }

  /* åˆ—è¡¨é …ç›®é–“è· */
  .bot-msg li {
    margin: 5px 0 !important;
  }

  /* æ¨™é¡Œé‚Šè· */
  .bot-msg h1, 
  .bot-msg h2, 
  .bot-msg h3 {
    margin: 12px 0 8px 0 !important;
  }

  /* å¼•ç”¨å€å¡Š */
  .bot-msg blockquote {
    margin: 10px 0 !important;
    padding: 8px 14px;
  }

  /* ç¨‹å¼ç¢¼å€å¡Š */
  .bot-msg pre {
    margin: 8px 0 !important;
    padding: 10px !important;
  }

  .bot-msg code {
    margin: 0 !important;
    padding: 2px 4px;
  }

  /* ä½¿ç”¨è€…è¨Šæ¯æ®µè½ï¼ˆå¦‚æœæœ‰ Markdownï¼‰ */
  .user-msg p {
    margin: 8px 0 !important;
  }
</style>
</head>

<body>

<!-- Top barï¼šAPI Key + æ¨¡å‹ï¼ˆé è¨­ flash-liteï¼‰ -->
<div class="top-bar">
  <label>API Keyï¼š</label>
  <input id="api-key" type="password" placeholder="è²¼ä¸Šä½ çš„ Gemini API Key" />

  <label>æ¨¡å‹ï¼š</label>
  <select id="model">
    <option value="gemini-2.5-flash-lite" selected>gemini-2.5-flash-liteï¼ˆé è¨­ï¼‰</option>
    <option value="gemini-2.5-flash">gemini-2.5-flash</option>
    <option value="gemini-2.5-pro">gemini-2.5-pro</option>
  </select>
</div>

<!-- Chat -->
<div id="chat"></div>

<!-- Input -->
<form id="form" class="input-area">
  <input id="file-input" type="file" accept="image/*,video/*,application/pdf">
  <textarea id="question" placeholder="è¼¸å…¥è¨Šæ¯â€¦"></textarea>
  <button id="send-btn" type="submit">é€å‡º</button>
</form>

<script>
  const chat = document.getElementById("chat");
  const apiKeyEl = document.getElementById("api-key");
  const modelEl = document.getElementById("model");
  const form = document.getElementById("form");
  const questionEl = document.getElementById("question");
  const sendBtn = document.getElementById("send-btn");
  const fileInputEl = document.getElementById("file-input");

  const MAX_FILE = 15 * 1024 * 1024;

  // ğŸ§  å°è©±è¨˜æ†¶ï¼šåªå­˜æ–‡å­—ï¼ˆä¸å­˜æª”æ¡ˆï¼‰
  let conversation = []; // æ¯é … { role: "user"|"model", parts:[{text:"..."}] }

  function renderMathSafe(target) {
    if (typeof renderMathInElement !== "function") return;
    renderMathInElement(target, {
      delimiters: [
        {left: "$$", right: "$$", display: true},
        {left: "\\[", right: "\\]", display: true},
        {left: "\\(", right: "\\)", display: false},
        {left: "$",  right: "$",  display: false}
      ],
      ignoredTags: ["script","noscript","style","textarea","option"]
    });
  }

  // ğŸŒ¿ æ ¹æ“šæ¨™é¡Œæ–‡å­—åŠ ä¸åŒ icon
  function addIconsToMarkdown(html) {
    return html.replace(/<h([1-3])>([^<]*)<\/h\1>/g, (m, level, text) => {
      const t = text.trim();
      let icon = "ğŸƒ";
      if (/æ ¸å¿ƒ|é‡é»|åˆ†æ/.test(t)) icon = "ğŸŒŸ";
      else if (/çµè«–|ç¸½çµ/.test(t)) icon = "âœ…";
      else if (/Prompt|æç¤º/.test(t)) icon = "ğŸ¨";
      else if (/æ­¥é©Ÿ|æ–¹æ³•/.test(t)) icon = "ğŸ§­";
      else if (level === "1") icon = "ğŸŒ¿";
      else if (level === "3") icon = "ğŸŒ±";
      return `<h${level}>${icon} ${t}</h${level}>`;
    });
  }

  function scrollBottom() {
    chat.scrollTop = chat.scrollHeight;
  }

  function addMsg(html, type) {
    const div = document.createElement("div");
    div.className = "msg " + type;
    div.innerHTML = html;
    chat.appendChild(div);
    scrollBottom();
    renderMathSafe(div);
    return div;
  }

  function toBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result.split(",")[1]);
      reader.onerror = err => reject(err);
      reader.readAsDataURL(file);
    });
  }

  function parseMarkdown(text) {
    return marked.parse(text);
  }

  function getRawTextFromData(data) {
    try {
      return data.candidates[0].content.parts
        .map(p => p.text || "")
        .join("");
    } catch {
      return "";
    }
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const apiKey = apiKeyEl.value.trim();
    const model = modelEl.value;
    let text = questionEl.value.trim();
    const hasFile = fileInputEl.files.length > 0;
    const file = hasFile ? fileInputEl.files[0] : null;

    if (!apiKey) return alert("è«‹è¼¸å…¥ API Key");
    if (!text && !hasFile) return alert("è«‹è¼¸å…¥è¨Šæ¯æˆ–é™„åŠ æª”æ¡ˆ");
    if (hasFile && file.size > MAX_FILE) return alert("æª”æ¡ˆè¶…é 15MB");

    // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
    addMsg(text || "ï¼ˆé™„åŠ æª”æ¡ˆï¼‰", "user-msg");

    // è¨˜ä½å¯¦éš› user æç¤ºï¼Œç”¨æ–¼å°è©±è¨˜æ†¶
    let userTextForHistory = text;

    // æ¸…ç©ºè¼¸å…¥æ¬„
    questionEl.value = "";
    fileInputEl.value = "";

    sendBtn.disabled = true;

    // æ€è€ƒä¸­æ³¡æ³¡
    const thinking = addMsg("ç³»çµ±æ€è€ƒä¸­â€¦", "thinking-msg");

    try {
      let parts = [];

      if (hasFile && file) {
        const base64 = await toBase64(file);
        parts.push({
          inlineData: { data: base64, mimeType: file.type }
        });

        if (!text) {
          if (file.type === "application/pdf") {
            text = "è«‹ç”¨ç¹é«”ä¸­æ–‡æ‘˜è¦æ­¤ PDFã€‚";
          } else if (file.type.startsWith("image/")) {
            text = "è«‹ç”¨ç¹é«”ä¸­æ–‡èªªæ˜é€™å¼µåœ–ç‰‡ã€‚";
          } else if (file.type.startsWith("video/")) {
            text = "è«‹ç”¨ç¹é«”ä¸­æ–‡èªªæ˜é€™æ®µå½±ç‰‡ã€‚";
          }
          userTextForHistory = text;
        }
      }

      if (text) {
        parts.push({ text });
      }

      // çµ„åˆæ­·å²å°è©±ï¼ˆåªå«æ–‡å­—ï¼‰
      const currentUserContentForRequest = {
        role: "user",
        parts: parts
      };

      const contentsForRequest = [
        ...conversation, // ä¹‹å‰çš„ user / model æ–‡å­—å°è©±
        currentUserContentForRequest
      ];

      const body = {
        systemInstruction: {
          role: "user",
          parts: [{
            text: "ä½ æ˜¯ä¸€ä½è¦ªåˆ‡çš„è¯èªåŠ©æ•™ï¼Œè«‹ç”¨è‡ªç„¶çš„ç¹é«”ä¸­æ–‡å›ç­”ï¼Œå¯ä»¥ä½¿ç”¨ Markdown èˆ‡ LaTeXï¼ˆ$...$ æˆ– $$...$$ï¼‰ã€‚"
          }]
        },
        contents: contentsForRequest
      };

      const res = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-goog-api-key": apiKey
          },
          body: JSON.stringify(body)
        }
      );

      let replyHTML;
      let rawReplyText = "";

      if (!res.ok) {
        replyHTML = "âš  API éŒ¯èª¤ï¼š\n" + await res.text();
      } else {
        const data = await res.json();
        rawReplyText = getRawTextFromData(data);
        replyHTML = addIconsToMarkdown(
          parseMarkdown(rawReplyText || "ï¼ˆç„¡å›æ‡‰æ–‡å­—ï¼‰")
        );
      }

      // æ›´æ–°ã€Œæ€è€ƒä¸­ã€ç‚ºçœŸæ­£å›æ‡‰
      thinking.className = "msg bot-msg";
      thinking.innerHTML = replyHTML;
      renderMathSafe(thinking);

      // æ›´æ–°å°è©±è¨˜æ†¶ï¼ˆåªå­˜æ–‡å­—ï¼‰
      if (userTextForHistory) {
        conversation.push({
          role: "user",
          parts: [{ text: userTextForHistory }]
        });
      }
      if (rawReplyText) {
        conversation.push({
          role: "model",
          parts: [{ text: rawReplyText }]
        });
      }

    } catch (err) {
      console.error(err);
      thinking.className = "msg bot-msg";
      thinking.textContent = "âš  æª”æ¡ˆè™•ç†æˆ–å‘¼å« API æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + err;
    } finally {
      sendBtn.disabled = false;
      scrollBottom();
    }
  });
</script>

</body>
</html>
