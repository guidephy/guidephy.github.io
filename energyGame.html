<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>âš¡ åƒç´ èƒ½æºï¼šæ±ºæˆ°å°ç£ v9</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Noto+Sans+TC:wght@500;900&display=swap');

        :root {
            --bg-ocean: #2c3e50;
            --land-green: #27ae60;
            --land-border: #145a32;
            --ui-bg: #212529;
            --ui-border: #95a5a6;
            --accent-blue: #3498db;
            --accent-gold: #f1c40f;
            --accent-red: #e74c3c;
            --text-white: #ecf0f1;
            
            --color-coal: #7f8c8d;
            --color-gas: #d35400;
            --color-green: #2ecc71;
            --color-solar: #f39c12;
            --color-nuclear: #8e44ad;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; user-select: none; }
        
        body {
            font-family: 'Noto Sans TC', monospace;
            background-color: var(--bg-ocean);
            background-image: 
                linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            
            /* === æ‰‹æ©Ÿç‰ˆé¢æ ¸å¿ƒä¿®æ­£ === */
            width: 100vw;
            height: 100vh;       /* ç›¸å®¹èˆŠç€è¦½å™¨ */
            height: 100dvh;      /* é—œéµï¼šå‹•æ…‹æ‰£é™¤ç€è¦½å™¨å·¥å…·åˆ—é«˜åº¦ */
            overflow: hidden;    /* ç¦æ­¢æ²å‹•æ•´å€‹é é¢ */
            color: var(--text-white);
            display: flex;
            flex-direction: column;
            image-rendering: pixelated;
        }

        /* === é ‚éƒ¨ HUD === */
        #hud {
            flex: 0 0 auto;
            background: var(--ui-bg);
            border-bottom: 4px solid var(--ui-border);
            padding: 8px 4px;
            /* é¿é–‹ iPhone ç€æµ· */
            padding-top: max(8px, env(safe-area-inset-top)); 
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            z-index: 100;
        }
        .stat-box { position: relative; text-align: center; border: 2px solid #555; background: #000; padding: 4px 2px; }
        .stat-label { font-size: 11px; color: #aaa; display: block; margin-bottom: 2px; }
        .stat-val { font-family: 'VT323', monospace; font-size: 22px; color: #fff; font-weight: bold; line-height: 1; }
        .stat-val.gold { color: var(--accent-gold); }
        .stat-val.blue { color: var(--accent-blue); }
        .stat-val.red { color: var(--accent-red); animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        .help-btn {
            position: absolute; top: 0; right: 0;
            color: #000; background: var(--accent-gold); 
            font-size: 12px; font-weight: bold; cursor: pointer;
            width: 14px; height: 14px; line-height: 14px;
            text-align: center; border-bottom-left-radius: 4px;
        }

        /* === è³‡è¨Šé¢æ¿ === */
        .info-panel {
            position: absolute; top: 80px; width: 140px;
            background: rgba(33, 37, 41, 0.95); padding: 8px; z-index: 90;
            box-shadow: 4px 4px 0px #000; pointer-events: none; border-radius: 2px;
        }
        #story-panel { left: 10px; border: 3px solid var(--ui-border); }
        #goal-panel { right: 10px; border: 3px solid var(--accent-blue); }
        
        .pixel-title { 
            font-size: 13px; color: var(--accent-gold); border-bottom: 2px dashed #555;
            padding-bottom: 4px; margin-bottom: 4px; font-weight: 900;
        }
        .pixel-text { font-size: 12px; line-height: 1.4; color: #ddd; }
        .goal-item { font-size: 11px; margin-bottom: 4px; border-bottom: 1px solid #444; padding-bottom: 2px; }
        .goal-check.done { color: var(--land-green); font-weight:bold; }

        /* === ä¸­å¤®åœ°åœ–å€ (å½ˆæ€§ä¼¸ç¸®) === */
        #game-stage {
            flex: 1; /* è‡ªå‹•å¡«æ»¿ä¸­é–“å‰©é¤˜ç©ºé–“ */
            position: relative; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            overflow: hidden;
            width: 100%;
        }
        #map-container { position: relative; width: 100%; height: 100%; }

        #taiwan-svg {
            width: 100%; height: 100%;
            filter: drop-shadow(6px 6px 0px rgba(0,0,0,0.5));
            overflow: visible;
        }
        .map-path { fill: var(--land-green); stroke: var(--land-border); stroke-width: 3px; }

        #power-pie-chart {
            position: absolute;
            top: 40%; left: 55%;
            transform: translate(-50%, -50%);
            width: 90px; height: 90px;
            border-radius: 50%;
            background: #444;
            border: 3px solid #fff;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.5);
            z-index: 50; pointer-events: none;
            transition: background 0.5s ease;
        }
        #pie-label {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); color: #fff; padding: 3px 6px;
            font-size: 11px; border-radius: 3px; white-space: nowrap;
        }

        /* å·¦ä¸‹è§’æˆ°æƒ…æ•¸æ“š */
        #map-data-overlay {
            position: absolute;
            bottom: 10px; left: 10px;   
            background: rgba(10, 10, 10, 0.95);
            border: 2px solid #fff;
            padding: 8px;
            width: 150px;
            z-index: 95;
            pointer-events: none;
            box-shadow: 4px 4px 0px #000;
        }
        .data-row { font-size: 12px; color: #ccc; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center;}
        .data-val { color: #fff; font-weight: bold; font-family: 'VT323', monospace; font-size: 16px; }
        .data-sep { border-top: 1px dashed #555; margin: 5px 0; }

        /* === åº•éƒ¨æ§åˆ¶å° (å›ºå®šé«˜åº¦ä½†é©é…åº•éƒ¨å®‰å…¨å€) === */
        #bottom-panel {
            flex: 0 0 auto; 
            background: var(--ui-bg); 
            border-top: 4px solid var(--ui-border);
            height: 260px; 
            /* é—œéµï¼šå¢åŠ åº•éƒ¨å…§è·ä»¥é¿é–‹æ‰‹æ©Ÿ Home Bar */
            padding: 10px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            display: flex; 
            flex-direction: column; 
            z-index: 100;
        }
        .arcade-tabs { display: flex; gap: 8px; margin-bottom: 8px; flex-shrink: 0; }
        .pixel-btn {
            flex: 1; background: #444; border: 2px solid #fff; color: #fff;
            padding: 8px; font-weight: bold; font-size: 15px;
            box-shadow: 3px 3px 0px #000; cursor: pointer; text-align: center;
        }
        .pixel-btn.active { background: var(--accent-blue); transform: translate(2px, 2px); box-shadow: 1px 1px 0px #000; }
        
        .tab-content { display: none; flex: 1; overflow: hidden; flex-direction: column; }
        .tab-content.active { display: flex; }

        /* å»ºè¨­å¡ç‰Œ */
        #build-deck { display: flex; gap: 4px; flex: 1; width: 100%; }
        .pixel-card {
            flex: 1; position: relative;
            background: #333; border: 2px solid #888;
            box-shadow: 2px 2px 0px #000; padding: 2px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: space-around;
            min-width: 0;
        }
        .pixel-card.selected { background: #555; border-color: var(--accent-gold); transform: translateY(-3px); }
        .pixel-card.disabled { opacity: 0.3; filter: grayscale(1); pointer-events: none; }
        .card-emoji { font-size: 26px; }
        .card-name { font-size: 12px; text-align: center; white-space: nowrap; color: #fff; font-weight: bold; }
        .card-power { font-family:'VT323'; color:var(--accent-blue); font-size:15px; font-weight: bold; }
        .card-cost { font-family:'VT323'; color:var(--accent-gold); font-size:20px; font-weight: bold; }

        .build-hint {
            font-size: 11px; color: #888; text-align: center; 
            padding-top: 6px; border-top: 1px solid #444; margin-top: 6px; flex-shrink: 0;
        }

        /* === ç‡ƒæ–™å¸‚å ´ (å„ªåŒ–æ²å‹•) === */
        #market-container { display: flex; gap: 8px; height: 100%; width: 100%; }
        .market-col {
            flex: 1; display: flex; flex-direction: column;
            background: #111; border: 1px solid #444; padding: 0; border-radius: 4px;
            height: 100%; 
            overflow-y: auto; /* æ•´å€‹æ¬„ä½å¯æ²å‹• */
            position: relative;
            -webkit-overflow-scrolling: touch; /* iOS æ»‘å‹•é †æš¢ */
        }
        .market-header { 
            font-size: 13px; color: var(--accent-gold); text-align: center; 
            background: #222; border-bottom: 1px solid #555; padding: 6px; 
            position: sticky; top: 0; z-index: 10;
        }
        
        .market-country-row {
            display: flex; flex-direction: column; background: #222; border: 1px solid #555; 
            padding: 6px; margin: 4px;
        }
        .m-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .flag { font-size: 14px; color:#fff; }
        .price { color: #fff; font-family: 'VT323'; font-size: 18px; font-weight: bold; color: var(--accent-gold); }
        .buy-btn-mini {
            width: 100%; background: var(--land-green); border: 1px solid #fff; color: white;
            padding: 4px; font-size: 12px; cursor: pointer; text-align: center; font-weight: bold;
        }
        .buy-btn-mini:active { background: #fff; color: #000; }

        .terminal-build-area {
            background: #2c3e50; border: 1px solid var(--accent-blue);
            padding: 8px; margin: 4px; text-align: center;
        }
        .terminal-info { font-size: 11px; color: #aec6cf; margin-bottom: 4px; }
        .build-term-btn {
            background: var(--accent-blue); color: #fff; border: 1px solid #fff;
            width: 100%; padding: 6px; font-size: 13px; cursor: pointer; font-weight: bold;
        }

        /* === ä¸‹ä¸€å›åˆæŒ‰éˆ• (ä½ç½®éš¨åº•éƒ¨é¢æ¿èª¿æ•´) === */
        #next-btn {
            position: fixed;
            /* 260px (panel height) + 20px (gap) + safe-area */
            bottom: calc(270px + env(safe-area-inset-bottom)); 
            right: 15px;
            width: 80px; height: 80px;
            background: var(--accent-red);
            border: 4px solid #fff; border-radius: 50%;
            box-shadow: 5px 5px 0px #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 150; cursor: pointer;
            font-size: 14px; font-weight: bold; text-align: center; line-height: 1.2;
            animation: pulse-btn 1.5s infinite;
        }
        #next-btn:active { transform: scale(0.95); box-shadow: 2px 2px 0px #000; }
        @keyframes pulse-btn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* å½ˆçª— */
        #modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000;
            display: none; justify-content: center; align-items: center; padding: 20px;
        }
        .retro-dialog { background: var(--accent-blue); border: 4px solid #fff; padding: 4px; width: 100%; max-width: 320px; box-shadow: 8px 8px 0px #000;}
        .retro-inner { background: var(--ui-bg); border: 2px solid #000; padding: 20px; text-align: center; }
        .retro-btn { margin-top: 15px; background: #000; color: #fff; border: 2px solid #fff; padding: 10px 30px; cursor: pointer; font-size: 16px; }
        .retro-btn.restart { background: var(--accent-red); color: #fff; border-color: #fff; }

        .float-pixel {
            position: fixed; font-family: 'VT323', monospace; font-size: 28px; font-weight: bold;
            text-shadow: 2px 2px 0px #000; pointer-events: none; z-index: 300;
            animation: floatPixel 1.2s steps(8) forwards;
        }
        @keyframes floatPixel { 0%{transform:translate(-50%,0);} 100%{transform:translate(-50%,-60px); opacity: 0;} }
        .crisis-mode { filter: sepia(100%) hue-rotate(-50deg) saturate(300%); }
        
        .rule-list { text-align: left; font-size: 14px; color: #ccc; margin: 10px 0; border: 1px solid #555; padding: 10px; background: #222; }
        .rule-item { display: flex; justify-content: space-between; margin-bottom: 6px; border-bottom: 1px solid #333; padding-bottom: 2px;}
        .rule-title { font-weight: bold; color: var(--accent-gold); margin-bottom: 5px; text-align: center;}
    </style>
</head>
<body>

    <div id="hud">
        <div class="stat-box"><span class="stat-label">è¥¿å…ƒ</span><span class="stat-val" id="hud-year">1975</span></div>
        <div class="stat-box">
            <span class="stat-label">è³‡é‡‘</span>
            <span class="stat-val gold" id="hud-funds">2500</span>
            <div class="help-btn" onclick="ui.showFundsHelp()">?</div>
        </div>
        <div class="stat-box">
            <span class="stat-label">ç«¶çˆ­åŠ›</span>
            <span class="stat-val blue" id="hud-comp">100%</span>
            <div class="help-btn" onclick="ui.showCompHelp()">?</div>
        </div>
        <div class="stat-box">
            <span class="stat-label">å­˜é‡</span>
            <span class="stat-val" id="hud-days">30å¤©</span>
            <div class="help-btn" onclick="ui.showStockHelp()">?</div>
        </div>
    </div>

    <div id="story-panel" class="info-panel">
        <div class="pixel-title">ä»»å‹™ç°¡å ±</div>
        <div class="pixel-text" id="story-text">...</div>
    </div>
    <div id="goal-panel" class="info-panel">
        <div class="pixel-title" style="color:var(--accent-blue)">éšæ®µç›®æ¨™</div>
        <div id="goal-list"></div>
    </div>

    <div id="game-stage">
        <div id="map-container">
            <svg id="taiwan-svg" viewBox="0 0 320 480">
                <path class="map-path" d="
                    M 210 30 
                    C 230 35, 250 50, 260 80
                    C 275 120, 270 180, 265 220
                    C 260 270, 240 320, 220 370
                    C 200 420, 185 450, 175 460
                    L 165 455
                    C 110 420, 60 350, 50 250  
                    C 45 180, 75 120, 100 80
                    C 140 50, 170 30, 210 30 Z
                "/>
            </svg>
            
            <div id="power-pie-chart">
                <div id="pie-label">ç™¼é›»å æ¯”</div>
            </div>
            
            <div id="buildings-layer"></div>

            <div id="map-data-overlay">
                <div class="data-row"><span>ç¸½ç™¼é›»</span><span class="data-val" id="stat-supply">0</span></div>
                <div class="data-row"><span>ç¸½éœ€æ±‚</span><span class="data-val" id="stat-demand">0</span></div>
                <div class="data-sep"></div>
                <div class="data-row"><span>ğŸ­ ç‡ƒç…¤é›»å» </span><span class="data-val" id="cnt-coal">0</span></div>
                <div class="data-row"><span>ğŸ”¥ ç‡ƒæ°£é›»å» </span><span class="data-val" id="cnt-gas">0</span></div>
                <div class="data-row"><span>â˜¢ï¸ æ ¸èƒ½é›»å» </span><span class="data-val" id="cnt-nuke">0</span></div>
                <div class="data-row"><span>ğŸŒ€ é›¢å²¸é¢¨é›»</span><span class="data-val" id="cnt-wind">0</span></div>
                <div class="data-row"><span>â˜€ï¸ å¤ªé™½èƒ½</span><span class="data-val" id="cnt-solar">0</span></div>
                <div class="data-row"><span>âš“ æ¥æ”¶ç«™</span><span class="data-val" id="cnt-term">0</span></div>
            </div>
        </div>
    </div>

    <div id="next-btn" onclick="game.nextTurn()">ä¸‹ä¸€<br>å¹´åº¦</div>

    <div id="bottom-panel">
        <div class="arcade-tabs">
            <button class="pixel-btn active" onclick="ui.switchTab('build')">ğŸ”¨ å»ºè¨­</button>
            <button class="pixel-btn" onclick="ui.switchTab('market')">ğŸš¢ ç‡ƒæ–™å¸‚å ´</button>
        </div>

        <div id="tab-build" class="tab-content active">
            <div id="build-deck"></div>
            <div class="build-hint">é»æ“Šå¡ç‰‡ç³»çµ±å°‡è‡ªå‹•é¸å€å»ºè¨­</div>
        </div>

        <div id="tab-market" class="tab-content">
            <div id="market-container">
                <div class="market-col">
                    <div class="market-header">ğŸª¨ ç…¤ (å­˜:<span id="val-coal-stock">0</span>)</div>
                    <div class="market-list" id="market-coal-list"></div>
                </div>
                <div class="market-col">
                    <div class="market-header">ğŸ”¥ æ°£ (å­˜:<span id="val-gas-stock">0</span>)</div>
                    
                    <div class="terminal-build-area">
                        <div class="terminal-info">ä¸Šé™: <span id="val-gas-cap">0</span> | å·²æœ‰ <span id="val-term-cnt">0</span> åº§</div>
                        <button class="build-term-btn" onclick="game.buildTerminal()">æ–°å»ºæ¥æ”¶ç«™ ($1000)</button>
                    </div>

                    <div class="market-list" id="market-gas-list"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-overlay">
        <div class="retro-dialog">
            <div class="retro-inner">
                <div class="retro-title" id="modal-title">TITLE</div>
                <div id="modal-content-area">
                    <p id="modal-desc" style="font-size:14px; line-height:1.6; color:#ddd; margin:15px 0;">CONTENT</p>
                </div>
                <button class="retro-btn" id="modal-btn" onclick="ui.closeModal()">ç¢º å®š</button>
            </div>
        </div>
    </div>

    <script>
        // === è³‡æ–™åº«è¨­å®š ===
        const PLANTS = {
            coal: { name: 'ç‡ƒç…¤', emoji: 'ğŸ­', cost: 500, output: 100, fuel: 20, type: 'land', color: '#7f8c8d' },
            gas: { name: 'ç‡ƒæ°£', emoji: 'ğŸ”¥', cost: 800, output: 120, fuel: 15, type: 'land', color: '#d35400' },
            terminal: { name: 'æ¥æ”¶ç«™', emoji: 'âš“', cost: 1000, output: 0, fuel: 0, type: 'coast', color: '#2980b9' },
            green: { name: 'é¢¨é›»', emoji: 'ğŸŒ€', cost: 1500, output: 20, fuel: 0, type: 'sea', color: '#2ecc71' },
            solar: { name: 'å¤ªé™½èƒ½', emoji: 'â˜€ï¸', cost: 600, output: 10, fuel: 0, type: 'land', color: '#f39c12' },
            nuclear: { name: 'æ ¸èƒ½', emoji: 'â˜¢ï¸', cost: 3000, output: 300, fuel: 0, type: 'land', color: '#8e44ad' }
        };

        const STAGES = [
            {
                title: "éšæ®µä¸€ï¼šåŸºç¤å»ºè¨­",
                desc: "1975å¹´ï¼Œåå¤§å»ºè¨­å•Ÿå‹•ã€‚è«‹å»ºè¨­é›»å» ï¼Œæ»¿è¶³å·¥æ¥­ç™¼å±•çš„é›»åŠ›éœ€æ±‚ã€‚",
                goals: [
                    { txt: "ç™¼é›»é‡ > 800MW", check: g => g.calcPower() >= 800 },
                    { txt: "ç‡ƒç…¤é›»å»  4 åº§", check: g => g.counts.coal >= 4 },
                    { txt: "ç‡ƒæ°£é›»å»  1 åº§", check: g => g.counts.gas >= 1 }
                ]
            },
            {
                title: "éšæ®µäºŒï¼šç¶“æ¿Ÿèµ·é£›",
                desc: "1990å¹´ï¼Œç«¹ç§‘å´›èµ·ã€‚éœ€è¦ç©©å®šçš„ç‡ƒæ°£é›»åŠ›èˆ‡æ¥æ”¶ç«™ã€‚",
                goals: [
                    { txt: "æ¥æ”¶ç«™ > 1 åº§", check: g => g.counts.terminal >= 2 },
                    { txt: "ç‡ƒæ°£é›»å»  3 åº§", check: g => g.counts.gas >= 3 }
                ]
            },
            {
                title: "éšæ®µä¸‰ï¼šèƒ½æºè½‰å‹",
                desc: "2010å¹´ï¼Œé¢å°å°é–é¢¨éšªï¼Œå¿…é ˆæé«˜å¤©ç„¶æ°£å®‰å…¨å­˜é‡ä¸¦ç™¼å±•ç¶ èƒ½ã€‚",
                goals: [
                    { txt: "å®‰å…¨å­˜é‡ > 14å¤©", check: g => g.getSafetyDays() >= 14 },
                    { txt: "é›¢å²¸é¢¨é›» 5 åº§", check: g => g.counts.green >= 5 }
                ]
            }
        ];

        const MARKET_SOURCES = {
            coal: [
                { id: 'au', name: 'æ¾³æ´²', flag: 'ğŸ‡¦ğŸ‡º', base: 100 },
                { id: 'id', name: 'å°å°¼', flag: 'ğŸ‡®ğŸ‡©', base: 80 },
                { id: 'ru', name: 'ä¿„åœ‹', flag: 'ğŸ‡·ğŸ‡º', base: 90 }
            ],
            gas: [
                { id: 'qa', name: 'å¡é”', flag: 'ğŸ‡¶ğŸ‡¦', base: 200 },
                { id: 'au', name: 'æ¾³æ´²', flag: 'ğŸ‡¦ğŸ‡º', base: 220 },
                { id: 'us', name: 'ç¾åœ‹', flag: 'ğŸ‡ºğŸ‡¸', base: 250 }
            ]
        };

        // === éŠæˆ²æ ¸å¿ƒ ===
        const game = {
            year: 1975, funds: 2500, comp: 100, demand: 600,
            fuel: { coal: 500, gas: 0 }, cap: { coal: 3000, gas: 0 },
            counts: { coal: 0, gas: 0, terminal: 0, green: 0, solar: 0, nuclear: 0 },
            stageIdx: 0, selected: null, blockade: false, bDays: 0,
            marketPrices: {}, 

            init() {
                this.resetVariables();
                this.counts.coal = 2;
                this.updateMarketPrices();
                ui.renderDeck(); ui.renderMarket(); ui.updateAll();
                // å˜—è©¦å…¨è¢å¹• (éƒ¨åˆ†ç€è¦½å™¨å¯èƒ½é˜»æ“‹)
                document.body.requestFullscreen().catch(e=>{});
                ui.showModal(STAGES[0].title, STAGES[0].desc);
            },

            resetVariables() {
                this.year = 1975; this.funds = 2500; this.comp = 100; this.demand = 600;
                this.fuel = { coal: 500, gas: 0 }; 
                this.cap = { coal: 3000, gas: 0 };
                this.counts = { coal: 0, gas: 0, terminal: 0, green: 0, solar: 0, nuclear: 0 };
                this.stageIdx = 0; this.selected = null; this.blockade = false;
                document.getElementById('buildings-layer').innerHTML = '';
                document.body.classList.remove('crisis-mode');
            },
            
            restart() {
                this.resetVariables();
                this.counts.coal = 2;
                this.updateMarketPrices();
                ui.renderDeck(); ui.renderMarket(); ui.updateAll();
                ui.closeModal();
                setTimeout(() => ui.showModal("éŠæˆ²é‡å•Ÿ", "ä¸€åˆ‡å›åˆ°1975å¹´ï¼Œè«‹é‡æ–°è¦åŠƒå°ç£èƒ½æºæ”¿ç­–ï¼"), 300);
            },

            selectCard(key) {
                if(this.selected === key) { this.selected = null; }
                else { this.selected = key; this.tryBuild(); }
                ui.renderDeck();
            },

            tryBuild() {
                if (!this.selected) return;
                const p = PLANTS[this.selected];
                
                if (this.selected === 'nuclear' && this.year < 2025) {
                    ui.floatText('ğŸ”’ æŠ€è¡“æœªè§£é–', 'red'); this.selected = null; return;
                }
                if (this.funds < p.cost) {
                    ui.floatText('ğŸ’¸ è³‡é‡‘ä¸è¶³', 'red'); this.selected = null; return;
                }
                if (this.selected === 'gas' && this.counts.terminal === 0) {
                    ui.floatText('âš ï¸ éœ€å»ºæ¥æ”¶ç«™', 'red'); this.selected = null; return;
                }

                this.funds -= p.cost;
                this.counts[this.selected]++;
                
                ui.floatText(`-$${p.cost}`, 'gold');
                this.placeBuilding(this.selected);
                this.selected = null;
                ui.renderDeck(); ui.updateAll();
            },

            buildTerminal() {
                const p = PLANTS.terminal;
                if (this.funds < p.cost) {
                    ui.floatText('ğŸ’¸ è³‡é‡‘ä¸è¶³', 'red'); return;
                }
                this.funds -= p.cost;
                this.counts.terminal++;
                this.cap.gas += 500;
                ui.floatText(`-$${p.cost} æ“´å……`, 'gold');
                this.placeBuilding('terminal');
                ui.updateAll();
            },

            placeBuilding(type) {
                const pInfo = PLANTS[type];
                const el = document.createElement('div');
                el.innerText = pInfo.emoji;
                el.style.position = 'absolute';
                el.style.fontSize = '18px';
                el.style.animation = 'dropIn 0.3s';
                
                let x, y;
                switch(pInfo.type) {
                    case 'sea': 
                        x = 10 + Math.random() * 50; y = 100 + Math.random() * 300; break;
                    case 'coast': 
                        x = 60 + Math.random() * 20; y = 50 + Math.random() * 300; break;
                    case 'land': 
                        x = 100 + Math.random() * 100; y = 50 + Math.random() * 350; break;
                }
                el.style.left = x + 'px'; el.style.top = y + 'px';
                // ç‚ºäº†ä¿æŒåœ“é¤…åœ–ç„¦é»ï¼Œé€™è£¡ä¸å¯¦éš›æ·»åŠ å»ºç¯‰åœ–æ¨™åˆ°åœ°åœ–
                // document.getElementById('buildings-layer').appendChild(el);
            },

            buyFuel(type, countryId) {
                if (this.blockade) { ui.floatText('ğŸš« å°é–ä¸­', 'red'); return; }
                const cost = this.marketPrices[`${type}_${countryId}`];
                if (this.funds < cost) { ui.floatText('ğŸ’¸ è³‡é‡‘ä¸è¶³', 'red'); return; }
                if (this.fuel[type] + 100 > this.cap[type]) {
                    ui.floatText('ğŸ“¦ å€‰åº«å·²æ»¿', 'red');
                    if(type==='gas' && this.counts.terminal===0) ui.floatText('âš ï¸ éœ€æ¥æ”¶ç«™', 'red');
                    return;
                }
                this.funds -= cost;
                this.fuel[type] += 100;
                ui.floatText(`+100`, 'blue');
                ui.updateAll();
            },

            updateMarketPrices() {
                ['coal', 'gas'].forEach(type => {
                    MARKET_SOURCES[type].forEach(src => {
                        const fluc = 0.8 + Math.random() * 0.5;
                        this.marketPrices[`${type}_${src.id}`] = Math.floor(src.base * fluc);
                    });
                });
            },

            calcIncome() {
                const baseIncome = 500;
                const powerBonus = Math.floor(this.calcPower() * 2); 
                return baseIncome + powerBonus;
            },

            nextTurn() {
                if (this.blockade) { this.handleBlockade(); return; }
                this.year++; 
                
                const income = this.calcIncome();
                this.funds += income; 
                ui.floatText(`+${income} è³‡é‡‘`, 'gold');

                this.demand += 30;
                this.updateMarketPrices();
                this.consumeFuel();
                
                const power = this.calcPower();
                if (power < this.demand) {
                    this.comp -= 15; ui.floatText('âš¡ ç¼ºé›»!', 'red');
                } else {
                    this.comp = Math.min(100, this.comp + 5);
                }

                const stage = STAGES[this.stageIdx];
                if (stage && stage.goals.every(g => g.check(this))) {
                    if (this.stageIdx < STAGES.length - 1) {
                        this.stageIdx++;
                        ui.showModal(STAGES[this.stageIdx].title, STAGES[this.stageIdx].desc);
                    }
                }

                if (this.year > 2020 && Math.random() < 0.15) this.startBlockade();
                if (this.comp <= 0) { 
                    ui.showGameOver();
                    return;
                }
                ui.renderMarket(); ui.updateAll();
            },

            consumeFuel() {
                const cNeed = this.counts.coal * 20;
                const gNeed = this.counts.gas * 20;
                if (this.fuel.coal >= cNeed) this.fuel.coal -= cNeed;
                else { this.fuel.coal = 0; this.comp -= 5; ui.floatText('ç¼ºç…¤', 'red'); }
                if (this.fuel.gas >= gNeed) this.fuel.gas -= gNeed;
                else { this.fuel.gas = 0; if(gNeed>0){this.comp -= 5; ui.floatText('ç¼ºæ°£', 'red');} }
            },

            calcPower() { return (this.counts.coal*100) + (this.counts.gas*120) + (this.counts.green*20) + (this.counts.solar*10) + (this.counts.nuclear*300); },
            
            getSafetyDays() {
                const cUse = Math.max(1, this.counts.coal * 20);
                const gUse = Math.max(1, this.counts.gas * 20);
                const cDay = Math.floor(this.fuel.coal / cUse);
                const gDay = (this.counts.gas === 0) ? 99 : Math.floor(this.fuel.gas / gUse);
                return Math.min(cDay, gDay);
            },
            
            getCoalDays() {
                 const cUse = Math.max(1, this.counts.coal * 20);
                 return Math.floor(this.fuel.coal / cUse);
            },

            startBlockade() {
                this.blockade = true; this.bDays = 11;
                document.body.classList.add('crisis-mode');
                ui.showModal("âš ï¸ ç´…è‰²è­¦å ±", "æµ·å³½å°é–é–‹å§‹ï¼é€²å£ä¸­æ–·ï¼Œè«‹æ’é 11 å¤©ã€‚");
            },

            handleBlockade() {
                this.bDays--; this.consumeFuel();
                ui.floatText(`å‰© ${this.bDays} å¤©`, 'red');
                if (this.bDays <= 0) {
                    this.blockade = false; document.body.classList.remove('crisis-mode');
                    ui.showModal("ğŸ³ï¸ å±æ©Ÿè§£é™¤", "å°é–çµæŸï¼Œå°ç£å­˜æ´»ï¼");
                }
                ui.updateAll();
            }
        };

        const ui = {
            switchTab(tab) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.pixel-btn').forEach(el => el.classList.remove('active'));
                document.getElementById(`tab-${tab}`).classList.add('active');
                
                const btns = document.querySelectorAll('.pixel-btn');
                if(tab==='build') btns[0].classList.add('active');
                if(tab==='market') btns[1].classList.add('active');
            },

            renderDeck() {
                const buildable = Object.entries(PLANTS).filter(([k,v]) => k !== 'terminal');
                document.getElementById('build-deck').innerHTML = buildable.map(([k, v]) => `
                    <div class="pixel-card ${game.selected === k ? 'selected' : ''} ${(k==='nuclear' && game.year < 2025) ? 'disabled' : ''}" onclick="game.selectCard('${k}')">
                        <div class="card-emoji">${v.emoji}</div>
                        <div class="card-name" style="color:${v.color}">${v.name}</div>
                        <div class="card-power">+${v.output}MW</div>
                        <div class="card-cost">$${v.cost}</div>
                    </div>
                `).join('');
            },

            renderMarket() {
                document.getElementById('val-coal-stock').innerText = game.fuel.coal;
                document.getElementById('val-gas-stock').innerText = game.fuel.gas;
                
                document.getElementById('val-gas-cap').innerText = game.cap.gas;
                document.getElementById('val-term-cnt').innerText = game.counts.terminal;

                document.getElementById('market-coal-list').innerHTML = MARKET_SOURCES.coal.map(src => `
                    <div class="market-country-row">
                        <div class="m-top"><span class="flag">${src.flag} ${src.name}</span><span class="price">$${game.marketPrices['coal_'+src.id]||src.base}</span></div>
                        <button class="buy-btn-mini" onclick="game.buyFuel('coal', '${src.id}')">100å™¸ $${game.marketPrices['coal_'+src.id]||src.base}</button>
                    </div>`).join('');

                document.getElementById('market-gas-list').innerHTML = MARKET_SOURCES.gas.map(src => `
                    <div class="market-country-row">
                        <div class="m-top"><span class="flag">${src.flag} ${src.name}</span><span class="price">$${game.marketPrices['gas_'+src.id]||src.base}</span></div>
                        <button class="buy-btn-mini" onclick="game.buyFuel('gas', '${src.id}')">100å™¸ $${game.marketPrices['gas_'+src.id]||src.base}</button>
                    </div>`).join('');
            },

            updatePieChart() {
                const pCoal = game.counts.coal * PLANTS.coal.output;
                const pGas = game.counts.gas * PLANTS.gas.output;
                const pGreen = (game.counts.green * PLANTS.green.output) + (game.counts.solar * PLANTS.solar.output);
                const pNuke = game.counts.nuclear * PLANTS.nuclear.output;
                const total = pCoal + pGas + pGreen + pNuke;
                
                if (total === 0) return;

                const degCoal = (pCoal / total) * 360;
                const degGas = (pGas / total) * 360;
                const degGreen = (pGreen / total) * 360;
                const degNuke = (pNuke / total) * 360;

                const chart = document.getElementById('power-pie-chart');
                chart.style.background = `conic-gradient(
                    var(--color-coal) 0deg ${degCoal}deg,
                    var(--color-gas) ${degCoal}deg ${degCoal + degGas}deg,
                    var(--color-nuclear) ${degCoal + degGas}deg ${degCoal + degGas + degNuke}deg,
                    var(--color-green) ${degCoal + degGas + degNuke}deg 360deg
                )`;
            },

            updateAll() {
                document.getElementById('hud-year').innerText = game.year;
                document.getElementById('hud-funds').innerText = game.funds;
                document.getElementById('hud-comp').innerText = game.comp + '%';
                
                const days = game.getSafetyDays();
                document.getElementById('hud-days').innerText = (days > 99 ? 'å……è¶³' : days + 'å¤©');
                document.getElementById('hud-days').className = `stat-val ${days < 14 ? 'red' : ''}`;

                document.getElementById('stat-supply').innerText = game.calcPower();
                document.getElementById('stat-demand').innerText = game.demand;
                
                document.getElementById('cnt-coal').innerText = game.counts.coal;
                document.getElementById('cnt-gas').innerText = game.counts.gas;
                document.getElementById('cnt-nuke').innerText = game.counts.nuclear;
                document.getElementById('cnt-wind').innerText = game.counts.green;
                document.getElementById('cnt-solar').innerText = game.counts.solar;
                document.getElementById('cnt-term').innerText = game.counts.terminal;

                const s = STAGES[game.stageIdx];
                document.getElementById('story-text').innerText = s.desc;
                document.getElementById('goal-list').innerHTML = s.goals.map(g => `
                    <div class="goal-item"><span class="goal-check ${g.check(game) ? 'done' : ''}">${g.check(game) ? 'âœ…' : 'â¬œ'}</span> <span>${g.txt}</span></div>
                `).join('');

                if (game.blockade) {
                    document.getElementById('next-btn').innerHTML = `æ’ä½<br>${game.bDays}å¤©`;
                    document.getElementById('next-btn').style.background = '#000';
                } else {
                    document.getElementById('next-btn').innerHTML = `ä¸‹ä¸€<br>å¹´åº¦`;
                    document.getElementById('next-btn').style.background = 'var(--accent-red)';
                }
                
                this.updatePieChart();
                this.renderMarket();
            },

            floatText(txt, color) {
                const el = document.createElement('div'); el.className = 'float-pixel'; el.innerText = txt;
                el.style.color = color === 'red' ? '#e74c3c' : (color === 'gold' ? '#f1c40f' : '#fff');
                el.style.left = '50%'; el.style.top = '40%';
                document.body.appendChild(el); setTimeout(() => el.remove(), 1200);
            },

            showModal(title, desc) {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-desc').style.display = 'block';
                document.getElementById('modal-desc').innerText = desc;
                const oldList = document.querySelector('.rule-list');
                if(oldList) oldList.remove();
                
                document.getElementById('modal-btn').innerText = "ç¢º å®š";
                document.getElementById('modal-btn').onclick = ui.closeModal;
                document.getElementById('modal-btn').classList.remove('restart');
                document.getElementById('modal-overlay').style.display = 'flex';
            },
            
            showCompHelp() {
                document.getElementById('modal-title').innerText = "ç«¶çˆ­åŠ›èªªæ˜";
                document.getElementById('modal-desc').style.display = 'none';
                const contentArea = document.getElementById('modal-content-area');
                contentArea.innerHTML = ''; 
                
                const list = document.createElement('div');
                list.className = 'rule-list';
                list.innerHTML = `
                    <div class="rule-title">è©•åˆ†è¦å‰‡</div>
                    <div class="rule-item"><span>âš¡ ä¾›é›»å……è¶³</span><span style="color:#2ecc71">+5%</span></div>
                    <div class="rule-item"><span>âš¡ ä¾›é›»ä¸è¶³</span><span style="color:#e74c3c">-15%</span></div>
                    <div class="rule-item"><span>ğŸª¨ ç¼ºå°‘ç…¤ç‚­</span><span style="color:#e74c3c">-5%</span></div>
                    <div class="rule-item"><span>ğŸ”¥ ç¼ºå°‘å¤©ç„¶æ°£</span><span style="color:#e74c3c">-5%</span></div>
                `;
                contentArea.appendChild(list);
                document.getElementById('modal-btn').innerText = "é—œ é–‰";
                document.getElementById('modal-btn').onclick = ui.closeModal;
                document.getElementById('modal-overlay').style.display = 'flex';
            },

            showFundsHelp() {
                document.getElementById('modal-title').innerText = "è³‡é‡‘æ”¶å…¥èªªæ˜";
                document.getElementById('modal-desc').style.display = 'none';
                const contentArea = document.getElementById('modal-content-area');
                contentArea.innerHTML = '';
                
                const income = game.calcIncome();
                
                const list = document.createElement('div');
                list.className = 'rule-list';
                list.innerHTML = `
                    <div class="rule-title">æ”¶å…¥å…¬å¼</div>
                    <div class="rule-item"><span>ğŸ’° åŸºç¤ç¨…æ”¶</span><span>$500</span></div>
                    <div class="rule-item"><span>âš¡ ç™¼é›»çå‹µ</span><span>+$${Math.floor(game.calcPower()*2)}</span></div>
                    <div class="rule-item" style="border-top:1px solid #fff; margin-top:5px; padding-top:5px;">
                        <span>é è¨ˆä¸‹å¹´æ”¶å…¥</span><span style="color:#f1c40f">$${income}</span>
                    </div>
                    <div style="font-size:10px; color:#888; margin-top:5px;">(å…¬å¼ï¼šç™¼é›»é‡ x 2 + 500)</div>
                `;
                contentArea.appendChild(list);
                document.getElementById('modal-btn').innerText = "é—œ é–‰";
                document.getElementById('modal-btn').onclick = ui.closeModal;
                document.getElementById('modal-overlay').style.display = 'flex';
            },

            showStockHelp() {
                document.getElementById('modal-title').innerText = "å®‰å…¨å­˜é‡èªªæ˜";
                document.getElementById('modal-desc').style.display = 'none';
                const contentArea = document.getElementById('modal-content-area');
                contentArea.innerHTML = '';
                
                const cUse = Math.max(1, game.counts.coal * 20);
                const gUse = Math.max(1, game.counts.gas * 20);
                const cDays = Math.floor(game.fuel.coal / cUse);
                const gDays = (game.counts.gas === 0) ? 99 : Math.floor(game.fuel.gas / gUse);

                const list = document.createElement('div');
                list.className = 'rule-list';
                list.innerHTML = `
                    <div class="rule-title">ç›®å‰å­˜é‡å¤©æ•¸</div>
                    <div class="rule-item"><span>ğŸª¨ ç…¤ç‚­</span><span>${cDays} å¤©</span></div>
                    <div class="rule-item"><span>ğŸ”¥ å¤©ç„¶æ°£</span><span>${game.counts.gas===0 ? '-' : gDays+' å¤©'}</span></div>
                    <div style="margin-top:10px; font-size:11px; color:#aaa; line-height:1.4;">
                        æ¶ˆè€—å…¬å¼ï¼š<br>
                        åº«å­˜é‡ Ã· (é›»å» æ•¸ x 20å–®ä½/å¹´)<br>
                        <span style="color:#e74c3c">*å°é–æœŸé–“ç„¡æ³•é€²å£ï¼Œéœ€é å­˜é‡æ’é11å¤©ã€‚</span>
                    </div>
                `;
                contentArea.appendChild(list);
                document.getElementById('modal-btn').innerText = "é—œ é–‰";
                document.getElementById('modal-btn').onclick = ui.closeModal;
                document.getElementById('modal-overlay').style.display = 'flex';
            },

            showGameOver() {
                document.getElementById('modal-title').innerText = "åœ‹å®¶ç ´ç”¢";
                document.getElementById('modal-desc').style.display = 'block';
                document.getElementById('modal-desc').innerText = "é›»åŠ›ä¸ç©©å°è‡´ç”¢æ¥­å¤–ç§»ï¼Œå°ç£ç«¶çˆ­åŠ›æ­¸é›¶ã€‚";
                
                const btn = document.getElementById('modal-btn');
                btn.innerText = "ğŸ”„ é‡æ–°é–‹å§‹";
                btn.classList.add('restart');
                btn.onclick = () => game.restart();
                
                document.getElementById('modal-overlay').style.display = 'flex';
            },

            closeModal() { 
                document.getElementById('modal-overlay').style.display = 'none'; 
                document.getElementById('modal-content-area').innerHTML = '<p id="modal-desc" style="font-size:14px; line-height:1.6; color:#ddd; margin:15px 0;">CONTENT</p>';
            }
        };

        game.init();
    </script>
</body>
</html>
