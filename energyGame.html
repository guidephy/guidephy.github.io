<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>âš¡ å³¶å¶¼èƒ½æºç”Ÿå­˜æˆ°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700;900&family=LXGW+WenKai+TC:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap');

        :root {
            --ui-bg: rgba(250, 245, 235, 0.93);
            --ui-bg-solid: #faf5eb;
            --ui-border: #d4c4a8;
            --accent-ink: #b8860b;
            --accent-gold: #c8922a;
            --accent-blue: #5a8fa8;
            --accent-red: #c2625a;
            --accent-green: #6b9e6b;
            --text-main: #3e3428;
            --text-muted: #8a7e6e;
            --text-light: #b5a998;

            --color-coal: #9e9488;
            --color-oil: #6e6458;
            --color-gas: #d4a04a;
            --color-green: #7aae7a;
            --color-solar: #e8b84a;
            --color-nuclear: #9a88b8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; user-select: none; }

        body {
            font-family: 'LXGW WenKai TC', 'Noto Serif TC', serif;
            width: 100vw;
            height: 100dvh;
            overflow: hidden;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            background: #87CEEB;
        }

        /* ============================================
           ANIMATED OCEAN & SKY â€” FULL SCREEN BEHIND ALL
           ============================================ */
        #ocean-bg {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
            background: linear-gradient(180deg, 
                #d4ecf7 0%,
                #b8ddf0 15%,
                #9dd0ea 30%,
                #88c4e0 45%,
                #6db8d8 60%,
                #58a8c8 75%,
                #4898b8 90%,
                #3a88a8 100%
            );
        }

        /* Sun */
        .sun {
            position: absolute;
            top: 4%;
            right: 18%;
            width: 50px; height: 50px;
            background: radial-gradient(circle, #fff8e0 0%, #ffe880 40%, rgba(255,220,100,0.3) 70%, transparent 100%);
            border-radius: 50%;
            box-shadow: 0 0 60px 20px rgba(255,220,120,0.35), 0 0 120px 40px rgba(255,200,80,0.15);
            animation: sun-breathe 6s ease-in-out infinite alternate;
        }
        @keyframes sun-breathe {
            from { transform: scale(1); box-shadow: 0 0 60px 20px rgba(255,220,120,0.35), 0 0 120px 40px rgba(255,200,80,0.15); }
            to   { transform: scale(1.08); box-shadow: 0 0 80px 30px rgba(255,220,120,0.45), 0 0 150px 50px rgba(255,200,80,0.2); }
        }

        /* Clouds */
        .cloud {
            position: absolute;
            border-radius: 50%;
            background: rgba(255,255,255,0.7);
            filter: blur(8px);
        }
        .cloud::before, .cloud::after {
            content: '';
            position: absolute;
            background: rgba(255,255,255,0.6);
            border-radius: 50%;
            filter: blur(6px);
        }
        .cloud-1 {
            width: 160px; height: 40px; top: 6%;
            animation: drift1 40s linear infinite;
        }
        .cloud-1::before { width: 80px; height: 35px; top: -12px; left: 30px; }
        .cloud-1::after { width: 60px; height: 28px; top: -8px; left: 80px; }
        .cloud-2 {
            width: 120px; height: 32px; top: 14%;
            animation: drift2 55s linear infinite;
            opacity: 0.7;
        }
        .cloud-2::before { width: 60px; height: 26px; top: -10px; left: 20px; }
        .cloud-2::after { width: 50px; height: 22px; top: -6px; left: 60px; }
        .cloud-3 {
            width: 180px; height: 35px; top: 3%;
            animation: drift3 48s linear infinite;
            opacity: 0.55;
        }
        .cloud-3::before { width: 90px; height: 30px; top: -14px; left: 40px; }
        .cloud-3::after { width: 70px; height: 25px; top: -10px; left: 100px; }
        .cloud-4 {
            width: 100px; height: 28px; top: 10%;
            animation: drift1 65s linear infinite;
            animation-delay: -20s;
            opacity: 0.5;
        }
        .cloud-4::before { width: 50px; height: 22px; top: -8px; left: 15px; }

        @keyframes drift1 { from { left: -20%; } to { left: 110%; } }
        @keyframes drift2 { from { left: 110%; } to { left: -20%; } }
        @keyframes drift3 { from { left: -25%; } to { left: 115%; } }

        /* Sea birds */
        .bird {
            position: absolute;
            opacity: 0.35;
            font-size: 16px;
            animation: fly 25s linear infinite;
            pointer-events: none;
        }
        .bird-1 { top: 8%; animation-duration: 22s; }
        .bird-2 { top: 16%; animation-duration: 30s; animation-delay: -10s; font-size: 12px; opacity: 0.25; }
        .bird-3 { top: 12%; animation-duration: 35s; animation-delay: -18s; font-size: 10px; opacity: 0.2; }
        @keyframes fly { from { left: -5%; } to { left: 105%; } }

        /* Ocean waves */
        .wave-layer {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 40%;
            overflow: hidden; pointer-events: none;
        }
        .wave {
            position: absolute;
            width: 250%;
            left: -75%;
            height: 80px;
        }
        .wave svg { width: 100%; height: 100%; }
        .wave-1 {
            bottom: 0%;
            animation: sway 7s ease-in-out infinite alternate;
            opacity: 0.18;
        }
        .wave-2 {
            bottom: 3%;
            animation: sway 9s ease-in-out infinite alternate-reverse;
            opacity: 0.12;
        }
        .wave-3 {
            bottom: 7%;
            animation: sway 11s ease-in-out infinite alternate;
            opacity: 0.08;
        }
        @keyframes sway {
            from { transform: translateX(-3%); }
            to { transform: translateX(3%); }
        }

        /* Sparkles on water */
        .sparkle {
            position: absolute;
            width: 4px; height: 4px;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            animation: twinkle 2.5s ease-in-out infinite;
            pointer-events: none;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 1; transform: scale(1.5); }
        }

        /* ============================================
           HUD â€” WARM CREAM
           ============================================ */
        #hud {
            flex: 0 0 auto;
            background: var(--ui-bg);
            border-bottom: 2px solid var(--ui-border);
            padding: 4px;
            padding-top: max(4px, env(safe-area-inset-top));
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            z-index: 100;
            position: relative;
            backdrop-filter: blur(12px);
        }
        .stat-box {
            position: relative; text-align: center;
            border: 1.5px solid var(--ui-border);
            background: rgba(255,255,255,0.5);
            padding: 2px; cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .stat-box:active { background: rgba(255,248,230,0.8); }
        .stat-label { font-size: 10px; color: var(--text-muted); display: block; letter-spacing: 1px; }
        .stat-val { font-family: 'Playfair Display', serif; font-size: 18px; color: var(--text-main); font-weight: bold; line-height: 1; }
        .stat-val.gold { color: var(--accent-gold); }
        .stat-val.blue { color: var(--accent-blue); }
        .stat-val.red { color: var(--accent-red); animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        .help-btn {
            position: absolute; top: 0; right: 0;
            color: #fff; background: var(--accent-ink);
            font-size: 9px; font-weight: bold; cursor: pointer;
            width: 13px; height: 13px; line-height: 13px;
            text-align: center; border-bottom-left-radius: 4px;
            border-top-right-radius: 5px;
            font-family: 'Playfair Display', serif;
        }
        .hud-help-icon { font-size: 18px; color: var(--text-main); line-height: 24px; }

        /* ============================================
           INFO BAR
           ============================================ */
        #info-bar {
            display: flex; width: 100%;
            background: rgba(250,245,235,0.92);
            border-bottom: 1.5px solid var(--ui-border);
            font-size: 11px; line-height: 1.3;
            z-index: 90; flex-shrink: 0;
            backdrop-filter: blur(8px);
        }
        #info-bar-story {
            flex: 1; padding: 4px 8px;
            border-right: 1px solid var(--ui-border);
            color: var(--text-main);
        }
        #info-bar-goals { flex: 1; padding: 4px 8px; }
        #info-bar-story .bar-title {
            font-size: 11px; color: var(--accent-gold); font-weight: 700; margin-bottom: 1px;
            font-family: 'Noto Serif TC', serif;
        }
        #info-bar-goals .bar-title {
            font-size: 11px; color: var(--accent-blue); font-weight: 700; margin-bottom: 1px;
            font-family: 'Noto Serif TC', serif;
        }
        .bar-goal-item { display: flex; align-items: center; gap: 3px; font-size: 10px; color: var(--text-muted); }
        .bar-goal-item .goal-check { font-size: 11px; }
        .bar-goal-item .goal-check.done { color: var(--accent-green); font-weight: bold; }

        /* ============================================
           MAP STAGE â€” TRANSPARENT so ocean shows through
           ============================================ */
        #game-stage {
            flex: 1; position: relative; display: flex; justify-content: center; align-items: center;
            overflow: hidden; width: 100%;
            z-index: 1;
            /* NO background â€” ocean shows through */
        }
        #map-container { position: relative; width: 100%; height: 100%; }

        #map-year-display {
            position: absolute; top: 12px; left: 50%; transform: translateX(-50%);
            padding: 5px 20px;
            color: var(--text-main);
            font-family: 'Noto Serif TC', serif;
            font-size: 18px;
            font-weight: 700;
            z-index: 92;
            pointer-events: none;
            background: rgba(250,245,235,0.85);
            border-radius: 20px;
            border: 1.5px solid var(--ui-border);
            backdrop-filter: blur(8px);
            letter-spacing: 3px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        #taiwan-svg {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            filter: drop-shadow(3px 4px 6px rgba(0,0,0,0.2));
            overflow: visible;
        }
        .map-path {
            fill: none;
            stroke: #7a8a6a;
            stroke-width: 2.5px;
            pointer-events: all;
        }

        #map-data-overlay {
            position: absolute;
            bottom: 6px; left: 6px;
            background: rgba(250,245,235,0.9);
            border: 1.5px solid var(--ui-border);
            padding: 5px 7px;
            width: 120px;
            z-index: 95;
            pointer-events: none;
            border-radius: 8px;
            backdrop-filter: blur(8px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .data-row { font-size: 10px; color: var(--text-muted); margin-bottom: 1px; display: flex; justify-content: space-between; align-items: center; }
        .data-val { color: var(--text-main); font-weight: bold; font-family: 'Playfair Display', serif; font-size: 13px; }
        .data-sep { border-top: 1px dashed var(--ui-border); margin: 2px 0; }

        #map-labels-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 20;
        }
        .map-label {
            position: absolute;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #fff;
            text-shadow: 0 1px 4px rgba(0,0,0,0.6), 0 0 8px rgba(0,0,0,0.3);
            pointer-events: none;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }
        @keyframes fadeIn { to { opacity: 1; } }
        .map-label-name {
            font-family: 'Noto Serif TC', serif;
            font-weight: 700; font-size: 14px;
            color: #fff;
            background: rgba(0,0,0,0.35);
            padding: 1px 6px; border-radius: 10px;
            margin-bottom: -2px;
        }
        .map-label-val {
            font-family: 'Playfair Display', serif;
            font-size: 24px; font-weight: bold;
            color: #fff; letter-spacing: 0.5px;
        }

        /* ============================================
           BOTTOM PANEL â€” WARM CREAM
           ============================================ */
        #bottom-panel {
            flex: 0 0 auto;
            background: var(--ui-bg);
            border-top: 2px solid var(--ui-border);
            height: 190px;
            padding: 6px;
            padding-bottom: calc(6px + env(safe-area-inset-bottom));
            display: flex; flex-direction: column; z-index: 100;
            position: relative;
            backdrop-filter: blur(12px);
        }
        .arcade-tabs { display: flex; gap: 8px; margin-bottom: 0; flex-shrink: 0; align-items: flex-end; }

        .pixel-btn {
            flex: 1;
            background: rgba(255,255,255,0.3);
            border: 1.5px solid var(--ui-border); border-bottom: none;
            color: var(--text-muted);
            padding: 6px;
            font-weight: 700; font-size: 13px;
            cursor: pointer; text-align: center;
            transform: translateY(2px);
            transition: all 0.25s;
            border-top-left-radius: 8px; border-top-right-radius: 8px;
            z-index: 1;
            font-family: 'LXGW WenKai TC', serif;
            letter-spacing: 1px;
        }
        .pixel-btn.active {
            background: rgba(90,143,168,0.15);
            border-color: var(--accent-blue); border-bottom: none;
            color: var(--accent-blue);
            transform: translateY(0);
            z-index: 10;
            padding-bottom: 10px;
        }

        .tab-content {
            display: none; flex: 1; overflow: visible; flex-direction: column;
            border-top: 1.5px solid var(--accent-blue); margin-top: -2px; z-index: 5;
            background: transparent; position: relative;
        }
        .tab-content.active { display: flex; }

        #build-deck, #market-deck {
            display: flex; gap: 4px; flex: 1; width: 100%; padding-top: 6px;
        }

        .pixel-card {
            flex: 1; min-width: 0; position: relative;
            background: linear-gradient(180deg, rgba(255,255,255,0.6) 0%, rgba(250,245,235,0.8) 100%);
            border: 1.5px solid var(--ui-border);
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
            padding: 2px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            min-height: 85px; gap: 0;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .pixel-card:active { transform: scale(0.97); }
        .pixel-card.selected {
            background: linear-gradient(180deg, rgba(90,143,168,0.15) 0%, rgba(90,143,168,0.08) 100%);
            border-color: var(--accent-blue);
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(90,143,168,0.2);
        }
        .pixel-card.disabled { opacity: 0.4; filter: grayscale(0.7); }

        .card-emoji { font-size: 18px; margin-top: 1px; }
        .card-name { font-size: 11px; text-align: center; white-space: nowrap; color: var(--text-main); font-weight: 700; font-family: 'Noto Serif TC', serif; }
        .card-divider { width: 60%; height: 1px; background: var(--ui-border); margin: 1px 0; }
        .card-label { font-size: 9px; color: var(--text-muted); transform: scale(0.9); }
        .card-val { font-family: 'Playfair Display', serif; color: var(--text-main); font-size: 14px; font-weight: bold; }
        .card-risk { font-size: 9px; color: var(--accent-red); font-weight: bold; margin: 1px 0; line-height: 1; }
        .card-cost { font-family: 'Playfair Display', serif; color: var(--accent-gold); font-size: 15px; font-weight: bold; margin-top: auto; }
        .card-bottom { margin-top: auto; display: flex; flex-direction: column; align-items: center; gap: 0; padding-bottom: 2px; }
        .card-badge {
            position: absolute; top: -4px; right: -4px;
            background: var(--accent-ink); color: #fff;
            border: 1.5px solid #fff; border-radius: 8px;
            font-family: 'Playfair Display', serif; font-size: 13px; font-weight: bold;
            padding: 0 5px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
            z-index: 10;
        }
        .nuke-risk { font-size: 8px; color: var(--accent-red); font-weight: bold; }
        .lock-overlay {
            position: absolute; inset: 0; background: rgba(250,245,235,0.8);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-muted); font-size: 11px; font-weight: bold; z-index: 5; text-align: center;
            border-radius: 8px;
        }

        /* Market Tabs */
        .market-sub-tabs { display: flex; width: 100%; border-bottom: 1.5px solid var(--ui-border); margin-bottom: 3px; }
        .market-sub-tab {
            flex: 1; padding: 4px 6px; text-align: center;
            font-size: 12px; cursor: pointer; font-weight: 700;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            opacity: 0.5;
            background: rgba(255,255,255,0.2);
            color: var(--text-muted);
            font-family: 'LXGW WenKai TC', serif;
        }
        .market-sub-tab.tab-coal.active {
            opacity: 1; background: rgba(158,148,136,0.1);
            color: var(--text-main); border-bottom-color: var(--color-coal);
        }
        .market-sub-tab.tab-gas.active {
            opacity: 1; background: rgba(212,160,74,0.08);
            color: var(--accent-gold); border-bottom-color: var(--color-gas);
        }

        /* Next Button */
        #next-btn {
            position: fixed;
            bottom: calc(200px + env(safe-area-inset-bottom));
            right: 15px;
            width: 62px; height: 62px;
            background: var(--accent-red);
            border: 2.5px solid #fff; border-radius: 50%;
            box-shadow: 0 3px 12px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 150; cursor: pointer;
            font-size: 12px; font-weight: 700; text-align: center; line-height: 1.1;
            animation: pulse-btn 2s ease-in-out infinite;
            font-family: 'LXGW WenKai TC', serif;
            color: #fff;
            letter-spacing: 1px;
        }
        #next-btn:active { transform: scale(0.95); }
        @keyframes pulse-btn { 0%,100% { transform: scale(1); } 50% { transform: scale(1.06); } }

        /* ============================================
           TUTORIAL & HIGHLIGHTS
           ============================================ */
        #tutorial-overlay {
            position: fixed; inset: 0; background: rgba(62,52,40,0.55); z-index: 2000;
            display: none; cursor: pointer;
            backdrop-filter: blur(2px);
        }
        .highlight-target {
            z-index: 2001 !important; position: relative !important;
            box-shadow: 0 0 0 3px var(--accent-gold), 0 0 15px rgba(200,146,42,0.4) !important;
            transition: all 0.3s; pointer-events: auto; cursor: pointer;
        }
        #next-btn.highlight-target { position: fixed !important; }

        #tutorial-tooltip {
            position: fixed; top: 30%; left: 50%; transform: translateX(-50%);
            background: #fffdf7; color: var(--text-main); padding: 18px 20px;
            border-radius: 14px;
            font-weight: 600; z-index: 2002; display: none;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            text-align: center; width: 80%;
            animation: floatTip 2s ease-in-out infinite alternate;
            cursor: pointer;
            font-family: 'LXGW WenKai TC', serif;
            border: 1.5px solid var(--ui-border);
            line-height: 1.6;
        }
        .tut-title {
            color: var(--accent-blue); font-size: 15px; margin-bottom: 8px;
            border-bottom: 1.5px solid var(--ui-border); padding-bottom: 4px;
            font-family: 'Noto Serif TC', serif; font-weight: 700; letter-spacing: 2px;
        }
        @keyframes floatTip { from { transform: translate(-50%, 0); } to { transform: translate(-50%, -8px); } }
        .tut-next { font-size: 10px; color: var(--text-light); margin-top: 8px; }

        /* ============================================
           TOAST
           ============================================ */
        #toast-container {
            position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
            width: 260px; pointer-events: none; z-index: 1500;
            display: flex; flex-direction: column; gap: 6px;
        }
        .toast-msg {
            background: rgba(255,253,247,0.95);
            color: var(--text-main);
            border-left: 3px solid var(--text-light);
            padding: 6px 12px;
            font-family: 'LXGW WenKai TC', serif; font-size: 13px;
            border-radius: 8px;
            backdrop-filter: blur(8px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            opacity: 0; transform: translateY(-10px);
            animation: toastIn 0.3s forwards;
            transition: all 0.4s ease;
            max-height: 50px; margin-bottom: 6px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .toast-msg.good { border-color: var(--accent-gold); }
        .toast-msg.bad { border-color: var(--accent-red); color: var(--accent-red); }
        @keyframes toastIn { to { opacity: 1; transform: translateY(0); } }
        .toast-msg.hiding {
            opacity: 0; transform: translateX(10px);
            max-height: 0; padding: 0; margin: 0; border: none;
        }

        /* ============================================
           MODAL â€” SOFT CREAM
           ============================================ */
        #modal-overlay {
            position: fixed; inset: 0; background: rgba(62,52,40,0.5); z-index: 3000;
            display: none; justify-content: center; align-items: center; padding: 20px;
            backdrop-filter: blur(4px);
        }
        .retro-dialog {
            background: linear-gradient(135deg, var(--accent-blue), #7ab8c8);
            border: 2px solid rgba(255,255,255,0.6);
            padding: 3px;
            width: 95%; max-width: 360px; max-height: 85vh;
            box-shadow: 0 12px 40px rgba(0,0,0,0.2);
            display: flex; flex-direction: column;
            border-radius: 14px;
        }
        .retro-inner {
            background: var(--ui-bg-solid);
            border: 1px solid var(--ui-border);
            padding: 18px; text-align: center;
            overflow-y: auto;
            border-radius: 12px;
        }
        .retro-btn {
            margin-top: 15px;
            background: rgba(90,143,168,0.12);
            color: var(--text-main);
            border: 1.5px solid var(--ui-border);
            padding: 10px 20px; cursor: pointer;
            font-size: 15px; width: 100%;
            font-family: 'Noto Serif TC', serif; font-weight: 700;
            border-radius: 10px;
            transition: all 0.2s;
            letter-spacing: 2px;
        }
        .retro-btn:active { transform: scale(0.97); background: rgba(90,143,168,0.2); }
        .retro-btn.restart { background: rgba(194,98,90,0.12); border-color: var(--accent-red); color: var(--accent-red); }
        .retro-btn.victory { background: rgba(200,146,42,0.12); color: var(--accent-gold); border-color: var(--accent-gold); }
        .retro-btn.stage-clear { background: rgba(200,146,42,0.15); color: var(--accent-gold); border-color: var(--accent-gold); font-weight: 900; }

        .btn-group-vertical { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .retro-btn.screenshot { background: rgba(90,143,168,0.12); color: var(--accent-blue); border-color: var(--accent-blue); }
        .retro-btn.restart-end { background: rgba(194,98,90,0.1); color: var(--accent-red); border-color: var(--accent-red); }

        /* Stage Clear */
        .retro-dialog.stage-clear-dialog {
            background: linear-gradient(135deg, var(--accent-gold), #d4a04a);
            animation: stagePop 0.4s ease-out;
        }
        @keyframes stagePop { 0% { transform: scale(0.8); opacity: 0; } 50% { transform: scale(1.05); } 100% { transform: scale(1); opacity: 1; } }
        .stage-clear-banner {
            padding: 12px 0 8px; font-size: 20px; font-weight: 900;
            color: var(--accent-gold); text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            letter-spacing: 3px; font-family: 'Noto Serif TC', serif;
        }
        .stage-clear-sub { font-size: 13px; color: var(--text-muted); margin-bottom: 10px; }
        .stage-clear-goals {
            background: rgba(107,158,107,0.08); border: 1px solid rgba(107,158,107,0.3);
            padding: 8px; margin: 8px 0; text-align: left; border-radius: 8px;
        }
        .stage-clear-goal-item { font-size: 13px; color: var(--accent-green); padding: 3px 0; display: flex; align-items: center; gap: 6px; }
        .stage-clear-divider { border: none; border-top: 1.5px dashed var(--ui-border); margin: 12px 0; }

        /* Report */
        .report-grid { display: flex; flex-direction: column; gap: 10px; }
        .report-card {
            background: rgba(255,255,255,0.4); border: 1px solid var(--ui-border);
            border-radius: 10px; padding: 10px;
        }
        .report-header { font-size: 13px; font-weight: 700; color: var(--accent-gold); margin-bottom: 6px; font-family: 'Noto Serif TC', serif; }
        .report-flex { display: flex; justify-content: space-between; align-items: center; }
        .report-label { font-size: 12px; color: var(--text-muted); }
        .report-big { font-family: 'Playfair Display', serif; font-size: 20px; font-weight: bold; }
        .comp-list { margin-bottom: 6px; }
        .comp-row { display: flex; justify-content: space-between; font-size: 12px; padding: 2px 0; }

        .rule-list { text-align: left; font-size: 13px; color: var(--text-muted); margin: 10px 0; border: 1px solid var(--ui-border); padding: 12px; background: rgba(255,255,255,0.3); border-radius: 8px; }
        .rule-item { display: flex; justify-content: space-between; margin-bottom: 6px; border-bottom: 1px solid rgba(212,196,168,0.4); padding-bottom: 2px; }
        .rule-title { font-weight: 900; color: var(--accent-gold); margin-bottom: 5px; text-align: center; font-family: 'Noto Serif TC', serif; letter-spacing: 2px; }

        .chart-container { margin: 15px 0; border: 1px solid var(--ui-border); background: rgba(62,52,40,0.06); padding: 8px; border-radius: 8px; }
        .chart-title { font-size: 12px; color: var(--text-muted); margin-bottom: 5px; }
        .chart-legend { display: flex; flex-wrap: wrap; gap: 8px; font-size: 10px; justify-content: center; margin-top: 5px; }
        .legend-item { display: flex; align-items: center; gap: 3px; color: var(--text-muted); }
        .color-box { width: 8px; height: 8px; border: 1px solid var(--ui-border); border-radius: 2px; }

        .rank-section { display: flex; gap: 8px; margin-top: 10px; text-align: left; }
        .rank-col { flex: 1; background: rgba(255,255,255,0.3); border: 1px solid var(--ui-border); padding: 6px; border-radius: 8px; }
        .rank-header { font-size: 12px; font-weight: 700; color: var(--accent-gold); border-bottom: 1px dashed var(--ui-border); padding-bottom: 4px; margin-bottom: 4px; text-align: center; font-family: 'Noto Serif TC', serif; }
        .rank-row { display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: var(--text-main); margin-bottom: 3px; }
        .rank-val { font-family: 'Playfair Display', serif; color: var(--text-main); font-size: 14px; }

        .crisis-mode { filter: sepia(60%) hue-rotate(-30deg) saturate(180%); }

        .report-section { text-align: left; margin-bottom: 12px; border-bottom: 1px solid var(--ui-border); padding-bottom: 8px; }
        .report-section:last-child { border-bottom: none; }
        .report-title { font-weight: bold; color: var(--text-muted); font-size: 12px; margin-bottom: 4px; }
        .report-val { font-size: 16px; font-weight: bold; display: flex; justify-content: space-between; }
        .report-detail { font-size: 12px; color: var(--text-muted); margin-top: 2px; padding-left: 10px; }
    </style>
</head>
<body>

    <!-- ====== ANIMATED OCEAN & SKY BACKGROUND ====== -->
    <div id="ocean-bg">
        <div class="sun"></div>
        <div class="cloud cloud-1"></div>
        <div class="cloud cloud-2"></div>
        <div class="cloud cloud-3"></div>
        <div class="cloud cloud-4"></div>
        <div class="bird bird-1">ğŸ•Š</div>
        <div class="bird bird-2">ğŸ•Š</div>
        <div class="bird bird-3">ğŸ•Š</div>

        <div class="wave-layer">
            <div class="wave wave-3">
                <svg viewBox="0 0 1200 80" preserveAspectRatio="none"><path d="M0,40 Q150,10 300,40 T600,40 T900,40 T1200,40 L1200,80 L0,80 Z" fill="rgba(255,255,255,0.5)"/></svg>
            </div>
            <div class="wave wave-2">
                <svg viewBox="0 0 1200 80" preserveAspectRatio="none"><path d="M0,35 Q100,15 250,40 T500,35 T750,42 T1000,30 T1200,38 L1200,80 L0,80 Z" fill="rgba(255,255,255,0.5)"/></svg>
            </div>
            <div class="wave wave-1">
                <svg viewBox="0 0 1200 80" preserveAspectRatio="none"><path d="M0,30 Q200,5 400,35 T800,30 T1200,35 L1200,80 L0,80 Z" fill="rgba(255,255,255,0.55)"/></svg>
            </div>
        </div>

        <div class="sparkle" style="bottom:22%; left:15%; animation-delay:0s;"></div>
        <div class="sparkle" style="bottom:18%; left:35%; animation-delay:0.8s;"></div>
        <div class="sparkle" style="bottom:25%; left:55%; animation-delay:1.5s;"></div>
        <div class="sparkle" style="bottom:15%; left:72%; animation-delay:0.3s;"></div>
        <div class="sparkle" style="bottom:20%; left:88%; animation-delay:2s;"></div>
        <div class="sparkle" style="bottom:28%; left:45%; animation-delay:1.2s;"></div>
        <div class="sparkle" style="bottom:12%; left:25%; animation-delay:1.8s;"></div>
    </div>

    <div id="toast-container"></div>

    <div id="tutorial-overlay" onclick="game.handleTutorialClick()"></div>
    <div id="tutorial-tooltip" onclick="game.handleTutorialClick()">
        <div id="tut-text"></div>
        <div class="tut-next">â–¼ é»æ“Šæ­¤è™•ç¹¼çºŒ</div>
    </div>

    <div id="hud">
        <div class="stat-box" onclick="ui.showFundsHelp()">
            <span class="stat-label">è³‡é‡‘</span>
            <span class="stat-val gold" id="hud-funds">2,000</span>
            <div class="help-btn">?</div>
        </div>
        <div class="stat-box" onclick="ui.showCompHelp()">
            <span class="stat-label">ç«¶çˆ­åŠ›</span>
            <span class="stat-val blue" id="hud-comp">100%</span>
            <div class="help-btn">?</div>
        </div>
        <div class="stat-box" onclick="ui.showStockHelp()">
            <span class="stat-label">ç‡ƒæ–™å­˜é‡</span>
            <span class="stat-val" id="hud-days">--</span>
            <div class="help-btn">?</div>
        </div>
        <div class="stat-box" style="background:rgba(90,143,168,0.12); border-color:var(--accent-blue);" onclick="game.replayTutorial()">
            <span class="stat-label" style="color:var(--accent-blue);">éŠæˆ²èªªæ˜</span>
            <span class="stat-val hud-help-icon">?</span>
        </div>
    </div>

    <div id="info-bar">
        <div id="info-bar-story">
            <div class="bar-title">ğŸ“‹ ä»»å‹™ç°¡å ±</div>
            <div id="story-text">...</div>
        </div>
        <div id="info-bar-goals">
            <div class="bar-title">ğŸ† éšæ®µç›®æ¨™</div>
            <div id="goal-list"></div>
        </div>
    </div>

    <div id="game-stage">
        <div id="map-container">
            <div id="map-year-display">ç¬¬ 1 å¹´</div>
            <svg id="taiwan-svg" viewBox="0 0 320 480">
                <defs>
                    <clipPath id="taiwan-clip">
                        <path d="M 210 30 C 230 35, 250 50, 260 80 C 275 120, 270 180, 265 220 C 260 270, 240 320, 220 370 C 200 420, 185 450, 175 460 L 165 455 C 110 420, 60 350, 50 250 C 45 180, 75 120, 100 80 C 140 50, 170 30, 210 30 Z"/>
                    </clipPath>
                </defs>
                <foreignObject x="0" y="0" width="320" height="480" clip-path="url(#taiwan-clip)">
                    <div id="taiwan-chart-div" xmlns="http://www.w3.org/1999/xhtml" style="width:100%; height:100%; background: #889878; transition: background 0.5s ease;"></div>
                </foreignObject>
                <path class="map-path" d="M 210 30 C 230 35, 250 50, 260 80 C 275 120, 270 180, 265 220 C 260 270, 240 320, 220 370 C 200 420, 185 450, 175 460 L 165 455 C 110 420, 60 350, 50 250 C 45 180, 75 120, 100 80 C 140 50, 170 30, 210 30 Z"/>
            </svg>
            <div id="map-labels-layer"></div>
            <div id="buildings-layer"></div>
            <div id="map-data-overlay">
                <div class="data-row"><span>ç¸½ç™¼é›»</span><span class="data-val" id="stat-supply">0 MW</span></div>
                <div class="data-row"><span>ç¸½éœ€æ±‚</span><span class="data-val" id="stat-demand">0 MW</span></div>
                <div class="data-sep"></div>
                <div class="data-row" id="data-row-coal"><span>ç…¤å­˜é‡</span><span class="data-val" id="stat-coal-days" style="color:var(--text-muted)">--</span></div>
                <div class="data-row" id="data-row-gas"><span>æ°£å­˜é‡</span><span class="data-val blue" id="stat-gas-days">--</span></div>
            </div>
        </div>
    </div>

    <div id="next-btn" onclick="game.nextTurn()">ä¸‹ä¸€<br>å¹´åº¦</div>

    <div id="bottom-panel">
        <div class="arcade-tabs">
            <button class="pixel-btn active" id="tab-btn-build" onclick="ui.switchTab('build')">ğŸ”¨ å»ºè¨­</button>
            <button class="pixel-btn" id="tab-btn-market" onclick="ui.switchTab('market')">ğŸš¢ ç‡ƒæ–™å¸‚å ´</button>
        </div>
        <div id="tab-build" class="tab-content active"><div id="build-deck"></div></div>
        <div id="tab-market" class="tab-content">
            <div class="market-sub-tabs">
                <div id="mt-coal" class="market-sub-tab tab-coal active" onclick="ui.setMarketTab('coal')">ğŸª¨ ç‡ƒç…¤</div>
                <div id="mt-gas" class="market-sub-tab tab-gas" onclick="ui.setMarketTab('gas')" style="display:none;">ğŸ”¥ ç‡ƒæ°£</div>
            </div>
            <div id="market-deck"></div>
        </div>
    </div>

    <div id="modal-overlay">
        <div class="retro-dialog">
            <div class="retro-inner">
                <div class="retro-title" id="modal-title">TITLE</div>
                <div id="modal-content-area">
                    <p id="modal-desc" style="font-size:14px; line-height:1.6; color:var(--text-main); margin:15px 0;">CONTENT</p>
                </div>
                <div id="modal-footer">
                    <button class="retro-btn" id="modal-btn" onclick="ui.closeModal()">ç¢º å®š</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const PLANTS = {
            coal: { name: 'ç‡ƒç…¤', emoji: 'ğŸ­', cost: 1000, output: 1500, fuel: 40, type: 'land', color: '#9e9488' },
            gas: { name: 'ç‡ƒæ°£', emoji: 'ğŸ”¥', cost: 1500, output: 2500, fuel: 30, type: 'land', color: '#d4a04a' },
            terminal: { name: 'æ¥æ”¶ç«™', emoji: 'âš“', cost: 2000, output: 0, fuel: 0, type: 'coast', color: '#5a8fa8' },
            green: { name: 'é¢¨é›»', emoji: 'ğŸŒ€', cost: 3000, output: 100, fuel: 0, type: 'sea', color: '#7aae7a' },
            solar: { name: 'å¤ªé™½èƒ½', emoji: 'â˜€ï¸', cost: 1200, output: 50, fuel: 0, type: 'land', color: '#e8b84a' },
            nuclear: { name: 'æ ¸èƒ½', emoji: 'â˜¢ï¸', cost: 5000, output: 6000, fuel: 0, type: 'land', color: '#9a88b8' }
        };

        const STAGES = [
            { title: "éšæ®µä¸€ï¼šä»¥ç…¤ä»£æ²¹", short: "çŸ³æ²¹å±æ©Ÿçˆ†ç™¼ï¼æ²¹åƒ¹é£†æ¼²ï¼Œè«‹ç›¡é€Ÿè½‰å‘ç‡ƒç…¤ç™¼é›»ã€‚",
              desc: "ğŸ›¢ï¸ **çŸ³æ²¹å±æ©Ÿèˆ‡åŸºè¼‰é‡å»º**ï¼š<br>å…©æ¬¡çŸ³æ²¹å±æ©Ÿé‡å‰µç¶“æ¿Ÿï¼Œç‡ƒæ²¹æˆæœ¬æš´æ¼²ã€‚ç‚ºé”æˆã€Œèƒ½æºå¤šå…ƒåŒ–ã€ï¼Œé¦–è¦ä»»å‹™æ˜¯é™ä½ç‡ƒæ²¹ä¾è³´ï¼Œæ”¹ç”¨å»‰åƒ¹çš„ç…¤ç‚­èˆ‡æ ¸èƒ½ä½œç‚ºåŸºè¼‰é›»åŠ›ã€‚<br>ä»»å‹™ï¼šæ“´å……ç‡ƒç…¤æ©Ÿçµ„ï¼Œç¢ºä¿å·¥æ¥­å‹•èƒ½ä¸ç†„ç«ã€‚",
              goals: [ { txt: "ç‡ƒç…¤é›»å»  > 5 åº§", check: g => g.counts.coal >= 5 }, { txt: "ç™¼é›»é‡ > 12000MW", check: g => g.calcPower() >= 12000 } ] },
            { title: "éšæ®µäºŒï¼šä»¥æ°£ä»£ç…¤", short: "é‚å…¥ç‡ƒæ°£æ™‚ä»£ï¼Œä¸¦é–‹æ”¾æ°‘ç‡Ÿé›»å» ï¼Œè§£æ±ºé™é›»ã€‚",
              desc: "ğŸ”¥ **ç‡ƒæ°£ä»£ç…¤**ï¼š<br>ç«¹ç§‘å´›èµ·ï¼Œæ™¶åœ“ä»£å·¥éœ€é«˜ç©©å®šé›»åŠ›ã€‚ç‡ƒæ°£ä½ç¢³ä¸”ç’°ä¿ã€‚<br>ç‚ºè§£æ±ºç’°ä¿èˆ‡é™é›»å•é¡Œï¼Œè«‹èˆˆå»ºç‡ƒæ°£ç™¼é›»å» ã€‚<br>ä»»å‹™ï¼šå•Ÿç”¨é¦–åº§æ¥æ”¶ç«™ï¼Œä¸¦è—‰ç”±ç‡ƒæ°£ç™¼é›»æ‹‰é«˜ç¸½ç™¼é›»é‡ã€‚",
              goals: [ { txt: "æ¥æ”¶ç«™ > 1 åº§", check: g => g.counts.terminal >= 1 }, { txt: "ç‡ƒæ°£ç™¼é›» > 15%", check: g => g.getGasPct() >= 15 }, { txt: "ç¸½ç™¼é›» > 30000MW", check: g => g.calcPower() >= 30000 } ] },
            { title: "éšæ®µä¸‰ï¼šèƒ½æºéŸŒæ€§", short: "ç‚ºå…æ–·æ°£å±æ©Ÿï¼Œè«‹å¢å»ºæ¥æ”¶ç«™ä¸¦æ‹‰é«˜å®‰å…¨å­˜é‡ã€‚",
              desc: "ğŸ›¡ï¸ **å¼·åŒ–èƒ½æºéŸŒæ€§**ï¼š<br>é¿å…å–®ä¸€æ¥æ”¶ç«™æ•…éšœå³æ–·é›»ã€‚è«‹å»ºè¨­å¤šåº§æ¥æ”¶ç«™åˆ†æ•£é¢¨éšªã€‚<br>åŒæ™‚å°‡ç…¤æ°£å­˜é‡æ‹‰é«˜è‡³ 7 å¤©ä»¥ä¸Šï¼Œç¢ºä¿åœ‹å®¶èƒ½æºéŸŒæ€§ã€‚<br><span style='color:var(--accent-red)'>(æ³¨æ„ï¼šå¾æœ¬éšæ®µèµ·ï¼Œåº«å­˜ä½æ–¼7å¤©å°‡æ‰£é™¤ç«¶çˆ­åŠ›ï¼)</span>",
              goals: [ { txt: "æ¥æ”¶ç«™ > 2 åº§", check: g => g.counts.terminal >= 2 }, { txt: "å®‰å…¨å­˜é‡ > 7å¤©", check: g => g.getSafetyDays() !== null && g.getSafetyDays() >= 7 } ] },
            { title: "éšæ®µå››ï¼šå†ç”Ÿè½‰å‹", short: "åœ‹éš›æˆ°çˆ­è‡´æˆæœ¬é£†å‡ï¼Œä¸”æœ‰å°é–é¢¨éšªï¼Œåˆ©ç”¨å†ç”Ÿèƒ½æºå¯¦ç¾è‡ªæœ‰èƒ½æºç›®æ¨™ã€‚",
              desc: "ğŸŒ¬ï¸ **è‡ªæœ‰èƒ½æºæˆ°ç•¥**ï¼š<br>å¤©ç„¶æ°£æ˜‚è²´ä¸”æ˜“å—å°é–å½±éŸ¿ã€‚å¹¸é‹çš„æ˜¯å°ç£æµ·å³½æœ‰é ‚ç´šé¢¨å ´ï¼<br>åŸ·è¡Œã€é¢¨æ°£äº’è£œã€ï¼šä»¥ç‡ƒæ°£å¿«é€Ÿå‡é™æ”¯æ´ç¶ èƒ½ã€‚<br>å»ºè¨­å†ç”Ÿèƒ½æºï¼Œç²å–ã€è‡ªæœ‰èƒ½æºã€ä»¥æŠ—è¡¡åœ°ç·£é¢¨éšªã€‚",
              goals: [ { txt: "æ¥æ”¶ç«™ > 3 åº§", check: g => g.counts.terminal >= 3 }, { txt: "å†ç”Ÿèƒ½æº > 15%", check: g => g.getGreenPct() >= 15 }, { txt: "å®‰å…¨å­˜é‡ > 11å¤©", check: g => g.getSafetyDays() !== null && g.getSafetyDays() >= 11 } ] },
            { title: "éšæ®µäº”ï¼šAIæ–°å±€", short: "é¢å°AIçˆ†ç™¼ã€RE100ã€æ°¸çºŒç›®æ¨™åŠåœ°ç·£å°é–é¢¨éšªï¼Œè«‹å¤§å¹…æå‡å†ç”Ÿèƒ½æºèˆ‡ç¸½ç™¼é›»é‡ã€‚",
              desc: "ğŸ¤– **AI èˆ‡æ°¸çºŒç«¶çˆ­**ï¼š<br>AI ç®—åŠ›æ¨å‡ç”¨é›»ï¼ŒRE100 é™åˆ¶å‡ºå£ã€‚<br>ç‚ºä¿ç”¢æ¥­å„ªå‹¢ï¼Œéœ€å¤§å¹…æå‡ç¶ èƒ½ä¾›æ‡‰ã€‚<br>é¢å°åœ°ç·£è»æ¼”ï¼Œæ›´éœ€å°‡å®‰å…¨å­˜é‡æ‹‰è‡³ 14 å¤©ï¼Œç¢ºä¿ä¾›é›»ç„¡è™ã€‚",
              goals: [ { txt: "å†ç”Ÿèƒ½æº > 20%", check: g => g.getGreenPct() >= 20 }, { txt: "å®‰å…¨å­˜é‡ > 14å¤©", check: g => g.getSafetyDays() !== null && g.getSafetyDays() >= 14 }, { txt: "ç¸½ç™¼é›» > 70000MW", check: g => g.calcPower() >= 70000 } ] }
        ];

        const MARKET_SOURCES = {
            coal: [ { id:'au',name:'æ¾³æ´²',flag:'ğŸ‡¦ğŸ‡º',base:100 }, { id:'id',name:'å°å°¼',flag:'ğŸ‡®ğŸ‡©',base:80 }, { id:'ru',name:'ä¿„åœ‹',flag:'ğŸ‡·ğŸ‡º',base:90 }, { id:'za',name:'å—é',flag:'ğŸ‡¿ğŸ‡¦',base:85 }, { id:'ca',name:'åŠ æ‹¿å¤§',flag:'ğŸ‡¨ğŸ‡¦',base:105 } ],
            gas: [ { id:'au',name:'æ¾³æ´²',flag:'ğŸ‡¦ğŸ‡º',base:220 }, { id:'qa',name:'å¡é”',flag:'ğŸ‡¶ğŸ‡¦',base:200 }, { id:'us',name:'ç¾åœ‹',flag:'ğŸ‡ºğŸ‡¸',base:250 }, { id:'my',name:'å¤§é¦¬',flag:'ğŸ‡²ğŸ‡¾',base:210 }, { id:'pg',name:'å·´ç´',flag:'ğŸ‡µğŸ‡¬',base:230 } ]
        };
        const NUKE_RISK_MAP = [0, 1, 2, 5, 8, 11, 15, 20, 25, 30, 40];

        const game = {
            year:1, funds:2000, comp:100, demand:10000, oilOutput:2000,
            fuel:{coal:3000,gas:0}, cap:{coal:3000,gas:0},
            counts:{coal:0,gas:0,terminal:0,green:0,solar:0,nuclear:0},
            stageIdx:0, selected:null, blockade:false, bDays:0,
            marketPrices:{}, purchaseCounts:{coal:{},gas:{}},
            isFreePlay:false, history:[], importStats:{coal:{},gas:{}},
            tutorialStep:0, stageTutorialStep:0, stageTutorialType:null,
            marketTab:'coal', isReplayTutorial:false,
            nukeDisasterCount:0, nukeShutdownTimer:0, isNukePermanentlyBanned:false,
            fuelZeroWarned:{coal:false,gas:false},

            init() {
                this.resetVariables(); this.counts.coal=0; this.cap.coal=3000;
                this.updateMarketPrices(); ui.renderDeck(); ui.renderMarket(); ui.updateAll();
                ui.showModal("âš¡ å³¶å¶¼èƒ½æºç”Ÿå­˜æˆ°",
                    `<div style="text-align:left; padding:0 10px; line-height:1.8; font-size:14px; color:var(--text-main);">
                        è¥¿å…ƒ1973å¹´ï¼Œä¸­æ±æˆ°ç«é»ç‡ƒçŸ³æ²¹å±æ©Ÿï¼Œæ²¹åƒ¹ä¸€å¤•æš´æ¼²ã€‚<br><br>
                        å°ç£â€”â€”ä¸€åº§<span style="color:var(--accent-red)">97%èƒ½æºä»°è³´é€²å£</span>çš„å³¶å¶¼ï¼Œæ­£é¢è‡¨æ–·é›»çš„å­˜äº¡å±æ©Ÿã€‚<br><br>
                        èº«ç‚ºæ–°ä»»<span style="color:var(--accent-gold)">èƒ½æºæ±ºç­–é•·</span>ï¼Œæ‚¨å¿…é ˆåœ¨æ¥ä¸‹ä¾†çš„50å¹´é–“ï¼Œå¸¶é ˜å°ç£ç©¿è¶ŠçŸ³æ²¹å±æ©Ÿã€ç¶“æ¿Ÿå¥‡è¹Ÿã€ç’°ä¿æµªæ½®èˆ‡åœ°ç·£å°é–ï¼Œæ‰“é€ ä¸€å€‹<span style="color:var(--accent-blue)">æ°¸ä¸æ–·é›»</span>çš„å³¶å¶¼ã€‚<br><br>
                        <span style="color:var(--text-muted); font-size:12px;">å»ºè¨­é›»å» ã€æ¡è³¼ç‡ƒæ–™ã€å®Œæˆéšæ®µä»»å‹™å³å¯å‹åˆ©ã€‚</span>
                    </div>`, () => { ui.closeModal(); if(game.year===1) game.startTutorial(); });
            },
            resetVariables() {
                this.year=1; this.funds=2000; this.comp=100; this.demand=10000; this.oilOutput=2000;
                this.fuel={coal:3000,gas:0}; this.cap={coal:3000,gas:0};
                this.counts={coal:0,gas:0,terminal:0,green:0,solar:0,nuclear:0};
                this.stageIdx=0; this.selected=null; this.blockade=false; this.isFreePlay=false;
                this.history=[]; this.importStats={coal:{},gas:{}}; this.purchaseCounts={coal:{},gas:{}};
                this.marketTab='coal'; this.nukeDisasterCount=0; this.nukeShutdownTimer=0;
                this.isNukePermanentlyBanned=false; this.fuelZeroWarned={coal:false,gas:false};
                document.getElementById('buildings-layer').innerHTML='';
                document.body.classList.remove('crisis-mode');
                this.tutorialStep=0; this.stageTutorialStep=0; this.stageTutorialType=null;
            },
            pendingFuelWarning: null,
            checkFuelZeroWarning() {
                const cDays=this.getCoalDays(), gDays=this.getGasDays();
                if(!this.fuelZeroWarned.coal && this.counts.coal>0 && cDays===0){this.fuelZeroWarned.coal=true;this.pendingFuelWarning='coal';return;}
                if(!this.fuelZeroWarned.gas && this.counts.gas>0 && gDays===0){this.fuelZeroWarned.gas=true;this.pendingFuelWarning='gas';return;}
                this.pendingFuelWarning=null;
            },
            showFuelZeroWarning() {
                const type=this.pendingFuelWarning; if(!type) return; this.pendingFuelWarning=null;
                const selector=type==='coal'?'#data-row-coal':'#data-row-gas';
                const name=type==='coal'?'ç‡ƒç…¤':'å¤©ç„¶æ°£';
                const overlay=document.getElementById('map-data-overlay');
                overlay.style.pointerEvents='auto'; overlay.style.zIndex='2500';
                this.stageTutorialType='fuelwarn'; this.stageTutorialStep=1;
                setTimeout(()=>{ui.highlightElement(selector,`ã€âš ï¸ ${name}åº«å­˜è€—ç›¡ã€‘\n${name}å­˜é‡æ­¸é›¶ï¼Œæ‰€æœ‰${name}é›»å» \nå°‡ç„¡æ³•é‹è½‰ï¼Œç™¼é›»é‡é™ç‚º 0ï¼\nè«‹ç›¡é€Ÿè£œå……ç‡ƒæ–™ã€‚`);},200);
            },
            endFuelZeroWarning() {
                this.stageTutorialStep=0; this.stageTutorialType=null; ui.clearHighlight();
                const overlay=document.getElementById('map-data-overlay');
                overlay.style.pointerEvents='none'; overlay.style.zIndex='95';
            },
            handleTutorialClick() { if(this.stageTutorialType==='fuelwarn'){this.endFuelZeroWarning();}else if(this.stageTutorialStep>0){this.nextStageTutorialStep();}else{this.nextTutorialStep();} },
            startTutorial() { this.tutorialStep=1; this.updateTutorial(); },
            replayTutorial() { this.isReplayTutorial=true; this.startTutorial(); },
            nextTutorialStep() {
                if(this.tutorialStep>0 && this.tutorialStep<7){this.tutorialStep++;this.updateTutorial();}
                else if(this.tutorialStep===7){
                    this.tutorialStep=0; ui.clearHighlight(); ui.switchTab('build',true);
                    const s=STAGES[this.stageIdx]; const goals=s.goals.map(g=>'ğŸ”¹ '+g.txt).join('<br>');
                    ui.showModal(s.title,`<div style="text-align:left;padding:0 10px;line-height:1.6;">${s.desc}<br><br><span style="color:var(--accent-blue)">ğŸ† æœ¬éšæ®µç›®æ¨™ï¼š</span><br>${goals}</div>`,()=>ui.closeModal());
                    this.isReplayTutorial=false;
                }
            },
            updateTutorial() {
                ui.clearHighlight();
                if(this.tutorialStep===1) ui.highlightElement('#hud .stat-box:nth-child(1)',"ã€å»ºè¨­è³‡é‡‘ã€‘\nå»ºè¨­é›»å» èˆ‡è³¼è²·ç‡ƒæ–™çš„ç¶“è²»ã€‚\næ¯å¹´æœƒä¾ç™¼é›»é‡ç²å¾—ç¨…æ”¶ã€‚");
                else if(this.tutorialStep===2) ui.highlightElement('#hud .stat-box:nth-child(2)',"ã€åœ‹å®¶ç«¶çˆ­åŠ›ã€‘\nåœ‹å®¶ç™¼å±•çš„é—œéµæŒ‡æ¨™ã€‚\nä¾›é›»ä¸ç©©æˆ–ç‡ƒæ–™çŸ­ç¼ºå°‡å°è‡´æŒ‡æ•¸ä¸‹é™ï¼Œ\nä¸€æ—¦æ­¸é›¶ï¼ŒéŠæˆ²å³åˆ»çµæŸã€‚");
                else if(this.tutorialStep===3) ui.highlightElement('#hud .stat-box:nth-child(3)',"ã€ç‡ƒæ–™å­˜é‡ã€‘\nåœ‹å®¶èƒ½æºå®‰å…¨çš„åº•ç·šï¼\nä»£è¡¨ç›®å‰çš„ç‡ƒæ–™åº«å­˜èƒ½æ”¯æ’å¹¾å¤©ã€‚\nè‹¥æ­¸é›¶å°‡å°è‡´åœ‹å®¶å´©æ½°ã€‚");
                else if(this.tutorialStep===4) ui.highlightElement('#hud .stat-box:nth-child(4)',"ã€éŠæˆ²èªªæ˜ã€‘\néš¨æ™‚é»æ“Šæ­¤è™•å¯å†æ¬¡æŸ¥çœ‹æœ¬æ•™å­¸ã€‚\nè¨˜å¾—é—œæ³¨éšæ®µç›®æ¨™ï¼");
                else if(this.tutorialStep===5){ui.switchTab('build',true);ui.highlightElement('#build-deck',"ã€å»ºè¨­å€ã€‘\né€™è£¡åˆ—å‡ºäº†å„ç¨®ç™¼é›»è¨­æ–½ã€‚\nå¾…æœƒæ‚¨å¯ä»¥é¸æ“‡å¡ç‰‡é€²è¡Œå»ºè¨­ã€‚\n(é»æ“Šç•«é¢ç¹¼çºŒ)");}
                else if(this.tutorialStep===6){ui.switchTab('market',true);ui.highlightElement('#tab-market',"ã€ç‡ƒæ–™å¸‚å ´ã€‘\né»æ“Šåˆ‡æ›åˆ†é ï¼Œ\nå¯æ ¹æ“šåƒ¹æ ¼è³¼è²·ä¸åŒé€²å£åœ‹çš„ç‡ƒæ–™ã€‚");}
                else if(this.tutorialStep===7){ui.switchTab('build',true);ui.highlightElement('#next-btn',"ã€ä¸‹ä¸€å¹´åº¦ã€‘\næº–å‚™å¥½å¾Œï¼Œé»æ“Šæ­¤è™•æ¨é€²æ™‚é–“ä¸¦ç²å¾—ç¨…æ”¶ã€‚");}
                else ui.clearHighlight();
            },
            startStageTutorial(type){this.stageTutorialType=type;this.stageTutorialStep=1;this.updateStageTutorial();},
            nextStageTutorialStep(){if(this.stageTutorialStep>0){this.stageTutorialStep++;this.updateStageTutorial();}},
            updateStageTutorial() {
                ui.clearHighlight();
                if(this.stageTutorialType==='gas'){
                    if(this.stageTutorialStep===1){ui.renderDeck();ui.switchTab('build',true);setTimeout(()=>{const c=document.querySelector('#build-deck .pixel-card:nth-child(2)');if(c)c.id='highlight-gas-card';ui.highlightElement('#highlight-gas-card',"ã€ğŸ”¥ ç‡ƒæ°£ç™¼é›»ã€‘\næ–°è§£é–ï¼ç‡ƒæ°£ç™¼é›»æ•ˆç‡é«˜ä¸”è¼ƒç’°ä¿ã€‚\nä½†éœ€å…ˆå»ºé€ æ¥æ”¶ç«™æ‰èƒ½èˆˆå»ºã€‚");},100);}
                    else if(this.stageTutorialStep===2){ui.switchTab('market',true);ui.setMarketTab('gas');setTimeout(()=>{ui.highlightElement('#mt-gas',"ã€ğŸ”¥ ç‡ƒæ°£å¸‚å ´ã€‘\né»æ“Šæ­¤åˆ†é å¯è³¼è²·å¤©ç„¶æ°£ç‡ƒæ–™ï¼Œ\nä¹Ÿå¯åœ¨æ­¤å»ºé€ æ¥æ”¶ç«™ä¾†å„²å­˜å¤©ç„¶æ°£ã€‚");},100);}
                    else{this.stageTutorialStep=0;this.stageTutorialType=null;ui.clearHighlight();ui.switchTab('build',true);}
                }else if(this.stageTutorialType==='green'){
                    if(this.stageTutorialStep===1){ui.renderDeck();ui.switchTab('build',true);setTimeout(()=>{const cards=document.querySelectorAll('#build-deck .pixel-card');cards.forEach(c=>{const n=c.querySelector('.card-name');if(n&&n.textContent==='é¢¨é›»')c.id='highlight-wind-card';if(n&&n.textContent==='å¤ªé™½èƒ½')c.id='highlight-solar-card';});ui.highlightElement('#highlight-wind-card',"ã€ğŸŒ€ é¢¨åŠ›ç™¼é›»ã€‘\næ–°è§£é–ï¼åˆ©ç”¨å°ç£æµ·å³½çš„é ‚ç´šé¢¨å ´ï¼Œ\nä¸éœ€ç‡ƒæ–™ï¼Œæ˜¯è‡ªæœ‰èƒ½æºçš„é—œéµï¼");},100);}
                    else if(this.stageTutorialStep===2){ui.switchTab('build',true);setTimeout(()=>{ui.highlightElement('#highlight-solar-card',"ã€â˜€ï¸ å¤ªé™½èƒ½ç™¼é›»ã€‘\næ–°è§£é–ï¼æˆæœ¬ä½å»‰çš„å†ç”Ÿèƒ½æºï¼Œ\nä¸éœ€ç‡ƒæ–™ï¼Œå¯å¿«é€Ÿä½ˆå»ºæå‡ç¶ èƒ½å æ¯”ã€‚");},100);}
                    else{this.stageTutorialStep=0;this.stageTutorialType=null;ui.clearHighlight();ui.switchTab('build',true);}
                }else{this.stageTutorialStep=0;this.stageTutorialType=null;ui.clearHighlight();}
            },
            restart(){this.resetVariables();this.counts.coal=0;this.cap.coal=3000;this.updateMarketPrices();ui.renderDeck();ui.renderMarket();ui.updateAll();ui.closeModal();setTimeout(()=>ui.showModal("éŠæˆ²é‡å•Ÿ","ä¸€åˆ‡å›åˆ°åŸé»ï¼Œè«‹é‡æ–°è¦åŠƒèƒ½æºæ”¿ç­–ï¼",()=>{ui.closeModal();game.startTutorial();}),300);},
            selectCard(key){if(this.tutorialStep!==0||this.stageTutorialStep!==0)return;if(this.selected===key){this.selected=null;}else{this.selected=key;this.tryBuild();}ui.renderDeck();},
            tryBuild(){
                if(this.tutorialStep!==0||this.stageTutorialStep!==0)return;
                if(!this.selected)return; const p=PLANTS[this.selected];
                if(this.selected==='nuclear'&&this.isNukePermanentlyBanned){ui.floatText('â›” æ ¸èƒ½å·²æ°¸ä¹…å»¢æ­¢','bad');this.selected=null;return;}
                if(this.funds<p.cost){ui.floatText('ğŸ’¸ è³‡é‡‘ä¸è¶³','bad');this.selected=null;return;}
                if(this.selected==='gas'&&this.counts.terminal===0){ui.floatText('âš ï¸ éœ€å»ºæ¥æ”¶ç«™','bad');this.selected=null;return;}
                this.funds-=p.cost; this.counts[this.selected]++;
                if(this.selected==='coal')this.cap.coal+=1500; if(this.selected==='terminal')this.cap.gas+=1500;
                ui.floatText(`å»ºè¨­${p.name} -$${p.cost}`,'good'); this.placeBuilding(this.selected);
                this.selected=null; ui.renderDeck(); ui.updateAll();
                if(this.tutorialStep===1){this.tutorialStep=2;this.updateTutorial();}
            },
            buildTerminal(){
                if(this.tutorialStep!==0||this.stageTutorialStep!==0)return;
                const p=PLANTS.terminal; if(this.funds<p.cost){ui.floatText('ğŸ’¸ è³‡é‡‘ä¸è¶³','bad');return;}
                this.funds-=p.cost; this.counts.terminal++; this.cap.gas+=1500;
                ui.floatText(`å»ºè¨­æ¥æ”¶ç«™ -$${p.cost}`,'good'); this.placeBuilding('terminal'); ui.updateAll();
            },
            placeBuilding(type){
                const pInfo=PLANTS[type]; const el=document.createElement('div');
                el.innerText=pInfo.emoji; el.style.position='absolute'; el.style.fontSize='18px';
                let x,y;
                switch(pInfo.type){case 'sea':x=10+Math.random()*50;y=100+Math.random()*300;break;case 'coast':x=60+Math.random()*20;y=50+Math.random()*300;break;case 'land':x=100+Math.random()*100;y=50+Math.random()*350;break;}
                el.style.left=x+'px'; el.style.top=y+'px';
            },
            buyFuel(type,countryId){
                if(this.tutorialStep!==0||this.stageTutorialStep!==0)return;
                if(this.blockade){ui.floatText('ğŸš« å°é–ä¸­','bad');return;}
                const basePrice=this.marketPrices[`${type}_${countryId}`]; const surge=this.purchaseCounts[type][countryId]||0; const finalCost=basePrice+surge;
                if(this.funds<finalCost){ui.floatText('ğŸ’¸ è³‡é‡‘ä¸è¶³','bad');return;}
                if(this.fuel[type]+100>this.cap[type]){ui.floatText('ğŸ“¦ å€‰åº«å·²æ»¿','bad');if(type==='gas'&&this.counts.terminal===0)ui.floatText('âš ï¸ éœ€æ¥æ”¶ç«™','bad');return;}
                this.funds-=finalCost; this.fuel[type]+=100;
                if(!this.purchaseCounts[type][countryId])this.purchaseCounts[type][countryId]=0; this.purchaseCounts[type][countryId]++;
                if(!this.importStats[type][countryId])this.importStats[type][countryId]=0; this.importStats[type][countryId]+=100;
                ui.floatText(`${type==='coal'?'ç…¤ç‚­':'å¤©ç„¶æ°£'}åº«å­˜ +100`,'good'); ui.updateAll();
            },
            updateMarketPrices(){
                this.purchaseCounts={coal:{},gas:{}};
                ['coal','gas'].forEach(type=>{MARKET_SOURCES[type].forEach(src=>{let fluc=0.8+Math.random()*0.5;let price=Math.floor(src.base*fluc);if(game.stageIdx===1&&type==='coal')price*=2;this.marketPrices[`${type}_${src.id}`]=price;});});
            },
            calcIncome(){let b=500;if(game.stageIdx===1)b=1000;if(game.stageIdx>=2)b=2000;return b+Math.floor(this.calcPower(true)*0.4);},
            getNukeRisk(){const c=this.counts.nuclear;return c>=NUKE_RISK_MAP.length?50:NUKE_RISK_MAP[c];},
            checkNuclearDisaster(){
                if(this.counts.nuclear>0){const risk=this.getNukeRisk();if(Math.random()*100<risk){
                    this.nukeDisasterCount++;let loss=Math.max(5000,Math.floor(this.funds/2));this.funds-=loss;this.funds-=2000;
                    if(this.funds<0)this.comp-=15;this.counts.nuclear--;this.nukeShutdownTimer=2;this.comp-=30;
                    let msg="â˜¢ï¸ æ ¸ç½çˆ†ç™¼ï¼ç«¶çˆ­åŠ›-30";if(this.funds<0)msg+="ï¼Œåœ‹å®¶ç ´ç”¢ -15";
                    if(this.nukeDisasterCount>=3){this.isNukePermanentlyBanned=true;this.counts.nuclear=0;return "â˜¢ï¸ æ ¸ç½3æ¬¡ï¼šæ ¸èƒ½æ°¸ä¹…å»¢æ­¢ï¼";}else{return msg;}
                    ui.renderDeck();
                }}return null;
            },
            nextTurn(){
                if(this.stageTutorialStep!==0)return;if(this.blockade){this.handleBlockade();return;}
                this.year++;if(this.nukeShutdownTimer>0)this.nukeShutdownTimer--;
                const pOil=this.oilOutput,pCoal=this.calcCoalOutput(),pGas=this.calcGasOutput(),pNuke=this.calcNukeOutput();
                const pGreen=(this.counts.green*PLANTS.green.output)+(this.counts.solar*PLANTS.solar.output);
                this.history.push({year:this.year,oil:pOil,coal:pCoal,gas:pGas,nuclear:pNuke,green:pGreen});
                let turnEvents=[]; const nukeMsg=this.checkNuclearDisaster(); if(nukeMsg)turnEvents.push(nukeMsg);
                const income=this.calcIncome(); this.funds+=income; this.demand+=1200; this.updateMarketPrices(); this.consumeFuel();
                let compChanges=[]; const power=this.calcPower();
                if(power<this.demand){this.comp-=15;compChanges.push("ç¼ºé›» -15");}else{this.comp=Math.min(100,this.comp+5);compChanges.push("ä¾›é›»ç©©å®š +5");}
                const cDays=this.getCoalDays(),gDays=this.getGasDays();
                if(this.counts.coal>0&&cDays===0&&this.counts.gas>0&&gDays===0){this.comp=-100;ui.showGameOver("èƒ½æºæ¯ç«­ï¼šç…¤æ°£å­˜é‡æ­¸é›¶ï¼<br>å…¨åœ‹å¤§åœé›»å°è‡´æ”¿åºœå®å°ã€‚");return;}
                if(this.stageIdx>=2){if(cDays!==null&&cDays<7){this.comp-=10;compChanges.push("ç¼ºç…¤ -10");}if(gDays!==null&&gDays<7){this.comp-=10;compChanges.push("ç¼ºæ°£ -10");}}
                if(this.comp<=0){ui.showGameOver();return;}
                ui.renderMarket(); ui.updateAll();
                if(!this.isFreePlay){const stage=STAGES[this.stageIdx];if(stage&&stage.goals.every(g=>g.check(this))){
                    if(this.stageIdx<STAGES.length-1){const clearedIdx=this.stageIdx;this.stageIdx++;ui.updateAll();const s=STAGES[this.stageIdx];const nsi=this.stageIdx;
                    ui.showStageComplete(clearedIdx,s,()=>{ui.closeModal();if(nsi===1)game.startStageTutorial('gas');else if(nsi===3)game.startStageTutorial('green');});return;}
                    else{ui.showVictory();return;}
                }}
                if(!this.blockade){this.checkFuelZeroWarning();ui.showTurnReport(this.year,income,compChanges,this.funds,this.comp,turnEvents);
                    if(this.pendingFuelWarning){const btn=document.getElementById('modal-btn');btn.onclick=()=>{ui.closeModal();game.showFuelZeroWarning();};}}
                if(this.tutorialStep===3){this.tutorialStep=0;ui.clearHighlight();ui.switchTab('build',true);}this.tutorialStep=0;
            },
            consumeFuel(){const cN=this.counts.coal*PLANTS.coal.fuel,gN=this.counts.gas*PLANTS.gas.fuel;this.fuel.coal=this.fuel.coal>=cN?this.fuel.coal-cN:0;this.fuel.gas=this.fuel.gas>=gN?this.fuel.gas-gN:0;},
            calcNukeOutput(){return this.nukeShutdownTimer>0?0:this.counts.nuclear*PLANTS.nuclear.output;},
            calcCoalOutput(){if(this.counts.coal===0)return 0;return this.fuel.coal<this.counts.coal*PLANTS.coal.fuel?0:this.counts.coal*PLANTS.coal.output;},
            calcGasOutput(){if(this.counts.gas===0)return 0;return this.fuel.gas<this.counts.gas*PLANTS.gas.fuel?0:this.counts.gas*PLANTS.gas.output;},
            calcPower(ignoreShutdown=false){let n=this.calcNukeOutput();if(ignoreShutdown)n=this.counts.nuclear*PLANTS.nuclear.output;return this.oilOutput+this.calcCoalOutput()+this.calcGasOutput()+(this.counts.green*PLANTS.green.output)+(this.counts.solar*PLANTS.solar.output)+n;},
            getGreenPct(){const t=this.calcPower();return t===0?0:Math.floor(((this.counts.green*PLANTS.green.output)+(this.counts.solar*PLANTS.solar.output))/t*100);},
            getGasPct(){const t=this.calcPower();return t===0?0:Math.floor(this.calcGasOutput()/t*100);},
            getSafetyDays(){const c=this.getCoalDays(),g=this.getGasDays();if(c===null&&g===null)return null;return Math.min(c===null?9999:c,g===null?9999:g);},
            getCoalDays(){if(this.counts.coal===0)return null;return Math.floor(this.fuel.coal/(this.counts.coal*PLANTS.coal.fuel));},
            getGasDays(){if(this.counts.gas===0)return null;return Math.floor(this.fuel.gas/(this.counts.gas*PLANTS.gas.fuel));},
            startBlockade(){this.blockade=true;this.bDays=11;document.body.classList.add('crisis-mode');ui.showModal("âš ï¸ ç´…è‰²è­¦å ±","æµ·å³½å°é–é–‹å§‹ï¼é€²å£ä¸­æ–·ï¼Œè«‹æ’é 11 å¤©ã€‚",()=>ui.closeModal());},
            handleBlockade(){this.bDays--;this.consumeFuel();ui.floatText(`å‰© ${this.bDays} å¤©`,'bad');if(this.bDays<=0){this.blockade=false;document.body.classList.remove('crisis-mode');ui.showModal("ğŸ³ï¸ å±æ©Ÿè§£é™¤","å°é–çµæŸï¼Œå°ç£å­˜æ´»ï¼",()=>ui.closeModal());}ui.updateAll();},
            captureScreenshot(){const el=document.querySelector('.retro-dialog');if(!el)return;const t=new Date();const fn=`${t.getFullYear()}${String(t.getMonth()+1).padStart(2,'0')}${String(t.getDate()).padStart(2,'0')}èƒ½æºç™¼å±•åœ–.png`;html2canvas(el,{backgroundColor:null,scale:2}).then(c=>{const a=document.createElement('a');a.download=fn;a.href=c.toDataURL("image/png");a.click();});}
        };

        const ui = {
            switchTab(tab,isSystem=false){
                if(game.tutorialStep!==0&&!isSystem&&game.year===1&&game.tutorialStep!==3)return;
                document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
                document.querySelectorAll('.pixel-btn').forEach(el=>el.classList.remove('active'));
                document.getElementById(`tab-${tab}`).classList.add('active');
                document.getElementById(tab==='build'?'tab-btn-build':'tab-btn-market').classList.add('active');
            },
            highlightElement(selector,text){
                document.getElementById('tutorial-overlay').style.display='block';
                const el=document.querySelector(selector);
                if(el){el.classList.add('highlight-target');
                    const bp=el.closest('#bottom-panel');if(bp)bp.style.zIndex='2001';
                    const hud=el.closest('#hud');if(hud)hud.style.zIndex='2001';
                    document.getElementById('tut-text').innerHTML=`<div class='tut-title'>éŠæˆ²èªªæ˜</div>${text.replace(/\n/g,'<br>')}`;
                    document.getElementById('tutorial-tooltip').style.display='block';
                }
            },
            clearHighlight(){
                document.getElementById('tutorial-overlay').style.display='none';
                document.getElementById('tutorial-tooltip').style.display='none';
                document.querySelectorAll('.highlight-target').forEach(el=>el.classList.remove('highlight-target'));
                const bp=document.getElementById('bottom-panel');if(bp)bp.style.zIndex='';
                const hud=document.getElementById('hud');if(hud)hud.style.zIndex='100';
            },
            setMarketTab(tab){if(tab==='gas'&&game.stageIdx<1)return;game.marketTab=tab;document.querySelectorAll('.market-sub-tab').forEach(el=>el.classList.remove('active'));document.getElementById('mt-'+tab).classList.add('active');ui.renderMarket();},
            renderDeck(){
                const sf={coal:0,nuclear:0,gas:1,green:3,solar:3};
                const buildable=Object.entries(PLANTS).filter(([k])=>k!=='terminal').filter(([k])=>game.stageIdx>=(sf[k]||0));
                document.getElementById('build-deck').innerHTML=buildable.map(([k,v])=>{
                    let locked=false,lockReason='',riskHtml='';
                    if(k==='nuclear'){if(game.isNukePermanentlyBanned){locked=true;lockReason='â›” æ°¸ä¹…å»¢æ­¢';}else{riskHtml=`<div class="nuke-risk">â˜¢ï¸ æ ¸ç½ +${game.getNukeRisk()}%</div>`;}}
                    return `<div class="pixel-card ${game.selected===k?'selected':''} ${locked?'disabled':''}" onclick="game.selectCard('${k}')">
                        <div class="card-badge">${game.counts[k]}</div>${locked?`<div class="lock-overlay">${lockReason}</div>`:''}
                        <div class="card-emoji">${v.emoji}</div><div class="card-name">${v.name}</div><div class="card-divider"></div>
                        <div class="card-label">ç™¼é›»é‡</div><div class="card-val">+${v.output.toLocaleString()}MW</div>
                        <div class="card-bottom"><div class="card-cost">$${v.cost.toLocaleString()}</div>${riskHtml}</div></div>`;
                }).join('');
            },
            renderMarket(){
                const tab=game.marketTab,sources=MARKET_SOURCES[tab]; if(game.stageIdx>=1)document.getElementById('mt-gas').style.display='block';
                let content='';
                if(tab==='gas'){const t=PLANTS.terminal;content+=`<div class="pixel-card market-card" onclick="game.buildTerminal()"><div class="card-badge" style="background:var(--accent-blue);color:#fff">${game.counts.terminal}</div><div class="card-emoji">${t.emoji}</div><div class="card-name">${t.name}</div><div class="card-divider"></div><div class="card-label">å„²æ°£å®¹é‡</div><div class="card-val">+1,500</div><div class="card-bottom"><div class="card-cost">$${t.cost.toLocaleString()}</div></div></div>`;}
                content+=sources.map(src=>{const base=game.marketPrices[tab+'_'+src.id]||src.base;const price=base+(game.purchaseCounts[tab][src.id]||0);
                    return `<div class="pixel-card market-card" onclick="game.buyFuel('${tab}','${src.id}')"><div class="card-emoji">${src.flag}</div><div class="card-name">${src.name}</div><div class="card-divider"></div><div class="card-label">${tab==='coal'?'ç‡ƒç…¤':'å¤©ç„¶æ°£'}</div><div class="card-val">+100</div><div class="card-bottom"><div class="card-cost">$${price}</div></div></div>`;
                }).join('');
                document.getElementById('market-deck').innerHTML=content;
            },
            updatePieChart(){
                const pOil=game.oilOutput,pCoal=game.calcCoalOutput(),pGas=game.calcGasOutput(),pGreen=(game.counts.green*PLANTS.green.output)+(game.counts.solar*PLANTS.solar.output),pNuke=game.calcNukeOutput();
                const total=pOil+pCoal+pGas+pGreen+pNuke;
                const chart=document.getElementById('taiwan-chart-div'), labels=document.getElementById('map-labels-layer');
                labels.innerHTML='';
                if(total===0){chart.style.background='#889878';return;}
                const dO=(pOil/total)*360,dC=(pCoal/total)*360,dG=(pGas/total)*360,dGr=(pGreen/total)*360,dN=(pNuke/total)*360;
                chart.style.background=`conic-gradient(from 0deg at 50% 50%,var(--color-oil) 0deg ${dO}deg,var(--color-coal) ${dO}deg ${dO+dC}deg,var(--color-gas) ${dO+dC}deg ${dO+dC+dG}deg,var(--color-nuclear) ${dO+dC+dG}deg ${dO+dC+dG+dN}deg,var(--color-green) ${dO+dC+dG+dN}deg 360deg)`;
                const cx=160,cy=240,r=65;
                [{name:'ç‡ƒæ²¹',val:pOil,deg:dO},{name:'ç‡ƒç…¤',val:pCoal,deg:dC},{name:'ç‡ƒæ°£',val:pGas,deg:dG},{name:'æ ¸èƒ½',val:pNuke,deg:dN},{name:'å†ç”Ÿ',val:pGreen,deg:dGr}].reduce((ang,item)=>{
                    const pct=item.val/total*100;
                    if(pct>3){const mid=ang+item.deg/2,rad=(mid-90)*Math.PI/180;const x=cx+r*Math.cos(rad),y=cy+r*Math.sin(rad);
                        const lbl=document.createElement('div');lbl.className='map-label';lbl.style.left=(x/320*100)+'%';lbl.style.top=(y/480*100)+'%';
                        lbl.innerHTML=`<div class="map-label-name">${item.name}</div><div class="map-label-val">${pct.toFixed(1)}%</div>`;labels.appendChild(lbl);}
                    return ang+item.deg;
                },0);
            },
            updateAll(){
                document.getElementById('map-year-display').innerText="ç¬¬ "+game.year+" å¹´";
                document.getElementById('hud-funds').innerText=game.funds.toLocaleString();
                document.getElementById('hud-comp').innerText=game.comp+'%';
                const days=game.getSafetyDays();
                if(days===null||days>999){document.getElementById('hud-days').innerText="--";document.getElementById('hud-days').className='stat-val';}
                else{document.getElementById('hud-days').innerText=(days>99?'å……è¶³':days+'å¤©');document.getElementById('hud-days').className=`stat-val ${days<14?'red':''}`;}
                document.getElementById('stat-supply').innerText=game.calcPower().toLocaleString()+" MW";
                document.getElementById('stat-demand').innerText=game.demand.toLocaleString()+" MW";
                const cD=game.getCoalDays();document.getElementById('stat-coal-days').innerText=(cD===null?'--':(cD>99?'âˆ':cD+'å¤©'));
                const gD=game.getGasDays();document.getElementById('stat-gas-days').innerText=(gD===null?'--':(gD>99?'âˆ':gD+'å¤©'));
                if(!game.isFreePlay){const s=STAGES[game.stageIdx];document.getElementById('story-text').innerText=s.short;
                    document.getElementById('goal-list').innerHTML=s.goals.map(g=>`<div class="bar-goal-item"><span class="goal-check ${g.check(game)?'done':''}">${g.check(game)?'âœ…':'â¬œ'}</span> <span>${g.txt}</span></div>`).join('');}
                else{document.getElementById('story-text').innerText="è‡ªç”±åŸ·æ”¿æ¨¡å¼";document.getElementById('goal-list').innerHTML="<div class='bar-goal-item'>ç¶­æŒç«¶çˆ­åŠ› > 0%</div>";}
                if(game.blockade){document.getElementById('next-btn').innerHTML=`æ’ä½<br>${game.bDays}å¤©`;document.getElementById('next-btn').style.background='#555';}
                else{document.getElementById('next-btn').innerHTML=`ä¸‹ä¸€<br>å¹´åº¦`;document.getElementById('next-btn').style.background='var(--accent-red)';}
                this.updatePieChart(); this.renderMarket(); this.renderDeck();
            },
            floatText(txt,type){const c=document.getElementById('toast-container');const el=document.createElement('div');el.className=`toast-msg ${type||''}`;
                if(type==='good')el.innerHTML=`<span>${txt}</span> <span>ğŸ’°</span>`;else if(type==='bad')el.innerHTML=`<span>${txt}</span> <span>âš ï¸</span>`;else el.innerText=txt;
                c.prepend(el);if(c.children.length>6){const o=c.lastElementChild;if(o)o.remove();}
                setTimeout(()=>{el.classList.add('hiding');el.addEventListener('transitionend',()=>el.remove());},1200);
            },
            showTurnReport(year,income,compDetails,totalFunds,totalComp,events){
                document.getElementById('modal-title').innerText=`ğŸ“… å¹´åº¦å ±å‘Š (${year})`;
                let compHtml=compDetails.map(d=>{const neg=d.includes('-');return `<div class="comp-row" style="color:${neg?'var(--accent-red)':'var(--accent-green)'}"><span>${d.split(' ')[0]}</span><span>${d.split(' ')[1]}</span></div>`;}).join('');
                let eventHtml='';if(events&&events.length>0)eventHtml=`<div class="report-card" style="border-color:var(--accent-red);background:rgba(194,98,90,0.08);"><div class="report-header" style="color:var(--accent-red)">âš ï¸ é‡å¤§çªç™¼äº‹ä»¶</div>${events.map(e=>`<div style="color:var(--text-main);font-size:13px;font-weight:bold;">${e}</div>`).join('')}</div>`;
                document.getElementById('modal-content-area').innerHTML=`<div class="report-grid">${eventHtml}<div class="report-card"><div class="report-header">ğŸ’° è²¡æ”¿æ”¶æ”¯çµç®—</div><div class="report-flex"><span class="report-label">æœ¬æœŸå·¥æ¥­ç¨…æ”¶</span><span class="report-big" style="color:var(--accent-gold)">+$${income.toLocaleString()}</span></div></div><div class="report-card"><div class="report-header">ğŸ“Š åœ‹å®¶ç«¶çˆ­åŠ›è©•ä¼°</div><div class="comp-list"><div class="report-label" style="margin-bottom:4px;">æœ¬å¹´åº¦è®Šå‹•åˆ†æ</div>${compHtml||'<div class="comp-row" style="color:var(--text-muted)"><span>å¹³ç©©é‹è¡Œ</span><span>-</span></div>'}</div><div class="report-flex"><span class="report-label">æœ€æ–°ç«¶çˆ­åŠ›æŒ‡æ•¸</span><span class="report-big" style="color:var(--accent-blue)">${totalComp}%</span></div></div></div>`;
                const btn=document.getElementById('modal-btn');btn.innerText="ç¢º å®š";btn.onclick=ui.closeModal;btn.className='retro-btn';document.getElementById('modal-overlay').style.display='flex';
            },
            showModal(title,desc,callback){document.getElementById('modal-title').innerText=title;document.getElementById('modal-content-area').innerHTML=`<p id="modal-desc" style="font-size:14px;line-height:1.6;color:var(--text-main);margin:15px 0;">${desc}</p>`;const btn=document.getElementById('modal-btn');btn.innerText="ç¢º å®š";btn.onclick=callback||ui.closeModal;btn.className='retro-btn';document.getElementById('modal-overlay').style.display='flex';},
            showCompHelp(){let sr='';if(game.stageIdx>=2)sr=`<div class="rule-item"><span>ğŸ“‰ ä½åº«å­˜(&lt;7å¤©)</span><span style="color:var(--accent-red)">æ¯é …-10%</span></div>`;ui.showModal("ç«¶çˆ­åŠ›èªªæ˜",`<div class="rule-list"><div class="rule-title">è©•åˆ†è¦å‰‡</div><div class="rule-item"><span>âš¡ ä¾›é›»å……è¶³</span><span style="color:var(--accent-green)">+5%</span></div><div class="rule-item"><span>âš¡ ä¾›é›»ä¸è¶³</span><span style="color:var(--accent-red)">-15%</span></div>${sr}<div class="rule-item"><span>â˜ ï¸ åº«å­˜è€—ç›¡(0å¤©)</span><span style="color:var(--accent-red)">ç›´æ¥å¤±æ•—</span></div></div>`);},
            showFundsHelp(){ui.showModal("å·¥æ¥­ç¨…æ”¶èªªæ˜",`<div class="rule-list"><div class="rule-title">è¨ˆç®—å…¬å¼</div><div class="rule-item"><span>ğŸ’° åŸºç¤ç¨…æ”¶</span><span>$${game.stageIdx===0?500:(game.stageIdx===1?1000:2000)}</span></div><div class="rule-item"><span>âš¡ å·¥æ¥­ç¨…æ”¶</span><span>+$${Math.floor(game.calcPower(true)*0.4).toLocaleString()}</span></div><div class="rule-item" style="border-top:1px solid var(--ui-border);margin-top:5px;padding-top:5px;"><span>é è¨ˆä¸‹å¹´æ”¶å…¥</span><span style="color:var(--accent-gold)">$${game.calcIncome().toLocaleString()}</span></div><div style="font-size:10px;color:var(--text-muted);margin-top:5px;">(å…¬å¼ï¼šç™¼é›»é‡ x 0.4 + åŸºç¤ç¨…)</div></div>`);},
            showStockHelp(){const cD=game.getCoalDays(),gD=game.getGasDays();ui.showModal("å­˜é‡èªªæ˜",`<div class="rule-list"><div class="rule-title">ç›®å‰å¯æ”¯æ’å¤©æ•¸</div><div class="rule-item"><span>ğŸª¨ ç…¤ç‚­</span><span>${cD===null?'--':(cD>99?'âˆ':cD+' å¤©')}</span></div><div class="rule-item"><span>ğŸ”¥ å¤©ç„¶æ°£</span><span>${gD===null?'--':(gD>99?'âˆ':gD+' å¤©')}</span></div><div style="margin-top:10px;font-size:11px;color:var(--text-muted);line-height:1.4;">æ¶ˆè€—å…¬å¼ï¼š<br>ç‡ƒç…¤æ¶ˆè€— = é›»å» æ•¸ x ${PLANTS.coal.fuel}<br>ç‡ƒæ°£æ¶ˆè€— = é›»å» æ•¸ x ${PLANTS.gas.fuel}<br>å¤©æ•¸ = åº«å­˜ / å¹´æ¶ˆè€—</div></div>`);},
            showGameOver(reason){document.getElementById('modal-title').innerText="åœ‹å®¶ç ´ç”¢";document.getElementById('modal-content-area').innerHTML=`<p style="color:var(--accent-red)">${reason||'é›»åŠ›ä¸ç©©å°è‡´ç”¢æ¥­å¤–ç§»ï¼Œç«¶çˆ­åŠ›æ­¸é›¶ã€‚'}</p>`;const btn=document.getElementById('modal-btn');btn.innerText="ğŸ”„ é‡æ–°é–‹å§‹";btn.classList.add('restart');btn.onclick=()=>game.restart();document.getElementById('modal-overlay').style.display='flex';},
            showVictory(){
                document.getElementById('modal-title').innerText="ğŸ† èƒ½æºè½‰å‹æˆåŠŸï¼";
                let maxP=0;game.history.forEach(h=>{const t=(h.oil||0)+h.coal+h.gas+h.nuclear+h.green;if(t>maxP)maxP=t;});
                const sY=game.history[0].year,dur=game.history.length-1;let paths={oil:"M0,200 ",coal:"M0,200 ",gas:"M0,200 ",nuke:"M0,200 ",green:"M0,200 "};
                const lH=game.history[game.history.length-1],lT=(lH.oil||0)+lH.coal+lH.gas+lH.nuclear+lH.green;
                const pcts={oil:Math.round((lH.oil||0)/lT*100),coal:Math.round(lH.coal/lT*100),gas:Math.round(lH.gas/lT*100),nuke:Math.round(lH.nuclear/lT*100),green:Math.round(lH.green/lT*100)};
                game.history.forEach((h,i)=>{const x=(i/dur)*400;const hO=(h.oil||0)/maxP*180,hC=((h.oil||0)+h.coal)/maxP*180,hG=((h.oil||0)+h.coal+h.gas)/maxP*180,hN=((h.oil||0)+h.coal+h.gas+h.nuclear)/maxP*180,hGr=((h.oil||0)+h.coal+h.gas+h.nuclear+h.green)/maxP*180;
                    paths.oil+=`L${x},${200-hO} `;paths.coal+=`L${x},${200-hC} `;paths.gas+=`L${x},${200-hG} `;paths.nuke+=`L${x},${200-hN} `;paths.green+=`L${x},${200-hGr} `;});
                const cp=`L400,200 L0,200 Z`;let xLabels="";
                for(let i=0;i<=dur;i++){const cy=sY+i;if(cy%5===0||i===0||i===dur){const x=(i/dur)*400;let ta="middle";if(i===0)ta="start";if(i===dur)ta="end";xLabels+=`<text x="${x}" y="215" fill="var(--text-muted)" font-size="12" text-anchor="${ta}">${cy}</text>`;}}
                const getRank=(obj,type)=>{const sorted=Object.entries(obj).sort((a,b)=>b[1]-a[1]);return sorted.map(([id,val])=>{const src=MARKET_SOURCES[type].find(s=>s.id===id);return `<div class="rank-row"><span>${src?src.flag+' '+src.name:id}</span><span class="rank-val">${val.toLocaleString()}00</span></div>`;}).join('')||'<div class="rank-row" style="color:var(--text-muted)">ç„¡é€²å£ç´€éŒ„</div>';};
                document.getElementById('modal-content-area').innerHTML=`<p style="color:var(--accent-green);margin-bottom:10px;font-weight:bold;">æ‚¨å»ºç«‹äº†é«˜éŸŒæ€§çš„é›»åŠ›ç³»çµ±ï¼</p>
                    <div class="chart-container"><div class="chart-title">ğŸ“ˆ ç™¼é›»çµæ§‹å †ç–Šåœ– (ç¸½: ${game.calcPower().toLocaleString()} MW)</div>
                    <svg viewBox="0 0 400 220" style="background:rgba(62,52,40,0.06);width:100%;height:auto;border-radius:4px;"><path d="${paths.green+cp}" fill="var(--color-green)"/><path d="${paths.nuke+cp}" fill="var(--color-nuclear)"/><path d="${paths.gas+cp}" fill="var(--color-gas)"/><path d="${paths.coal+cp}" fill="var(--color-coal)"/><path d="${paths.oil+cp}" fill="var(--color-oil)"/>${xLabels}</svg>
                    <div class="chart-legend"><div class="legend-item"><span class="color-box" style="background:var(--color-oil)"></span>æ²¹ ${pcts.oil}%</div><div class="legend-item"><span class="color-box" style="background:var(--color-coal)"></span>ç…¤ ${pcts.coal}%</div><div class="legend-item"><span class="color-box" style="background:var(--color-gas)"></span>æ°£ ${pcts.gas}%</div><div class="legend-item"><span class="color-box" style="background:var(--color-nuclear)"></span>æ ¸ ${pcts.nuke}%</div><div class="legend-item"><span class="color-box" style="background:var(--color-green)"></span>ç¶  ${pcts.green}%</div></div></div>
                    <div class="rank-section"><div class="rank-col"><div class="rank-header">ğŸª¨ ç‡ƒç…¤é€²å£ç¸½é‡</div>${getRank(game.importStats.coal,'coal')}</div><div class="rank-col"><div class="rank-header">ğŸ”¥ ç‡ƒæ°£é€²å£ç¸½é‡</div>${getRank(game.importStats.gas,'gas')}</div></div>
                    <div class="btn-group-vertical"><button class="retro-btn screenshot" onclick="game.captureScreenshot()">ğŸ“· æˆªå–åœ–ç‰‡</button><button class="retro-btn restart-end" onclick="game.restart()">ğŸ”„ é‡æ–°éŠæˆ²</button></div>`;
                document.getElementById('modal-btn').style.display='none';document.getElementById('modal-overlay').style.display='flex';
            },
            showStageComplete(clearedStageIdx,nextStage,callback){
                const cs=STAGES[clearedStageIdx],sn=clearedStageIdx+1;
                const goalsHtml=cs.goals.map(g=>`<div class="stage-clear-goal-item">âœ… ${g.txt}</div>`).join('');
                const nextGoalsHtml=nextStage.goals.map(g=>'ğŸ”¹ '+g.txt).join('<br>');
                document.getElementById('modal-title').innerText='';
                document.getElementById('modal-content-area').innerHTML=`<div class="stage-clear-banner">ğŸ‰ éšæ®µ ${sn} é€šé—œï¼</div><div class="stage-clear-sub">${cs.title} â€” ä»»å‹™å®Œæˆ</div><div class="stage-clear-goals">${goalsHtml}</div><hr class="stage-clear-divider"><div style="text-align:left;padding:0 5px;line-height:1.6;"><div style="font-size:15px;font-weight:900;color:var(--accent-gold);margin-bottom:6px;font-family:'Noto Serif TC',serif;">â–¶ ä¸‹ä¸€éšæ®µï¼š${nextStage.title}</div>${nextStage.desc}<br><br><span style="color:var(--accent-blue)">ğŸ† æœ¬éšæ®µç›®æ¨™ï¼š</span><br>${nextGoalsHtml}</div>`;
                document.querySelector('.retro-dialog').classList.add('stage-clear-dialog');
                const btn=document.getElementById('modal-btn');btn.style.display='block';btn.innerText="ğŸš€ é–‹å§‹æŒ‘æˆ°";btn.className='retro-btn stage-clear';btn.onclick=callback||ui.closeModal;document.getElementById('modal-overlay').style.display='flex';
            },
            closeModal(){document.getElementById('modal-overlay').style.display='none';document.getElementById('modal-content-area').innerHTML='<p id="modal-desc" style="font-size:14px;line-height:1.6;color:var(--text-main);margin:15px 0;">CONTENT</p>';document.querySelector('.retro-dialog').classList.remove('stage-clear-dialog');const btn=document.getElementById('modal-btn');btn.style.display='block';btn.className='retro-btn';const rb=document.querySelector('.retro-btn.restart');if(rb)rb.remove();}
        };
        game.init();
    </script>
</body>
</html>
