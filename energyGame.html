<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>âš¡ åƒç´ èƒ½æºï¼šæ±ºæˆ°å°ç£ v63</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Noto+Sans+TC:wght@500;900&display=swap');

        :root {
            --bg-ocean: #2c3e50;
            --land-green: #27ae60;
            --land-border: #145a32;
            --ui-bg: #212529;
            --ui-border: #95a5a6;
            --accent-blue: #3498db;
            --accent-gold: #f1c40f;
            --accent-red: #e74c3c;
            --text-white: #ecf0f1;
            
            --color-coal: #7f8c8d;
            --color-gas: #d35400;
            --color-green: #2ecc71;
            --color-solar: #f39c12;
            --color-nuclear: #8e44ad;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; user-select: none; }
        
        body {
            font-family: 'Noto Sans TC', monospace;
            background-color: var(--bg-ocean);
            background-image: 
                linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            
            width: 100vw;
            height: 100dvh;
            overflow: hidden;
            color: var(--text-white);
            display: flex;
            flex-direction: column;
            image-rendering: pixelated;
        }

        /* === HUD === */
        #hud {
            flex: 0 0 auto;
            background: var(--ui-bg);
            border-bottom: 4px solid var(--ui-border);
            padding: 8px 4px;
            padding-top: max(8px, env(safe-area-inset-top)); 
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            z-index: 100;
            position: relative; /* For z-index to work */
        }
        .stat-box { position: relative; text-align: center; border: 2px solid #555; background: #000; padding: 4px 2px; cursor: pointer; }
        .stat-label { font-size: 11px; color: #aaa; display: block; margin-bottom: 2px; }
        .stat-val { font-family: 'VT323', monospace; font-size: 22px; color: #fff; font-weight: bold; line-height: 1; }
        .stat-val.gold { color: var(--accent-gold); }
        .stat-val.blue { color: var(--accent-blue); }
        .stat-val.red { color: var(--accent-red); animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        .help-btn {
            position: absolute; top: 0; right: 0;
            color: #000; background: var(--accent-gold); 
            font-size: 12px; font-weight: bold; cursor: pointer;
            width: 14px; height: 14px; line-height: 14px;
            text-align: center; border-bottom-left-radius: 4px;
        }
        
        /* New HUD Help Button Style */
        .hud-help-icon {
            font-size: 24px; color: #fff; line-height: 32px;
        }

        /* === Info Panels === */
        .info-panel {
            position: absolute; top: 80px; width: 140px;
            background: rgba(33, 37, 41, 0.95); padding: 8px; z-index: 90;
            box-shadow: 4px 4px 0px #000; pointer-events: none; border-radius: 2px;
        }
        #story-panel { left: 10px; border: 3px solid var(--ui-border); }
        #goal-panel { right: 10px; border: 3px solid var(--accent-blue); }
        
        .pixel-title { 
            font-size: 13px; color: var(--accent-gold); border-bottom: 2px dashed #555;
            padding-bottom: 4px; margin-bottom: 4px; font-weight: 900;
        }
        .pixel-text { font-size: 12px; line-height: 1.4; color: #ddd; }
        .goal-item { font-size: 11px; margin-bottom: 4px; border-bottom: 1px solid #444; padding-bottom: 2px; }
        .goal-check.done { color: var(--land-green); font-weight:bold; }

        /* === Map Stage === */
        #game-stage {
            flex: 1; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; width: 100%;
        }
        #map-container { position: relative; width: 100%; height: 100%; }

        /* Year Display on Map */
        #map-year-display {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            /* background removed */
            /* border removed */
            padding: 4px 15px;
            color: #fff; /* White color */
            font-family: 'VT323', monospace;
            font-size: 24px; /* Smaller font */
            font-weight: bold;
            z-index: 92;
            text-shadow: 2px 2px 0 #000; /* Shadow for readability */
        }

        #taiwan-svg {
            width: 100%; height: 100%;
            filter: drop-shadow(6px 6px 0px rgba(0,0,0,0.5));
            overflow: visible;
        }
        .map-path { fill: var(--land-green); stroke: var(--land-border); stroke-width: 3px; }

        /* Revised Pie Chart Style - Centered & Larger */
        #power-pie-chart {
            position: absolute;
            top: 45%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            width: 150px; height: 150px; /* Bigger chart */
            border-radius: 50%;
            background: #444;
            border: 4px solid #fff;
            box-shadow: 6px 6px 0px rgba(0,0,0,0.5);
            z-index: 50; pointer-events: none;
            transition: background 0.5s ease;
        }
        /* Center hole for Donut effect (optional, keeping it for style) */
        #pie-center-hole {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 50px; height: 50px; background: rgba(0,0,0,0.6); border-radius: 50%;
            border: 2px solid #fff;
            display: flex; align-items: center; justify-content: center;
        }
        #pie-center-text {
            font-size: 11px; color: #fff; font-weight: bold;
        }

        /* On-Chart Labels */
        .chart-label {
            position: absolute;
            transform: translate(-50%, -50%);
            color: #fff;
            font-family: 'VT323', monospace;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            text-shadow: 
                -1px -1px 0 #000,  
                 1px -1px 0 #000,
                -1px  1px 0 #000,
                 1px  1px 0 #000,
                 2px 2px 0px rgba(0,0,0,0.5);
            pointer-events: none;
            white-space: nowrap;
            line-height: 0.9;
        }
        .chart-label span {
            display: block;
            font-size: 12px; /* Smaller font for category name */
            font-family: 'Noto Sans TC', sans-serif;
            margin-bottom: 2px;
        }

        #map-data-overlay {
            position: absolute;
            bottom: 10px; left: 10px;   
            background: rgba(10, 10, 10, 0.95);
            border: 2px solid #fff;
            padding: 8px;
            width: 140px;
            z-index: 95;
            pointer-events: none;
            box-shadow: 4px 4px 0px #000;
        }
        .data-row { font-size: 12px; color: #ccc; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center;}
        .data-val { color: #fff; font-weight: bold; font-family: 'VT323', monospace; font-size: 16px; }
        .data-sep { border-top: 1px dashed #555; margin: 5px 0; }

        /* === Bottom Panel === */
        #bottom-panel {
            flex: 0 0 auto; 
            background: var(--ui-bg); 
            border-top: 4px solid var(--ui-border);
            height: 260px; 
            padding: 10px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            display: flex; flex-direction: column; z-index: 100;
            position: relative;
        }
        .arcade-tabs { display: flex; gap: 8px; margin-bottom: 0px; flex-shrink: 0; align-items: flex-end; }
        
        /* Revised Tab Styles */
        .pixel-btn {
            flex: 1; 
            background: #1a1a1a; 
            border: 2px solid #444; border-bottom: none;
            color: #777;
            padding: 8px; 
            font-weight: bold; font-size: 15px;
            cursor: pointer; text-align: center;
            
            /* Inactive State: "Lower/Behind" - Reduced to 2px */
            transform: translateY(2px); 
            box-shadow: none;
            transition: all 0.2s;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            z-index: 1;
        }
        .pixel-btn.active { 
            background: var(--accent-blue); 
            border: 2px solid #fff; border-bottom: none;
            color: #fff;
            
            /* Active State: "Higher/Front" */
            transform: translateY(0); 
            box-shadow: 0px -2px 0px rgba(0,0,0,0.5); 
            z-index: 10;
            padding-bottom: 12px; 
        }
        
        .tab-content { 
            display: none; flex: 1; 
            /* Changed overflow to visible to show box-shadow */
            overflow: visible; 
            flex-direction: column; 
            border-top: 2px solid #fff; 
            margin-top: -2px; 
            z-index: 5;
            background: var(--ui-bg); 
            position: relative;
        }
        .tab-content.active { display: flex; }

        /* Build Deck */
        #build-deck { display: flex; gap: 4px; flex: 1; width: 100%; padding-top: 8px; }
        .pixel-card {
            flex: 1; position: relative;
            background: #333; border: 2px solid #888;
            box-shadow: 2px 2px 0px #000; padding: 2px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: space-around;
            min-width: 0;
        }
        .pixel-card.selected { background: #555; border-color: var(--accent-gold); transform: translateY(-3px); }
        .pixel-card.disabled { opacity: 0.5; filter: grayscale(1); background: #222; }
        
        .card-emoji { font-size: 26px; }
        .card-name { font-size: 12px; text-align: center; white-space: nowrap; color: #fff; font-weight: bold; }
        .card-power { font-family:'VT323'; color:var(--accent-blue); font-size:15px; font-weight: bold; }
        .card-cost { font-family:'VT323'; color:var(--accent-gold); font-size:20px; font-weight: bold; }
        
        .card-badge {
            position: absolute; top: -4px; right: -4px;
            background: var(--accent-gold); color: #000;
            border: 2px solid #fff; border-radius: 4px;
            font-family: 'VT323', monospace; font-size: 16px; font-weight: bold;
            padding: 0 5px; box-shadow: 2px 2px 0px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .nuke-risk {
            position: absolute; bottom: 2px; width: 100%; text-align: center;
            font-size: 10px; color: var(--accent-red); font-weight: bold; background: rgba(0,0,0,0.6);
        }

        .lock-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.7);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #fff; font-size: 12px; font-weight: bold; z-index: 5; text-align: center;
        }

        .build-hint {
            font-size: 11px; color: #888; text-align: center; 
            padding-top: 6px; border-top: 1px solid #444; margin-top: 6px; flex-shrink: 0;
        }

        /* Market */
        #market-container { display: flex; gap: 8px; height: 100%; width: 100%; position: relative; padding-top: 8px; }
        .market-col {
            flex: 1; display: flex; flex-direction: column;
            background: #111; border: 1px solid #444; padding: 0; border-radius: 4px;
            height: 100%; 
            overflow-y: auto; position: relative;
            -webkit-overflow-scrolling: touch;
        }
        .market-header { 
            font-size: 13px; color: var(--accent-gold); text-align: center; 
            background: #222; border-bottom: 1px solid #555; padding: 6px; 
            position: sticky; top: 0; z-index: 10;
        }
        .market-country-row {
            display: flex; flex-direction: column; background: #222; border: 1px solid #555; 
            padding: 6px; margin: 4px;
        }
        .m-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .flag { font-size: 14px; color:#fff; }
        .price { color: #fff; font-family: 'VT323'; font-size: 18px; font-weight: bold; color: var(--accent-gold); }
        .buy-btn-mini {
            width: 100%; background: var(--land-green); border: 1px solid #fff; color: white;
            padding: 4px; font-size: 12px; cursor: pointer; text-align: center; font-weight: bold;
        }
        .buy-btn-mini:active { background: #fff; color: #000; }

        .terminal-build-area {
            background: #2c3e50; border: 1px solid var(--accent-blue);
            padding: 8px; margin: 4px; text-align: center;
        }
        .terminal-info { font-size: 11px; color: #aec6cf; margin-bottom: 4px; }
        .build-term-btn {
            background: var(--accent-blue); color: #fff; border: 1px solid #fff;
            width: 100%; padding: 6px; font-size: 13px; cursor: pointer; font-weight: bold;
        }

        /* Next Button */
        #next-btn {
            position: fixed;
            bottom: calc(270px + env(safe-area-inset-bottom)); 
            right: 15px;
            width: 80px; height: 80px;
            background: var(--accent-red);
            border: 4px solid #fff; border-radius: 50%;
            box-shadow: 5px 5px 0px #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 150; cursor: pointer;
            font-size: 14px; font-weight: bold; text-align: center; line-height: 1.2;
            animation: pulse-btn 1.5s infinite;
        }
        #next-btn:active { transform: scale(0.95); box-shadow: 2px 2px 0px #000; }
        @keyframes pulse-btn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Tutorial & Highlights */
        #tutorial-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; /* Increased Z-Index */
            display: none; cursor: pointer;
        }
        /* Specific highlight override */
        .highlight-target {
            z-index: 2001 !important; /* Must be > overlay */
            position: relative !important;
            box-shadow: 0 0 0 4px var(--accent-gold), 0 0 20px var(--accent-gold) !important;
            transition: all 0.3s;
            pointer-events: none; /* Make clicks pass through highlighted element to the overlay */
        }
        
        /* Fix for Next Button position when highlighted */
        #next-btn.highlight-target {
            position: fixed !important;
        }
        
        #tutorial-tooltip {
            position: fixed; top: 30%; left: 50%; transform: translateX(-50%);
            background: #fff; color: #000; padding: 15px; border-radius: 10px;
            font-weight: bold; z-index: 2002; display: none; /* Must be > overlay and target */
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            text-align: center; width: 80%;
            animation: floatTooltip 1s infinite alternate;
        }
        .tut-title {
            color: var(--accent-blue);
            font-size: 16px;
            margin-bottom: 8px;
            border-bottom: 2px solid #ddd;
            padding-bottom: 4px;
            text-align: center;
        }
        @keyframes floatTooltip { from { transform: translate(-50%, 0); } to { transform: translate(-50%, -10px); } }
        .tut-next { font-size: 10px; color: #666; margin-top: 5px; }

        /* Toast Notification System */
        #toast-container {
            position: fixed; top: 100px; left: 50%; transform: translateX(-50%);
            width: 280px; pointer-events: none; z-index: 1500;
            display: flex; flex-direction: column; /* Stack direction */
            gap: 6px;
        }
        .toast-msg {
            background: rgba(0,0,0,0.9);
            color: #fff; border-left: 4px solid #fff;
            padding: 8px 12px; font-family: 'VT323', monospace; font-size: 18px;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.5);
            
            /* Entry Animation */
            opacity: 0; transform: translateY(-10px);
            animation: toastEntry 0.3s forwards;
            
            /* Exit Transition */
            transition: all 0.4s ease;
            max-height: 50px; /* Assume no toast > 50px */
            margin-bottom: 6px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .toast-msg.good { border-color: var(--accent-gold); color: #fff; }
        .toast-msg.bad { border-color: var(--accent-red); color: #ffcccc; }
        
        @keyframes toastEntry {
            to { opacity: 1; transform: translateY(0); }
        }
        
        .toast-msg.hiding {
            opacity: 0;
            transform: translateX(10px);
            max-height: 0;
            padding-top: 0; padding-bottom: 0;
            margin-bottom: 0;
            border: none;
        }

        /* Modal */
        #modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000;
            display: none; justify-content: center; align-items: center; padding: 20px;
        }
        .retro-dialog { 
            background: var(--accent-blue); border: 4px solid #fff; padding: 4px; 
            width: 95%; max-width: 360px; max-height: 85vh;
            box-shadow: 8px 8px 0px #000;
            display: flex; flex-direction: column;
        }
        .retro-inner { 
            background: var(--ui-bg); border: 2px solid #000; padding: 20px; text-align: center;
            overflow-y: auto;
        }
        .retro-btn { margin-top: 15px; background: #000; color: #fff; border: 2px solid #fff; padding: 10px 30px; cursor: pointer; font-size: 16px; width: 100%;}
        .retro-btn.restart { background: var(--accent-red); color: #fff; border-color: #fff; }
        .retro-btn.victory { background: var(--accent-gold); color: #000; border-color: #fff; }

        /* Report Modal Styles */
        .report-section { text-align: left; margin-bottom: 12px; border-bottom: 1px solid #444; padding-bottom: 8px; }
        .report-section:last-child { border-bottom: none; }
        .report-title { font-weight: bold; color: #aaa; font-size: 12px; margin-bottom: 4px; }
        .report-val { font-size: 16px; font-weight: bold; display: flex; justify-content: space-between; }
        .report-detail { font-size: 12px; color: #888; margin-top: 2px; padding-left: 10px; }

        .crisis-mode { filter: sepia(100%) hue-rotate(-50deg) saturate(300%); }
        
        .rule-list { text-align: left; font-size: 14px; color: #ccc; margin: 10px 0; border: 1px solid #555; padding: 10px; background: #222; }
        .rule-item { display: flex; justify-content: space-between; margin-bottom: 6px; border-bottom: 1px solid #333; padding-bottom: 2px;}
        .rule-title { font-weight: bold; color: var(--accent-gold); margin-bottom: 5px; text-align: center;}

        .chart-container { margin: 15px 0; border: 1px solid #555; background: #111; padding: 5px; }
        .chart-title { font-size: 12px; color: #aaa; margin-bottom: 5px; text-align: left; }
        .chart-legend { display: flex; flex-wrap: wrap; gap: 8px; font-size: 10px; justify-content: center; margin-top: 5px;}
        .legend-item { display: flex; align-items: center; gap: 3px; }
        .color-box { width: 8px; height: 8px; border: 1px solid #fff; }
        .rank-list { text-align: left; font-size: 11px; color:#ddd; margin-top: 5px; }
        .rank-item { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 2px 0;}
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="tutorial-overlay" onclick="game.nextTutorialStep()"></div>
    <div id="tutorial-tooltip">
        <div id="tut-text"></div>
        <div class="tut-next">â–¼ é»æ“Šç•«é¢ç¹¼çºŒ</div>
    </div>

    <div id="hud">
        <div class="stat-box" onclick="ui.showFundsHelp()">
            <span class="stat-label">è³‡é‡‘</span>
            <span class="stat-val gold" id="hud-funds">2,000</span>
            <div class="help-btn">?</div>
        </div>
        <div class="stat-box" onclick="ui.showCompHelp()">
            <span class="stat-label">ç«¶çˆ­åŠ›</span>
            <span class="stat-val blue" id="hud-comp">100%</span>
            <div class="help-btn">?</div>
        </div>
        <div class="stat-box" onclick="ui.showStockHelp()">
            <span class="stat-label">ç‡ƒæ–™å­˜é‡</span>
            <span class="stat-val" id="hud-days">--</span>
            <div class="help-btn">?</div>
        </div>
        <div class="stat-box" style="background:#4a5568; border-color:#fff;" onclick="game.replayTutorial()">
            <span class="stat-label" style="color:#fff;">éŠæˆ²èªªæ˜</span>
            <span class="stat-val hud-help-icon">?</span>
        </div>
    </div>

    <div id="story-panel" class="info-panel">
        <div class="pixel-title">ä»»å‹™ç°¡å ±</div>
        <div class="pixel-text" id="story-text">...</div>
    </div>
    <div id="goal-panel" class="info-panel">
        <div class="pixel-title" style="color:var(--accent-blue)">éšæ®µç›®æ¨™</div>
        <div id="goal-list"></div>
    </div>

    <div id="game-stage">
        <div id="map-container">
            <div id="map-year-display">ç¬¬ 1 å¹´</div>
            <svg id="taiwan-svg" viewBox="0 0 320 480">
                <path class="map-path" d="
                    M 210 30 
                    C 230 35, 250 50, 260 80
                    C 275 120, 270 180, 265 220
                    C 260 270, 240 320, 220 370
                    C 200 420, 185 450, 175 460
                    L 165 455
                    C 110 420, 60 350, 50 250  
                    C 45 180, 75 120, 100 80
                    C 140 50, 170 30, 210 30 Z
                "/>
            </svg>
            
            <div id="power-pie-chart">
                <!-- No label inside, using dynamic labels -->
                <div id="pie-center-hole">
                   <div id="pie-center-text">å æ¯”</div>
                </div>
            </div>
            
            <!-- Removed Legend Box -->

            <div id="buildings-layer"></div>

            <div id="map-data-overlay">
                <div class="data-row"><span>ç¸½ç™¼é›»</span><span class="data-val" id="stat-supply">0 MW</span></div>
                <div class="data-row"><span>ç¸½éœ€æ±‚</span><span class="data-val" id="stat-demand">0 MW</span></div>
                <div class="data-sep"></div>
                <div class="data-row"><span>ç…¤å­˜é‡</span><span class="data-val" id="stat-coal-days" style="color:#aaa">--</span></div>
                <div class="data-row"><span>æ°£å­˜é‡</span><span class="data-val blue" id="stat-gas-days">--</span></div>
            </div>
        </div>
    </div>

    <div id="next-btn" onclick="game.nextTurn()">
        ä¸‹ä¸€<br>å¹´åº¦
    </div>

    <div id="bottom-panel">
        <div class="arcade-tabs">
            <button class="pixel-btn active" id="tab-btn-build" onclick="ui.switchTab('build')">ğŸ”¨ å»ºè¨­</button>
            <button class="pixel-btn" id="tab-btn-market" onclick="ui.switchTab('market')">ğŸš¢ ç‡ƒæ–™å¸‚å ´</button>
        </div>

        <div id="tab-build" class="tab-content active">
            <div id="build-deck"></div>
            <div class="build-hint">é»æ“Šå¡ç‰‡ç³»çµ±å°‡è‡ªå‹•é¸å€å»ºè¨­</div>
        </div>

        <div id="tab-market" class="tab-content">
            <div id="market-container">
                <div class="market-col">
                    <div class="market-header">ğŸª¨ ç…¤ (å­˜:<span id="val-coal-stock">0</span>)</div>
                    <div class="market-list" id="market-coal-list"></div>
                </div>
                <div class="market-col">
                    <div class="market-header">ğŸ”¥ æ°£ (å­˜:<span id="val-gas-stock">0</span>)</div>
                    <div class="terminal-build-area">
                        <div class="terminal-info">ä¸Šé™: <span id="val-gas-cap">0</span> | å·²æœ‰ <span id="val-term-cnt">0</span> åº§</div>
                        <button class="build-term-btn" onclick="game.buildTerminal()">æ–°å»ºæ¥æ”¶ç«™ ($2000)</button>
                    </div>
                    <div class="market-list" id="market-gas-list"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-overlay">
        <div class="retro-dialog">
            <div class="retro-inner">
                <div class="retro-title" id="modal-title">TITLE</div>
                <div id="modal-content-area">
                    <p id="modal-desc" style="font-size:14px; line-height:1.6; color:#ddd; margin:15px 0;">CONTENT</p>
                </div>
                <div id="modal-footer">
                    <button class="retro-btn" id="modal-btn" onclick="ui.closeModal()">ç¢º å®š</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const PLANTS = {
            coal: { name: 'ç‡ƒç…¤', emoji: 'ğŸ­', cost: 1000, output: 1500, fuel: 40, type: 'land', color: '#7f8c8d' },
            gas: { name: 'ç‡ƒæ°£', emoji: 'ğŸ”¥', cost: 1500, output: 2500, fuel: 30, type: 'land', color: '#d35400' },
            terminal: { name: 'æ¥æ”¶ç«™', emoji: 'âš“', cost: 2000, output: 0, fuel: 0, type: 'coast', color: '#2980b9' },
            green: { name: 'é¢¨é›»', emoji: 'ğŸŒ€', cost: 3000, output: 100, fuel: 0, type: 'sea', color: '#2ecc71' },
            solar: { name: 'å¤ªé™½èƒ½', emoji: 'â˜€ï¸', cost: 1200, output: 50, fuel: 0, type: 'land', color: '#f39c12' },
            nuclear: { name: 'æ ¸èƒ½', emoji: 'â˜¢ï¸', cost: 5000, output: 6000, fuel: 0, type: 'land', color: '#8e44ad' }
        };

        const STAGES = [
            {
                title: "éšæ®µä¸€ï¼šåŸºç¤å»ºè¨­ (1975-1990)",
                short: "åå¤§å»ºè¨­å•Ÿå‹•ï¼Œè«‹æ“´å……ç‡ƒç…¤é›»åŠ›ï¼Œæ»¿è¶³å·¥æ¥­éœ€æ±‚ã€‚",
                desc: "ğŸ—ï¸ **åŸºç¤å»ºè¨­æœŸ**ï¼š<br>æ°‘åœ‹60å¹´ä»£ï¼Œåå¤§å»ºè¨­å•Ÿå‹•ã€‚é‡å·¥æ¥­èˆ‡è£½é€ æ¥­èˆˆèµ·ï¼Œé›»åŠ›ç¼ºå£æ“´å¤§ã€‚<br>é¦–è¦ä»»å‹™ï¼šæ“´å……åŸºè¼‰é›»åŠ›ï¼Œç¢ºä¿å·¥æ¥­å‹•èƒ½ä¸ç†„ç«ã€‚",
                goals: [
                    { txt: "ç™¼é›»é‡ > 12000MW", check: g => g.calcPower() >= 12000 },
                    { txt: "ç‡ƒç…¤é›»å»  > 6 åº§", check: g => g.counts.coal >= 6 }
                ]
            },
            {
                title: "éšæ®µäºŒï¼šç‡ƒæ°£æ™‚ä»£ (1990-2005)",
                short: "çŸ³æ²¹å±æ©Ÿå¼•ç™¼é€šè†¨ï¼Œç«¹ç§‘å´›èµ·ã€‚è«‹å»ºæ¥æ”¶ç«™ç™¼å±•ç‡ƒæ°£ã€‚",
                desc: "â›½ **èƒ½æºè½‰å‹èˆ‡ç«¹ç§‘**ï¼š<br>çŸ³æ²¹å±æ©Ÿå¼•ç™¼é€šè†¨ï¼Œæ”¿åºœæ±ºå¿ƒã€Œä¸æŠŠé›è›‹æ”¾åŒå€‹ç±ƒå­ã€ã€‚<br>ç«¹ç§‘å´›èµ·ï¼Œæ™¶åœ“ä»£å·¥éœ€é«˜ç©©å®šé›»åŠ›ã€‚ç‡ƒæ°£ä½ç¢³ä¸”ç’°ä¿ã€‚<br>ä»»å‹™ï¼šèˆˆå»ºé¦–åº§æ¥æ”¶ç«™ï¼Œé–‹å•Ÿç‡ƒæ°£æ™‚ä»£ï¼(æ³¨æ„ï¼šæ­¤éšæ®µç…¤åƒ¹ç¿»å€)",
                goals: [
                    { txt: "æ¥æ”¶ç«™ > 1 åº§", check: g => g.counts.terminal >= 1 },
                    { txt: "ç‡ƒæ°£ç™¼é›» > 20%", check: g => g.getGasPct() >= 20 },
                    { txt: "ç¸½ç™¼é›» > 30000MW", check: g => g.calcPower() >= 30000 }
                ]
            },
            {
                title: "éšæ®µä¸‰ï¼šèƒ½æºéŸŒæ€§ (2005-2015)",
                short: "ç‚ºå…æ–·æ°£å±æ©Ÿï¼Œè«‹å¢å»ºæ¥æ”¶ç«™ä¸¦æ‹‰é«˜å®‰å…¨å­˜é‡ã€‚",
                desc: "ğŸ›¡ï¸ **å¼·åŒ–èƒ½æºéŸŒæ€§**ï¼š<br>é¿å…å–®ä¸€æ¥æ”¶ç«™æ•…éšœå³æ–·é›»ã€‚è«‹å»ºè¨­å¤šåº§æ¥æ”¶ç«™åˆ†æ•£é¢¨éšªã€‚<br>åŒæ™‚å°‡ç…¤æ°£å­˜é‡æ‹‰é«˜è‡³ 7 å¤©ä»¥ä¸Šï¼Œç¢ºä¿åœ‹å®¶èƒ½æºéŸŒæ€§ã€‚<br><span style='color:var(--accent-red)'>(æ³¨æ„ï¼šå¾æœ¬éšæ®µèµ·ï¼Œåº«å­˜ä½æ–¼7å¤©å°‡æ‰£é™¤ç«¶çˆ­åŠ›ï¼)</span>",
                goals: [
                    { txt: "æ¥æ”¶ç«™ > 3 åº§", check: g => g.counts.terminal >= 3 },
                    { txt: "å®‰å…¨å­˜é‡ > 7å¤©", check: g => g.getSafetyDays() !== null && g.getSafetyDays() >= 7 }
                ]
            },
            {
                title: "éšæ®µå››ï¼šé¢¨æ°£äº’è£œ (2015-2025)",
                short: "æ‡‰å°å°é–é¢¨éšªï¼Œåˆ©ç”¨é¢¨å ´ç™¼å±•è‡ªæœ‰èƒ½æºï¼ŒåŸ·è¡Œé¢¨æ°£äº’è£œã€‚",
                desc: "ğŸŒ¬ï¸ **è‡ªæœ‰èƒ½æºæˆ°ç•¥**ï¼š<br>å¤©ç„¶æ°£æ˜‚è²´ä¸”æ˜“å—å°é–å½±éŸ¿ã€‚å¹¸é‹çš„æ˜¯å°ç£æµ·å³½æœ‰é ‚ç´šé¢¨å ´ï¼<br>åŸ·è¡Œã€é¢¨æ°£äº’è£œã€ï¼šä»¥ç‡ƒæ°£å¿«é€Ÿå‡é™æ”¯æ´ç¶ èƒ½ã€‚<br>å»ºè¨­å†ç”Ÿèƒ½æºï¼Œç²å–ã€è‡ªæœ‰èƒ½æºã€ä»¥æŠ—è¡¡åœ°ç·£é¢¨éšªã€‚",
                goals: [
                    { txt: "å†ç”Ÿèƒ½æº > 10%", check: g => g.getGreenPct() >= 10 },
                    { txt: "å®‰å…¨å­˜é‡ > 11å¤©", check: g => g.getSafetyDays() !== null && g.getSafetyDays() >= 11 }
                ]
            },
            {
                title: "éšæ®µäº”ï¼šAIæ–°å±€ (2025-)",
                short: "AIèˆ‡RE100éœ€æ±‚å¤§å¢ã€‚è«‹å¤§å¹…æå‡ç¶ èƒ½èˆ‡ç¸½ç™¼é›»é‡ã€‚",
                desc: "ğŸ¤– **AI èˆ‡æ°¸çºŒç«¶çˆ­**ï¼š<br>AI ç®—åŠ›æ¨å‡ç”¨é›»ï¼ŒRE100 é™åˆ¶å‡ºå£ã€‚<br>ç‚ºä¿ç”¢æ¥­å„ªå‹¢ï¼Œéœ€å¤§å¹…æå‡ç¶ èƒ½ä¾›æ‡‰ã€‚<br>é¢å°åœ°ç·£è»æ¼”ï¼Œæ›´éœ€å°‡å®‰å…¨å­˜é‡æ‹‰è‡³ 14 å¤©ï¼Œç¢ºä¿ä¾›é›»ç„¡è™ã€‚",
                goals: [
                    { txt: "å†ç”Ÿèƒ½æº > 20%", check: g => g.getGreenPct() >= 20 },
                    { txt: "å®‰å…¨å­˜é‡ > 14å¤©", check: g => g.getSafetyDays() !== null && g.getSafetyDays() >= 14 },
                    { txt: "ç¸½ç™¼é›» > 70000MW", check: g => g.calcPower() >= 70000 }
                ]
            }
        ];

        const MARKET_SOURCES = {
            coal: [
                { id: 'au', name: 'æ¾³æ´²', flag: 'ğŸ‡¦ğŸ‡º', base: 100 },
                { id: 'id', name: 'å°å°¼', flag: 'ğŸ‡®ğŸ‡©', base: 80 },
                { id: 'ru', name: 'ä¿„åœ‹', flag: 'ğŸ‡·ğŸ‡º', base: 90 },
                { id: 'za', name: 'å—é', flag: 'ğŸ‡¿ğŸ‡¦', base: 85 },
                { id: 'ca', name: 'åŠ æ‹¿å¤§', flag: 'ğŸ‡¨ğŸ‡¦', base: 105 }
            ],
            gas: [
                { id: 'au', name: 'æ¾³æ´²', flag: 'ğŸ‡¦ğŸ‡º', base: 220 },
                { id: 'qa', name: 'å¡é”', flag: 'ğŸ‡¶ğŸ‡¦', base: 200 },
                { id: 'us', name: 'ç¾åœ‹', flag: 'ğŸ‡ºğŸ‡¸', base: 250 },
                { id: 'my', name: 'å¤§é¦¬', flag: 'ğŸ‡²ğŸ‡¾', base: 210 },
                { id: 'pg', name: 'å·´ç´', flag: 'ğŸ‡µğŸ‡¬', base: 230 }
            ]
        };

        const NUKE_RISK_MAP = [0, 1, 2, 5, 8, 11, 15, 20, 25, 30, 40]; 

        const game = {
            year: 1, funds: 2000, comp: 100, demand: 10000, 
            fuel: { coal: 3000, gas: 0 }, cap: { coal: 3000, gas: 0 },
            counts: { coal: 0, gas: 0, terminal: 0, green: 0, solar: 0, nuclear: 0 },
            stageIdx: 0, selected: null, blockade: false, bDays: 0,
            marketPrices: {}, 
            purchaseCounts: { coal: {}, gas: {} },
            isFreePlay: false,
            history: [],
            importStats: { coal: {}, gas: {} },
            tutorialStep: 0,
            isReplayTutorial: false,
            
            nukeDisasterCount: 0,
            nukeShutdownTimer: 0,
            isNukePermanentlyBanned: false,

            init() {
                this.resetVariables();
                this.counts.coal = 0; 
                this.cap.coal = 3000; 
                this.updateMarketPrices();
                ui.renderDeck(); ui.renderMarket(); ui.updateAll();
                
                // --- Chain Modals: Intro -> Stage 0 (Base) -> Tutorial ---
                ui.showModal("ä»»å‹™ç°¡å ±ï¼šèƒ½æºä»»å‘½",
                    `<div style="text-align:left; padding:0 10px; line-height:1.6;">
                        æ­å–œæ‚¨ï¼æ‚¨å·²è¢«ä»»å‘½ç‚º<span style="color:var(--accent-gold)">å°ç£èƒ½æºæ±ºç­–é•·</span>ã€‚<br><br>
                        å¾æ­¤åˆ»èµ·ï¼Œåœ‹å®¶çš„å‹•åŠ›æŒæ¡åœ¨æ‚¨æ‰‹ä¸­ã€‚æ‚¨å°‡è·¨è¶Š50å¹´çš„æ™‚ç©ºï¼Œé¢å°<span style="color:var(--accent-blue)">ç¶“æ¿Ÿèµ·é£›çš„é›»åŠ›éœ€æ±‚</span>ã€<span style="color:var(--accent-green)">ç’°å¢ƒä¿è­·çš„è½‰å‹å£“åŠ›</span>ï¼Œä»¥åŠ<span style="color:var(--accent-red)">åœ°ç·£æ”¿æ²»çš„åš´å³»æŒ‘æˆ°</span>ã€‚<br><br>
                        <span style="color:var(--accent-gold)">æ ¸å¿ƒç›®æ¨™ï¼š</span>åœ¨æœ‰é™è³‡é‡‘ä¸‹ï¼Œå»ºç«‹ä¸€å€‹ç©©å®šã€å®‰å…¨ä¸”æ½”æ·¨çš„é›»åŠ›ç³»çµ±ã€‚
                    </div>`,
                    () => {
                        // Use swapModal instead of close+show to prevent flashing
                        // Start Tutorial immediately
                        ui.closeModal();
                        if(game.year === 1) game.startTutorial();
                    }
                );
            },

            resetVariables() {
                this.year = 1; 
                this.funds = 2000; 
                this.comp = 100; this.demand = 10000;
                this.fuel = { coal: 3000, gas: 0 }; 
                this.cap = { coal: 3000, gas: 0 };
                this.counts = { coal: 0, gas: 0, terminal: 0, green: 0, solar: 0, nuclear: 0 };
                this.stageIdx = 0; this.selected = null; this.blockade = false; this.isFreePlay = false;
                this.history = []; this.importStats = { coal: {}, gas: {} };
                this.purchaseCounts = { coal: {}, gas: {} };
                
                this.nukeDisasterCount = 0;
                this.nukeShutdownTimer = 0;
                this.isNukePermanentlyBanned = false;

                document.getElementById('buildings-layer').innerHTML = '';
                document.body.classList.remove('crisis-mode');
                this.tutorialStep = 0;
            },
            
            startTutorial() {
                this.tutorialStep = 1;
                this.updateTutorial();
            },
            
            replayTutorial() {
                this.isReplayTutorial = true;
                this.startTutorial();
            },

            nextTutorialStep() {
                if(this.tutorialStep > 0 && this.tutorialStep < 7) {
                    this.tutorialStep++;
                    this.updateTutorial();
                } else if(this.tutorialStep === 7) { 
                    this.tutorialStep = 0;
                    ui.clearHighlight();
                    ui.switchTab('build', true);
                    
                    // Show Current Stage Goals AFTER Tutorial
                    const s = STAGES[this.stageIdx];
                    const goals = s.goals.map(g => 'ğŸ”¹ ' + g.txt).join('<br>');
                    
                    // Show modal immediately
                    ui.showModal(s.title,
                        `<div style="text-align:left; padding:0 10px; line-height:1.6;">
                            ${s.desc}<br><br>
                            <span style="color:var(--accent-blue)">ğŸ† æœ¬éšæ®µç›®æ¨™ï¼š</span><br>${goals}
                        </div>`,
                        () => ui.closeModal()
                    );
                    
                    this.isReplayTutorial = false;
                }
            },

            updateTutorial() {
                ui.clearHighlight();
                
                if(this.tutorialStep === 1) {
                    ui.switchTab('build', true); 
                    ui.highlightElement('#hud .stat-box:nth-child(1)', "ã€å»ºè¨­è³‡é‡‘ã€‘\nå»ºè¨­é›»å» èˆ‡è³¼è²·ç‡ƒæ–™çš„ç¶“è²»ã€‚\næ¯å¹´æœƒä¾ç™¼é›»é‡ç²å¾—ç¨…æ”¶ã€‚");
                } else if(this.tutorialStep === 2) {
                     ui.highlightElement('#hud .stat-box:nth-child(2)', "ã€åœ‹å®¶ç«¶çˆ­åŠ›ã€‘\nåœ‹å®¶ç™¼å±•çš„é—œéµæŒ‡æ¨™ã€‚\nä¾›é›»ä¸ç©©æˆ–ç‡ƒæ–™çŸ­ç¼ºå°‡å°è‡´æŒ‡æ•¸ä¸‹é™ï¼Œ\nä¸€æ—¦æ­¸é›¶ï¼ŒéŠæˆ²å³åˆ»çµæŸã€‚");
                } else if(this.tutorialStep === 3) {
                     ui.highlightElement('#hud .stat-box:nth-child(3)', "ã€ç‡ƒæ–™å­˜é‡ã€‘\nåœ‹å®¶èƒ½æºå®‰å…¨çš„åº•ç·šï¼\nä»£è¡¨ç›®å‰çš„ç‡ƒæ–™åº«å­˜èƒ½æ”¯æ’å¹¾å¤©ã€‚\nè‹¥æ­¸é›¶å°‡å°è‡´åœ‹å®¶å´©æ½°ã€‚");
                } else if(this.tutorialStep === 4) {
                    ui.switchTab('build', true); 
                    ui.highlightElement('#build-deck', "ã€å»ºè¨­å€ã€‘\né€™è£¡åˆ—å‡ºäº†å„ç¨®ç™¼é›»è¨­æ–½ã€‚\nå¾…æœƒæ‚¨å¯ä»¥é¸æ“‡å¡ç‰‡é€²è¡Œå»ºè¨­ã€‚\n(é»æ“Šç•«é¢ç¹¼çºŒ)");
                } else if(this.tutorialStep === 5) {
                    ui.switchTab('market', true); 
                    ui.highlightElement('#market-container', "ã€ç‡ƒæ–™å¸‚å ´ã€‘\né»æ“Šåˆ‡æ›åˆ†é ï¼Œå¯è³¼è²·ç…¤ç‚­èˆ‡å¤©ç„¶æ°£ã€‚\n(å¾€ä¸‹æ»‘å‹•å¯è³¼è²·ä¸åŒé€²å£åœ‹çš„ç‡ƒæ–™)");
                } else if(this.tutorialStep === 6) {
                    ui.switchTab('build', true); 
                    ui.highlightElement('#next-btn', "ã€ä¸‹ä¸€å¹´åº¦ã€‘\næº–å‚™å¥½å¾Œï¼Œé»æ“Šæ­¤è™•æ¨é€²æ™‚é–“ä¸¦ç²å¾—ç¨…æ”¶ã€‚");
                } else {
                    ui.clearHighlight();
                }
            },
            
            restart() {
                this.resetVariables();
                this.counts.coal = 0; this.cap.coal = 3000;
                this.updateMarketPrices();
                ui.renderDeck(); ui.renderMarket(); ui.updateAll();
                ui.closeModal();
                setTimeout(() => ui.showModal("éŠæˆ²é‡å•Ÿ", "ä¸€åˆ‡å›åˆ°åŸé»ï¼Œè«‹é‡æ–°è¦åŠƒèƒ½æºæ”¿ç­–ï¼", () => {
                     ui.closeModal();
                     game.startTutorial();
                }), 300);
            },

            selectCard(key) {
                // Modified: Block interaction if in tutorial
                if (this.tutorialStep !== 0) return;

                if(this.selected === key) { this.selected = null; }
                else { this.selected = key; this.tryBuild(); }
                ui.renderDeck();
                // Removed direct jump logic, handled inside tryBuild success
            },

            tryBuild() {
                // Modified: Only allow building if tutorial is finished (step 0)
                if (this.tutorialStep !== 0) return;
                
                if (!this.selected) return;
                const p = PLANTS[this.selected];
                
                if (this.selected === 'nuclear') {
                    if (this.year >= 46) { // Approx 2021 if start at 1? No, 1975+46=2021
                         // Actually logic was year >= 2021. Since year is now 1, 2, 3...
                         // 1975 is base. 2021 - 1975 = 46. So year > 46 is ban
                         // Let's keep year as relative for logic? No user wanted "Year 1".
                         // Logic needs update: 1975 + this.year > 2021
                        if (1975 + this.year >= 2021) {
                            ui.floatText('ğŸš« 2021å¾Œç¦æ­¢æ–°å»ºæ ¸é›»', 'bad'); this.selected = null; return;
                        }
                    }
                    if (this.isNukePermanentlyBanned) {
                        ui.floatText('â›” æ ¸èƒ½å·²æ°¸ä¹…å»¢æ­¢', 'bad'); this.selected = null; return;
                    }
                }

                if (this.funds < p.cost) {
                    ui.floatText('ğŸ’¸ è³‡é‡‘ä¸è¶³', 'bad'); this.selected = null; return;
                }
                if (this.selected === 'gas' && this.counts.terminal === 0) {
                    ui.floatText('âš ï¸ éœ€å»ºæ¥æ”¶ç«™', 'bad'); this.selected = null; return;
                }

                this.funds -= p.cost;
                this.counts[this.selected]++;
                
                if (this.selected === 'coal') this.cap.coal += 1500; 
                if (this.selected === 'terminal') this.cap.gas += 1500;
                
                ui.floatText(`å»ºè¨­${p.name} -$${p.cost}`, 'good');
                this.placeBuilding(this.selected);
                this.selected = null;
                ui.renderDeck(); ui.updateAll();
                
                // Advance Tutorial if constructing the first plant (coal usually)
                if(this.tutorialStep === 1) {
                    this.tutorialStep = 2;
                    this.updateTutorial();
                }
            },

            buildTerminal() {
                // Modified: Disable during tutorial
                if (this.tutorialStep !== 0) return;

                const p = PLANTS.terminal;
                if (this.funds < p.cost) {
                    ui.floatText('ğŸ’¸ è³‡é‡‘ä¸è¶³', 'bad'); return;
                }
                this.funds -= p.cost;
                this.counts.terminal++;
                this.cap.gas += 1500;
                ui.floatText(`å»ºè¨­æ¥æ”¶ç«™ -$${p.cost}`, 'good');
                this.placeBuilding('terminal');
                ui.updateAll();
            },

            placeBuilding(type) {
                const pInfo = PLANTS[type];
                const el = document.createElement('div');
                el.innerText = pInfo.emoji;
                el.style.position = 'absolute';
                el.style.fontSize = '18px';
                el.style.animation = 'dropIn 0.3s';
                let x, y;
                switch(pInfo.type) {
                    case 'sea': x = 10 + Math.random() * 50; y = 100 + Math.random() * 300; break;
                    case 'coast': x = 60 + Math.random() * 20; y = 50 + Math.random() * 300; break;
                    case 'land': x = 100 + Math.random() * 100; y = 50 + Math.random() * 350; break;
                }
                el.style.left = x + 'px'; el.style.top = y + 'px';
            },

            buyFuel(type, countryId) {
                // Modify: Disable during tutorial
                if (this.tutorialStep !== 0) return;

                if (this.blockade) { ui.floatText('ğŸš« å°é–ä¸­', 'bad'); return; }
                const basePrice = this.marketPrices[`${type}_${countryId}`];
                const surge = this.purchaseCounts[type][countryId] || 0;
                const finalCost = basePrice + surge;

                if (this.funds < finalCost) { ui.floatText('ğŸ’¸ è³‡é‡‘ä¸è¶³', 'bad'); return; }
                if (this.fuel[type] + 100 > this.cap[type]) {
                    ui.floatText('ğŸ“¦ å€‰åº«å·²æ»¿', 'bad');
                    if(type==='gas' && this.counts.terminal===0) ui.floatText('âš ï¸ éœ€æ¥æ”¶ç«™', 'bad');
                    return;
                }
                this.funds -= finalCost;
                this.fuel[type] += 100;
                if (!this.purchaseCounts[type][countryId]) this.purchaseCounts[type][countryId] = 0;
                this.purchaseCounts[type][countryId]++;
                if (!this.importStats[type][countryId]) this.importStats[type][countryId] = 0;
                this.importStats[type][countryId] += 100;
                
                const fuelName = type === 'coal' ? 'ç…¤ç‚­' : 'å¤©ç„¶æ°£';
                ui.floatText(`${fuelName}åº«å­˜ +100`, 'good');
                ui.updateAll();
                if(this.tutorialStep === 4) { this.tutorialStep = 5; ui.clearHighlight(); }
            },

            updateMarketPrices() {
                this.purchaseCounts = { coal: {}, gas: {} };
                ['coal', 'gas'].forEach(type => {
                    MARKET_SOURCES[type].forEach(src => {
                        const fluc = 0.8 + Math.random() * 0.5;
                        let price = Math.floor(src.base * fluc);
                        
                        // Stage 2 (Index 1) Coal Price Double Logic
                        if (game.stageIdx === 1 && type === 'coal') {
                            price *= 2;
                        }
                        
                        this.marketPrices[`${type}_${src.id}`] = price;
                    });
                });
            },

            calcIncome() {
                let baseIncome = 500;
                if (game.stageIdx === 1) baseIncome = 1000;
                if (game.stageIdx >= 2) baseIncome = 2000; // Adjusted for new stages
                const powerBonus = Math.floor(this.calcPower(true) * 0.4); 
                return baseIncome + powerBonus;
            },
            
            getNukeRisk() {
                const cnt = this.counts.nuclear;
                if(cnt >= NUKE_RISK_MAP.length) return 50;
                return NUKE_RISK_MAP[cnt];
            },

            checkNuclearDisaster() {
                if (this.counts.nuclear > 0) {
                    const risk = this.getNukeRisk();
                    if (Math.random() * 100 < risk) {
                        this.nukeDisasterCount++;
                        let loss = Math.max(5000, Math.floor(this.funds / 2));
                        this.funds -= loss;
                        this.funds -= 2000;
                        if(this.funds < 0) { 
                            this.comp -= 15; 
                        }
                        this.counts.nuclear--;
                        this.nukeShutdownTimer = 2;
                        this.comp -= 30;
                        
                        let msg = "â˜¢ï¸ æ ¸ç½çˆ†ç™¼ï¼ç«¶çˆ­åŠ›-30";
                        if(this.funds < 0) msg += "ï¼Œåœ‹å®¶ç ´ç”¢ -15";
                        
                        if(this.nukeDisasterCount >= 3) {
                            this.isNukePermanentlyBanned = true;
                            this.counts.nuclear = 0; 
                            return "â˜¢ï¸ æ ¸ç½3æ¬¡ï¼šæ ¸èƒ½æ°¸ä¹…å»¢æ­¢ï¼";
                        } else {
                            return msg;
                        }
                        ui.renderDeck();
                    }
                }
                return null;
            },

            nextTurn() {
                if (this.blockade) { this.handleBlockade(); return; }
                this.year++; 
                if (this.nukeShutdownTimer > 0) this.nukeShutdownTimer--;

                // Record history
                const pCoal = this.counts.coal * PLANTS.coal.output;
                const pGas = this.counts.gas * PLANTS.gas.output;
                const pNuke = this.calcNukeOutput();
                const pGreen = (this.counts.green * PLANTS.green.output) + (this.counts.solar * PLANTS.solar.output);
                
                this.history.push({
                    year: this.year,
                    coal: pCoal,
                    gas: pGas,
                    nuclear: pNuke,
                    green: pGreen
                });

                // --- 1. Check Events ---
                let turnEvents = [];
                const nukeMsg = this.checkNuclearDisaster();
                if(nukeMsg) turnEvents.push(nukeMsg);

                // --- 2. Income ---
                const income = this.calcIncome();
                this.funds += income; 
                // Removed toast for income, will show in modal
                
                this.demand += 1200;
                this.updateMarketPrices();
                
                // --- 3. Consumption ---
                this.consumeFuel(); 
                
                // --- 4. Competitiveness Logic ---
                let compBonus = 0;
                let compChanges = []; // Store strings: "Reason val"

                const power = this.calcPower();
                // Check Power Shortage
                if (power < this.demand) {
                    this.comp -= 15;
                    compChanges.push("ç¼ºé›» -15");
                } else {
                    compBonus += 5;
                    this.comp = Math.min(100, this.comp + 5);
                    compChanges.push("ä¾›é›»ç©©å®š +5");
                }

                // Check 0 Stock Instant Fail
                const cDays = this.getCoalDays();
                const gDays = this.getGasDays();
                const hasCoalPlant = this.counts.coal > 0;
                const hasGasPlant = this.counts.gas > 0;
                const coalFail = hasCoalPlant && cDays === 0;
                const gasFail = hasGasPlant && gDays === 0;

                if (coalFail && gasFail) {
                    this.comp = -100;
                    ui.showGameOver("èƒ½æºæ¯ç«­ï¼šç…¤æ°£å­˜é‡æ­¸é›¶ï¼<br>å…¨åœ‹å¤§åœé›»å°è‡´æ”¿åºœå®å°ã€‚");
                    return;
                }

                // Low Stock Penalty (Only active from Stage 3 onwards)
                if (this.stageIdx >= 2) {
                    if (cDays !== null && cDays < 7) {
                        this.comp -= 10;
                        compChanges.push("ç¼ºç…¤ -10");
                    }
                    if (gDays !== null && gDays < 7) {
                        this.comp -= 10;
                        compChanges.push("ç¼ºæ°£ -10");
                    }
                }
                
                // Blockade Check
                if (this.year > 2020 && Math.random() < 0.15 && !this.isFreePlay) {
                    this.startBlockade();
                    turnEvents.push("âš ï¸ æµ·å³½å°é–é–‹å§‹ï¼");
                }

                // --- 5. Game Over / Victory Check ---
                if (this.comp <= 0) { ui.showGameOver(); return; }
                
                ui.renderMarket(); ui.updateAll();
                
                // --- 6. Goal Check (Stage) ---
                if (!this.isFreePlay) {
                    const stage = STAGES[this.stageIdx];
                    if (stage && stage.goals.every(g => g.check(this))) {
                        if (this.stageIdx < STAGES.length - 1) {
                            this.stageIdx++;
                            // FIX: Update UI to show new stage goals immediately
                            ui.updateAll(); 
                            
                            const s = STAGES[this.stageIdx];
                            const gHtml = s.goals.map(g => 'ğŸ”¹ ' + g.txt).join('<br>');
                            ui.showModal(s.title, 
                                `<div style="text-align:left; padding:0 10px; line-height:1.6;">
                                    ${s.desc}<br><br>
                                    <span style="color:var(--accent-blue)">ğŸ† æœ¬éšæ®µç›®æ¨™ï¼š</span><br>${gHtml}
                                </div>`, 
                                () => ui.closeModal()
                            );
                            // Skip turn report on stage clear to avoid clutter
                            return;
                        } else {
                            ui.showVictory();
                            return; 
                        }
                    }
                }

                // --- 7. Show Turn Report (If no blockade blocking view or game over) ---
                // Only show if not in blockade mode (blockade handles its own modal)
                if (!this.blockade) {
                    ui.showTurnReport(this.year, income, compChanges, this.funds, this.comp, turnEvents);
                }
                
                // Tutorial Step Advancement
                if(this.tutorialStep === 3) {
                    this.tutorialStep = 0;
                    ui.clearHighlight();
                    ui.switchTab('build', true); 
                }
                
                // CRITICAL FIX: Always ensure tutorial lock is released on next turn if not in tutorial logic flow
                this.tutorialStep = 0;
            },

            consumeFuel() {
                const cNeed = this.counts.coal * PLANTS.coal.fuel;
                const gNeed = this.counts.gas * PLANTS.gas.fuel;
                if (this.fuel.coal >= cNeed) this.fuel.coal -= cNeed;
                else { this.fuel.coal = 0; }
                if (this.fuel.gas >= gNeed) this.fuel.gas -= gNeed;
                else { this.fuel.gas = 0; }
            },

            calcNukeOutput() {
                if (this.nukeShutdownTimer > 0) return 0;
                return this.counts.nuclear * PLANTS.nuclear.output;
            },

            calcPower(ignoreShutdown = false) { 
                let nukeOut = this.calcNukeOutput();
                if (ignoreShutdown) nukeOut = this.counts.nuclear * PLANTS.nuclear.output;
                return (this.counts.coal * PLANTS.coal.output) + 
                       (this.counts.gas * PLANTS.gas.output) + 
                       (this.counts.green * PLANTS.green.output) + 
                       (this.counts.solar * PLANTS.solar.output) + 
                       nukeOut;
            },
            
            getGreenPct() {
                const total = this.calcPower();
                if (total === 0) return 0;
                const green = (this.counts.green * PLANTS.green.output) + (this.counts.solar * PLANTS.solar.output);
                return Math.floor((green / total) * 100);
            },

            getGasPct() {
                const total = this.calcPower();
                if (total === 0) return 0;
                const gas = this.counts.gas * PLANTS.gas.output;
                return Math.floor((gas / total) * 100);
            },

            getSafetyDays() {
                const cDay = this.getCoalDays();
                const gDay = this.getGasDays();
                if (cDay === null && gDay === null) return null;
                const cVal = cDay === null ? 9999 : cDay;
                const gVal = gDay === null ? 9999 : gDay;
                return Math.min(cVal, gVal);
            },
            
            getCoalDays() {
                 if (this.counts.coal === 0) return null;
                 const cUse = this.counts.coal * PLANTS.coal.fuel;
                 return Math.floor(this.fuel.coal / cUse);
            },
            
            getGasDays() {
                 if (this.counts.gas === 0) return null;
                 const gUse = this.counts.gas * PLANTS.gas.fuel;
                 return Math.floor(this.fuel.gas / gUse);
            },

            startBlockade() {
                this.blockade = true; this.bDays = 11;
                document.body.classList.add('crisis-mode');
                ui.showModal("âš ï¸ ç´…è‰²è­¦å ±", "æµ·å³½å°é–é–‹å§‹ï¼é€²å£ä¸­æ–·ï¼Œè«‹æ’é 11 å¤©ã€‚", () => ui.closeModal());
            },

            handleBlockade() {
                this.bDays--; this.consumeFuel();
                ui.floatText(`å‰© ${this.bDays} å¤©`, 'bad');
                if (this.bDays <= 0) {
                    this.blockade = false; document.body.classList.remove('crisis-mode');
                    ui.showModal("ğŸ³ï¸ å±æ©Ÿè§£é™¤", "å°é–çµæŸï¼Œå°ç£å­˜æ´»ï¼", () => ui.closeModal());
                }
                ui.updateAll();
            }
        };

        const ui = {
            switchTab(tab, isSystem = false) {
                // If tutorial active and not a system call, block tab switching
                // BUT allow unlocking after 1975 OR if step is 3 (final tutorial step before unlocking)
                if(game.tutorialStep !== 0 && !isSystem && game.year === 1975 && game.tutorialStep !== 3) return;

                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.pixel-btn').forEach(el => el.classList.remove('active'));
                document.getElementById(`tab-${tab}`).classList.add('active');
                
                const btns = document.querySelectorAll('.pixel-btn');
                // btn indices: build=0, market=1
                const btnId = tab === 'build' ? 'tab-btn-build' : 'tab-btn-market';
                document.getElementById(btnId).classList.add('active');
                
                if(game.tutorialStep === 4 && tab === 'market') {
                    setTimeout(() => ui.highlightElement('.buy-btn-mini:first-child', 'é»æ“Šè³¼è²·ï¼'), 100);
                }
            },

            highlightElement(selector, text) {
                const overlay = document.getElementById('tutorial-overlay');
                overlay.style.display = 'block';
                
                const el = document.querySelector(selector);
                if(el) {
                    el.classList.add('highlight-target');
                    
                    // FIX: Force lift bottom panel above overlay
                    const bottomPanel = el.closest('#bottom-panel');
                    if (bottomPanel) {
                        bottomPanel.style.zIndex = '2001'; 
                    }

                    // FIX: Force lift HUD if target is inside HUD
                    const hud = el.closest('#hud');
                    if(hud) {
                        hud.style.zIndex = '2001';
                    }

                    const tooltip = document.getElementById('tutorial-tooltip');
                    // Change here to include title
                    document.getElementById('tut-text').innerHTML = `<div class='tut-title'>éŠæˆ²èªªæ˜</div>${text.replace(/\n/g, '<br>')}`;
                    tooltip.style.display = 'block';
                }
            },

            clearHighlight() {
                document.getElementById('tutorial-overlay').style.display = 'none';
                document.getElementById('tutorial-tooltip').style.display = 'none';
                document.querySelectorAll('.highlight-target').forEach(el => el.classList.remove('highlight-target'));
                
                // Reset bottom panel z-index
                const bottomPanel = document.getElementById('bottom-panel');
                if(bottomPanel) bottomPanel.style.zIndex = ''; 
                
                // Reset HUD z-index
                const hud = document.getElementById('hud');
                if(hud) hud.style.zIndex = '100'; // Or just empty if default is fine, but HUD has specific style
            },

            renderDeck() {
                const buildable = Object.entries(PLANTS).filter(([k,v]) => k !== 'terminal');
                document.getElementById('build-deck').innerHTML = buildable.map(([k, v]) => {
                    let locked = false;
                    let lockReason = '';
                    let riskText = '';
                    if (k === 'nuclear') {
                        if (game.year >= 2021) { locked = true; lockReason = 'ğŸš« 2021é™å»º'; }
                        else if (game.isNukePermanentlyBanned) { locked = true; lockReason = 'â›” æ°¸ä¹…å»¢æ­¢'; }
                        else {
                            const risk = game.getNukeRisk();
                            riskText = `<div class="nuke-risk">âš ï¸ ç½ç‡:${risk}%</div>`;
                        }
                    }
                    const count = game.counts[k];
                    
                    return `
                    <div class="pixel-card ${game.selected === k ? 'selected' : ''} ${locked ? 'disabled' : ''}" onclick="game.selectCard('${k}')">
                        <div class="card-badge">${count}</div>
                        ${locked ? `<div class="lock-overlay">${lockReason}</div>` : ''}
                        ${riskText}
                        <div class="card-emoji">${v.emoji}</div>
                        <div class="card-name" style="color:${v.color}">${v.name}</div>
                        <div class="card-power">+${v.output}MW</div>
                        <div class="card-cost">$${v.cost.toLocaleString()}</div>
                    </div>
                `}).join('');
            },

            renderMarket() {
                document.getElementById('val-coal-stock').innerText = game.fuel.coal.toLocaleString();
                document.getElementById('val-gas-stock').innerText = game.fuel.gas.toLocaleString();
                
                document.getElementById('val-gas-cap').innerText = game.cap.gas.toLocaleString();
                document.getElementById('val-term-cnt').innerText = game.counts.terminal;

                document.getElementById('market-coal-list').innerHTML = MARKET_SOURCES.coal.map(src => {
                    const base = game.marketPrices['coal_'+src.id]||src.base;
                    const surge = game.purchaseCounts['coal'][src.id] || 0;
                    return `
                    <div class="market-country-row">
                        <div class="m-top"><span class="flag">${src.flag} ${src.name}</span><span class="price">$${base+surge}</span></div>
                        <button class="buy-btn-mini" onclick="game.buyFuel('coal', '${src.id}')">100å™¸ $${base+surge}</button>
                    </div>`
                }).join('');

                document.getElementById('market-gas-list').innerHTML = MARKET_SOURCES.gas.map(src => {
                    const base = game.marketPrices['gas_'+src.id]||src.base;
                    const surge = game.purchaseCounts['gas'][src.id] || 0;
                    return `
                    <div class="market-country-row">
                        <div class="m-top"><span class="flag">${src.flag} ${src.name}</span><span class="price">$${base+surge}</span></div>
                        <button class="buy-btn-mini" onclick="game.buyFuel('gas', '${src.id}')">100å™¸ $${base+surge}</button>
                    </div>`
                }).join('');
            },

            updatePieChart() {
                const pCoal = game.counts.coal * PLANTS.coal.output;
                const pGas = game.counts.gas * PLANTS.gas.output;
                const pGreen = (game.counts.green * PLANTS.green.output) + (game.counts.solar * PLANTS.solar.output);
                const pNuke = game.calcNukeOutput(); 
                const total = pCoal + pGas + pGreen + pNuke;

                // Clear previous labels inside the chart container
                const chartContainer = document.getElementById('power-pie-chart');
                // Remove all children EXCEPT the pie-center-hole (if you want to keep it, but user said remove it, wait. 
                // User said "remove data panel, text on chart".
                // I will clear everything and re-add labels.
                chartContainer.innerHTML = ''; 

                if (total === 0) {
                    chartContainer.style.background = '#444';
                    return;
                }

                // Update Gradient
                const degCoal = (pCoal / total) * 360;
                const degGas = (pGas / total) * 360;
                const degGreen = (pGreen / total) * 360;
                const degNuke = (pNuke / total) * 360;

                chartContainer.style.background = `conic-gradient(
                    var(--color-coal) 0deg ${degCoal}deg,
                    var(--color-gas) ${degCoal}deg ${degCoal + degGas}deg,
                    var(--color-nuclear) ${degCoal + degGas}deg ${degCoal + degGas + degNuke}deg,
                    var(--color-green) ${degCoal + degGas + degNuke}deg 360deg
                )`;

                // Add Labels directly on chart
                const addLabel = (name, val, startAngle, sliceAngle) => {
                    if (sliceAngle < 15) return; // Hide label if slice is too small (< ~4%)

                    const midAngle = startAngle + sliceAngle / 2;
                    // Convert to radians. Note: CSS conic gradient starts at 12 o'clock (0deg).
                    // Standard trig 0 is 3 o'clock.
                    // So 0deg CSS = -90deg Trig.
                    // angle_rad = (midAngle - 90) * (PI / 180)
                    const rad = (midAngle - 90) * (Math.PI / 180);
                    
                    // Radius is 75px (150px width / 2). Let's place label at r=45px (60%)
                    const r = 45;
                    const x = 75 + r * Math.cos(rad);
                    const y = 75 + r * Math.sin(rad);

                    const label = document.createElement('div');
                    label.className = 'chart-label';
                    // Use CSS to position center of label at x,y
                    label.style.left = `${x}px`;
                    label.style.top = `${y}px`;
                    
                    // NEW: One decimal place for pie chart labels
                    const pct = (val / total * 100).toFixed(1);
                    label.innerHTML = `<span>${name}</span>${pct}%`;
                    chartContainer.appendChild(label);
                };

                let currentAngle = 0;
                
                // Coal
                if (pCoal > 0) {
                    const slice = (pCoal / total) * 360;
                    addLabel('ç…¤', pCoal, currentAngle, slice);
                    currentAngle += slice;
                }
                
                // Gas
                if (pGas > 0) {
                    const slice = (pGas / total) * 360;
                    addLabel('æ°£', pGas, currentAngle, slice);
                    currentAngle += slice;
                }

                // Nuclear
                if (pNuke > 0) {
                    const slice = (pNuke / total) * 360;
                    addLabel('æ ¸', pNuke, currentAngle, slice);
                    currentAngle += slice;
                }

                // Green
                if (pGreen > 0) {
                    const slice = (pGreen / total) * 360;
                    addLabel('å†ç”Ÿ', pGreen, currentAngle, slice);
                    currentAngle += slice;
                }
            },

            updateAll() {
                document.getElementById('map-year-display').innerText = "ç¬¬ " + game.year + " å¹´";
                document.getElementById('hud-funds').innerText = game.funds.toLocaleString();
                document.getElementById('hud-comp').innerText = game.comp + '%';
                
                const days = game.getSafetyDays();
                if (days === null || days > 999) {
                     document.getElementById('hud-days').innerText = "--";
                     document.getElementById('hud-days').className = `stat-val`;
                } else {
                     document.getElementById('hud-days').innerText = (days > 99 ? 'å……è¶³' : days + 'å¤©');
                     document.getElementById('hud-days').className = `stat-val ${days < 14 ? 'red' : ''}`;
                }

                document.getElementById('stat-supply').innerText = game.calcPower().toLocaleString() + " MW";
                document.getElementById('stat-demand').innerText = game.demand.toLocaleString() + " MW";
                
                const cDays = game.getCoalDays();
                document.getElementById('stat-coal-days').innerText = (cDays === null ? '--' : (cDays > 99 ? 'âˆ' : cDays + 'å¤©'));
                
                const gDays = game.getGasDays();
                document.getElementById('stat-gas-days').innerText = (gDays === null ? '--' : (gDays > 99 ? 'âˆ' : gDays + 'å¤©'));

                if (!game.isFreePlay) {
                    const s = STAGES[game.stageIdx];
                    document.getElementById('story-text').innerText = s.short;
                    document.getElementById('goal-list').innerHTML = s.goals.map(g => `
                        <div class="goal-item"><span class="goal-check ${g.check(game) ? 'done' : ''}">${g.check(game) ? 'âœ…' : 'â¬œ'}</span> <span>${g.txt}</span></div>
                    `).join('');
                } else {
                    document.getElementById('story-text').innerText = "è‡ªç”±åŸ·æ”¿æ¨¡å¼";
                    document.getElementById('goal-list').innerHTML = "<div class='goal-item'>ç¶­æŒç«¶çˆ­åŠ› > 0%</div>";
                }

                if (game.blockade) {
                    document.getElementById('next-btn').innerHTML = `æ’ä½<br>${game.bDays}å¤©`;
                    document.getElementById('next-btn').style.background = '#000';
                } else {
                    // Update next btn innerHTML, but keep help btn
                    document.getElementById('next-btn').innerHTML = `ä¸‹ä¸€<br>å¹´åº¦`;
                    document.getElementById('next-btn').style.background = 'var(--accent-red)';
                }
                
                this.updatePieChart();
                this.renderMarket();
                this.renderDeck();
            },

            floatText(txt, type) {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                el.className = `toast-msg ${type || ''}`;
                
                if(type === 'good') el.innerHTML = `<span>${txt}</span> <span>ğŸ’°</span>`;
                if(type === 'bad') el.innerHTML = `<span>${txt}</span> <span>âš ï¸</span>`;
                if(!type) el.innerText = txt; 

                container.prepend(el);

                if (container.children.length > 6) {
                     const oldest = container.lastElementChild;
                     if(oldest) oldest.remove(); 
                }

                // Faster remove
                setTimeout(() => {
                    el.classList.add('hiding'); 
                    el.addEventListener('transitionend', () => el.remove()); 
                }, 1200); 
            },

            swapModal(title, desc, callback) {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-content-area').innerHTML = `<p id="modal-desc" style="font-size:14px; line-height:1.6; color:#ddd; margin:15px 0;">${desc}</p>`;
                
                const btn = document.getElementById('modal-btn');
                btn.innerText = "ç¢º å®š";
                // Update click handler directly
                btn.onclick = callback ? callback : ui.closeModal;
                
                // Ensure it's visible (if swapping from closed state, though typical usage is open->open)
                document.getElementById('modal-overlay').style.display = 'flex';
            },

            showTurnReport(year, income, compDetails, totalFunds, totalComp, events) {
                document.getElementById('modal-title').innerText = `ğŸ“… å¹´åº¦å ±å‘Š (${year})`;
                
                let compHtml = compDetails.map(d => {
                    const isNeg = d.includes('-');
                    return `<div style="color:${isNeg ? '#e74c3c' : '#2ecc71'}">${d}</div>`;
                }).join('');
                
                let eventHtml = '';
                if(events && events.length > 0) {
                    eventHtml = `
                    <div class="report-section">
                        <div class="report-title" style="color:var(--accent-red)">âš ï¸ é‡å¤§äº‹ä»¶</div>
                        ${events.map(e => `<div style="color:#fff; font-size:14px; margin-bottom:4px;">${e}</div>`).join('')}
                    </div>`;
                }

                const html = `
                    <div class="report-section">
                        <div class="report-title">ğŸ’° è²¡æ”¿æ”¶æ”¯</div>
                        <div class="report-val">
                            <span>æœ¬æœŸæ”¶å…¥</span>
                            <span style="color:var(--accent-gold)">+$${income.toLocaleString()}</span>
                        </div>
                    </div>

                    <div class="report-section">
                        <div class="report-title">ğŸ“Š ç«¶çˆ­åŠ›è©•ä¼°</div>
                        <div class="report-val">
                            <span>ç•¶å‰æŒ‡æ•¸</span>
                            <span style="color:var(--accent-blue)">${totalComp}%</span>
                        </div>
                        <div class="report-detail">
                            ${compHtml || '<div style="color:#888">ç„¡é¡¯è‘—è®ŠåŒ–</div>'}
                        </div>
                    </div>
                    
                    ${eventHtml}
                `;

                document.getElementById('modal-content-area').innerHTML = html;
                
                const btn = document.getElementById('modal-btn');
                btn.innerText = "ç¢º å®š";
                btn.onclick = ui.closeModal;
                btn.className = 'retro-btn';
                document.getElementById('modal-overlay').style.display = 'flex';
            },

            showModal(title, desc, callback) {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-content-area').innerHTML = `<p id="modal-desc" style="font-size:14px; line-height:1.6; color:#ddd; margin:15px 0;">${desc}</p>`;
                
                const btn = document.getElementById('modal-btn');
                btn.innerText = "ç¢º å®š";
                btn.onclick = callback ? callback : ui.closeModal;
                btn.className = 'retro-btn';
                document.getElementById('modal-overlay').style.display = 'flex';
            },
            
            showCompHelp() {
                let stockRule = '';
                if (game.stageIdx >= 2) {
                    stockRule = `<div class="rule-item"><span>ğŸ“‰ ä½åº«å­˜(&lt;7å¤©)</span><span style="color:#e74c3c">æ¯é …-10%</span></div>`;
                }

                ui.showModal("ç«¶çˆ­åŠ›èªªæ˜", `
                    <div class="rule-list">
                        <div class="rule-title">è©•åˆ†è¦å‰‡</div>
                        <div class="rule-item"><span>âš¡ ä¾›é›»å……è¶³</span><span style="color:#2ecc71">+5%</span></div>
                        <div class="rule-item"><span>âš¡ ä¾›é›»ä¸è¶³</span><span style="color:#e74c3c">-15%</span></div>
                        ${stockRule}
                        <div class="rule-item"><span>â˜ ï¸ åº«å­˜è€—ç›¡(0å¤©)</span><span style="color:#e74c3c">ç›´æ¥å¤±æ•—</span></div>
                    </div>
                `);
            },

            showFundsHelp() {
                ui.showModal("å·¥æ¥­ç¨…æ”¶èªªæ˜", `
                    <div class="rule-list">
                        <div class="rule-title">è¨ˆç®—å…¬å¼</div>
                        <div class="rule-item"><span>ğŸ’° åŸºç¤ç¨…æ”¶</span><span>$${game.stageIdx===0?500:(game.stageIdx===1?1000:2000)}</span></div>
                        <div class="rule-item"><span>âš¡ å·¥æ¥­ç¨…æ”¶</span><span>+$${Math.floor(game.calcPower(true)*0.4).toLocaleString()}</span></div>
                        <div class="rule-item" style="border-top:1px solid #fff; margin-top:5px; padding-top:5px;">
                            <span>é è¨ˆä¸‹å¹´æ”¶å…¥</span><span style="color:#f1c40f">$${game.calcIncome().toLocaleString()}</span>
                        </div>
                        <div style="font-size:10px; color:#888; margin-top:5px;">(å…¬å¼ï¼šç™¼é›»é‡ x 0.4 + åŸºç¤ç¨…)</div>
                    </div>
                `);
            },

            showStockHelp() {
                const cDays = game.getCoalDays();
                const gDays = game.getGasDays();
                
                ui.showModal("å­˜é‡èªªæ˜", `
                    <div class="rule-list">
                        <div class="rule-title">ç›®å‰å¯æ”¯æ’å¤©æ•¸</div>
                        <div class="rule-item"><span>ğŸª¨ ç…¤ç‚­</span><span>${cDays===null?'--':(cDays>99?'âˆ':cDays+' å¤©')}</span></div>
                        <div class="rule-item"><span>ğŸ”¥ å¤©ç„¶æ°£</span><span>${gDays===null?'--':(gDays>99?'âˆ':gDays+' å¤©')}</span></div>
                        <div style="margin-top:10px; font-size:11px; color:#aaa; line-height:1.4;">
                            æ¶ˆè€—å…¬å¼ï¼š<br>
                            ç‡ƒç…¤æ¶ˆè€— = é›»å» æ•¸ x ${PLANTS.coal.fuel}<br>
                            ç‡ƒæ°£æ¶ˆè€— = é›»å» æ•¸ x ${PLANTS.gas.fuel}<br>
                            å¤©æ•¸ = åº«å­˜ / å¹´æ¶ˆè€—<br>
                            <span style="color:#e74c3c">*å°é–æœŸé–“ç„¡æ³•é€²å£ï¼Œéœ€é å­˜é‡æ’é11å¤©ã€‚</span>
                        </div>
                    </div>
                `);
            },

            showGameOver(reason) {
                document.getElementById('modal-title').innerText = "åœ‹å®¶ç ´ç”¢";
                document.getElementById('modal-content-area').innerHTML = `<p style="color:#e74c3c">${reason || 'é›»åŠ›ä¸ç©©å°è‡´ç”¢æ¥­å¤–ç§»ï¼Œç«¶çˆ­åŠ›æ­¸é›¶ã€‚'}</p>`;
                
                const btn = document.getElementById('modal-btn');
                btn.innerText = "ğŸ”„ é‡æ–°é–‹å§‹";
                btn.classList.add('restart');
                btn.onclick = () => game.restart();
                document.getElementById('modal-overlay').style.display = 'flex';
            },

            showVictory() {
                document.getElementById('modal-title').innerText = "ğŸ† èƒ½æºè½‰å‹æˆåŠŸï¼";
                
                let maxPower = 0;
                game.history.forEach(h => {
                    const total = h.coal + h.gas + h.nuclear + h.green;
                    if(total > maxPower) maxPower = total;
                });
                
                const startYear = game.history[0].year;
                const endYear = game.history[game.history.length-1].year;
                const duration = game.history.length - 1;
                
                let paths = { coal: "M0,200 ", gas: "M0,200 ", nuke: "M0,200 ", green: "M0,200 " };
                
                const lastH = game.history[game.history.length-1];
                const lastTotal = lastH.coal + lastH.gas + lastH.nuclear + lastH.green;
                const pcts = {
                    coal: Math.round(lastH.coal/lastTotal*100),
                    gas: Math.round(lastH.gas/lastTotal*100),
                    nuke: Math.round(lastH.nuclear/lastTotal*100),
                    green: Math.round(lastH.green/lastTotal*100)
                };

                game.history.forEach((h, i) => {
                    const x = (i / duration) * 400;
                    
                    const hCoal = (h.coal / maxPower) * 180;
                    const hGas = (h.coal + h.gas) / maxPower * 180;
                    const hNuke = (h.coal + h.gas + h.nuclear) / maxPower * 180;
                    const hGreen = (h.coal + h.gas + h.nuclear + h.green) / maxPower * 180;
                    
                    paths.coal += `L${x},${200 - hCoal} `;
                    paths.gas += `L${x},${200 - hGas} `;
                    paths.nuke += `L${x},${200 - hNuke} `;
                    paths.green += `L${x},${200 - hGreen} `;
                });
                
                const closePath = `L400,200 L0,200 Z`;

                let xAxisLabels = "";
                for(let i=0; i <= duration; i++) {
                    const currentY = startYear + i;
                    if(currentY % 5 === 0 || i === 0 || i === duration) {
                        const x = (i / duration) * 400;
                        let textAnchor = "middle";
                        if(i===0) textAnchor = "start";
                        if(i===duration) textAnchor = "end";
                        xAxisLabels += `<text x="${x}" y="215" fill="#aaa" font-size="12" text-anchor="${textAnchor}">${currentY}</text>`;
                    }
                }

                const getRank = (obj) => Object.entries(obj)
                    .sort((a,b) => b[1] - a[1])
                    .map(e => {
                        const name = MARKET_SOURCES.coal.find(x=>x.id==e[0])?.name || MARKET_SOURCES.gas.find(x=>x.id==e[0])?.name || e[0];
                        const flag = MARKET_SOURCES.coal.find(x=>x.id==e[0])?.flag || MARKET_SOURCES.gas.find(x=>x.id==e[0])?.flag || '';
                        return `<div class="rank-item"><span>${flag} ${name}</span><span>${e[1]}00å™¸</span></div>`;
                    }).join('');

                const finalHTML = `
                    <p style="color:#2ecc71; margin-bottom:10px;">æ‚¨å»ºç«‹äº†é«˜éŸŒæ€§çš„é›»åŠ›ç³»çµ±ï¼</p>
                    
                    <div class="chart-container">
                        <div class="chart-title">ğŸ“ˆ ç™¼é›»çµæ§‹å †ç–Šåœ– (ç¸½: ${game.calcPower().toLocaleString()} MW)</div>
                        <svg viewBox="0 0 400 220" style="background:#222; width:100%; height:auto;">
                            <path d="${paths.green + closePath}" fill="#2ecc71" />
                            <path d="${paths.nuke + closePath}" fill="#8e44ad" />
                            <path d="${paths.gas + closePath}" fill="#d35400" />
                            <path d="${paths.coal + closePath}" fill="#7f8c8d" />
                            ${xAxisLabels}
                        </svg>
                        <div class="chart-legend">
                            <div class="legend-item"><span class="color-box" style="background:#7f8c8d"></span>ç…¤ ${pcts.coal}%</div>
                            <div class="legend-item"><span class="color-box" style="background:#d35400"></span>æ°£ ${pcts.gas}%</div>
                            <div class="legend-item"><span class="color-box" style="background:#8e44ad"></span>æ ¸ ${pcts.nuke}%</div>
                            <div class="legend-item"><span class="color-box" style="background:#2ecc71"></span>ç¶  ${pcts.green}%</div>
                        </div>
                    </div>

                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <div style="flex:1;">
                            <div class="chart-title">ğŸª¨ ç…¤ç‚­é€²å£æ’è¡Œ</div>
                            <div class="rank-list">${getRank(game.importStats.coal)}</div>
                        </div>
                        <div style="flex:1;">
                            <div class="chart-title">ğŸ”¥ å¤©ç„¶æ°£é€²å£æ’è¡Œ</div>
                            <div class="rank-list">${getRank(game.importStats.gas)}</div>
                        </div>
                    </div>
                `;

                document.getElementById('modal-content-area').innerHTML = finalHTML;
                
                const btn = document.getElementById('modal-btn');
                btn.innerText = "ç¹¼çºŒåŸ·æ”¿";
                btn.className = 'retro-btn victory';
                btn.onclick = () => {
                    game.isFreePlay = true;
                    ui.closeModal();
                };
                
                const contentArea = document.querySelector('.retro-inner');
                if(!contentArea.querySelector('.restart')) {
                    const restartBtn = document.createElement('button');
                    restartBtn.className = 'retro-btn restart';
                    restartBtn.innerText = "ğŸ”„ é‡æ–°æŒ‘æˆ°";
                    restartBtn.style.marginTop = '10px';
                    restartBtn.onclick = () => game.restart();
                    contentArea.appendChild(restartBtn);
                }
                
                document.getElementById('modal-overlay').style.display = 'flex';
            },

            closeModal() { 
                document.getElementById('modal-overlay').style.display = 'none'; 
                document.getElementById('modal-content-area').innerHTML = '<p id="modal-desc" style="font-size:14px; line-height:1.6; color:#ddd; margin:15px 0;">CONTENT</p>';
                const btn = document.getElementById('modal-btn');
                btn.className = 'retro-btn';
                
                const restartBtn = document.querySelector('.retro-btn.restart');
                if(restartBtn) restartBtn.remove();
            }
        };

        game.init();
    </script>
</body>
</html>
