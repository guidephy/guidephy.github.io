<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>‚ö° ÂÉèÁ¥†ËÉΩÊ∫êÔºöÊ±∫Êà∞Âè∞ÁÅ£ v22</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Noto+Sans+TC:wght@500;900&display=swap');

        :root {
            --bg-ocean: #2c3e50;
            --land-green: #27ae60;
            --land-border: #145a32;
            --ui-bg: #212529;
            --ui-border: #95a5a6;
            --accent-blue: #3498db;
            --accent-gold: #f1c40f;
            --accent-red: #e74c3c;
            --text-white: #ecf0f1;
            
            --color-coal: #7f8c8d;
            --color-gas: #d35400;
            --color-green: #2ecc71;
            --color-solar: #f39c12;
            --color-nuclear: #8e44ad;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; user-select: none; }
        
        body {
            font-family: 'Noto Sans TC', monospace;
            background-color: var(--bg-ocean);
            background-image: 
                linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            
            width: 100vw;
            height: 100dvh;
            overflow: hidden;
            color: var(--text-white);
            display: flex;
            flex-direction: column;
            image-rendering: pixelated;
        }

        /* === HUD === */
        #hud {
            flex: 0 0 auto;
            background: var(--ui-bg);
            border-bottom: 4px solid var(--ui-border);
            padding: 8px 4px;
            padding-top: max(8px, env(safe-area-inset-top)); 
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            z-index: 100;
        }
        .stat-box { position: relative; text-align: center; border: 2px solid #555; background: #000; padding: 4px 2px; }
        .stat-label { font-size: 11px; color: #aaa; display: block; margin-bottom: 2px; }
        .stat-val { font-family: 'VT323', monospace; font-size: 22px; color: #fff; font-weight: bold; line-height: 1; }
        .stat-val.gold { color: var(--accent-gold); }
        .stat-val.blue { color: var(--accent-blue); }
        .stat-val.red { color: var(--accent-red); animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        .help-btn {
            position: absolute; top: 0; right: 0;
            color: #000; background: var(--accent-gold); 
            font-size: 12px; font-weight: bold; cursor: pointer;
            width: 14px; height: 14px; line-height: 14px;
            text-align: center; border-bottom-left-radius: 4px;
        }

        /* === Info Panels === */
        .info-panel {
            position: absolute; top: 80px; width: 140px;
            background: rgba(33, 37, 41, 0.95); padding: 8px; z-index: 90;
            box-shadow: 4px 4px 0px #000; pointer-events: none; border-radius: 2px;
        }
        #story-panel { left: 10px; border: 3px solid var(--ui-border); }
        #goal-panel { right: 10px; border: 3px solid var(--accent-blue); }
        
        .pixel-title { 
            font-size: 13px; color: var(--accent-gold); border-bottom: 2px dashed #555;
            padding-bottom: 4px; margin-bottom: 4px; font-weight: 900;
        }
        .pixel-text { font-size: 12px; line-height: 1.4; color: #ddd; }
        .goal-item { font-size: 11px; margin-bottom: 4px; border-bottom: 1px solid #444; padding-bottom: 2px; }
        .goal-check.done { color: var(--land-green); font-weight:bold; }

        /* === Map Stage === */
        #game-stage {
            flex: 1; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; width: 100%;
        }
        #map-container { position: relative; width: 100%; height: 100%; }

        #taiwan-svg {
            width: 100%; height: 100%;
            filter: drop-shadow(6px 6px 0px rgba(0,0,0,0.5));
            overflow: visible;
        }
        .map-path { fill: var(--land-green); stroke: var(--land-border); stroke-width: 3px; }

        #power-pie-chart {
            position: absolute;
            top: 40%; left: 55%;
            transform: translate(-50%, -50%);
            width: 90px; height: 90px;
            border-radius: 50%;
            background: #444;
            border: 3px solid #fff;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.5);
            z-index: 50; pointer-events: none;
            transition: background 0.5s ease;
        }
        #pie-label {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); color: #fff; padding: 3px 6px;
            font-size: 11px; border-radius: 3px; white-space: nowrap;
        }
        /* ÈÅäÊà≤‰∏≠ÂúìÈ§ÖÂúñÁöÑÂúñ‰æã */
        #pie-legend-box {
            position: absolute; top: 52%; left: 55%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); padding: 4px; border-radius: 4px;
            display: flex; gap: 6px; pointer-events: none; z-index: 50;
            white-space: nowrap;
        }
        .ingame-legend-item { display: flex; align-items: center; gap: 2px; font-size: 10px; color: #fff; }
        .dot { width: 6px; height: 6px; border-radius: 50%; }

        #map-data-overlay {
            position: absolute;
            bottom: 10px; left: 10px;   
            background: rgba(10, 10, 10, 0.95);
            border: 2px solid #fff;
            padding: 8px;
            width: 140px;
            z-index: 95;
            pointer-events: none;
            box-shadow: 4px 4px 0px #000;
        }
        .data-row { font-size: 12px; color: #ccc; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center;}
        .data-val { color: #fff; font-weight: bold; font-family: 'VT323', monospace; font-size: 16px; }
        .data-sep { border-top: 1px dashed #555; margin: 5px 0; }

        /* === Bottom Panel === */
        #bottom-panel {
            flex: 0 0 auto; 
            background: var(--ui-bg); 
            border-top: 4px solid var(--ui-border);
            height: 260px; 
            padding: 10px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            display: flex; flex-direction: column; z-index: 100;
        }
        .arcade-tabs { display: flex; gap: 8px; margin-bottom: 8px; flex-shrink: 0; }
        .pixel-btn {
            flex: 1; background: #444; border: 2px solid #fff; color: #fff;
            padding: 8px; font-weight: bold; font-size: 15px;
            box-shadow: 3px 3px 0px #000; cursor: pointer; text-align: center;
        }
        .pixel-btn.active { background: var(--accent-blue); transform: translate(2px, 2px); box-shadow: 1px 1px 0px #000; }
        
        .tab-content { display: none; flex: 1; overflow: hidden; flex-direction: column; }
        .tab-content.active { display: flex; }

        /* Build Deck */
        #build-deck { display: flex; gap: 4px; flex: 1; width: 100%; }
        .pixel-card {
            flex: 1; position: relative;
            background: #333; border: 2px solid #888;
            box-shadow: 2px 2px 0px #000; padding: 2px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: space-around;
            min-width: 0;
        }
        .pixel-card.selected { background: #555; border-color: var(--accent-gold); transform: translateY(-3px); }
        .pixel-card.disabled { opacity: 0.5; filter: grayscale(1); background: #222; }
        
        .card-emoji { font-size: 26px; }
        .card-name { font-size: 12px; text-align: center; white-space: nowrap; color: #fff; font-weight: bold; }
        .card-power { font-family:'VT323'; color:var(--accent-blue); font-size:15px; font-weight: bold; }
        .card-cost { font-family:'VT323'; color:var(--accent-gold); font-size:20px; font-weight: bold; }
        
        .card-badge {
            position: absolute; top: -4px; right: -4px;
            background: var(--accent-gold); color: #000;
            border: 2px solid #fff; border-radius: 4px;
            font-family: 'VT323', monospace; font-size: 16px; font-weight: bold;
            padding: 0 5px; box-shadow: 2px 2px 0px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .nuke-risk {
            position: absolute; bottom: 2px; width: 100%; text-align: center;
            font-size: 10px; color: var(--accent-red); font-weight: bold; background: rgba(0,0,0,0.6);
        }

        .lock-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.7);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #fff; font-size: 12px; font-weight: bold; z-index: 5; text-align: center;
        }

        .build-hint {
            font-size: 11px; color: #888; text-align: center; 
            padding-top: 6px; border-top: 1px solid #444; margin-top: 6px; flex-shrink: 0;
        }

        /* Market */
        #market-container { display: flex; gap: 8px; height: 100%; width: 100%; }
        .market-col {
            flex: 1; display: flex; flex-direction: column;
            background: #111; border: 1px solid #444; padding: 0; border-radius: 4px;
            height: 100%; 
            overflow-y: auto; position: relative;
            -webkit-overflow-scrolling: touch;
        }
        .market-header { 
            font-size: 13px; color: var(--accent-gold); text-align: center; 
            background: #222; border-bottom: 1px solid #555; padding: 6px; 
            position: sticky; top: 0; z-index: 10;
        }
        .market-country-row {
            display: flex; flex-direction: column; background: #222; border: 1px solid #555; 
            padding: 6px; margin: 4px;
        }
        .m-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .flag { font-size: 14px; color:#fff; }
        .price { color: #fff; font-family: 'VT323'; font-size: 18px; font-weight: bold; color: var(--accent-gold); }
        .buy-btn-mini {
            width: 100%; background: var(--land-green); border: 1px solid #fff; color: white;
            padding: 4px; font-size: 12px; cursor: pointer; text-align: center; font-weight: bold;
        }
        .buy-btn-mini:active { background: #fff; color: #000; }

        .terminal-build-area {
            background: #2c3e50; border: 1px solid var(--accent-blue);
            padding: 8px; margin: 4px; text-align: center;
        }
        .terminal-info { font-size: 11px; color: #aec6cf; margin-bottom: 4px; }
        .build-term-btn {
            background: var(--accent-blue); color: #fff; border: 1px solid #fff;
            width: 100%; padding: 6px; font-size: 13px; cursor: pointer; font-weight: bold;
        }

        /* Next Button */
        #next-btn {
            position: fixed;
            bottom: calc(270px + env(safe-area-inset-bottom)); 
            right: 15px;
            width: 80px; height: 80px;
            background: var(--accent-red);
            border: 4px solid #fff; border-radius: 50%;
            box-shadow: 5px 5px 0px #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 150; cursor: pointer;
            font-size: 14px; font-weight: bold; text-align: center; line-height: 1.2;
            animation: pulse-btn 1.5s infinite;
        }
        #next-btn:active { transform: scale(0.95); box-shadow: 2px 2px 0px #000; }
        @keyframes pulse-btn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Tutorial & Highlights */
        #tutorial-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 900;
            display: none; cursor: pointer;
        }
        .highlight-target {
            z-index: 901 !important;
            position: relative !important;
            box-shadow: 0 0 0 4px var(--accent-gold), 0 0 20px var(--accent-gold) !important;
            transition: all 0.3s;
        }
        #tutorial-tooltip {
            position: fixed; bottom: 350px; left: 50%; transform: translateX(-50%);
            background: #fff; color: #000; padding: 15px; border-radius: 10px;
            font-weight: bold; z-index: 902; display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            text-align: center; width: 80%;
            animation: floatTooltip 1s infinite alternate;
        }
        @keyframes floatTooltip { from { transform: translate(-50%, 0); } to { transform: translate(-50%, -10px); } }
        .tut-next { font-size: 10px; color: #666; margin-top: 5px; }

        /* Modal */
        #modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000;
            display: none; justify-content: center; align-items: center; padding: 20px;
        }
        .retro-dialog { 
            background: var(--accent-blue); border: 4px solid #fff; padding: 4px; 
            width: 95%; max-width: 360px; max-height: 85vh;
            box-shadow: 8px 8px 0px #000;
            display: flex; flex-direction: column;
        }
        .retro-inner { 
            background: var(--ui-bg); border: 2px solid #000; padding: 20px; text-align: center;
            overflow-y: auto;
        }
        .retro-btn { margin-top: 15px; background: #000; color: #fff; border: 2px solid #fff; padding: 10px 30px; cursor: pointer; font-size: 16px; width: 100%;}
        .retro-btn.restart { background: var(--accent-red); color: #fff; border-color: #fff; }
        .retro-btn.victory { background: var(--accent-gold); color: #000; border-color: #fff; }

        .float-pixel {
            position: fixed; font-family: 'VT323', monospace; font-size: 28px; font-weight: bold;
            text-shadow: 2px 2px 0px #000; pointer-events: none; z-index: 300;
            animation: floatPixel 1.2s steps(8) forwards;
        }
        @keyframes floatPixel { 0%{transform:translate(-50%,0);} 100%{transform:translate(-50%,-60px); opacity: 0;} }
        .crisis-mode { filter: sepia(100%) hue-rotate(-50deg) saturate(300%); }
        
        .rule-list { text-align: left; font-size: 14px; color: #ccc; margin: 10px 0; border: 1px solid #555; padding: 10px; background: #222; }
        .rule-item { display: flex; justify-content: space-between; margin-bottom: 6px; border-bottom: 1px solid #333; padding-bottom: 2px;}
        .rule-title { font-weight: bold; color: var(--accent-gold); margin-bottom: 5px; text-align: center;}

        .chart-container { margin: 15px 0; border: 1px solid #555; background: #111; padding: 5px; }
        .chart-title { font-size: 12px; color: #aaa; margin-bottom: 5px; text-align: left; }
        .chart-legend { display: flex; flex-wrap: wrap; gap: 8px; font-size: 10px; justify-content: center; margin-top: 5px;}
        .legend-item { display: flex; align-items: center; gap: 3px; }
        .color-box { width: 8px; height: 8px; border: 1px solid #fff; }
        .rank-list { text-align: left; font-size: 11px; color:#ddd; margin-top: 5px; }
        .rank-item { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 2px 0;}
    </style>
</head>
<body>

    <div id="tutorial-overlay" onclick="game.nextTutorialStep()"></div>
    <div id="tutorial-tooltip">
        <div id="tut-text"></div>
        <div class="tut-next">‚ñº ÈªûÊìäÁï´Èù¢ÁπºÁ∫å</div>
    </div>

    <div id="hud">
        <div class="stat-box"><span class="stat-label">Ë•øÂÖÉ</span><span class="stat-val" id="hud-year">1975</span></div>
        <div class="stat-box">
            <span class="stat-label">Ë≥áÈáë</span>
            <span class="stat-val gold" id="hud-funds">5,000</span>
            <div class="help-btn" onclick="ui.showFundsHelp()">?</div>
        </div>
        <div class="stat-box">
            <span class="stat-label">Á´∂Áà≠Âäõ</span>
            <span class="stat-val blue" id="hud-comp">100%</span>
            <div class="help-btn" onclick="ui.showCompHelp()">?</div>
        </div>
        <div class="stat-box">
            <span class="stat-label">Â≠òÈáè</span>
            <span class="stat-val" id="hud-days">30Â§©</span>
            <div class="help-btn" onclick="ui.showStockHelp()">?</div>
        </div>
    </div>

    <div id="story-panel" class="info-panel">
        <div class="pixel-title">‰ªªÂãôÁ∞°Â†±</div>
        <div class="pixel-text" id="story-text">...</div>
    </div>
    <div id="goal-panel" class="info-panel">
        <div class="pixel-title" style="color:var(--accent-blue)">ÈöéÊÆµÁõÆÊ®ô</div>
        <div id="goal-list"></div>
    </div>

    <div id="game-stage">
        <div id="map-container">
            <svg id="taiwan-svg" viewBox="0 0 320 480">
                <path class="map-path" d="
                    M 210 30 
                    C 230 35, 250 50, 260 80
                    C 275 120, 270 180, 265 220
                    C 260 270, 240 320, 220 370
                    C 200 420, 185 450, 175 460
                    L 165 455
                    C 110 420, 60 350, 50 250  
                    C 45 180, 75 120, 100 80
                    C 140 50, 170 30, 210 30 Z
                "/>
            </svg>
            
            <div id="power-pie-chart">
                <div id="pie-label">ÁôºÈõªÂç†ÊØî</div>
            </div>
            
            <div id="pie-legend-box">
                <div class="ingame-legend-item"><span class="dot" style="background:var(--color-coal)"></span>ÁÖ§</div>
                <div class="ingame-legend-item"><span class="dot" style="background:var(--color-gas)"></span>Ê∞£</div>
                <div class="ingame-legend-item"><span class="dot" style="background:var(--color-nuclear)"></span>Ê†∏</div>
                <div class="ingame-legend-item"><span class="dot" style="background:var(--color-green)"></span>Á∂†</div>
            </div>

            <div id="buildings-layer"></div>

            <div id="map-data-overlay">
                <div class="data-row"><span>Á∏ΩÁôºÈõª</span><span class="data-val" id="stat-supply">0 MW</span></div>
                <div class="data-row"><span>Á∏ΩÈúÄÊ±Ç</span><span class="data-val" id="stat-demand">0 MW</span></div>
                <div class="data-sep"></div>
                <div class="data-row"><span>ÁÖ§Â≠òÈáè</span><span class="data-val" id="stat-coal-days" style="color:#aaa">‚àû</span></div>
                <div class="data-row"><span>Ê∞£Â≠òÈáè</span><span class="data-val blue" id="stat-gas-days">‚àû</span></div>
            </div>
        </div>
    </div>

    <div id="next-btn" onclick="game.nextTurn()">‰∏ã‰∏Ä<br>Âπ¥Â∫¶</div>

    <div id="bottom-panel">
        <div class="arcade-tabs">
            <button class="pixel-btn active" onclick="ui.switchTab('build')">üî® Âª∫Ë®≠</button>
            <button class="pixel-btn" onclick="ui.switchTab('market')">üö¢ ÁáÉÊñôÂ∏ÇÂ†¥</button>
        </div>

        <div id="tab-build" class="tab-content active">
            <div id="build-deck"></div>
            <div class="build-hint">ÈªûÊìäÂç°ÁâáÁ≥ªÁµ±Â∞áËá™ÂãïÈÅ∏ÂùÄÂª∫Ë®≠</div>
        </div>

        <div id="tab-market" class="tab-content">
            <div id="market-container">
                <div class="market-col">
                    <div class="market-header">ü™® ÁÖ§ (Â≠ò:<span id="val-coal-stock">0</span>)</div>
                    <div class="market-list" id="market-coal-list"></div>
                </div>
                <div class="market-col">
                    <div class="market-header">üî• Ê∞£ (Â≠ò:<span id="val-gas-stock">0</span>)</div>
                    <div class="terminal-build-area">
                        <div class="terminal-info">‰∏äÈôê: <span id="val-gas-cap">0</span> | Â∑≤Êúâ <span id="val-term-cnt">0</span> Â∫ß</div>
                        <button class="build-term-btn" onclick="game.buildTerminal()">Êñ∞Âª∫Êé•Êî∂Á´ô ($1000)</button>
                    </div>
                    <div class="market-list" id="market-gas-list"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-overlay">
        <div class="retro-dialog">
            <div class="retro-inner">
                <div class="retro-title" id="modal-title">TITLE</div>
                <div id="modal-content-area">
                    <p id="modal-desc" style="font-size:14px; line-height:1.6; color:#ddd; margin:15px 0;">CONTENT</p>
                </div>
                <div id="modal-footer">
                    <button class="retro-btn" id="modal-btn" onclick="ui.closeModal()">Á¢∫ ÂÆö</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ÁáÉÊñôÈúÄÊ±ÇÊ∏õÂçä: ÁÖ§ 40, Ê∞£ 30
        const PLANTS = {
            coal: { name: 'ÁáÉÁÖ§', emoji: 'üè≠', cost: 1000, output: 1500, fuel: 40, type: 'land', color: '#7f8c8d' },
            gas: { name: 'ÁáÉÊ∞£', emoji: 'üî•', cost: 1500, output: 2500, fuel: 30, type: 'land', color: '#d35400' },
            terminal: { name: 'Êé•Êî∂Á´ô', emoji: '‚öì', cost: 2000, output: 0, fuel: 0, type: 'coast', color: '#2980b9' },
            green: { name: 'È¢®Èõª', emoji: 'üåÄ', cost: 3000, output: 100, fuel: 0, type: 'sea', color: '#2ecc71' },
            solar: { name: 'Â§™ÈôΩËÉΩ', emoji: '‚òÄÔ∏è', cost: 1200, output: 50, fuel: 0, type: 'land', color: '#f39c12' },
            nuclear: { name: 'Ê†∏ËÉΩ', emoji: '‚ò¢Ô∏è', cost: 5000, output: 6000, fuel: 0, type: 'land', color: '#8e44ad' }
        };

        const STAGES = [
            {
                title: "ÈöéÊÆµ‰∏ÄÔºöÂü∫Á§éÂª∫Ë®≠",
                desc: "ÁôºÂ±ïÂàùÊúüÔºåÂçÅÂ§ßÂª∫Ë®≠ÂïüÂãï„ÄÇË´ãÂª∫Ë®≠ÈõªÂª†ÔºåÊªøË∂≥Â∑•Ê•≠ÁôºÂ±ïÁöÑÈõªÂäõÈúÄÊ±Ç„ÄÇ",
                goals: [
                    { txt: "ÁôºÈõªÈáè > 12000MW", check: g => g.calcPower() >= 12000 },
                    { txt: "ÁáÉÁÖ§ÈõªÂª† > 6 Â∫ß", check: g => g.counts.coal >= 6 }
                ]
            },
            {
                title: "ÈöéÊÆµ‰∫åÔºöÁ∂ìÊøüËµ∑È£õ",
                desc: "Á∂ìÊøüÊàêÈï∑ÊúüÔºåÁ´πÁßëÂ¥õËµ∑„ÄÇÈúÄË¶ÅÁ©©ÂÆöÁöÑÁáÉÊ∞£ÈõªÂäõËàáÊé•Êî∂Á´ô„ÄÇ",
                goals: [
                    { txt: "Êé•Êî∂Á´ô > 3 Â∫ß", check: g => g.counts.terminal >= 3 },
                    { txt: "ÁáÉÊ∞£ÈõªÂª† > 10 Â∫ß", check: g => g.counts.gas >= 10 }
                ]
            },
            {
                title: "ÈöéÊÆµ‰∏âÔºöËÉΩÊ∫êËΩâÂûã",
                desc: "ÊàêÁÜüÊúüÔºåÈù¢Â∞çÂ∞ÅÈéñÈ¢®Èö™ÔºåÁõÆÊ®ôÂª∫Á´ãÈ´òÈüåÊÄßËàáÁ∂†Ëâ≤ÈõªÁ∂≤„ÄÇ",
                goals: [
                    { txt: "ÂÆâÂÖ®Â≠òÈáè > 14Â§©", check: g => g.getSafetyDays() >= 14 },
                    { txt: "ÂÜçÁîüËÉΩÊ∫ê > 20%", check: g => g.getGreenPct() >= 20 },
                    { txt: "Á∏ΩÁôºÈõª > 70000MW", check: g => g.calcPower() >= 70000 }
                ]
            }
        ];

        const MARKET_SOURCES = {
            coal: [
                { id: 'au', name: 'Êæ≥Ê¥≤', flag: 'üá¶üá∫', base: 100 },
                { id: 'id', name: 'Âç∞Â∞º', flag: 'üáÆüá©', base: 80 },
                { id: 'ru', name: '‰øÑÂúã', flag: 'üá∑üá∫', base: 90 }
            ],
            gas: [
                { id: 'au', name: 'Êæ≥Ê¥≤', flag: 'üá¶üá∫', base: 220 },
                { id: 'qa', name: 'Âç°ÈÅî', flag: 'üá∂üá¶', base: 200 },
                { id: 'us', name: 'ÁæéÂúã', flag: 'üá∫üá∏', base: 250 }
            ]
        };

        const NUKE_RISK_MAP = [0, 1, 2, 5, 8, 11, 15, 20, 25, 30, 40]; 

        const game = {
            year: 1975, funds: 5000, comp: 100, demand: 10000, 
            fuel: { coal: 3000, gas: 0 }, cap: { coal: 3000, gas: 0 },
            counts: { coal: 0, gas: 0, terminal: 0, green: 0, solar: 0, nuclear: 0 },
            stageIdx: 0, selected: null, blockade: false, bDays: 0,
            marketPrices: {}, 
            purchaseCounts: { coal: {}, gas: {} },
            isFreePlay: false,
            history: [],
            importStats: { coal: {}, gas: {} },
            tutorialStep: 0,
            
            nukeDisasterCount: 0,
            nukeShutdownTimer: 0,
            isNukePermanentlyBanned: false,

            init() {
                this.resetVariables();
                this.counts.coal = 0; 
                this.cap.coal = 3000; 
                this.updateMarketPrices();
                ui.renderDeck(); ui.renderMarket(); ui.updateAll();
                document.body.requestFullscreen().catch(e=>{});
                
                // Show mission intro first, then tutorial
                ui.showModal("‰ªªÂãôÁ∞°Â†±", 
                    "Ê≠°Ëøé‰æÜÂà∞„ÄäÂÉèÁ¥†ËÉΩÊ∫ê„Äã„ÄÇ<br>ÊÇ®Â∞áÊâÆÊºîÂè∞ÁÅ£ËÉΩÊ∫êÊ±∫Á≠ñËÄÖÔºåÂú®Èï∑ÈÅî50Âπ¥ÁöÑÊ≠∑Âè≤‰∏≠ÔºåÈù¢Â∞çÁ∂ìÊøüÁôºÂ±ï„ÄÅÁí∞‰øùËΩâÂûãËàáÂú∞Á∑£ÊîøÊ≤ªÁöÑÊåëÊà∞„ÄÇ<br><br>ÁõÆÊ®ôÔºöÂª∫Á´ãÁ©©ÂÆö„ÄÅÂÆâÂÖ®‰∏îÊΩîÊ∑®ÁöÑÈõªÂäõÁ≥ªÁµ±„ÄÇ");
            },

            resetVariables() {
                this.year = 1975; this.funds = 5000; this.comp = 100; this.demand = 10000;
                this.fuel = { coal: 3000, gas: 0 }; 
                this.cap = { coal: 3000, gas: 0 };
                this.counts = { coal: 0, gas: 0, terminal: 0, green: 0, solar: 0, nuclear: 0 };
                this.stageIdx = 0; this.selected = null; this.blockade = false; this.isFreePlay = false;
                this.history = []; this.importStats = { coal: {}, gas: {} };
                this.purchaseCounts = { coal: {}, gas: {} };
                
                this.nukeDisasterCount = 0;
                this.nukeShutdownTimer = 0;
                this.isNukePermanentlyBanned = false;

                document.getElementById('buildings-layer').innerHTML = '';
                document.body.classList.remove('crisis-mode');
                this.tutorialStep = 0;
            },
            
            startTutorial() {
                this.tutorialStep = 1;
                this.updateTutorial();
            },

            nextTutorialStep() {
                if(this.tutorialStep > 0 && this.tutorialStep < 4) {
                    this.tutorialStep++;
                    this.updateTutorial();
                } else if(this.tutorialStep === 4) {
                    this.tutorialStep = 0; // End
                    ui.clearHighlight();
                }
            },

            updateTutorial() {
                ui.clearHighlight();
                const textEl = document.getElementById('tut-text');
                
                if(this.tutorialStep === 1) {
                    textEl.innerText = "„ÄêÂª∫Ë®≠ÂçÄ„Äë\nÈªûÊìä‰∏ãÊñπÂç°ÁâáÂç≥ÂèØÂª∫Ë®≠ÈõªÂª†„ÄÇ\nÊ≥®ÊÑèÔºöÂàùÊúüË≥áÈáëÊúâÈôêÔºåË´ãË¨πÊÖéË¶èÂäÉ„ÄÇ";
                    ui.highlightElement('#build-deck');
                } else if(this.tutorialStep === 2) {
                    textEl.innerText = "„ÄêÁáÉÊñôÂ∏ÇÂ†¥„Äë\nÈªûÊìäÂàáÊèõÂàÜÈ†ÅÔºåÂèØË≥ºË≤∑ÁÖ§ÁÇ≠ËàáÂ§©ÁÑ∂Ê∞£„ÄÇ\nÊ≥®ÊÑèÔºöÊØèË≤∑‰∏ÄÊ¨°ÂÉπÊ†ºÊúÉ‰∏äÊº≤ÔºåË´ãÂàÜÊï£Ë≤®Ê∫êÔºÅ";
                    ui.highlightElement('.arcade-tabs button:nth-child(2)');
                } else if(this.tutorialStep === 3) {
                    textEl.innerText = "„Äê‰∏ã‰∏ÄÂπ¥Â∫¶„Äë\nÊ∫ñÂÇôÂ•ΩÂæåÔºåÈªûÊìäÊ≠§ËôïÊé®ÈÄ≤ÊôÇÈñì‰∏¶Áç≤ÂæóÁ®ÖÊî∂„ÄÇ";
                    ui.highlightElement('#next-btn');
                } else {
                    ui.clearHighlight();
                }
            },
            
            restart() {
                this.resetVariables();
                this.counts.coal = 0; this.cap.coal = 3000;
                this.updateMarketPrices();
                ui.renderDeck(); ui.renderMarket(); ui.updateAll();
                ui.closeModal();
                setTimeout(() => ui.showModal("ÈÅäÊà≤ÈáçÂïü", "‰∏ÄÂàáÂõûÂà∞ÂéüÈªûÔºåË´ãÈáçÊñ∞Ë¶èÂäÉËÉΩÊ∫êÊîøÁ≠ñÔºÅ"), 300);
            },

            selectCard(key) {
                if(this.selected === key) { this.selected = null; }
                else { this.selected = key; this.tryBuild(); }
                ui.renderDeck();
                
                if(this.tutorialStep === 1 && key === 'coal') {
                    this.tutorialStep = 2;
                    ui.clearHighlight();
                }
            },

            tryBuild() {
                if (!this.selected) return;
                const p = PLANTS[this.selected];
                
                if (this.selected === 'nuclear') {
                    if (this.year >= 2021) {
                        ui.floatText('üö´ 2021ÂæåÁ¶ÅÊ≠¢Êñ∞Âª∫Ê†∏Èõª', 'red'); this.selected = null; return;
                    }
                    if (this.isNukePermanentlyBanned) {
                        ui.floatText('‚õî Ê†∏ËÉΩÂ∑≤Ê∞∏‰πÖÂª¢Ê≠¢', 'red'); this.selected = null; return;
                    }
                    // Removed immediate penalty as per previous request, keeping logic clean
                }

                if (this.funds < p.cost) {
                    ui.floatText('üí∏ Ë≥áÈáë‰∏çË∂≥', 'red'); this.selected = null; return;
                }
                if (this.selected === 'gas' && this.counts.terminal === 0) {
                    ui.floatText('‚ö†Ô∏è ÈúÄÂª∫Êé•Êî∂Á´ô', 'red'); this.selected = null; return;
                }

                this.funds -= p.cost;
                this.counts[this.selected]++;
                
                if (this.selected === 'coal') this.cap.coal += 1500; 
                if (this.selected === 'terminal') this.cap.gas += 1500;
                
                ui.floatText(`-$${p.cost}`, 'gold');
                this.placeBuilding(this.selected);
                this.selected = null;
                ui.renderDeck(); ui.updateAll();
                
                if(this.tutorialStep === 2) {
                    this.tutorialStep = 3;
                    ui.highlightElement('#next-btn', 'Âª∫Ë®≠ÂÆåÊàêÔºÅË´ãÊåâ„Äå‰∏ã‰∏ÄÂπ¥Â∫¶„Äç');
                }
            },

            buildTerminal() {
                const p = PLANTS.terminal;
                if (this.funds < p.cost) {
                    ui.floatText('üí∏ Ë≥áÈáë‰∏çË∂≥', 'red'); return;
                }
                this.funds -= p.cost;
                this.counts.terminal++;
                this.cap.gas += 1500;
                ui.floatText(`-$${p.cost} Êì¥ÂÖÖ`, 'gold');
                this.placeBuilding('terminal');
                ui.updateAll();
            },

            placeBuilding(type) {
                const pInfo = PLANTS[type];
                const el = document.createElement('div');
                el.innerText = pInfo.emoji;
                el.style.position = 'absolute';
                el.style.fontSize = '18px';
                el.style.animation = 'dropIn 0.3s';
                let x, y;
                switch(pInfo.type) {
                    case 'sea': x = 10 + Math.random() * 50; y = 100 + Math.random() * 300; break;
                    case 'coast': x = 60 + Math.random() * 20; y = 50 + Math.random() * 300; break;
                    case 'land': x = 100 + Math.random() * 100; y = 50 + Math.random() * 350; break;
                }
                el.style.left = x + 'px'; el.style.top = y + 'px';
            },

            buyFuel(type, countryId) {
                if (this.blockade) { ui.floatText('üö´ Â∞ÅÈéñ‰∏≠', 'red'); return; }
                const basePrice = this.marketPrices[`${type}_${countryId}`];
                const surge = this.purchaseCounts[type][countryId] || 0;
                const finalCost = basePrice + surge;

                if (this.funds < finalCost) { ui.floatText('üí∏ Ë≥áÈáë‰∏çË∂≥', 'red'); return; }
                if (this.fuel[type] + 100 > this.cap[type]) {
                    ui.floatText('üì¶ ÂÄâÂ∫´Â∑≤Êªø', 'red');
                    if(type==='gas' && this.counts.terminal===0) ui.floatText('‚ö†Ô∏è ÈúÄÊé•Êî∂Á´ô', 'red');
                    return;
                }
                this.funds -= finalCost;
                this.fuel[type] += 100;
                if (!this.purchaseCounts[type][countryId]) this.purchaseCounts[type][countryId] = 0;
                this.purchaseCounts[type][countryId]++;
                if (!this.importStats[type][countryId]) this.importStats[type][countryId] = 0;
                this.importStats[type][countryId] += 100;
                ui.floatText(`+100`, 'blue');
                ui.updateAll();
                if(this.tutorialStep === 4) { this.tutorialStep = 5; ui.clearHighlight(); }
            },

            updateMarketPrices() {
                this.purchaseCounts = { coal: {}, gas: {} };
                ['coal', 'gas'].forEach(type => {
                    MARKET_SOURCES[type].forEach(src => {
                        const fluc = 0.8 + Math.random() * 0.5;
                        this.marketPrices[`${type}_${src.id}`] = Math.floor(src.base * fluc);
                    });
                });
            },

            calcIncome() {
                let baseIncome = 500;
                if (game.stageIdx === 1) baseIncome = 1000;
                if (game.stageIdx === 2) baseIncome = 2000;
                const powerBonus = Math.floor(this.calcPower(true) * 0.4); 
                return baseIncome + powerBonus;
            },
            
            getNukeRisk() {
                const cnt = this.counts.nuclear;
                if(cnt >= NUKE_RISK_MAP.length) return 50;
                return NUKE_RISK_MAP[cnt];
            },

            checkNuclearDisaster() {
                if (this.counts.nuclear > 0) {
                    const risk = this.getNukeRisk();
                    if (Math.random() * 100 < risk) {
                        this.nukeDisasterCount++;
                        let loss = Math.max(5000, Math.floor(this.funds / 2));
                        this.funds -= loss;
                        this.funds -= 2000;
                        if(this.funds < 0) { this.comp -= 15; ui.floatText("üí∏ Á†¥Áî¢!", "red"); }
                        this.counts.nuclear--;
                        this.nukeShutdownTimer = 2;
                        this.comp -= 30;
                        if(this.nukeDisasterCount >= 3) {
                            this.isNukePermanentlyBanned = true;
                            this.counts.nuclear = 0; 
                            ui.showModal("‚ò¢Ô∏è Ê†∏ËÉΩÊ∞∏‰πÖÂª¢Ê≠¢", "Ê†∏ÁÅΩÁôºÁîü‰∏âÊ¨°ÔºåÁ§æÊúÉÂÖ±Ë≠òÂ¥©Áõ§„ÄÇ<br>ÊâÄÊúâÊ†∏ÈõªÂª†Âº∑Âà∂Èô§ÂΩπÔºÅ");
                        } else {
                            ui.showModal("‚ò¢Ô∏è Ê†∏ÁÅΩÁàÜÁôºÔºÅ", `ÊêçÂ§±ÊÖòÈáçÔºÅ(-$${loss+2000})<br>ÂÖ∂È§òÊ†∏ÈõªÂª†Âº∑Âà∂ÂÅúÊ©üÂÆâÊ™¢ 2 Âπ¥„ÄÇ`);
                        }
                        ui.renderDeck();
                    }
                }
            },

            nextTurn() {
                if(game.tutorialStep === 3) { this.tutorialStep = 4; ui.highlightElement('.pixel-btn:nth-child(2)', 'Ë´ãÂàáÊèõËá≥Â∏ÇÂ†¥Ë≥ºË≤∑ÁáÉÊñô'); }
                if (this.blockade) { this.handleBlockade(); return; }
                this.year++; 
                if (this.nukeShutdownTimer > 0) this.nukeShutdownTimer--;

                // Á¥ÄÈåÑÁôºÈõªÁµêÊßãÁî®ÊñºÂúñË°® (Layer Stacking Logic)
                // We record cumulative values for simpler stacking in SVG later
                const pCoal = this.counts.coal * PLANTS.coal.output;
                const pGas = this.counts.gas * PLANTS.gas.output;
                const pNuke = this.calcNukeOutput();
                const pGreen = (this.counts.green * PLANTS.green.output) + (this.counts.solar * PLANTS.solar.output);
                
                this.history.push({
                    year: this.year,
                    coal: pCoal,
                    gas: pGas,
                    nuclear: pNuke,
                    green: pGreen
                });

                this.checkNuclearDisaster();
                const income = this.calcIncome();
                this.funds += income; 
                ui.floatText(`+${income} Ë≥áÈáë`, 'gold');
                this.demand += 1200;
                this.updateMarketPrices();
                this.consumeFuel();
                
                const power = this.calcPower();
                if (power < this.demand) {
                    this.comp -= 15; ui.floatText('‚ö° Áº∫Èõª!', 'red');
                } else {
                    this.comp = Math.min(100, this.comp + 5);
                }

                if (!this.isFreePlay) {
                    const stage = STAGES[this.stageIdx];
                    if (stage && stage.goals.every(g => g.check(this))) {
                        if (this.stageIdx < STAGES.length - 1) {
                            this.stageIdx++;
                            ui.showModal(STAGES[this.stageIdx].title, STAGES[this.stageIdx].desc);
                        } else {
                            ui.showVictory();
                        }
                    }
                }

                if (this.year > 2020 && Math.random() < 0.15 && !this.isFreePlay) this.startBlockade();
                if (this.comp <= 0) { ui.showGameOver(); return; }
                ui.renderMarket(); ui.updateAll();
            },

            consumeFuel() {
                const cNeed = this.counts.coal * PLANTS.coal.fuel;
                const gNeed = this.counts.gas * PLANTS.gas.fuel;
                if (this.fuel.coal >= cNeed) this.fuel.coal -= cNeed;
                else { this.fuel.coal = 0; if(this.counts.coal>0){this.comp -= 5; ui.floatText('Áº∫ÁÖ§', 'red');} }
                if (this.fuel.gas >= gNeed) this.fuel.gas -= gNeed;
                else { this.fuel.gas = 0; if(this.counts.gas>0){this.comp -= 5; ui.floatText('Áº∫Ê∞£', 'red');} }
            },

            calcNukeOutput() {
                if (this.nukeShutdownTimer > 0) return 0;
                return this.counts.nuclear * PLANTS.nuclear.output;
            },

            calcPower(ignoreShutdown = false) { 
                let nukeOut = this.calcNukeOutput();
                if (ignoreShutdown) nukeOut = this.counts.nuclear * PLANTS.nuclear.output;
                return (this.counts.coal * PLANTS.coal.output) + 
                       (this.counts.gas * PLANTS.gas.output) + 
                       (this.counts.green * PLANTS.green.output) + 
                       (this.counts.solar * PLANTS.solar.output) + 
                       nukeOut;
            },
            
            getGreenPct() {
                const total = this.calcPower();
                if (total === 0) return 0;
                const green = (this.counts.green * PLANTS.green.output) + (this.counts.solar * PLANTS.solar.output);
                return Math.floor((green / total) * 100);
            },

            getSafetyDays() {
                const cUse = Math.max(1, this.counts.coal * PLANTS.coal.fuel);
                const gUse = Math.max(1, this.counts.gas * PLANTS.gas.fuel);
                const cDay = Math.floor(this.fuel.coal / cUse);
                const gDay = (this.counts.gas === 0) ? 99 : Math.floor(this.fuel.gas / gUse);
                return Math.min(cDay, gDay);
            },
            
            getCoalDays() {
                 if (this.counts.coal === 0) return 99;
                 const cUse = this.counts.coal * PLANTS.coal.fuel;
                 return Math.floor(this.fuel.coal / cUse);
            },
            
            getGasDays() {
                 if (this.counts.gas === 0) return 99;
                 const gUse = this.counts.gas * PLANTS.gas.fuel;
                 return Math.floor(this.fuel.gas / gUse);
            },

            startBlockade() {
                this.blockade = true; this.bDays = 11;
                document.body.classList.add('crisis-mode');
                ui.showModal("‚ö†Ô∏è Á¥ÖËâ≤Ë≠¶Â†±", "Êµ∑Â≥ΩÂ∞ÅÈéñÈñãÂßãÔºÅÈÄ≤Âè£‰∏≠Êñ∑ÔºåË´ãÊíêÈÅé 11 Â§©„ÄÇ");
            },

            handleBlockade() {
                this.bDays--; this.consumeFuel();
                ui.floatText(`Ââ© ${this.bDays} Â§©`, 'red');
                if (this.bDays <= 0) {
                    this.blockade = false; document.body.classList.remove('crisis-mode');
                    ui.showModal("üè≥Ô∏è Âç±Ê©üËß£Èô§", "Â∞ÅÈéñÁµêÊùüÔºåÂè∞ÁÅ£Â≠òÊ¥ªÔºÅ");
                }
                ui.updateAll();
            }
        };

        const ui = {
            switchTab(tab) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.pixel-btn').forEach(el => el.classList.remove('active'));
                document.getElementById(`tab-${tab}`).classList.add('active');
                
                const btns = document.querySelectorAll('.pixel-btn');
                if(tab==='build') btns[0].classList.add('active');
                if(tab==='market') btns[1].classList.add('active');
                
                if(game.tutorialStep === 4 && tab === 'market') {
                    setTimeout(() => ui.highlightElement('.buy-btn-mini:first-child', 'ÈªûÊìäË≥ºË≤∑ÔºÅ'), 100);
                }
            },

            highlightElement(selector) {
                document.getElementById('tutorial-overlay').style.display = 'block';
                document.getElementById('tutorial-tooltip').style.display = 'block';
                const el = document.querySelector(selector);
                if(el) el.classList.add('highlight-target');
            },

            clearHighlight() {
                document.getElementById('tutorial-overlay').style.display = 'none';
                document.getElementById('tutorial-tooltip').style.display = 'none';
                document.querySelectorAll('.highlight-target').forEach(el => el.classList.remove('highlight-target'));
            },

            renderDeck() {
                const buildable = Object.entries(PLANTS).filter(([k,v]) => k !== 'terminal');
                document.getElementById('build-deck').innerHTML = buildable.map(([k, v]) => {
                    let locked = false;
                    let lockReason = '';
                    let riskText = '';
                    if (k === 'nuclear') {
                        if (game.year >= 2021) { locked = true; lockReason = 'üö´ 2021ÈôêÂª∫'; }
                        else if (game.isNukePermanentlyBanned) { locked = true; lockReason = '‚õî Ê∞∏‰πÖÂª¢Ê≠¢'; }
                        else {
                            const risk = game.getNukeRisk();
                            riskText = `<div class="nuke-risk">‚ö†Ô∏è ÁÅΩÁéá:${risk}%</div>`;
                        }
                    }
                    const count = game.counts[k];
                    
                    return `
                    <div class="pixel-card ${game.selected === k ? 'selected' : ''} ${locked ? 'disabled' : ''}" onclick="game.selectCard('${k}')">
                        <div class="card-badge">${count}</div>
                        ${locked ? `<div class="lock-overlay">${lockReason}</div>` : ''}
                        ${riskText}
                        <div class="card-emoji">${v.emoji}</div>
                        <div class="card-name" style="color:${v.color}">${v.name}</div>
                        <div class="card-power">+${v.output}MW</div>
                        <div class="card-cost">$${v.cost.toLocaleString()}</div>
                    </div>
                `}).join('');
            },

            renderMarket() {
                document.getElementById('val-coal-stock').innerText = game.fuel.coal.toLocaleString();
                document.getElementById('val-gas-stock').innerText = game.fuel.gas.toLocaleString();
                
                document.getElementById('val-gas-cap').innerText = game.cap.gas.toLocaleString();
                document.getElementById('val-term-cnt').innerText = game.counts.terminal;

                document.getElementById('market-coal-list').innerHTML = MARKET_SOURCES.coal.map(src => {
                    const base = game.marketPrices['coal_'+src.id]||src.base;
                    const surge = game.purchaseCounts['coal'][src.id] || 0;
                    return `
                    <div class="market-country-row">
                        <div class="m-top"><span class="flag">${src.flag} ${src.name}</span><span class="price">$${base+surge}</span></div>
                        <button class="buy-btn-mini" onclick="game.buyFuel('coal', '${src.id}')">100Âô∏ $${base+surge}</button>
                    </div>`
                }).join('');

                document.getElementById('market-gas-list').innerHTML = MARKET_SOURCES.gas.map(src => {
                    const base = game.marketPrices['gas_'+src.id]||src.base;
                    const surge = game.purchaseCounts['gas'][src.id] || 0;
                    return `
                    <div class="market-country-row">
                        <div class="m-top"><span class="flag">${src.flag} ${src.name}</span><span class="price">$${base+surge}</span></div>
                        <button class="buy-btn-mini" onclick="game.buyFuel('gas', '${src.id}')">100Âô∏ $${base+surge}</button>
                    </div>`
                }).join('');
            },

            updatePieChart() {
                const pCoal = game.counts.coal * PLANTS.coal.output;
                const pGas = game.counts.gas * PLANTS.gas.output;
                const pGreen = (game.counts.green * PLANTS.green.output) + (game.counts.solar * PLANTS.solar.output);
                const pNuke = game.calcNukeOutput(); 
                const total = pCoal + pGas + pGreen + pNuke;
                
                if (total === 0) return;

                const degCoal = (pCoal / total) * 360;
                const degGas = (pGas / total) * 360;
                const degGreen = (pGreen / total) * 360;
                const degNuke = (pNuke / total) * 360;

                const chart = document.getElementById('power-pie-chart');
                chart.style.background = `conic-gradient(
                    var(--color-coal) 0deg ${degCoal}deg,
                    var(--color-gas) ${degCoal}deg ${degCoal + degGas}deg,
                    var(--color-nuclear) ${degCoal + degGas}deg ${degCoal + degGas + degNuke}deg,
                    var(--color-green) ${degCoal + degGas + degNuke}deg 360deg
                )`;
            },

            updateAll() {
                document.getElementById('hud-year').innerText = game.year;
                document.getElementById('hud-funds').innerText = game.funds.toLocaleString();
                document.getElementById('hud-comp').innerText = game.comp + '%';
                
                const days = game.getSafetyDays();
                document.getElementById('hud-days').innerText = (days > 99 ? 'ÂÖÖË∂≥' : days + 'Â§©');
                document.getElementById('hud-days').className = `stat-val ${days < 14 ? 'red' : ''}`;

                document.getElementById('stat-supply').innerText = game.calcPower().toLocaleString() + " MW";
                document.getElementById('stat-demand').innerText = game.demand.toLocaleString() + " MW";
                
                const cDays = game.getCoalDays();
                document.getElementById('stat-coal-days').innerText = (cDays > 99 ? '‚àû' : cDays + 'Â§©');
                
                const gDays = game.getGasDays();
                document.getElementById('stat-gas-days').innerText = (gDays > 99 ? '‚àû' : gDays + 'Â§©');

                if (!game.isFreePlay) {
                    const s = STAGES[game.stageIdx];
                    document.getElementById('story-text').innerText = s.desc;
                    document.getElementById('goal-list').innerHTML = s.goals.map(g => `
                        <div class="goal-item"><span class="goal-check ${g.check(game) ? 'done' : ''}">${g.check(game) ? '‚úÖ' : '‚¨ú'}</span> <span>${g.txt}</span></div>
                    `).join('');
                } else {
                    document.getElementById('story-text').innerText = "Ëá™Áî±Âü∑ÊîøÊ®°Âºè";
                    document.getElementById('goal-list').innerHTML = "<div class='goal-item'>Á∂≠ÊåÅÁ´∂Áà≠Âäõ > 0%</div>";
                }

                if (game.blockade) {
                    document.getElementById('next-btn').innerHTML = `Êíê‰Ωè<br>${game.bDays}Â§©`;
                    document.getElementById('next-btn').style.background = '#000';
                } else {
                    document.getElementById('next-btn').innerHTML = `‰∏ã‰∏Ä<br>Âπ¥Â∫¶`;
                    document.getElementById('next-btn').style.background = 'var(--accent-red)';
                }
                
                this.updatePieChart();
                this.renderMarket();
                this.renderDeck();
            },

            floatText(txt, color) {
                const el = document.createElement('div'); el.className = 'float-pixel'; el.innerText = txt;
                el.style.color = color === 'red' ? '#e74c3c' : (color === 'gold' ? '#f1c40f' : '#fff');
                el.style.left = '50%'; el.style.top = '40%';
                document.body.appendChild(el); setTimeout(() => el.remove(), 1200);
            },

            showModal(title, desc) {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-content-area').innerHTML = `<p id="modal-desc" style="font-size:14px; line-height:1.6; color:#ddd; margin:15px 0;">${desc}</p>`;
                
                const btn = document.getElementById('modal-btn');
                btn.innerText = "Á¢∫ ÂÆö";
                btn.onclick = () => {
                    ui.closeModal();
                    if(game.year === 1975 && game.tutorialStep === 0) {
                        game.startTutorial();
                    }
                };
                btn.className = 'retro-btn';
                document.getElementById('modal-overlay').style.display = 'flex';
            },
            
            showCompHelp() {
                ui.showModal("Á´∂Áà≠ÂäõË™™Êòé", `
                    <div class="rule-list">
                        <div class="rule-title">Ë©ïÂàÜË¶èÂâá</div>
                        <div class="rule-item"><span>‚ö° ‰æõÈõªÂÖÖË∂≥</span><span style="color:#2ecc71">+5%</span></div>
                        <div class="rule-item"><span>‚ö° ‰æõÈõª‰∏çË∂≥</span><span style="color:#e74c3c">-15%</span></div>
                        <div class="rule-item"><span>ü™® Áº∫Â∞ëÁÖ§ÁÇ≠</span><span style="color:#e74c3c">-5%</span></div>
                        <div class="rule-item"><span>üî• Áº∫Â∞ëÂ§©ÁÑ∂Ê∞£</span><span style="color:#e74c3c">-5%</span></div>
                    </div>
                `);
            },

            showFundsHelp() {
                ui.showModal("Â∑•Ê•≠Á®ÖÊî∂Ë™™Êòé", `
                    <div class="rule-list">
                        <div class="rule-title">Ë®àÁÆóÂÖ¨Âºè</div>
                        <div class="rule-item"><span>üí∞ Âü∫Á§éÁ®ÖÊî∂</span><span>$${game.stageIdx===0?500:(game.stageIdx===1?1000:2000)}</span></div>
                        <div class="rule-item"><span>‚ö° Â∑•Ê•≠Á®ÖÊî∂</span><span>+$${Math.floor(game.calcPower(true)*0.4).toLocaleString()}</span></div>
                        <div class="rule-item" style="border-top:1px solid #fff; margin-top:5px; padding-top:5px;">
                            <span>È†êË®à‰∏ãÂπ¥Êî∂ÂÖ•</span><span style="color:#f1c40f">$${game.calcIncome().toLocaleString()}</span>
                        </div>
                        <div style="font-size:10px; color:#888; margin-top:5px;">(ÂÖ¨ÂºèÔºöÁôºÈõªÈáè x 0.4 + Âü∫Á§éÁ®Ö)</div>
                    </div>
                `);
            },

            showStockHelp() {
                const cDays = game.getCoalDays();
                const gDays = game.getGasDays();
                
                ui.showModal("Â≠òÈáèË™™Êòé", `
                    <div class="rule-list">
                        <div class="rule-title">ÁõÆÂâçÂèØÊîØÊíêÂ§©Êï∏</div>
                        <div class="rule-item"><span>ü™® ÁÖ§ÁÇ≠</span><span>${cDays>99?'‚àû':cDays+' Â§©'}</span></div>
                        <div class="rule-item"><span>üî• Â§©ÁÑ∂Ê∞£</span><span>${gDays>99?'‚àû':gDays+' Â§©'}</span></div>
                        <div style="margin-top:10px; font-size:11px; color:#aaa; line-height:1.4;">
                            Ê∂àËÄóÂÖ¨ÂºèÔºö<br>
                            ÁáÉÁÖ§Ê∂àËÄó = ÈõªÂª†Êï∏ x ${PLANTS.coal.fuel}<br>
                            ÁáÉÊ∞£Ê∂àËÄó = ÈõªÂª†Êï∏ x ${PLANTS.gas.fuel}<br>
                            Â§©Êï∏ = Â∫´Â≠ò / Âπ¥Ê∂àËÄó<br>
                            <span style="color:#e74c3c">*Â∞ÅÈéñÊúüÈñìÁÑ°Ê≥ïÈÄ≤Âè£ÔºåÈúÄÈù†Â≠òÈáèÊíêÈÅé11Â§©„ÄÇ</span>
                        </div>
                    </div>
                `);
            },

            showGameOver() {
                document.getElementById('modal-title').innerText = "ÂúãÂÆ∂Á†¥Áî¢";
                document.getElementById('modal-content-area').innerHTML = '<p style="color:#e74c3c">ÈõªÂäõ‰∏çÁ©©Â∞éËá¥Áî¢Ê•≠Â§ñÁßªÔºåÁ´∂Áà≠ÂäõÊ≠∏Èõ∂„ÄÇ</p>';
                
                const btn = document.getElementById('modal-btn');
                btn.innerText = "üîÑ ÈáçÊñ∞ÈñãÂßã";
                btn.classList.add('restart');
                btn.onclick = () => game.restart();
                document.getElementById('modal-overlay').style.display = 'flex';
            },

            showVictory() {
                document.getElementById('modal-title').innerText = "üèÜ ËÉΩÊ∫êËΩâÂûãÊàêÂäüÔºÅ";
                
                let maxPower = 0;
                game.history.forEach(h => {
                    const total = h.coal + h.gas + h.nuclear + h.green;
                    if(total > maxPower) maxPower = total;
                });
                
                // SVG Stacked Area Chart Logic
                let paths = { coal: "M0,100 ", gas: "M0,100 ", nuke: "M0,100 ", green: "M0,100 " };
                
                game.history.forEach((h, i) => {
                    const x = (i / (game.history.length-1)) * 100;
                    
                    // Normalize to 100 height
                    const hCoal = (h.coal / maxPower) * 100;
                    const hGas = (h.coal + h.gas) / maxPower * 100;
                    const hNuke = (h.coal + h.gas + h.nuclear) / maxPower * 100;
                    const hGreen = (h.coal + h.gas + h.nuclear + h.green) / maxPower * 100;
                    
                    paths.coal += `L${x},${100 - hCoal} `;
                    paths.gas += `L${x},${100 - hGas} `;
                    paths.nuke += `L${x},${100 - hNuke} `;
                    paths.green += `L${x},${100 - hGreen} `;
                });
                
                const closePath = `L100,100 L0,100 Z`;
                
                // Import Ranking Logic
                const getRank = (obj) => Object.entries(obj)
                    .sort((a,b) => b[1] - a[1])
                    .map(e => {
                        const name = MARKET_SOURCES.coal.find(x=>x.id==e[0])?.name || MARKET_SOURCES.gas.find(x=>x.id==e[0])?.name || e[0];
                        const flag = MARKET_SOURCES.coal.find(x=>x.id==e[0])?.flag || MARKET_SOURCES.gas.find(x=>x.id==e[0])?.flag || '';
                        return `<div class="rank-item"><span>${flag} ${name}</span><span>${e[1]}00Âô∏</span></div>`;
                    }).join('');

                const finalHTML = `
                    <p style="color:#2ecc71; margin-bottom:10px;">ÊÇ®Âª∫Á´ã‰∫ÜÈ´òÈüåÊÄßÁöÑÈõªÂäõÁ≥ªÁµ±ÔºÅ</p>
                    
                    <div class="chart-container">
                        <div class="chart-title">üìà ÁôºÈõªÁµêÊßãÂ†ÜÁñäÂúñ (Á∏Ω: ${game.calcPower().toLocaleString()} MW)</div>
                        <svg viewBox="0 0 100 100" style="background:#222; width:100%; height:100px;">
                            <path d="${paths.green + closePath}" fill="#2ecc71" />
                            <path d="${paths.nuke + closePath}" fill="#8e44ad" />
                            <path d="${paths.gas + closePath}" fill="#d35400" />
                            <path d="${paths.coal + closePath}" fill="#7f8c8d" />
                        </svg>
                        <div class="chart-legend">
                            <div class="legend-item"><span class="color-box" style="background:#7f8c8d"></span>ÁÖ§</div>
                            <div class="legend-item"><span class="color-box" style="background:#d35400"></span>Ê∞£</div>
                            <div class="legend-item"><span class="color-box" style="background:#8e44ad"></span>Ê†∏</div>
                            <div class="legend-item"><span class="color-box" style="background:#2ecc71"></span>Á∂†</div>
                        </div>
                    </div>

                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <div style="flex:1;">
                            <div class="chart-title">ü™® ÁÖ§ÁÇ≠ÈÄ≤Âè£ÊéíË°å</div>
                            <div class="rank-list">${getRank(game.importStats.coal)}</div>
                        </div>
                        <div style="flex:1;">
                            <div class="chart-title">üî• Â§©ÁÑ∂Ê∞£ÈÄ≤Âè£ÊéíË°å</div>
                            <div class="rank-list">${getRank(game.importStats.gas)}</div>
                        </div>
                    </div>
                `;

                document.getElementById('modal-content-area').innerHTML = finalHTML;
                
                const btn = document.getElementById('modal-btn');
                btn.innerText = "ÁπºÁ∫åÂü∑Êîø";
                btn.className = 'retro-btn victory';
                btn.onclick = () => {
                    game.isFreePlay = true;
                    ui.closeModal();
                };
                
                const contentArea = document.querySelector('.retro-inner');
                if(!contentArea.querySelector('.restart')) {
                    const restartBtn = document.createElement('button');
                    restartBtn.className = 'retro-btn restart';
                    restartBtn.innerText = "üîÑ ÈáçÊñ∞ÊåëÊà∞";
                    restartBtn.style.marginTop = '10px';
                    restartBtn.onclick = () => game.restart();
                    contentArea.appendChild(restartBtn);
                }
                
                document.getElementById('modal-overlay').style.display = 'flex';
            },

            closeModal() { 
                document.getElementById('modal-overlay').style.display = 'none'; 
                document.getElementById('modal-content-area').innerHTML = '<p id="modal-desc" style="font-size:14px; line-height:1.6; color:#ddd; margin:15px 0;">CONTENT</p>';
                const btn = document.getElementById('modal-btn');
                btn.className = 'retro-btn';
                
                const restartBtn = document.querySelector('.retro-btn.restart');
                if(restartBtn) restartBtn.remove();
            }
        };

        game.init();
    </script>
</body>
</html>
