<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>âš¡ åƒç´ èƒ½æºï¼šæ±ºæˆ°å°ç£ v25</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Noto+Sans+TC:wght@500;900&display=swap');

        :root {
            --bg-ocean: #2c3e50;
            --land-green: #27ae60;
            --land-border: #145a32;
            --ui-bg: #212529;
            --ui-border: #95a5a6;
            --accent-blue: #3498db;
            --accent-gold: #f1c40f;
            --accent-red: #e74c3c;
            --text-white: #ecf0f1;
            
            --color-coal: #7f8c8d;
            --color-gas: #d35400;
            --color-green: #2ecc71;
            --color-solar: #f39c12;
            --color-nuclear: #8e44ad;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; user-select: none; }
        
        body {
            font-family: 'Noto Sans TC', monospace;
            background-color: var(--bg-ocean);
            background-image: 
                linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            
            width: 100vw;
            height: 100dvh;
            overflow: hidden;
            color: var(--text-white);
            display: flex;
            flex-direction: column;
            image-rendering: pixelated;
        }

        /* === HUD === */
        #hud {
            flex: 0 0 auto;
            background: var(--ui-bg);
            border-bottom: 4px solid var(--ui-border);
            padding: 8px 4px;
            padding-top: max(8px, env(safe-area-inset-top)); 
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            z-index: 100;
        }
        .stat-box { position: relative; text-align: center; border: 2px solid #555; background: #000; padding: 4px 2px; }
        .stat-label { font-size: 11px; color: #aaa; display: block; margin-bottom: 2px; }
        .stat-val { font-family: 'VT323', monospace; font-size: 22px; color: #fff; font-weight: bold; line-height: 1; }
        .stat-val.gold { color: var(--accent-gold); }
        .stat-val.blue { color: var(--accent-blue); }
        .stat-val.red { color: var(--accent-red); animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        .help-btn {
            position: absolute; top: 0; right: 0;
            color: #000; background: var(--accent-gold); 
            font-size: 12px; font-weight: bold; cursor: pointer;
            width: 14px; height: 14px; line-height: 14px;
            text-align: center; border-bottom-left-radius: 4px;
        }

        /* === Info Panels === */
        .info-panel {
            position: absolute; top: 80px; width: 140px;
            background: rgba(33, 37, 41, 0.95); padding: 8px; z-index: 90;
            box-shadow: 4px 4px 0px #000; pointer-events: none; border-radius: 2px;
        }
        #story-panel { left: 10px; border: 3px solid var(--ui-border); }
        #goal-panel { right: 10px; border: 3px solid var(--accent-blue); }
        
        .pixel-title { 
            font-size: 13px; color: var(--accent-gold); border-bottom: 2px dashed #555;
            padding-bottom: 4px; margin-bottom: 4px; font-weight: 900;
        }
        .pixel-text { font-size: 12px; line-height: 1.4; color: #ddd; }
        .goal-item { font-size: 11px; margin-bottom: 4px; border-bottom: 1px solid #444; padding-bottom: 2px; }
        .goal-check.done { color: var(--land-green); font-weight:bold; }

        /* === Map Stage === */
        #game-stage {
            flex: 1; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; width: 100%;
        }
        #map-container { position: relative; width: 100%; height: 100%; }

        #taiwan-svg {
            width: 100%; height: 100%;
            filter: drop-shadow(6px 6px 0px rgba(0,0,0,0.5));
            overflow: visible;
        }
        .map-path { fill: var(--land-green); stroke: var(--land-border); stroke-width: 3px; }

        #power-pie-chart {
            position: absolute;
            top: 40%; left: 55%;
            transform: translate(-50%, -50%);
            width: 90px; height: 90px;
            border-radius: 50%;
            background: #444;
            border: 3px solid #fff;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.5);
            z-index: 50; pointer-events: none;
            transition: background 0.5s ease;
        }
        #pie-label {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); color: #fff; padding: 3px 6px;
            font-size: 11px; border-radius: 3px; white-space: nowrap;
        }
        /* éŠæˆ²ä¸­åœ“é¤…åœ–çš„åœ–ä¾‹ */
        #pie-legend-box {
            position: absolute; top: 52%; left: 55%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); padding: 4px; border-radius: 4px;
            display: flex; gap: 6px; pointer-events: none; z-index: 50;
            white-space: nowrap;
        }
        .ingame-legend-item { display: flex; align-items: center; gap: 2px; font-size: 10px; color: #fff; }
        .dot { width: 6px; height: 6px; border-radius: 50%; }

        #map-data-overlay {
            position: absolute;
            bottom: 10px; left: 10px;   
            background: rgba(10, 10, 10, 0.95);
            border: 2px solid #fff;
            padding: 8px;
            width: 140px;
            z-index: 95;
            pointer-events: none;
            box-shadow: 4px 4px 0px #000;
        }
        .data-row { font-size: 12px; color: #ccc; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center;}
        .data-val { color: #fff; font-weight: bold; font-family: 'VT323', monospace; font-size: 16px; }
        .data-sep { border-top: 1px dashed #555; margin: 5px 0; }

        /* === Bottom Panel === */
        #bottom-panel {
            flex: 0 0 auto; 
            background: var(--ui-bg); 
            border-top: 4px solid var(--ui-border);
            height: 260px; 
            padding: 10px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            display: flex; flex-direction: column; z-index: 100;
        }
        .arcade-tabs { display: flex; gap: 8px; margin-bottom: 8px; flex-shrink: 0; }
        .pixel-btn {
            flex: 1; background: #444; border: 2px solid #fff; color: #fff;
            padding: 8px; font-weight: bold; font-size: 15px;
            box-shadow: 3px 3px 0px #000; cursor: pointer; text-align: center;
        }
        .pixel-btn.active { background: var(--accent-blue); transform: translate(2px, 2px); box-shadow: 1px 1px 0px #000; }
        
        .tab-content { display: none; flex: 1; overflow: hidden; flex-direction: column; }
        .tab-content.active { display: flex; }

        /* Build Deck */
        #build-deck { display: flex; gap: 4px; flex: 1; width: 100%; }
        .pixel-card {
            flex: 1; position: relative;
            background: #333; border: 2px solid #888;
            box-shadow: 2px 2px 0px #000; padding: 2px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: space-around;
            min-width: 0;
        }
        .pixel-card.selected { background: #555; border-color: var(--accent-gold); transform: translateY(-3px); }
        .pixel-card.disabled { opacity: 0.5; filter: grayscale(1); background: #222; }
        
        .card-emoji { font-size: 26px; }
        .card-name { font-size: 12px; text-align: center; white-space: nowrap; color: #fff; font-weight: bold; }
        .card-power { font-family:'VT323'; color:var(--accent-blue); font-size:15px; font-weight: bold; }
        .card-cost { font-family:'VT323'; color:var(--accent-gold); font-size:20px; font-weight: bold; }
        
        .card-badge {
            position: absolute; top: -4px; right: -4px;
            background: var(--accent-gold); color: #000;
            border: 2px solid #fff; border-radius: 4px;
            font-family: 'VT323', monospace; font-size: 16px; font-weight: bold;
            padding: 0 5px; box-shadow: 2px 2px 0px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .nuke-risk {
            position: absolute; bottom: 2px; width: 100%; text-align: center;
            font-size: 10px; color: var(--accent-red); font-weight: bold; background: rgba(0,0,0,0.6);
        }

        .lock-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.7);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #fff; font-size: 12px; font-weight: bold; z-index: 5; text-align: center;
        }

        .build-hint {
            font-size: 11px; color: #888; text-align: center; 
            padding-top: 6px; border-top: 1px solid #444; margin-top: 6px; flex-shrink: 0;
        }

        /* Market */
        #market-container { display: flex; gap: 8px; height: 100%; width: 100%; }
        .market-col {
            flex: 1; display: flex; flex-direction: column;
            background: #111; border: 1px solid #444; padding: 0; border-radius: 4px;
            height: 100%; 
            overflow-y: auto; position: relative;
            -webkit-overflow-scrolling: touch;
        }
        .market-header { 
            font-size: 13px; color: var(--accent-gold); text-align: center; 
            background: #222; border-bottom: 1px solid #555; padding: 6px; 
            position: sticky; top: 0; z-index: 10;
        }
        .market-country-row {
            display: flex; flex-direction: column; background: #222; border: 1px solid #555; 
            padding: 6px; margin: 4px;
        }
        .m-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .flag { font-size: 14px; color:#fff; }
        .price { color: #fff; font-family: 'VT323'; font-size: 18px; font-weight: bold; color: var(--accent-gold); }
        .buy-btn-mini {
            width: 100%; background: var(--land-green); border: 1px solid #fff; color: white;
            padding: 4px; font-size: 12px; cursor: pointer; text-align: center; font-weight: bold;
        }
        .buy-btn-mini:active { background: #fff; color: #000; }

        .terminal-build-area {
            background: #2c3e50; border: 1px solid var(--accent-blue);
            padding: 8px; margin: 4px; text-align: center;
        }
        .terminal-info { font-size: 11px; color: #aec6cf; margin-bottom: 4px; }
        .build-term-btn {
            background: var(--accent-blue); color: #fff; border: 1px solid #fff;
            width: 100%; padding: 6px; font-size: 13px; cursor: pointer; font-weight: bold;
        }

        /* Next Button */
        #next-btn {
            position: fixed;
            bottom: calc(270px + env(safe-area-inset-bottom)); 
            right: 15px;
            width: 80px; height: 80px;
            background: var(--accent-red);
            border: 4px solid #fff; border-radius: 50%;
            box-shadow: 5px 5px 0px #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 150; cursor: pointer;
            font-size: 14px; font-weight: bold; text-align: center; line-height: 1.2;
            animation: pulse-btn 1.5s infinite;
        }
        #next-btn:active { transform: scale(0.95); box-shadow: 2px 2px 0px #000; }
        @keyframes pulse-btn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Tutorial & Highlights */
        #tutorial-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 900;
            display: none; cursor: pointer;
        }
        .highlight-target {
            z-index: 901 !important;
            position: relative !important;
            box-shadow: 0 0 0 4px var(--accent-gold), 0 0 20px var(--accent-gold) !important;
            transition: all 0.3s;
        }
        #tutorial-tooltip {
            position: fixed; bottom: 350px; left: 50%; transform: translateX(-50%);
            background: #fff; color: #000; padding: 15px; border-radius: 10px;
            font-weight: bold; z-index: 902; display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            text-align: center; width: 80%;
            animation: floatTooltip 1s infinite alternate;
        }
        @keyframes floatTooltip { from { transform: translate(-50%, 0); } to { transform: translate(-50%, -10px); } }
        .tut-next { font-size: 10px; color: #666; margin-top: 5px; }

        /* Modal */
        #modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000;
            display: none; justify-content: center; align-items: center; padding: 20px;
        }
        .retro-dialog { 
            background: var(--accent-blue); border: 4px solid #fff; padding: 4px; 
            width: 95%; max-width: 420px; max-height: 85vh;
            box-shadow: 8px 8px 0px #000;
            display: flex; flex-direction: column;
        }
        .retro-inner { 
            background: var(--ui-bg); border: 2px solid #000; padding: 20px; text-align: center;
            overflow-y: auto;
        }
        .retro-btn { margin-top: 15px; background: #000; color: #fff; border: 2px solid #fff; padding: 10px 30px; cursor: pointer; font-size: 16px; width: 100%;}
        .retro-btn.restart { background: var(--accent-red); color: #fff; border-color: #fff; }
        .retro-btn.victory { background: var(--accent-gold); color: #000; border-color: #fff; }

        .float-pixel {
            position: fixed; font-family: 'VT323', monospace; font-size: 28px; font-weight: bold;
            text-shadow: 2px 2px 0px #000; pointer-events: none; z-index: 300;
            animation: floatPixel 1.2s steps(8) forwards;
        }
        @keyframes floatPixel { 0%{transform:translate(-50%,0);} 100%{transform:translate(-50%,-60px); opacity: 0;} }
        .crisis-mode { filter: sepia(100%) hue-rotate(-50deg) saturate(300%); }
        
        .rule-list { text-align: left; font-size: 14px; color: #ccc; margin: 10px 0; border: 1px solid #555; padding: 10px; background: #222; }
        .rule-item { display: flex; justify-content: space-between; margin-bottom: 6px; border-bottom: 1px solid #333; padding-bottom: 2px;}
        .rule-title { font-weight: bold; color: var(--accent-gold); margin-bottom: 5px; text-align: center;}

        .chart-container { margin: 15px 0; border: 1px solid #555; background: #111; padding: 5px; }
        .chart-title { font-size: 12px; color: #aaa; margin-bottom: 5px; text-align: left; }
        .chart-legend { display: flex; flex-wrap: wrap; gap: 12px; font-size: 12px; justify-content: center; margin-top: 8px; color: #ddd;}
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .color-box { width: 10px; height: 10px; border: 1px solid #fff; }
        .rank-list { text-align: left; font-size: 11px; color:#ddd; margin-top: 5px; }
        .rank-item { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 2px 0;}
    </style>
</head>
<body>

    <div id="tutorial-overlay" onclick="game.nextTutorialStep()"></div>
    <div id="tutorial-tooltip">
        <div id="tut-text"></div>
        <div class="tut-next">â–¼ é»æ“Šç•«é¢ç¹¼çºŒ</div>
    </div>

    <div id="hud">
        <div class="stat-box"><span class="stat-label">è¥¿å…ƒ</span><span class="stat-val" id="hud-year">1975</span></div>
        <div class="stat-box">
            <span class="stat-label">è³‡é‡‘</span>
            <span class="stat-val gold" id="hud-funds">2,000</span>
            <div class="help-btn" onclick="ui.showFundsHelp()">?</div>
        </div>
        <div class="stat-box">
            <span class="stat-label">ç«¶çˆ­åŠ›</span>
            <span class="stat-val blue" id="hud-comp">100%</span>
            <div class="help-btn" onclick="ui.showCompHelp()">?</div>
        </div>
        <div class="stat-box">
            <span class="stat-label">å­˜é‡</span>
            <span class="stat-val" id="hud-days">30å¤©</span>
            <div class="help-btn" onclick="ui.showStockHelp()">?</div>
        </div>
    </div>

    <div id="story-panel" class="info-panel">
        <div class="pixel-title">ä»»å‹™ç°¡å ±</div>
        <div class="pixel-text" id="story-text">...</div>
    </div>
    <div id="goal-panel" class="info-panel">
        <div class="pixel-title" style="color:var(--accent-blue)">éšæ®µç›®æ¨™</div>
        <div id="goal-list"></div>
    </div>

    <div id="game-stage">
        <div id="map-container">
            <svg id="taiwan-svg" viewBox="0 0 320 480">
                <path class="map-path" d="
                    M 210 30 
                    C 230 35, 250 50, 260 80
                    C 275 120, 270 180, 265 220
                    C 260 270, 240 320, 220 370
                    C 200 420, 185 450, 175 460
                    L 165 455
                    C 110 420, 60 350, 50 250  
                    C 45 180, 75 120, 100 80
                    C 140 50, 170 30, 210 30 Z
                "/>
            </svg>
            
            <div id="power-pie-chart">
                <div id="pie-label">ç™¼é›»å æ¯”</div>
            </div>
            
            <div id="pie-legend-box">
                <div class="ingame-legend-item"><span class="dot" style="background:var(--color-coal)"></span>ç…¤</div>
                <div class="ingame-legend-item"><span class="dot" style="background:var(--color-gas)"></span>æ°£</div>
                <div class="ingame-legend-item"><span class="dot" style="background:var(--color-nuclear)"></span>æ ¸</div>
                <div class="ingame-legend-item"><span class="dot" style="background:var(--color-green)"></span>ç¶ </div>
            </div>

            <div id="buildings-layer"></div>

            <div id="map-data-overlay">
                <div class="data-row"><span>ç¸½ç™¼é›»</span><span class="data-val" id="stat-supply">0 MW</span></div>
                <div class="data-row"><span>ç¸½éœ€æ±‚</span><span class="data-val" id="stat-demand">0 MW</span></div>
                <div class="data-sep"></div>
                <div class="data-row"><span>ç…¤å­˜é‡</span><span class="data-val" id="stat-coal-days" style="color:#aaa">--</span></div>
                <div class="data-row"><span>æ°£å­˜é‡</span><span class="data-val blue" id="stat-gas-days">--</span></div>
            </div>
        </div>
    </div>

    <div id="next-btn" onclick="game.nextTurn()">ä¸‹ä¸€<br>å¹´åº¦</div>

    <div id="bottom-panel">
        <div class="arcade-tabs">
            <button class="pixel-btn active" onclick="ui.switchTab('build')">ğŸ”¨ å»ºè¨­</button>
            <button class="pixel-btn" onclick="ui.switchTab('market')">ğŸš¢ ç‡ƒæ–™å¸‚å ´</button>
        </div>

        <div id="tab-build" class="tab-content active">
            <div id="build-deck"></div>
            <div class="build-hint">é»æ“Šå¡ç‰‡ç³»çµ±å°‡è‡ªå‹•é¸å€å»ºè¨­</div>
        </div>

        <div id="tab-market" class="tab-content">
            <div id="market-container">
                <div class="market-col">
                    <div class="market-header">ğŸª¨ ç…¤ (å­˜:<span id="val-coal-stock">0</span>)</div>
                    <div class="market-list" id="market-coal-list"></div>
                </div>
                <div class="market-col">
                    <div class="market-header">ğŸ”¥ æ°£ (å­˜:<span id="val-gas-stock">0</span>)</div>
                    <div class="terminal-build-area">
                        <div class="terminal-info">ä¸Šé™: <span id="val-gas-cap">0</span> | å·²æœ‰ <span id="val-term-cnt">0</span> åº§</div>
                        <button class="build-term-btn" onclick="game.buildTerminal()">æ–°å»ºæ¥æ”¶ç«™ ($1000)</button>
                    </div>
                    <div class="market-list" id="market-gas-list"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-overlay">
        <div class="retro-dialog">
            <div class="retro-inner">
                <div class="retro-title" id="modal-title">TITLE</div>
                <div id="modal-content-area">
                    <p id="modal-desc" style="font-size:14px; line-height:1.6; color:#ddd; margin:15px 0;">CONTENT</p>
                </div>
                <div id="modal-footer">
                    <button class="retro-btn" id="modal-btn" onclick="ui.closeModal()">ç¢º å®š</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const PLANTS = {
            coal: { name: 'ç‡ƒç…¤', emoji: 'ğŸ­', cost: 1000, output: 1500, fuel: 40, type: 'land', color: '#7f8c8d' },
            gas: { name: 'ç‡ƒæ°£', emoji: 'ğŸ”¥', cost: 1500, output: 2500, fuel: 30, type: 'land', color: '#d35400' },
            terminal: { name: 'æ¥æ”¶ç«™', emoji: 'âš“', cost: 2000, output: 0, fuel: 0, type: 'coast', color: '#2980b9' },
            green: { name: 'é¢¨é›»', emoji: 'ğŸŒ€', cost: 3000, output: 100, fuel: 0, type: 'sea', color: '#2ecc71' },
            solar: { name: 'å¤ªé™½èƒ½', emoji: 'â˜€ï¸', cost: 1200, output: 50, fuel: 0, type: 'land', color: '#f39c12' },
            nuclear: { name: 'æ ¸èƒ½', emoji: 'â˜¢ï¸', cost: 5000, output: 6000, fuel: 0, type: 'land', color: '#8e44ad' }
        };

        const STAGES = [
            {
                title: "éšæ®µä¸€ï¼šåŸºç¤å»ºè¨­",
                desc: "ç™¼å±•åˆæœŸï¼Œåå¤§å»ºè¨­å•Ÿå‹•ã€‚è«‹å»ºè¨­é›»å» ï¼Œæ»¿è¶³å·¥æ¥­ç™¼å±•çš„é›»åŠ›éœ€æ±‚ã€‚",
                goals: [
                    { txt: "ç™¼é›»é‡ > 12000MW", check: g => g.calcPower() >= 12000 },
                    { txt: "ç‡ƒç…¤é›»å»  > 6 åº§", check: g => g.counts.coal >= 6 }
                ]
            },
            {
                title: "éšæ®µäºŒï¼šç¶“æ¿Ÿèµ·é£›",
                desc: "ç¶“æ¿Ÿæˆé•·æœŸï¼Œç«¹ç§‘å´›èµ·ã€‚éœ€è¦ç©©å®šçš„ç‡ƒæ°£é›»åŠ›èˆ‡æ¥æ”¶ç«™ã€‚",
                goals: [
                    { txt: "æ¥æ”¶ç«™ > 3 åº§", check: g => g.counts.terminal >= 3 },
                    { txt: "ç‡ƒæ°£é›»å»  > 10 åº§", check: g => g.counts.gas >= 10 }
                ]
            },
            {
                title: "éšæ®µä¸‰ï¼šèƒ½æºè½‰å‹",
                desc: "æˆç†ŸæœŸï¼Œé¢å°å°é–é¢¨éšªï¼Œç›®æ¨™å»ºç«‹é«˜éŸŒæ€§èˆ‡ç¶ è‰²é›»ç¶²ã€‚",
                goals: [
                    { txt: "å®‰å…¨å­˜é‡ > 14å¤©", check: g => g.getSafetyDays() >= 14 },
                    { txt: "å†ç”Ÿèƒ½æº > 20%", check: g => g.getGreenPct() >= 20 },
                    { txt: "ç¸½ç™¼é›» > 70000MW", check: g => g.calcPower() >= 70000 }
                ]
            }
        ];

        const MARKET_SOURCES = {
            coal: [
                { id: 'au', name: 'æ¾³æ´²', flag: 'ğŸ‡¦ğŸ‡º', base: 100 },
                { id: 'id', name: 'å°å°¼', flag: 'ğŸ‡®ğŸ‡©', base: 80 },
                { id: 'ru', name: 'ä¿„åœ‹', flag: 'ğŸ‡·ğŸ‡º', base: 90 },
                { id: 'za', name: 'å—é', flag: 'ğŸ‡¿ğŸ‡¦', base: 85 },
                { id: 'ca', name: 'åŠ æ‹¿å¤§', flag: 'ğŸ‡¨ğŸ‡¦', base: 105 }
            ],
            gas: [
                { id: 'au', name: 'æ¾³æ´²', flag: 'ğŸ‡¦ğŸ‡º', base: 220 },
                { id: 'qa', name: 'å¡é”', flag: 'ğŸ‡¶ğŸ‡¦', base: 200 },
                { id: 'us', name: 'ç¾åœ‹', flag: 'ğŸ‡ºğŸ‡¸', base: 250 },
                { id: 'my', name: 'å¤§é¦¬', flag: 'ğŸ‡²ğŸ‡¾', base: 210 },
                { id: 'pg', name: 'å·´ç´', flag: 'ğŸ‡µğŸ‡¬', base: 230 }
            ]
        };

        const NUKE_RISK_MAP = [0, 1, 2, 5, 8, 11, 15, 20, 25, 30, 40]; 

        const game = {
            year: 1975, funds: 2000, comp: 100, demand: 10000, 
            fuel: { coal: 3000, gas: 0 }, cap: { coal: 3000, gas: 0 },
            counts: { coal: 0, gas: 0, terminal: 0, green: 0, solar: 0, nuclear: 0 },
            stageIdx: 0, selected: null, blockade: false, bDays: 0,
            marketPrices: {}, 
            purchaseCounts: { coal: {}, gas: {} },
            isFreePlay: false,
            history: [],
            importStats: { coal: {}, gas: {} },
            tutorialStep: 0,
            hasSeenMarketHint: false, // Flag for the market scroll hint
            
            nukeDisasterCount: 0,
            nukeShutdownTimer: 0,
            isNukePermanentlyBanned: false,

            init() {
                this.resetVariables();
                this.counts.coal = 0; 
                this.cap.coal = 3000; 
                this.updateMarketPrices();
                ui.renderDeck(); ui.renderMarket(); ui.updateAll();
                
                // Show mission intro first, then tutorial
                ui.showModal("ä»»å‹™ç°¡å ±", 
                    "æ­¡è¿ä¾†åˆ°ã€Šåƒç´ èƒ½æºã€‹ã€‚<br>æ‚¨å°‡æ‰®æ¼”å°ç£èƒ½æºæ±ºç­–è€…ï¼Œåœ¨é•·é”50å¹´çš„æ­·å²ä¸­ï¼Œé¢å°ç¶“æ¿Ÿç™¼å±•ã€ç’°ä¿è½‰å‹èˆ‡åœ°ç·£æ”¿æ²»çš„æŒ‘æˆ°ã€‚<br><br>ç›®æ¨™ï¼šå»ºç«‹ç©©å®šã€å®‰å…¨ä¸”æ½”æ·¨çš„é›»åŠ›ç³»çµ±ã€‚",
                    () => {
                        // User clicked OK
                        try { document.documentElement.requestFullscreen().catch(()=>{}); } catch(e){}
                        ui.closeModal();
                        if(game.year === 1975 && game.tutorialStep === 0) {
                            game.startTutorial();
                        }
                    }
                );
            },

            resetVariables() {
                this.year = 1975; 
                this.funds = 2000; // Adjusted starting funds to 2000
                this.comp = 100; this.demand = 10000;
                this.fuel = { coal: 3000, gas: 0 }; 
                this.cap = { coal: 3000, gas: 0 };
                this.counts = { coal: 0, gas: 0, terminal: 0, green: 0, solar: 0, nuclear: 0 };
                this.stageIdx = 0; this.selected = null; this.blockade = false; this.isFreePlay = false;
                this.history = []; this.importStats = { coal: {}, gas: {} };
                this.purchaseCounts = { coal: {}, gas: {} };
                
                this.nukeDisasterCount = 0;
                this.nukeShutdownTimer = 0;
                this.isNukePermanentlyBanned = false;
                this.hasSeenMarketHint = false;

                document.getElementById('buildings-layer').innerHTML = '';
                document.body.classList.remove('crisis-mode');
                this.tutorialStep = 0;
            },
            
            startTutorial() {
                this.tutorialStep = 1;
                this.updateTutorial();
            },

            nextTutorialStep() {
                // If we are at the market hint step (2.5), we need custom logic to transition to step 3 (Next button)
                if (this.tutorialStep === 2.5) {
                    this.tutorialStep = 3;
                    ui.clearHighlight();
                    ui.highlightElement('#next-btn', "ã€ä¸‹ä¸€å¹´åº¦ã€‘\næº–å‚™å¥½å¾Œï¼Œé»æ“Šæ­¤è™•æ¨é€²æ™‚é–“ä¸¦ç²å¾—ç¨…æ”¶ã€‚");
                    return;
                }

                if(this.tutorialStep > 0 && this.tutorialStep < 4) {
                    this.tutorialStep++;
                    this.updateTutorial();
                } else if(this.tutorialStep === 4) {
                    this.tutorialStep = 0; // End
                    ui.clearHighlight();
                }
            },

            updateTutorial() {
                ui.clearHighlight();
                const textEl = document.getElementById('tut-text');
                
                if(this.tutorialStep === 1) {
                    ui.highlightElement('#build-deck', "ã€å»ºè¨­å€ã€‘\né»æ“Šä¸‹æ–¹å¡ç‰‡å³å¯å»ºè¨­é›»å» ã€‚\næ³¨æ„ï¼šåˆæœŸè³‡é‡‘æœ‰é™ï¼Œè«‹è¬¹æ…è¦åŠƒã€‚");
                } else if(this.tutorialStep === 2) {
                    ui.highlightElement('.arcade-tabs button:nth-child(2)', "ã€ç‡ƒæ–™å¸‚å ´ã€‘\né»æ“Šåˆ‡æ›åˆ†é ï¼Œå¯è³¼è²·ç…¤ç‚­èˆ‡å¤©ç„¶æ°£ã€‚");
                } else if(this.tutorialStep === 2.5) {
                    // Logic handled in switchTab
                } else if(this.tutorialStep === 3) {
                    ui.highlightElement('#next-btn', "ã€ä¸‹ä¸€å¹´åº¦ã€‘\næº–å‚™å¥½å¾Œï¼Œé»æ“Šæ­¤è™•æ¨é€²æ™‚é–“ä¸¦ç²å¾—ç¨…æ”¶ã€‚");
                } else {
                    ui.clearHighlight();
                }
            },
            
            restart() {
                this.resetVariables();
                this.counts.coal = 0; this.cap.coal = 3000;
                this.updateMarketPrices();
                ui.renderDeck(); ui.renderMarket(); ui.updateAll();
                ui.closeModal();
                setTimeout(() => ui.showModal("éŠæˆ²é‡å•Ÿ", "ä¸€åˆ‡å›åˆ°åŸé»ï¼Œè«‹é‡æ–°è¦åŠƒèƒ½æºæ”¿ç­–ï¼", () => {
                     ui.closeModal();
                     game.startTutorial();
                }), 300);
            },

            selectCard(key) {
                if(this.selected === key) { this.selected = null; }
                else { this.selected = key; this.tryBuild(); }
                ui.renderDeck();
                
                if(this.tutorialStep === 1 && key === 'coal') {
                    this.tutorialStep = 2;
                    ui.clearHighlight();
                    ui.highlightElement('.arcade-tabs button:nth-child(2)', "ã€ç‡ƒæ–™å¸‚å ´ã€‘\nè«‹é»æ“Šä¸Šæ–¹æ¨™ç±¤ï¼Œåˆ‡æ›è‡³å¸‚å ´æ¡è³¼ç‡ƒæ–™ã€‚");
                }
            },

            tryBuild() {
                if (!this.selected) return;
                const p = PLANTS[this.selected];
                
                if (this.selected === 'nuclear') {
                    if (this.year >= 2021) {
                        ui.floatText('ğŸš« 2021å¾Œç¦æ­¢æ–°å»ºæ ¸é›»', 'red'); this.selected = null; return;
                    }
                    if (this.isNukePermanentlyBanned) {
                        ui.floatText('â›” æ ¸èƒ½å·²æ°¸ä¹…å»¢æ­¢', 'red'); this.selected = null; return;
                    }
                }

                if (this.funds < p.cost) {
                    ui.floatText('ğŸ’¸ è³‡é‡‘ä¸è¶³', 'red'); this.selected = null; return;
                }
                if (this.selected === 'gas' && this.counts.terminal === 0) {
                    ui.floatText('âš ï¸ éœ€å»ºæ¥æ”¶ç«™', 'red'); this.selected = null; return;
                }

                this.funds -= p.cost;
                this.counts[this.selected]++;
                
                if (this.selected === 'coal') this.cap.coal += 1500; 
                if (this.selected === 'terminal') this.cap.gas += 1500;
                
                ui.floatText(`-$${p.cost}`, 'gold');
                this.placeBuilding(this.selected);
                this.selected = null;
                ui.renderDeck(); ui.updateAll();
                
                // If user is in tutorial step 2 (should be market) but builds again, remind them
                if(this.tutorialStep === 2) {
                    ui.clearHighlight();
                    ui.highlightElement('.arcade-tabs button:nth-child(2)', "ã€ç‡ƒæ–™å¸‚å ´ã€‘\nè«‹é»æ“Šä¸Šæ–¹æ¨™ç±¤ï¼Œåˆ‡æ›è‡³å¸‚å ´æ¡è³¼ç‡ƒæ–™ã€‚");
                }
            },

            buildTerminal() {
                const p = PLANTS.terminal;
                if (this.funds < p.cost) {
                    ui.floatText('ğŸ’¸ è³‡é‡‘ä¸è¶³', 'red'); return;
                }
                this.funds -= p.cost;
                this.counts.terminal++;
                this.cap.gas += 1500;
                ui.floatText(`-$${p.cost} æ“´å……`, 'gold');
                this.placeBuilding('terminal');
                ui.updateAll();
            },

            placeBuilding(type) {
                const pInfo = PLANTS[type];
                const el = document.createElement('div');
                el.innerText = pInfo.emoji;
                el.style.position = 'absolute';
                el.style.fontSize = '18px';
                el.style.animation = 'dropIn 0.3s';
                let x, y;
                switch(pInfo.type) {
                    case 'sea': x = 10 + Math.random() * 50; y = 100 + Math.random() * 300; break;
                    case 'coast': x = 60 + Math.random() * 20; y = 50 + Math.random() * 300; break;
                    case 'land': x = 100 + Math.random() * 100; y = 50 + Math.random() * 350; break;
                }
                el.style.left = x + 'px'; el.style.top = y + 'px';
            },

            buyFuel(type, countryId) {
                if (this.blockade) { ui.floatText('ğŸš« å°é–ä¸­', 'red'); return; }
                const basePrice = this.marketPrices[`${type}_${countryId}`];
                const surge = this.purchaseCounts[type][countryId] || 0;
                const finalCost = basePrice + surge;

                if (this.funds < finalCost) { ui.floatText('ğŸ’¸ è³‡é‡‘ä¸è¶³', 'red'); return; }
                if (this.fuel[type] + 100 > this.cap[type]) {
                    ui.floatText('ğŸ“¦ å€‰åº«å·²æ»¿', 'red');
                    if(type==='gas' && this.counts.terminal===0) ui.floatText('âš ï¸ éœ€æ¥æ”¶ç«™', 'red');
                    return;
                }
                this.funds -= finalCost;
                this.fuel[type] += 100;
                if (!this.purchaseCounts[type][countryId]) this.purchaseCounts[type][countryId] = 0;
                this.purchaseCounts[type][countryId]++;
                if (!this.importStats[type][countryId]) this.importStats[type][countryId] = 0;
                this.importStats[type][countryId] += 100;
                ui.floatText(`+100`, 'blue');
                ui.updateAll();
                if(this.tutorialStep === 4) { this.tutorialStep = 5; ui.clearHighlight(); }
            },

            updateMarketPrices() {
                this.purchaseCounts = { coal: {}, gas: {} };
                ['coal', 'gas'].forEach(type => {
                    MARKET_SOURCES[type].forEach(src => {
                        const fluc = 0.8 + Math.random() * 0.5;
                        this.marketPrices[`${type}_${src.id}`] = Math.floor(src.base * fluc);
                    });
                });
            },

            calcIncome() {
                let baseIncome = 500;
                if (game.stageIdx === 1) baseIncome = 1000;
                if (game.stageIdx === 2) baseIncome = 2000;
                const powerBonus = Math.floor(this.calcPower(true) * 0.4); 
                return baseIncome + powerBonus;
            },
            
            getNukeRisk() {
                const cnt = this.counts.nuclear;
                if(cnt >= NUKE_RISK_MAP.length) return 50;
                return NUKE_RISK_MAP[cnt];
            },

            checkNuclearDisaster() {
                if (this.counts.nuclear > 0) {
                    const risk = this.getNukeRisk();
                    if (Math.random() * 100 < risk) {
                        this.nukeDisasterCount++;
                        let loss = Math.max(5000, Math.floor(this.funds / 2));
                        this.funds -= loss;
                        this.funds -= 2000;
                        if(this.funds < 0) { this.comp -= 15; ui.floatText("ğŸ’¸ ç ´ç”¢!", "red"); }
                        this.counts.nuclear--;
                        this.nukeShutdownTimer = 2;
                        this.comp -= 30;
                        if(this.nukeDisasterCount >= 3) {
                            this.isNukePermanentlyBanned = true;
                            this.counts.nuclear = 0; 
                            ui.showModal("â˜¢ï¸ æ ¸èƒ½æ°¸ä¹…å»¢æ­¢", "æ ¸ç½ç™¼ç”Ÿä¸‰æ¬¡ï¼Œç¤¾æœƒå…±è­˜å´©ç›¤ã€‚<br>æ‰€æœ‰æ ¸é›»å» å¼·åˆ¶é™¤å½¹ï¼", () => ui.closeModal());
                        } else {
                            ui.showModal("â˜¢ï¸ æ ¸ç½çˆ†ç™¼ï¼", `æå¤±æ…˜é‡ï¼(-$${loss+2000})<br>å…¶é¤˜æ ¸é›»å» å¼·åˆ¶åœæ©Ÿå®‰æª¢ 2 å¹´ã€‚`, () => ui.closeModal());
                        }
                        ui.renderDeck();
                    }
                }
            },

            nextTurn() {
                if(game.tutorialStep === 3) { this.tutorialStep = 4; ui.highlightElement('.pixel-btn:nth-child(2)', 'è«‹åˆ‡æ›è‡³å¸‚å ´è³¼è²·ç‡ƒæ–™'); }
                if (this.blockade) { this.handleBlockade(); return; }
                this.year++; 
                if (this.nukeShutdownTimer > 0) this.nukeShutdownTimer--;

                // Record history
                const pCoal = this.counts.coal * PLANTS.coal.output;
                const pGas = this.counts.gas * PLANTS.gas.output;
                const pNuke = this.calcNukeOutput();
                const pGreen = (this.counts.green * PLANTS.green.output) + (this.counts.solar * PLANTS.solar.output);
                
                this.history.push({
                    year: this.year,
                    coal: pCoal,
                    gas: pGas,
                    nuclear: pNuke,
                    green: pGreen
                });

                this.checkNuclearDisaster();
                
                // === MOVED GOAL CHECK HERE (BEFORE CONSUMPTION) ===
                if (!this.isFreePlay) {
                    const stage = STAGES[this.stageIdx];
                    if (stage && stage.goals.every(g => g.check(this))) {
                        if (this.stageIdx < STAGES.length - 1) {
                            this.stageIdx++;
                            ui.showModal(STAGES[this.stageIdx].title, STAGES[this.stageIdx].desc, () => ui.closeModal());
                        } else {
                            ui.showVictory();
                            // If victory, stop processing consumption to prevent "13 days" feel-bad moment visually
                            return; 
                        }
                    }
                }
                // ==================================================

                const income = this.calcIncome();
                this.funds += income; 
                ui.floatText(`+${income} è³‡é‡‘`, 'gold');
                this.demand += 1200;
                this.updateMarketPrices();
                
                this.consumeFuel(); // Fuel consumed AFTER goal check
                
                const power = this.calcPower();
                if (power < this.demand) {
                    this.comp -= 15; ui.floatText('âš¡ ç¼ºé›»!', 'red');
                } else {
                    this.comp = Math.min(100, this.comp + 5);
                }

                if (this.year > 2020 && Math.random() < 0.15 && !this.isFreePlay) this.startBlockade();
                if (this.comp <= 0) { ui.showGameOver(); return; }
                ui.renderMarket(); ui.updateAll();
            },

            consumeFuel() {
                const cNeed = this.counts.coal * PLANTS.coal.fuel;
                const gNeed = this.counts.gas * PLANTS.gas.fuel;
                if (this.fuel.coal >= cNeed) this.fuel.coal -= cNeed;
                else { this.fuel.coal = 0; if(this.counts.coal>0){this.comp -= 5; ui.floatText('ç¼ºç…¤', 'red');} }
                if (this.fuel.gas >= gNeed) this.fuel.gas -= gNeed;
                else { this.fuel.gas = 0; if(this.counts.gas>0){this.comp -= 5; ui.floatText('ç¼ºæ°£', 'red');} }
            },

            calcNukeOutput() {
                if (this.nukeShutdownTimer > 0) return 0;
                return this.counts.nuclear * PLANTS.nuclear.output;
            },

            calcPower(ignoreShutdown = false) { 
                let nukeOut = this.calcNukeOutput();
                if (ignoreShutdown) nukeOut = this.counts.nuclear * PLANTS.nuclear.output;
                return (this.counts.coal * PLANTS.coal.output) + 
                       (this.counts.gas * PLANTS.gas.output) + 
                       (this.counts.green * PLANTS.green.output) + 
                       (this.counts.solar * PLANTS.solar.output) + 
                       nukeOut;
            },
            
            getGreenPct() {
                const total = this.calcPower();
                if (total === 0) return 0;
                const green = (this.counts.green * PLANTS.green.output) + (this.counts.solar * PLANTS.solar.output);
                return Math.floor((green / total) * 100);
            },

            getSafetyDays() {
                const cUse = Math.max(1, this.counts.coal * PLANTS.coal.fuel);
                const gUse = Math.max(1, this.counts.gas * PLANTS.gas.fuel);
                const cDay = Math.floor(this.fuel.coal / cUse);
                const gDay = (this.counts.gas === 0) ? 99 : Math.floor(this.fuel.gas / gUse);
                return Math.min(cDay, gDay);
            },
            
            getCoalDays() {
                 if (this.counts.coal === 0) return null;
                 const cUse = this.counts.coal * PLANTS.coal.fuel;
                 return Math.floor(this.fuel.coal / cUse);
            },
            
            getGasDays() {
                 if (this.counts.gas === 0) return null;
                 const gUse = this.counts.gas * PLANTS.gas.fuel;
                 return Math.floor(this.fuel.gas / gUse);
            },

            startBlockade() {
                this.blockade = true; this.bDays = 11;
                document.body.classList.add('crisis-mode');
                ui.showModal("âš ï¸ ç´…è‰²è­¦å ±", "æµ·å³½å°é–é–‹å§‹ï¼é€²å£ä¸­æ–·ï¼Œè«‹æ’é 11 å¤©ã€‚", () => ui.closeModal());
            },

            handleBlockade() {
                this.bDays--; this.consumeFuel();
                ui.floatText(`å‰© ${this.bDays} å¤©`, 'red');
                if (this.bDays <= 0) {
                    this.blockade = false; document.body.classList.remove('crisis-mode');
                    ui.showModal("ğŸ³ï¸ å±æ©Ÿè§£é™¤", "å°é–çµæŸï¼Œå°ç£å­˜æ´»ï¼", () => ui.closeModal());
                }
                ui.updateAll();
            }
        };

        const ui = {
            switchTab(tab) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.pixel-btn').forEach(el => el.classList.remove('active'));
                document.getElementById(`tab-${tab}`).classList.add('active');
                
                const btns = document.querySelectorAll('.pixel-btn');
                if(tab==='build') btns[0].classList.add('active');
                if(tab==='market') btns[1].classList.add('active');
                
                // === New Market Hint Logic ===
                if (tab === 'market' && !game.hasSeenMarketHint && game.tutorialStep === 2) {
                    game.hasSeenMarketHint = true;
                    game.tutorialStep = 2.5; // Intermediate step
                    setTimeout(() => {
                        ui.highlightElement('.market-list', "ã€å…¨çƒå¸‚å ´ã€‘\nå‘ä¸‹æ»‘å‹•å¯æŸ¥çœ‹æ›´å¤šä¾›æ‡‰åœ‹ã€‚\nåˆ†æ•£è²¨æºå¯é¿å…å–®ä¸€åƒ¹æ ¼æ³¢å‹•ï¼");
                    }, 300);
                }

                if(game.tutorialStep === 4 && tab === 'market') {
                    setTimeout(() => ui.highlightElement('.buy-btn-mini:first-child', 'é»æ“Šè³¼è²·ï¼'), 100);
                }
            },

            highlightElement(selector, text) {
                document.getElementById('tutorial-overlay').style.display = 'block';
                const el = document.querySelector(selector);
                if(el) {
                    el.classList.add('highlight-target');
                    const tooltip = document.getElementById('tutorial-tooltip');
                    document.getElementById('tut-text').innerText = text;
                    tooltip.style.display = 'block';
                }
            },

            clearHighlight() {
                document.getElementById('tutorial-overlay').style.display = 'none';
                document.getElementById('tutorial-tooltip').style.display = 'none';
                document.querySelectorAll('.highlight-target').forEach(el => el.classList.remove('highlight-target'));
            },

            renderDeck() {
                const buildable = Object.entries(PLANTS).filter(([k,v]) => k !== 'terminal');
                document.getElementById('build-deck').innerHTML = buildable.map(([k, v]) => {
                    let locked = false;
                    let lockReason = '';
                    let riskText = '';
                    if (k === 'nuclear') {
                        if (game.year >= 2021) { locked = true; lockReason = 'ğŸš« 2021é™å»º'; }
                        else if (game.isNukePermanentlyBanned) { locked = true; lockReason = 'â›” æ°¸ä¹…å»¢æ­¢'; }
                        else {
                            const risk = game.getNukeRisk();
                            riskText = `<div class="nuke-risk">âš ï¸ ç½ç‡:${risk}%</div>`;
                        }
                    }
                    const count = game.counts[k];
                    
                    return `
                    <div class="pixel-card ${game.selected === k ? 'selected' : ''} ${locked ? 'disabled' : ''}" onclick="game.selectCard('${k}')">
                        <div class="card-badge">${count}</div>
                        ${locked ? `<div class="lock-overlay">${lockReason}</div>` : ''}
                        ${riskText}
                        <div class="card-emoji">${v.emoji}</div>
                        <div class="card-name" style="color:${v.color}">${v.name}</div>
                        <div class="card-power">+${v.output}MW</div>
                        <div class="card-cost">$${v.cost.toLocaleString()}</div>
                    </div>
                `}).join('');
            },

            renderMarket() {
                document.getElementById('val-coal-stock').innerText = game.fuel.coal.toLocaleString();
                document.getElementById('val-gas-stock').innerText = game.fuel.gas.toLocaleString();
                
                document.getElementById('val-gas-cap').innerText = game.cap.gas.toLocaleString();
                document.getElementById('val-term-cnt').innerText = game.counts.terminal;

                document.getElementById('market-coal-list').innerHTML = MARKET_SOURCES.coal.map(src => {
                    const base = game.marketPrices['coal_'+src.id]||src.base;
                    const surge = game.purchaseCounts['coal'][src.id] || 0;
                    return `
                    <div class="market-country-row">
                        <div class="m-top"><span class="flag">${src.flag} ${src.name}</span><span class="price">$${base+surge}</span></div>
                        <button class="buy-btn-mini" onclick="game.buyFuel('coal', '${src.id}')">100å™¸ $${base+surge}</button>
                    </div>`
                }).join('');

                document.getElementById('market-gas-list').innerHTML = MARKET_SOURCES.gas.map(src => {
                    const base = game.marketPrices['gas_'+src.id]||src.base;
                    const surge = game.purchaseCounts['gas'][src.id] || 0;
                    return `
                    <div class="market-country-row">
                        <div class="m-top"><span class="flag">${src.flag} ${src.name}</span><span class="price">$${base+surge}</span></div>
                        <button class="buy-btn-mini" onclick="game.buyFuel('gas', '${src.id}')">100å™¸ $${base+surge}</button>
                    </div>`
                }).join('');
            },

            updatePieChart() {
                const pCoal = game.counts.coal * PLANTS.coal.output;
                const pGas = game.counts.gas * PLANTS.gas.output;
                const pGreen = (game.counts.green * PLANTS.green.output) + (game.counts.solar * PLANTS.solar.output);
                const pNuke = game.calcNukeOutput(); 
                const total = pCoal + pGas + pGreen + pNuke;
                
                if (total === 0) return;

                const degCoal = (pCoal / total) * 360;
                const degGas = (pGas / total) * 360;
                const degGreen = (pGreen / total) * 360;
                const degNuke = (pNuke / total) * 360;

                const chart = document.getElementById('power-pie-chart');
                chart.style.background = `conic-gradient(
                    var(--color-coal) 0deg ${degCoal}deg,
                    var(--color-gas) ${degCoal}deg ${degCoal + degGas}deg,
                    var(--color-nuclear) ${degCoal + degGas}deg ${degCoal + degGas + degNuke}deg,
                    var(--color-green) ${degCoal + degGas + degNuke}deg 360deg
                )`;
            },

            updateAll() {
                document.getElementById('hud-year').innerText = game.year;
                document.getElementById('hud-funds').innerText = game.funds.toLocaleString();
                document.getElementById('hud-comp').innerText = game.comp + '%';
                
                const days = game.getSafetyDays();
                document.getElementById('hud-days').innerText = (days > 99 ? 'å……è¶³' : days + 'å¤©');
                document.getElementById('hud-days').className = `stat-val ${days < 14 ? 'red' : ''}`;

                document.getElementById('stat-supply').innerText = game.calcPower().toLocaleString() + " MW";
                document.getElementById('stat-demand').innerText = game.demand.toLocaleString() + " MW";
                
                const cDays = game.getCoalDays();
                document.getElementById('stat-coal-days').innerText = (cDays === null ? '--' : (cDays > 99 ? 'âˆ' : cDays + 'å¤©'));
                
                const gDays = game.getGasDays();
                document.getElementById('stat-gas-days').innerText = (gDays === null ? '--' : (gDays > 99 ? 'âˆ' : gDays + 'å¤©'));

                if (!game.isFreePlay) {
                    const s = STAGES[game.stageIdx];
                    document.getElementById('story-text').innerText = s.desc;
                    document.getElementById('goal-list').innerHTML = s.goals.map(g => `
                        <div class="goal-item"><span class="goal-check ${g.check(game) ? 'done' : ''}">${g.check(game) ? 'âœ…' : 'â¬œ'}</span> <span>${g.txt}</span></div>
                    `).join('');
                } else {
                    document.getElementById('story-text').innerText = "è‡ªç”±åŸ·æ”¿æ¨¡å¼";
                    document.getElementById('goal-list').innerHTML = "<div class='goal-item'>ç¶­æŒç«¶çˆ­åŠ› > 0%</div>";
                }

                if (game.blockade) {
                    document.getElementById('next-btn').innerHTML = `æ’ä½<br>${game.bDays}å¤©`;
                    document.getElementById('next-btn').style.background = '#000';
                } else {
                    document.getElementById('next-btn').innerHTML = `ä¸‹ä¸€<br>å¹´åº¦`;
                    document.getElementById('next-btn').style.background = 'var(--accent-red)';
                }
                
                this.updatePieChart();
                this.renderMarket();
                this.renderDeck();
            },

            floatText(txt, color) {
                const el = document.createElement('div'); el.className = 'float-pixel'; el.innerText = txt;
                el.style.color = color === 'red' ? '#e74c3c' : (color === 'gold' ? '#f1c40f' : '#fff');
                el.style.left = '50%'; el.style.top = '40%';
                document.body.appendChild(el); setTimeout(() => el.remove(), 1200);
            },

            showModal(title, desc, callback) {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-content-area').innerHTML = `<p id="modal-desc" style="font-size:14px; line-height:1.6; color:#ddd; margin:15px 0;">${desc}</p>`;
                
                const btn = document.getElementById('modal-btn');
                btn.innerText = "ç¢º å®š";
                // IMPORTANT: Use the provided callback or default to just close
                btn.onclick = callback ? callback : ui.closeModal;
                btn.className = 'retro-btn';
                document.getElementById('modal-overlay').style.display = 'flex';
            },
            
            showCompHelp() {
                ui.showModal("ç«¶çˆ­åŠ›èªªæ˜", `
                    <div class="rule-list">
                        <div class="rule-title">è©•åˆ†è¦å‰‡</div>
                        <div class="rule-item"><span>âš¡ ä¾›é›»å……è¶³</span><span style="color:#2ecc71">+5%</span></div>
                        <div class="rule-item"><span>âš¡ ä¾›é›»ä¸è¶³</span><span style="color:#e74c3c">-15%</span></div>
                        <div class="rule-item"><span>ğŸª¨ ç¼ºå°‘ç…¤ç‚­</span><span style="color:#e74c3c">-5%</span></div>
                        <div class="rule-item"><span>ğŸ”¥ ç¼ºå°‘å¤©ç„¶æ°£</span><span style="color:#e74c3c">-5%</span></div>
                    </div>
                `);
            },

            showFundsHelp() {
                ui.showModal("å·¥æ¥­ç¨…æ”¶èªªæ˜", `
                    <div class="rule-list">
                        <div class="rule-title">è¨ˆç®—å…¬å¼</div>
                        <div class="rule-item"><span>ğŸ’° åŸºç¤ç¨…æ”¶</span><span>$${game.stageIdx===0?500:(game.stageIdx===1?1000:2000)}</span></div>
                        <div class="rule-item"><span>âš¡ å·¥æ¥­ç¨…æ”¶</span><span>+$${Math.floor(game.calcPower(true)*0.4).toLocaleString()}</span></div>
                        <div class="rule-item" style="border-top:1px solid #fff; margin-top:5px; padding-top:5px;">
                            <span>é è¨ˆä¸‹å¹´æ”¶å…¥</span><span style="color:#f1c40f">$${game.calcIncome().toLocaleString()}</span>
                        </div>
                        <div style="font-size:10px; color:#888; margin-top:5px;">(å…¬å¼ï¼šç™¼é›»é‡ x 0.4 + åŸºç¤ç¨…)</div>
                    </div>
                `);
            },

            showStockHelp() {
                const cDays = game.getCoalDays();
                const gDays = game.getGasDays();
                
                ui.showModal("å­˜é‡èªªæ˜", `
                    <div class="rule-list">
                        <div class="rule-title">ç›®å‰å¯æ”¯æ’å¤©æ•¸</div>
                        <div class="rule-item"><span>ğŸª¨ ç…¤ç‚­</span><span>${cDays===null?'--':(cDays>99?'âˆ':cDays+' å¤©')}</span></div>
                        <div class="rule-item"><span>ğŸ”¥ å¤©ç„¶æ°£</span><span>${gDays===null?'--':(gDays>99?'âˆ':gDays+' å¤©')}</span></div>
                        <div style="margin-top:10px; font-size:11px; color:#aaa; line-height:1.4;">
                            æ¶ˆè€—å…¬å¼ï¼š<br>
                            ç‡ƒç…¤æ¶ˆè€— = é›»å» æ•¸ x ${PLANTS.coal.fuel}<br>
                            ç‡ƒæ°£æ¶ˆè€— = é›»å» æ•¸ x ${PLANTS.gas.fuel}<br>
                            å¤©æ•¸ = åº«å­˜ / å¹´æ¶ˆè€—<br>
                            <span style="color:#e74c3c">*å°é–æœŸé–“ç„¡æ³•é€²å£ï¼Œéœ€é å­˜é‡æ’é11å¤©ã€‚</span>
                        </div>
                    </div>
                `);
            },

            showGameOver() {
                document.getElementById('modal-title').innerText = "åœ‹å®¶ç ´ç”¢";
                document.getElementById('modal-content-area').innerHTML = '<p style="color:#e74c3c">é›»åŠ›ä¸ç©©å°è‡´ç”¢æ¥­å¤–ç§»ï¼Œç«¶çˆ­åŠ›æ­¸é›¶ã€‚</p>';
                
                const btn = document.getElementById('modal-btn');
                btn.innerText = "ğŸ”„ é‡æ–°é–‹å§‹";
                btn.classList.add('restart');
                btn.onclick = () => game.restart();
                document.getElementById('modal-overlay').style.display = 'flex';
            },

            showVictory() {
                document.getElementById('modal-title').innerText = "ğŸ† èƒ½æºè½‰å‹æˆåŠŸï¼";
                
                let maxPower = 0;
                game.history.forEach(h => {
                    const total = h.coal + h.gas + h.nuclear + h.green;
                    if(total > maxPower) maxPower = total;
                });
                
                // --- Updated SVG Chart with X-Axis and better layout ---
                const startYear = game.history[0].year;
                const endYear = game.history[game.history.length-1].year;
                const duration = game.history.length - 1;
                
                let paths = { coal: "M0,200 ", gas: "M0,200 ", nuke: "M0,200 ", green: "M0,200 " };
                
                // For percentages in legend
                const lastH = game.history[game.history.length-1];
                const lastTotal = lastH.coal + lastH.gas + lastH.nuclear + lastH.green;
                const pcts = {
                    coal: Math.round(lastH.coal/lastTotal*100),
                    gas: Math.round(lastH.gas/lastTotal*100),
                    nuke: Math.round(lastH.nuclear/lastTotal*100),
                    green: Math.round(lastH.green/lastTotal*100)
                };

                game.history.forEach((h, i) => {
                    // Map x from 0 to 400 (SVG width)
                    const x = (i / duration) * 400;
                    
                    // Normalize height to 180 (SVG height - bottom margin)
                    const hCoal = (h.coal / maxPower) * 180;
                    const hGas = (h.coal + h.gas) / maxPower * 180;
                    const hNuke = (h.coal + h.gas + h.nuclear) / maxPower * 180;
                    const hGreen = (h.coal + h.gas + h.nuclear + h.green) / maxPower * 180;
                    
                    paths.coal += `L${x},${200 - hCoal} `;
                    paths.gas += `L${x},${200 - hGas} `;
                    paths.nuke += `L${x},${200 - hNuke} `;
                    paths.green += `L${x},${200 - hGreen} `;
                });
                
                const closePath = `L400,200 L0,200 Z`;

                // Generate X-Axis Labels
                let xAxisLabels = "";
                for(let i=0; i <= duration; i++) {
                    const currentY = startYear + i;
                    if(currentY % 5 === 0 || i === 0 || i === duration) {
                        const x = (i / duration) * 400;
                        // Avoid edge clipping
                        let textAnchor = "middle";
                        if(i===0) textAnchor = "start";
                        if(i===duration) textAnchor = "end";
                        xAxisLabels += `<text x="${x}" y="215" fill="#aaa" font-size="12" text-anchor="${textAnchor}">${currentY}</text>`;
                    }
                }

                const getRank = (obj) => Object.entries(obj)
                    .sort((a,b) => b[1] - a[1])
                    .map(e => {
                        const name = MARKET_SOURCES.coal.find(x=>x.id==e[0])?.name || MARKET_SOURCES.gas.find(x=>x.id==e[0])?.name || e[0];
                        const flag = MARKET_SOURCES.coal.find(x=>x.id==e[0])?.flag || MARKET_SOURCES.gas.find(x=>x.id==e[0])?.flag || '';
                        return `<div class="rank-item"><span>${flag} ${name}</span><span>${e[1]}00å™¸</span></div>`;
                    }).join('');

                const finalHTML = `
                    <p style="color:#2ecc71; margin-bottom:10px;">æ‚¨å»ºç«‹äº†é«˜éŸŒæ€§çš„é›»åŠ›ç³»çµ±ï¼</p>
                    
                    <div class="chart-container">
                        <div class="chart-title">ğŸ“ˆ ç™¼é›»çµæ§‹å †ç–Šåœ– (ç¸½: ${game.calcPower().toLocaleString()} MW)</div>
                        <svg viewBox="0 0 400 220" style="background:#222; width:100%; height:auto;">
                            <path d="${paths.green + closePath}" fill="#2ecc71" />
                            <path d="${paths.nuke + closePath}" fill="#8e44ad" />
                            <path d="${paths.gas + closePath}" fill="#d35400" />
                            <path d="${paths.coal + closePath}" fill="#7f8c8d" />
                            ${xAxisLabels}
                        </svg>
                        <div class="chart-legend">
                            <div class="legend-item"><span class="color-box" style="background:#7f8c8d"></span>ç…¤ ${pcts.coal}%</div>
                            <div class="legend-item"><span class="color-box" style="background:#d35400"></span>æ°£ ${pcts.gas}%</div>
                            <div class="legend-item"><span class="color-box" style="background:#8e44ad"></span>æ ¸ ${pcts.nuke}%</div>
                            <div class="legend-item"><span class="color-box" style="background:#2ecc71"></span>ç¶  ${pcts.green}%</div>
                        </div>
                    </div>

                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <div style="flex:1;">
                            <div class="chart-title">ğŸª¨ ç…¤ç‚­é€²å£æ’è¡Œ</div>
                            <div class="rank-list">${getRank(game.importStats.coal)}</div>
                        </div>
                        <div style="flex:1;">
                            <div class="chart-title">ğŸ”¥ å¤©ç„¶æ°£é€²å£æ’è¡Œ</div>
                            <div class="rank-list">${getRank(game.importStats.gas)}</div>
                        </div>
                    </div>
                `;

                document.getElementById('modal-content-area').innerHTML = finalHTML;
                
                const btn = document.getElementById('modal-btn');
                btn.innerText = "ç¹¼çºŒåŸ·æ”¿";
                btn.className = 'retro-btn victory';
                btn.onclick = () => {
                    game.isFreePlay = true;
                    ui.closeModal();
                };
                
                const contentArea = document.querySelector('.retro-inner');
                if(!contentArea.querySelector('.restart')) {
                    const restartBtn = document.createElement('button');
                    restartBtn.className = 'retro-btn restart';
                    restartBtn.innerText = "ğŸ”„ é‡æ–°æŒ‘æˆ°";
                    restartBtn.style.marginTop = '10px';
                    restartBtn.onclick = () => game.restart();
                    contentArea.appendChild(restartBtn);
                }
                
                document.getElementById('modal-overlay').style.display = 'flex';
            },

            closeModal() { 
                document.getElementById('modal-overlay').style.display = 'none'; 
                document.getElementById('modal-content-area').innerHTML = '<p id="modal-desc" style="font-size:14px; line-height:1.6; color:#ddd; margin:15px 0;">CONTENT</p>';
                const btn = document.getElementById('modal-btn');
                btn.className = 'retro-btn';
                
                const restartBtn = document.querySelector('.retro-btn.restart');
                if(restartBtn) restartBtn.remove();
            }
        };

        game.init();
    </script>
</body>
</html>
