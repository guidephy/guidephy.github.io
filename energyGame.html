<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>âš¡ å³¶å¶¼èƒ½æºç”Ÿå­˜æˆ°</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Noto+Sans+TC:wght@500;900&display=swap');

        :root {
            --bg-ocean: #2c3e50;
            --land-green: #27ae60;
            --land-border: #145a32;
            --ui-bg: #212529;
            --ui-border: #95a5a6;
            --accent-blue: #3498db;
            --accent-gold: #f1c40f;
            --accent-red: #e74c3c;
            --text-white: #ecf0f1;
            
            --color-coal: #7f8c8d;
            --color-oil: #1a1a2e;
            --color-gas: #d35400;
            --color-green: #2ecc71;
            --color-solar: #f39c12;
            --color-nuclear: #8e44ad;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; user-select: none; }
        
        body {
            font-family: 'Noto Sans TC', monospace;
            background-color: var(--bg-ocean);
            background-image: 
                linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            
            width: 100vw;
            height: 100dvh;
            overflow: hidden;
            color: var(--text-white);
            display: flex;
            flex-direction: column;
            image-rendering: pixelated;
        }

        /* === HUD (COMPACT VERSION) === */
        #hud {
            flex: 0 0 auto;
            background: var(--ui-bg);
            border-bottom: 3px solid var(--ui-border);
            padding: 4px 4px; /* Reduced padding */
            padding-top: max(4px, env(safe-area-inset-top)); 
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            z-index: 100;
            position: relative; 
        }
        .stat-box { position: relative; text-align: center; border: 2px solid #555; background: #000; padding: 2px 2px; cursor: pointer; }
        .stat-label { font-size: 10px; color: #aaa; display: block; margin-bottom: 0px; } /* Smaller font */
        .stat-val { font-family: 'VT323', monospace; font-size: 18px; color: #fff; font-weight: bold; line-height: 1; } /* Smaller font (was 22px) */
        .stat-val.gold { color: var(--accent-gold); }
        .stat-val.blue { color: var(--accent-blue); }
        .stat-val.red { color: var(--accent-red); animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        .help-btn {
            position: absolute; top: 0; right: 0;
            color: #000; background: var(--accent-gold); 
            font-size: 10px; font-weight: bold; cursor: pointer;
            width: 12px; height: 12px; line-height: 12px;
            text-align: center; border-bottom-left-radius: 4px;
        }
        
        .hud-help-icon { font-size: 18px; color: #fff; line-height: 24px; }

        /* === Info Bar === */
        #info-bar {
            display: flex; width: 100%; 
            background: rgba(33, 37, 41, 0.95);
            border-bottom: 2px solid #555;
            font-size: 11px; line-height: 1.3;
            z-index: 90; flex-shrink: 0;
        }
        #info-bar-story {
            flex: 1; padding: 4px 8px; /* Slightly tighter */
            border-right: 1px solid #555;
            color: #ddd;
        }
        #info-bar-goals {
            flex: 1; padding: 4px 8px;
        }
        #info-bar-story .bar-title {
            font-size: 11px; color: var(--accent-gold); font-weight: 900; margin-bottom: 1px;
        }
        #info-bar-goals .bar-title {
            font-size: 11px; color: var(--accent-blue); font-weight: 900; margin-bottom: 1px;
        }
        .bar-goal-item {
            display: flex; align-items: center; gap: 3px; font-size: 10px; color: #ccc;
        }
        .bar-goal-item .goal-check { font-size: 11px; }
        .bar-goal-item .goal-check.done { color: var(--land-green); font-weight: bold; }

        /* === Map Stage (Will naturally expand due to flex:1) === */
        #game-stage {
            flex: 1; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; width: 100%;
        }
        #map-container { position: relative; width: 100%; height: 100%; }

        /* Year Display on Map */
        #map-year-display {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            padding: 4px 15px;
            color: #fff; 
            font-family: 'VT323', monospace;
            font-size: 24px; 
            font-weight: bold;
            z-index: 92;
            text-shadow: 2px 2px 0 #000;
            pointer-events: none;
        }

        #taiwan-svg {
            width: 100%; height: 100%;
            filter: drop-shadow(6px 6px 0px rgba(0,0,0,0.5));
            overflow: visible;
        }
        .map-path { fill: var(--land-green); stroke: var(--land-border); stroke-width: 3px; }

        /* Revised Pie Chart Style - Centered & Larger */
        #power-pie-chart {
            position: absolute;
            top: 48%; /* Slight adjustment */
            left: 50%; 
            transform: translate(-50%, -50%);
            width: 140px; height: 140px; /* Slightly smaller to fit better */
            border-radius: 50%;
            background: #444;
            border: 4px solid #fff;
            box-shadow: 6px 6px 0px rgba(0,0,0,0.5);
            z-index: 50; pointer-events: none;
            transition: background 0.5s ease;
        }
        /* Center hole for Donut effect */
        #pie-center-hole {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 46px; height: 46px; background: rgba(0,0,0,0.6); border-radius: 50%;
            border: 2px solid #fff;
            display: flex; align-items: center; justify-content: center;
        }
        #pie-center-text {
            font-size: 10px; color: #fff; font-weight: bold;
        }

        /* On-Chart Labels */
        .chart-label {
            position: absolute;
            transform: translate(-50%, -50%);
            color: #fff;
            font-family: 'VT323', monospace;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            text-shadow: 
                -1px -1px 0 #000,  1px -1px 0 #000,
                -1px  1px 0 #000,  1px  1px 0 #000,
                 2px 2px 0px rgba(0,0,0,0.5);
            pointer-events: none;
            white-space: nowrap;
            line-height: 0.9;
        }
        .chart-label span {
            display: block;
            font-size: 12px; font-family: 'Noto Sans TC', sans-serif;
            margin-bottom: 2px;
        }

        #map-data-overlay {
            position: absolute;
            bottom: 4px; left: 4px;   
            background: rgba(10, 10, 10, 0.85);
            border: 1px solid rgba(255,255,255,0.5);
            padding: 4px 6px;
            width: 120px;
            z-index: 95;
            pointer-events: none;
            box-shadow: 2px 2px 0px rgba(0,0,0,0.5);
            border-radius: 2px;
        }
        .data-row { font-size: 10px; color: #bbb; margin-bottom: 1px; display: flex; justify-content: space-between; align-items: center;}
        .data-val { color: #fff; font-weight: bold; font-family: 'VT323', monospace; font-size: 13px; }
        .data-sep { border-top: 1px dashed #444; margin: 2px 0; }

        /* === Bottom Panel (COMPACT VERSION) === */
        #bottom-panel {
            flex: 0 0 auto; 
            background: var(--ui-bg); 
            border-top: 4px solid var(--ui-border);
            height: 190px; /* Reduced from 260px */
            padding: 6px;
            padding-bottom: calc(6px + env(safe-area-inset-bottom));
            display: flex; flex-direction: column; z-index: 100;
            position: relative;
        }
        .arcade-tabs { display: flex; gap: 8px; margin-bottom: 0px; flex-shrink: 0; align-items: flex-end; }
        
        .pixel-btn {
            flex: 1; 
            background: #1a1a1a; 
            border: 2px solid #444; border-bottom: none;
            color: #777;
            padding: 6px; /* Reduced padding */
            font-weight: bold; font-size: 14px;
            cursor: pointer; text-align: center;
            transform: translateY(2px); 
            box-shadow: none;
            transition: all 0.2s;
            border-top-left-radius: 4px; border-top-right-radius: 4px;
            z-index: 1;
        }
        .pixel-btn.active { 
            background: var(--accent-blue); 
            border: 2px solid #fff; border-bottom: none;
            color: #fff;
            transform: translateY(0); 
            box-shadow: 0px -2px 0px rgba(0,0,0,0.5); 
            z-index: 10;
            padding-bottom: 10px; 
        }
        
        .tab-content { 
            display: none; flex: 1; overflow: visible; flex-direction: column; 
            border-top: 2px solid #fff; margin-top: -2px; z-index: 5;
            background: var(--ui-bg); position: relative;
        }
        .tab-content.active { display: flex; }

        /* Build Deck & Market Deck */
        #build-deck, #market-deck { 
            display: flex; gap: 3px; flex: 1; width: 100%; padding-top: 6px; 
        }

        .pixel-card {
            flex: 1; 
            min-width: 0;
            position: relative;
            background: linear-gradient(180deg, #3a3a3a 0%, #2a2a2a 100%); 
            border: 2px solid #888;
            box-shadow: 2px 2px 0px #000; padding: 2px 2px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            min-height: 85px; /* Reduced from 120px */
            gap: 0px;
        }
        .pixel-card.selected { background: linear-gradient(180deg, #555 0%, #444 100%); border-color: var(--accent-gold); transform: translateY(-3px); }
        .pixel-card.disabled { opacity: 0.5; filter: grayscale(1); background: #222; }
        
        .card-emoji { font-size: 18px; margin-top: 1px; } /* Smaller emoji */
        .card-name { font-size: 11px; text-align: center; white-space: nowrap; color: #fff; font-weight: bold; }
        .card-divider { width: 70%; height: 1px; background: #555; margin: 1px 0; }
        .card-label { font-size: 9px; color: #999; letter-spacing: 0px; transform: scale(0.9); }
        
        /* Universal value style for Build and Market */
        .card-val { font-family:'VT323'; color:#fff; font-size:14px; font-weight: bold; } /* Smaller font */
        .card-risk { font-size: 9px; color: var(--accent-red); font-weight: bold; margin: 1px 0; line-height:1; }
        .card-cost { font-family:'VT323'; color:var(--accent-gold); font-size:15px; font-weight: bold; margin-top: auto; } /* Smaller font */
        .card-bottom { margin-top: auto; display: flex; flex-direction: column; align-items: center; gap: 0px; padding-bottom: 2px; }
        
        .card-badge {
            position: absolute; top: -4px; right: -4px;
            background: var(--accent-gold); color: #000;
            border: 2px solid #fff; border-radius: 4px;
            font-family: 'VT323', monospace; font-size: 13px; font-weight: bold; /* Smaller */
            padding: 0 4px; box-shadow: 1px 1px 0px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .nuke-risk {
            font-size: 8px; color: var(--accent-red); font-weight: bold;
        }

        .lock-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.7);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #fff; font-size: 11px; font-weight: bold; z-index: 5; text-align: center;
        }


        /* Market Tabs (Full Width) */
        .market-sub-tabs { display: flex; width: 100%; border-bottom: 2px solid #555; margin-bottom: 3px; }
        .market-sub-tab {
            flex: 1; padding: 4px 6px; text-align: center;
            font-size: 12px; cursor: pointer; font-weight: bold;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            opacity: 0.5;
            background: #1a1a1a;
            color: #888;
        }
        /* Specific Styles for Coal and Gas Tabs */
        .market-sub-tab.tab-coal.active { 
            opacity: 1; 
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
            color: #ccc; 
            border-bottom-color: var(--color-coal);
        }
        
        .market-sub-tab.tab-gas.active { 
            opacity: 1; 
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
            color: #f0a070; 
            border-bottom-color: var(--color-gas);
        }

        /* Next Button (Compact) */
        #next-btn {
            position: fixed;
            /* Adjusted bottom position based on new panel height (190 + extra) */
            bottom: calc(200px + env(safe-area-inset-bottom)); 
            right: 15px;
            width: 65px; height: 65px; /* Reduced from 80px */
            background: var(--accent-red);
            border: 3px solid #fff; border-radius: 50%;
            box-shadow: 4px 4px 0px #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 150; cursor: pointer;
            font-size: 12px; font-weight: bold; text-align: center; line-height: 1.1;
            animation: pulse-btn 1.5s infinite;
        }
        #next-btn:active { transform: scale(0.95); box-shadow: 2px 2px 0px #000; }
        @keyframes pulse-btn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Tutorial & Highlights */
        #tutorial-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; /* Increased Z-Index */
            display: none; cursor: pointer;
        }
        /* Specific highlight override */
        .highlight-target {
            z-index: 2001 !important; /* Must be > overlay */
            position: relative !important;
            box-shadow: 0 0 0 4px var(--accent-gold), 0 0 20px var(--accent-gold) !important;
            transition: all 0.3s;
            pointer-events: auto; /* Allow scrolling/interaction */
            cursor: pointer;
        }
        
        /* Fix for Next Button position when highlighted */
        #next-btn.highlight-target {
            position: fixed !important;
        }
        
        #tutorial-tooltip {
            position: fixed; top: 30%; left: 50%; transform: translateX(-50%);
            background: #fff; color: #000; padding: 15px; border-radius: 10px;
            font-weight: bold; z-index: 2002; display: none; /* Must be > overlay and target */
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            text-align: center; width: 80%;
            animation: floatTooltip 1s infinite alternate;
            cursor: pointer; /* FIX: Indicate clickable */
        }
        .tut-title {
            color: var(--accent-blue);
            font-size: 16px;
            margin-bottom: 8px;
            border-bottom: 2px solid #ddd;
            padding-bottom: 4px;
            text-align: center;
        }
        @keyframes floatTooltip { from { transform: translate(-50%, 0); } to { transform: translate(-50%, -10px); } }
        .tut-next { font-size: 10px; color: #666; margin-top: 5px; }

        /* Toast Notification System */
        #toast-container {
            position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
            width: 280px; pointer-events: none; z-index: 1500;
            display: flex; flex-direction: column; /* Stack direction */
            gap: 6px;
        }
        .toast-msg {
            background: rgba(0,0,0,0.9);
            color: #fff; border-left: 4px solid #fff;
            padding: 6px 10px; font-family: 'VT323', monospace; font-size: 16px;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.5);
            
            /* Entry Animation */
            opacity: 0; transform: translateY(-10px);
            animation: toastEntry 0.3s forwards;
            
            /* Exit Transition */
            transition: all 0.4s ease;
            max-height: 50px; /* Assume no toast > 50px */
            margin-bottom: 6px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .toast-msg.good { border-color: var(--accent-gold); color: #fff; }
        .toast-msg.bad { border-color: var(--accent-red); color: #ffcccc; }
        
        @keyframes toastEntry {
            to { opacity: 1; transform: translateY(0); }
        }
        
        .toast-msg.hiding {
            opacity: 0;
            transform: translateX(10px);
            max-height: 0;
            padding-top: 0; padding-bottom: 0;
            margin-bottom: 0;
            border: none;
        }

        /* Modal */
        #modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000;
            display: none; justify-content: center; align-items: center; padding: 20px;
        }
        .retro-dialog { 
            background: var(--accent-blue); border: 4px solid #fff; padding: 4px; 
            width: 95%; max-width: 360px; max-height: 85vh;
            box-shadow: 8px 8px 0px #000;
            display: flex; flex-direction: column;
        }
        .retro-inner { 
            background: var(--ui-bg); border: 2px solid #000; padding: 15px; text-align: center;
            overflow-y: auto;
        }
        .retro-btn { margin-top: 15px; background: #000; color: #fff; border: 2px solid #fff; padding: 8px 20px; cursor: pointer; font-size: 16px; width: 100%;}
        .retro-btn.restart { background: var(--accent-red); color: #fff; border-color: #fff; }
        .retro-btn.victory { background: var(--accent-gold); color: #000; border-color: #fff; }
        .retro-btn.stage-clear { background: var(--accent-gold); color: #000; border-color: #fff; font-weight: bold; }

        /* Stage Clear Celebration */
        .retro-dialog.stage-clear-dialog {
            background: linear-gradient(135deg, #f1c40f 0%, #e67e22 100%);
            border: 4px solid #fff;
            animation: stageClearPop 0.4s ease-out;
        }
        @keyframes stageClearPop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        .stage-clear-banner {
            text-align: center; padding: 12px 0 8px;
            font-size: 20px; font-weight: 900;
            color: var(--accent-gold);
            text-shadow: 2px 2px 0 #000;
            letter-spacing: 2px;
        }
        .stage-clear-sub {
            text-align: center; font-size: 13px; color: #aaa;
            margin-bottom: 10px;
        }
        .stage-clear-goals {
            background: rgba(0,0,0,0.3); border: 1px solid #555;
            padding: 8px; margin: 8px 0; text-align: left;
        }
        .stage-clear-goal-item {
            font-size: 13px; color: #2ecc71; padding: 3px 0;
            display: flex; align-items: center; gap: 6px;
        }
        .stage-clear-divider {
            border: none; border-top: 2px dashed var(--accent-gold);
            margin: 12px 0;
        }

        /* Report Modal Styles */
        .report-section { text-align: left; margin-bottom: 12px; border-bottom: 1px solid #444; padding-bottom: 8px; }
        .report-section:last-child { border-bottom: none; }
        .report-title { font-weight: bold; color: #aaa; font-size: 12px; margin-bottom: 4px; }
        .report-val { font-size: 16px; font-weight: bold; display: flex; justify-content: space-between; }
        .report-detail { font-size: 12px; color: #888; margin-top: 2px; padding-left: 10px; }

        .crisis-mode { filter: sepia(100%) hue-rotate(-50deg) saturate(300%); }
        
        .rule-list { text-align: left; font-size: 14px; color: #ccc; margin: 10px 0; border: 1px solid #555; padding: 10px; background: #222; }
        .rule-item { display: flex; justify-content: space-between; margin-bottom: 6px; border-bottom: 1px solid #333; padding-bottom: 2px;}
        .rule-title { font-weight: bold; color: var(--accent-gold); margin-bottom: 5px; text-align: center;}

        .chart-container { margin: 15px 0; border: 1px solid #555; background: #111; padding: 5px; }
        .chart-title { font-size: 12px; color: #aaa; margin-bottom: 5px; text-align: left; }
        .chart-legend { display: flex; flex-wrap: wrap; gap: 8px; font-size: 10px; justify-content: center; margin-top: 5px;}
        .legend-item { display: flex; align-items: center; gap: 3px; }
        .color-box { width: 8px; height: 8px; border: 1px solid #fff; }
        .rank-list { text-align: left; font-size: 11px; color:#ddd; margin-top: 5px; }
        .rank-item { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 2px 0;}
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="tutorial-overlay" onclick="game.handleTutorialClick()"></div>
    <div id="tutorial-tooltip" onclick="game.handleTutorialClick()">
        <div id="tut-text"></div>
        <div class="tut-next">â–¼ é»æ“Šæ­¤è™•ç¹¼çºŒ</div>
    </div>

    <div id="hud">
        <div class="stat-box" onclick="ui.showFundsHelp()">
            <span class="stat-label">è³‡é‡‘</span>
            <span class="stat-val gold" id="hud-funds">2,000</span>
            <div class="help-btn">?</div>
        </div>
        <div class="stat-box" onclick="ui.showCompHelp()">
            <span class="stat-label">ç«¶çˆ­åŠ›</span>
            <span class="stat-val blue" id="hud-comp">100%</span>
            <div class="help-btn">?</div>
        </div>
        <div class="stat-box" onclick="ui.showStockHelp()">
            <span class="stat-label">ç‡ƒæ–™å­˜é‡</span>
            <span class="stat-val" id="hud-days">--</span>
            <div class="help-btn">?</div>
        </div>
        <div class="stat-box" style="background:#4a5568; border-color:#fff;" onclick="game.replayTutorial()">
            <span class="stat-label" style="color:#fff;">éŠæˆ²èªªæ˜</span>
            <span class="stat-val hud-help-icon">?</span>
        </div>
    </div>

    <div id="info-bar">
        <div id="info-bar-story">
            <div class="bar-title">ğŸ“‹ ä»»å‹™ç°¡å ±</div>
            <div id="story-text">...</div>
        </div>
        <div id="info-bar-goals">
            <div class="bar-title">ğŸ† éšæ®µç›®æ¨™</div>
            <div id="goal-list"></div>
        </div>
    </div>

    <div id="game-stage">
        <div id="map-container">
            <div id="map-year-display">ç¬¬ 1 å¹´</div>
            <svg id="taiwan-svg" viewBox="0 0 320 480">
                <path class="map-path" d="
                    M 210 30 
                    C 230 35, 250 50, 260 80
                    C 275 120, 270 180, 265 220
                    C 260 270, 240 320, 220 370
                    C 200 420, 185 450, 175 460
                    L 165 455
                    C 110 420, 60 350, 50 250  
                    C 45 180, 75 120, 100 80
                    C 140 50, 170 30, 210 30 Z
                "/>
            </svg>
            
            <div id="power-pie-chart">
                <div id="pie-center-hole">
                   <div id="pie-center-text">å æ¯”</div>
                </div>
            </div>
            
            <div id="buildings-layer"></div>

            <div id="map-data-overlay">
                <div class="data-row"><span>ç¸½ç™¼é›»</span><span class="data-val" id="stat-supply">0 MW</span></div>
                <div class="data-row"><span>ç¸½éœ€æ±‚</span><span class="data-val" id="stat-demand">0 MW</span></div>
                <div class="data-sep"></div>
                <div class="data-row" id="data-row-coal"><span>ç…¤å­˜é‡</span><span class="data-val" id="stat-coal-days" style="color:#aaa">--</span></div>
                <div class="data-row" id="data-row-gas"><span>æ°£å­˜é‡</span><span class="data-val blue" id="stat-gas-days">--</span></div>
            </div>
        </div>
    </div>

    <div id="next-btn" onclick="game.nextTurn()">
        ä¸‹ä¸€<br>å¹´åº¦
    </div>

    <div id="bottom-panel">
        <div class="arcade-tabs">
            <button class="pixel-btn active" id="tab-btn-build" onclick="ui.switchTab('build')">ğŸ”¨ å»ºè¨­</button>
            <button class="pixel-btn" id="tab-btn-market" onclick="ui.switchTab('market')">ğŸš¢ ç‡ƒæ–™å¸‚å ´</button>
        </div>

        <div id="tab-build" class="tab-content active">
            <div id="build-deck"></div>
        </div>

        <div id="tab-market" class="tab-content">
            <div class="market-sub-tabs">
                <div id="mt-coal" class="market-sub-tab tab-coal active" onclick="ui.setMarketTab('coal')">ğŸª¨ ç‡ƒç…¤</div>
                <div id="mt-gas" class="market-sub-tab tab-gas" onclick="ui.setMarketTab('gas')" style="display:none;">ğŸ”¥ ç‡ƒæ°£</div>
            </div>
            <div id="market-deck">
                </div>
        </div>
    </div>

    <div id="modal-overlay">
        <div class="retro-dialog">
            <div class="retro-inner">
                <div class="retro-title" id="modal-title">TITLE</div>
                <div id="modal-content-area">
                    <p id="modal-desc" style="font-size:14px; line-height:1.6; color:#ddd; margin:15px 0;">CONTENT</p>
                </div>
                <div id="modal-footer">
                    <button class="retro-btn" id="modal-btn" onclick="ui.closeModal()">ç¢º å®š</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const PLANTS = {
            coal: { name: 'ç‡ƒç…¤', emoji: 'ğŸ­', cost: 1000, output: 1500, fuel: 40, type: 'land', color: '#7f8c8d' },
            gas: { name: 'ç‡ƒæ°£', emoji: 'ğŸ”¥', cost: 1500, output: 2500, fuel: 30, type: 'land', color: '#d35400' },
            terminal: { name: 'æ¥æ”¶ç«™', emoji: 'âš“', cost: 2000, output: 0, fuel: 0, type: 'coast', color: '#2980b9' },
            green: { name: 'é¢¨é›»', emoji: 'ğŸŒ€', cost: 3000, output: 100, fuel: 0, type: 'sea', color: '#2ecc71' },
            solar: { name: 'å¤ªé™½èƒ½', emoji: 'â˜€ï¸', cost: 1200, output: 50, fuel: 0, type: 'land', color: '#f39c12' },
            nuclear: { name: 'æ ¸èƒ½', emoji: 'â˜¢ï¸', cost: 5000, output: 6000, fuel: 0, type: 'land', color: '#8e44ad' }
        };

        const STAGES = [
            {
                title: "éšæ®µä¸€ï¼šä»¥ç…¤ä»£æ²¹",
                short: "çŸ³æ²¹å±æ©Ÿçˆ†ç™¼ï¼æ²¹åƒ¹é£†æ¼²ï¼Œè«‹ç›¡é€Ÿè½‰å‘ç‡ƒç…¤ç™¼é›»ã€‚",
                desc: "ğŸ›¢ï¸ **çŸ³æ²¹å±æ©Ÿèˆ‡åŸºè¼‰é‡å»º**ï¼š<br>å…©æ¬¡çŸ³æ²¹å±æ©Ÿé‡å‰µç¶“æ¿Ÿï¼Œç‡ƒæ²¹æˆæœ¬æš´æ¼²ã€‚ç‚ºé”æˆã€Œèƒ½æºå¤šå…ƒåŒ–ã€ï¼Œé¦–è¦ä»»å‹™æ˜¯é™ä½ç‡ƒæ²¹ä¾è³´ï¼Œæ”¹ç”¨å»‰åƒ¹çš„ç…¤ç‚­èˆ‡æ ¸èƒ½ä½œç‚ºåŸºè¼‰é›»åŠ›ã€‚<br>ä»»å‹™ï¼šæ“´å……ç‡ƒç…¤æ©Ÿçµ„ï¼Œç¢ºä¿å·¥æ¥­å‹•èƒ½ä¸ç†„ç«ã€‚",
                goals: [
                    { txt: "ç‡ƒç…¤é›»å»  > 5 åº§", check: g => g.counts.coal >= 5 },
                    { txt: "ç™¼é›»é‡ > 12000MW", check: g => g.calcPower() >= 12000 }
                ]
            },
            {
                title: "éšæ®µäºŒï¼šä»¥æ°£ä»£ç…¤",
                short: "é‚å…¥ç‡ƒæ°£æ™‚ä»£ï¼Œä¸¦é–‹æ”¾æ°‘ç‡Ÿé›»å» ï¼Œè§£æ±ºé™é›»ã€‚",
                desc: "ğŸ”¥ **ç‡ƒæ°£ä»£ç…¤**ï¼š<br>ç«¹ç§‘å´›èµ·ï¼Œæ™¶åœ“ä»£å·¥éœ€é«˜ç©©å®šé›»åŠ›ã€‚ç‡ƒæ°£ä½ç¢³ä¸”ç’°ä¿ã€‚<br>ç‚ºè§£æ±ºç’°ä¿èˆ‡é™é›»å•é¡Œï¼Œè«‹èˆˆå»ºç‡ƒæ°£ç™¼é›»å» ã€‚<br>ä»»å‹™ï¼šå•Ÿç”¨é¦–åº§æ¥æ”¶ç«™ï¼Œä¸¦è—‰ç”±ç‡ƒæ°£ç™¼é›»æ‹‰é«˜ç¸½ç™¼é›»é‡ã€‚",
                goals: [
                    { txt: "æ¥æ”¶ç«™ > 1 åº§", check: g => g.counts.terminal >= 1 },
                    { txt: "ç‡ƒæ°£ç™¼é›» > 15%", check: g => g.getGasPct() >= 15 },
                    { txt: "ç¸½ç™¼é›» > 30000MW", check: g => g.calcPower() >= 30000 }
                ]
            },
            {
                title: "éšæ®µä¸‰ï¼šèƒ½æºéŸŒæ€§",
                short: "ç‚ºå…æ–·æ°£å±æ©Ÿï¼Œè«‹å¢å»ºæ¥æ”¶ç«™ä¸¦æ‹‰é«˜å®‰å…¨å­˜é‡ã€‚",
                desc: "ğŸ›¡ï¸ **å¼·åŒ–èƒ½æºéŸŒæ€§**ï¼š<br>é¿å…å–®ä¸€æ¥æ”¶ç«™æ•…éšœå³æ–·é›»ã€‚è«‹å»ºè¨­å¤šåº§æ¥æ”¶ç«™åˆ†æ•£é¢¨éšªã€‚<br>åŒæ™‚å°‡ç…¤æ°£å­˜é‡æ‹‰é«˜è‡³ 7 å¤©ä»¥ä¸Šï¼Œç¢ºä¿åœ‹å®¶èƒ½æºéŸŒæ€§ã€‚<br><span style='color:var(--accent-red)'>(æ³¨æ„ï¼šå¾æœ¬éšæ®µèµ·ï¼Œåº«å­˜ä½æ–¼7å¤©å°‡æ‰£é™¤ç«¶çˆ­åŠ›ï¼)</span>",
                goals: [
                    { txt: "æ¥æ”¶ç«™ > 2 åº§", check: g => g.counts.terminal >= 2 },
                    { txt: "å®‰å…¨å­˜é‡ > 7å¤©", check: g => g.getSafetyDays() !== null && g.getSafetyDays() >= 7 }
                ]
            },
            {
                title: "éšæ®µå››ï¼šå†ç”Ÿè½‰å‹",
                short: "åœ‹éš›æˆ°çˆ­è‡´æˆæœ¬é£†å‡ï¼Œä¸”æœ‰å°é–é¢¨éšªï¼Œåˆ©ç”¨å†ç”Ÿèƒ½æºå¯¦ç¾è‡ªæœ‰èƒ½æºç›®æ¨™ã€‚",
                desc: "ğŸŒ¬ï¸ **è‡ªæœ‰èƒ½æºæˆ°ç•¥**ï¼š<br>å¤©ç„¶æ°£æ˜‚è²´ä¸”æ˜“å—å°é–å½±éŸ¿ã€‚å¹¸é‹çš„æ˜¯å°ç£æµ·å³½æœ‰é ‚ç´šé¢¨å ´ï¼<br>åŸ·è¡Œã€é¢¨æ°£äº’è£œã€ï¼šä»¥ç‡ƒæ°£å¿«é€Ÿå‡é™æ”¯æ´ç¶ èƒ½ã€‚<br>å»ºè¨­å†ç”Ÿèƒ½æºï¼Œç²å–ã€è‡ªæœ‰èƒ½æºã€ä»¥æŠ—è¡¡åœ°ç·£é¢¨éšªã€‚",
                goals: [
                    { txt: "æ¥æ”¶ç«™ > 3 åº§", check: g => g.counts.terminal >= 3 },
                    { txt: "å†ç”Ÿèƒ½æº > 15%", check: g => g.getGreenPct() >= 15 },
                    { txt: "å®‰å…¨å­˜é‡ > 11å¤©", check: g => g.getSafetyDays() !== null && g.getSafetyDays() >= 11 }
                ]
            },
            {
                title: "éšæ®µäº”ï¼šAIæ–°å±€",
                short: "é¢å°AIçˆ†ç™¼ã€RE100ã€æ°¸çºŒç›®æ¨™åŠåœ°ç·£å°é–é¢¨éšªï¼Œè«‹å¤§å¹…æå‡å†ç”Ÿèƒ½æºèˆ‡ç¸½ç™¼é›»é‡ã€‚",
                desc: "ğŸ¤– **AI èˆ‡æ°¸çºŒç«¶çˆ­**ï¼š<br>AI ç®—åŠ›æ¨å‡ç”¨é›»ï¼ŒRE100 é™åˆ¶å‡ºå£ã€‚<br>ç‚ºä¿ç”¢æ¥­å„ªå‹¢ï¼Œéœ€å¤§å¹…æå‡ç¶ èƒ½ä¾›æ‡‰ã€‚<br>é¢å°åœ°ç·£è»æ¼”ï¼Œæ›´éœ€å°‡å®‰å…¨å­˜é‡æ‹‰è‡³ 14 å¤©ï¼Œç¢ºä¿ä¾›é›»ç„¡è™ã€‚",
                goals: [
                    { txt: "å†ç”Ÿèƒ½æº > 20%", check: g => g.getGreenPct() >= 20 },
                    { txt: "å®‰å…¨å­˜é‡ > 14å¤©", check: g => g.getSafetyDays() !== null && g.getSafetyDays() >= 14 },
                    { txt: "ç¸½ç™¼é›» > 70000MW", check: g => g.calcPower() >= 70000 }
                ]
            }
        ];

        const MARKET_SOURCES = {
            coal: [
                { id: 'au', name: 'æ¾³æ´²', flag: 'ğŸ‡¦ğŸ‡º', base: 100 },
                { id: 'id', name: 'å°å°¼', flag: 'ğŸ‡®ğŸ‡©', base: 80 },
                { id: 'ru', name: 'ä¿„åœ‹', flag: 'ğŸ‡·ğŸ‡º', base: 90 },
                { id: 'za', name: 'å—é', flag: 'ğŸ‡¿ğŸ‡¦', base: 85 },
                { id: 'ca', name: 'åŠ æ‹¿å¤§', flag: 'ğŸ‡¨ğŸ‡¦', base: 105 }
            ],
            gas: [
                { id: 'au', name: 'æ¾³æ´²', flag: 'ğŸ‡¦ğŸ‡º', base: 220 },
                { id: 'qa', name: 'å¡é”', flag: 'ğŸ‡¶ğŸ‡¦', base: 200 },
                { id: 'us', name: 'ç¾åœ‹', flag: 'ğŸ‡ºğŸ‡¸', base: 250 },
                { id: 'my', name: 'å¤§é¦¬', flag: 'ğŸ‡²ğŸ‡¾', base: 210 },
                { id: 'pg', name: 'å·´ç´', flag: 'ğŸ‡µğŸ‡¬', base: 230 }
            ]
        };

        const NUKE_RISK_MAP = [0, 1, 2, 5, 8, 11, 15, 20, 25, 30, 40]; 

        const game = {
            year: 1, funds: 2000, comp: 100, demand: 10000, 
            oilOutput: 2000,
            fuel: { coal: 3000, gas: 0 }, cap: { coal: 3000, gas: 0 },
            counts: { coal: 0, gas: 0, terminal: 0, green: 0, solar: 0, nuclear: 0 },
            stageIdx: 0, selected: null, blockade: false, bDays: 0,
            marketPrices: {}, 
            purchaseCounts: { coal: {}, gas: {} },
            isFreePlay: false,
            history: [],
            importStats: { coal: {}, gas: {} },
            tutorialStep: 0,
            stageTutorialStep: 0,
            stageTutorialType: null,
            marketTab: 'coal',
            isReplayTutorial: false,
            
            nukeDisasterCount: 0,
            nukeShutdownTimer: 0,
            isNukePermanentlyBanned: false,
            fuelZeroWarned: { coal: false, gas: false },

            init() {
                this.resetVariables();
                this.counts.coal = 0; 
                this.cap.coal = 3000; 
                this.updateMarketPrices();
                ui.renderDeck(); ui.renderMarket(); ui.updateAll();
                
                ui.showModal("âš¡ å³¶å¶¼èƒ½æºç”Ÿå­˜æˆ°",
                    `<div style="text-align:left; padding:0 10px; line-height:1.8; font-size:14px; color:#ddd;">
                        è¥¿å…ƒ1973å¹´ï¼Œä¸­æ±æˆ°ç«é»ç‡ƒçŸ³æ²¹å±æ©Ÿï¼Œæ²¹åƒ¹ä¸€å¤•æš´æ¼²ã€‚<br><br>
                        å°ç£â€”â€”ä¸€åº§<span style="color:var(--accent-red)">97%èƒ½æºä»°è³´é€²å£</span>çš„å³¶å¶¼ï¼Œæ­£é¢è‡¨æ–·é›»çš„å­˜äº¡å±æ©Ÿã€‚<br><br>
                        èº«ç‚ºæ–°ä»»<span style="color:var(--accent-gold)">èƒ½æºæ±ºç­–é•·</span>ï¼Œæ‚¨å¿…é ˆåœ¨æ¥ä¸‹ä¾†çš„50å¹´é–“ï¼Œå¸¶é ˜å°ç£ç©¿è¶ŠçŸ³æ²¹å±æ©Ÿã€ç¶“æ¿Ÿå¥‡è¹Ÿã€ç’°ä¿æµªæ½®èˆ‡åœ°ç·£å°é–ï¼Œæ‰“é€ ä¸€å€‹<span style="color:var(--accent-blue)">æ°¸ä¸æ–·é›»</span>çš„å³¶å¶¼ã€‚<br><br>
                        <span style="color:#888; font-size:12px;">å»ºè¨­é›»å» ã€æ¡è³¼ç‡ƒæ–™ã€å®Œæˆéšæ®µä»»å‹™å³å¯å‹åˆ©ã€‚</span>
                    </div>`,
                    () => {
                        ui.closeModal();
                        if(game.year === 1) game.startTutorial();
                    }
                );
            },

            resetVariables() {
                this.year = 1; 
                this.funds = 2000; 
                this.comp = 100; this.demand = 10000;
                this.oilOutput = 2000;
                this.fuel = { coal: 3000, gas: 0 }; 
                this.cap = { coal: 3000, gas: 0 };
                this.counts = { coal: 0, gas: 0, terminal: 0, green: 0, solar: 0, nuclear: 0 };
                this.stageIdx = 0; this.selected = null; this.blockade = false; this.isFreePlay = false;
                this.history = []; this.importStats = { coal: {}, gas: {} };
                this.purchaseCounts = { coal: {}, gas: {} };
                this.marketTab = 'coal';
                
                this.nukeDisasterCount = 0;
                this.nukeShutdownTimer = 0;
                this.isNukePermanentlyBanned = false;
                this.fuelZeroWarned = { coal: false, gas: false };

                document.getElementById('buildings-layer').innerHTML = '';
                document.body.classList.remove('crisis-mode');
                this.tutorialStep = 0;
                this.stageTutorialStep = 0;
                this.stageTutorialType = null;
            },
            
            // === ç‡ƒæ–™æ­¸é›¶è­¦å‘Šï¼ˆåƒ…é¦–æ¬¡ï¼‰ ===
            pendingFuelWarning: null,

            checkFuelZeroWarning() {
                const cDays = this.getCoalDays();
                const gDays = this.getGasDays();
                
                // ç…¤å­˜é‡é¦–æ¬¡æ­¸é›¶
                if (!this.fuelZeroWarned.coal && this.counts.coal > 0 && cDays === 0) {
                    this.fuelZeroWarned.coal = true;
                    this.pendingFuelWarning = 'coal';
                    return;
                }
                // æ°£å­˜é‡é¦–æ¬¡æ­¸é›¶
                if (!this.fuelZeroWarned.gas && this.counts.gas > 0 && gDays === 0) {
                    this.fuelZeroWarned.gas = true;
                    this.pendingFuelWarning = 'gas';
                    return;
                }
                this.pendingFuelWarning = null;
            },

            showFuelZeroWarning() {
                const type = this.pendingFuelWarning;
                if (!type) return;
                this.pendingFuelWarning = null;

                const selector = type === 'coal' ? '#data-row-coal' : '#data-row-gas';
                const name = type === 'coal' ? 'ç‡ƒç…¤' : 'å¤©ç„¶æ°£';
                
                // æš«æ™‚è®“ map-data-overlay å¯è¢« highlight
                const overlay = document.getElementById('map-data-overlay');
                overlay.style.pointerEvents = 'auto';
                overlay.style.zIndex = '2500';

                this.stageTutorialType = 'fuelwarn';
                this.stageTutorialStep = 1;

                setTimeout(() => {
                    ui.highlightElement(selector,
                        `ã€âš ï¸ ${name}åº«å­˜è€—ç›¡ã€‘\n${name}å­˜é‡æ­¸é›¶ï¼Œæ‰€æœ‰${name}é›»å» \nå°‡ç„¡æ³•é‹è½‰ï¼Œç™¼é›»é‡é™ç‚º 0ï¼\nè«‹ç›¡é€Ÿè£œå……ç‡ƒæ–™ã€‚`);
                }, 200);
            },

            endFuelZeroWarning() {
                this.stageTutorialStep = 0;
                this.stageTutorialType = null;
                ui.clearHighlight();
                const overlay = document.getElementById('map-data-overlay');
                overlay.style.pointerEvents = 'none';
                overlay.style.zIndex = '95';
            },

            handleTutorialClick() {
                if (this.stageTutorialType === 'fuelwarn') {
                    this.endFuelZeroWarning();
                } else if (this.stageTutorialStep > 0) {
                    this.nextStageTutorialStep();
                } else {
                    this.nextTutorialStep();
                }
            },

            startTutorial() {
                this.tutorialStep = 1;
                this.updateTutorial();
            },
            
            replayTutorial() {
                this.isReplayTutorial = true;
                this.startTutorial();
            },

            nextTutorialStep() {
                if(this.tutorialStep > 0 && this.tutorialStep < 7) {
                    this.tutorialStep++;
                    this.updateTutorial();
                } else if(this.tutorialStep === 7) { 
                    this.tutorialStep = 0;
                    ui.clearHighlight();
                    ui.switchTab('build', true);
                    
                    const s = STAGES[this.stageIdx];
                    const goals = s.goals.map(g => 'ğŸ”¹ ' + g.txt).join('<br>');
                    
                    ui.showModal(s.title,
                        `<div style="text-align:left; padding:0 10px; line-height:1.6;">
                            ${s.desc}<br><br>
                            <span style="color:var(--accent-blue)">ğŸ† æœ¬éšæ®µç›®æ¨™ï¼š</span><br>${goals}
                        </div>`,
                        () => ui.closeModal()
                    );
                    
                    this.isReplayTutorial = false;
                }
            },

            updateTutorial() {
                ui.clearHighlight();
                
                if(this.tutorialStep === 1) {
                     ui.highlightElement('#hud .stat-box:nth-child(1)', "ã€å»ºè¨­è³‡é‡‘ã€‘\nå»ºè¨­é›»å» èˆ‡è³¼è²·ç‡ƒæ–™çš„ç¶“è²»ã€‚\næ¯å¹´æœƒä¾ç™¼é›»é‡ç²å¾—ç¨…æ”¶ã€‚");
                } else if(this.tutorialStep === 2) {
                     ui.highlightElement('#hud .stat-box:nth-child(2)', "ã€åœ‹å®¶ç«¶çˆ­åŠ›ã€‘\nåœ‹å®¶ç™¼å±•çš„é—œéµæŒ‡æ¨™ã€‚\nä¾›é›»ä¸ç©©æˆ–ç‡ƒæ–™çŸ­ç¼ºå°‡å°è‡´æŒ‡æ•¸ä¸‹é™ï¼Œ\nä¸€æ—¦æ­¸é›¶ï¼ŒéŠæˆ²å³åˆ»çµæŸã€‚");
                } else if(this.tutorialStep === 3) {
                     ui.highlightElement('#hud .stat-box:nth-child(3)', "ã€ç‡ƒæ–™å­˜é‡ã€‘\nåœ‹å®¶èƒ½æºå®‰å…¨çš„åº•ç·šï¼\nä»£è¡¨ç›®å‰çš„ç‡ƒæ–™åº«å­˜èƒ½æ”¯æ’å¹¾å¤©ã€‚\nè‹¥æ­¸é›¶å°‡å°è‡´åœ‹å®¶å´©æ½°ã€‚");
                } else if(this.tutorialStep === 4) {
                     ui.highlightElement('#hud .stat-box:nth-child(4)', "ã€éŠæˆ²èªªæ˜ã€‘\néš¨æ™‚é»æ“Šæ­¤è™•å¯å†æ¬¡æŸ¥çœ‹æœ¬æ•™å­¸ã€‚\nè¨˜å¾—é—œæ³¨éšæ®µç›®æ¨™ï¼");
                } else if(this.tutorialStep === 5) {
                    ui.switchTab('build', true); 
                    ui.highlightElement('#build-deck', "ã€å»ºè¨­å€ã€‘\né€™è£¡åˆ—å‡ºäº†å„ç¨®ç™¼é›»è¨­æ–½ã€‚\nå¾…æœƒæ‚¨å¯ä»¥é¸æ“‡å¡ç‰‡é€²è¡Œå»ºè¨­ã€‚\n(é»æ“Šç•«é¢ç¹¼çºŒ)");
                } else if(this.tutorialStep === 6) {
                    ui.switchTab('market', true); 
                    ui.highlightElement('#tab-market', "ã€ç‡ƒæ–™å¸‚å ´ã€‘\né»æ“Šåˆ‡æ›åˆ†é ï¼Œ\nå¯æ ¹æ“šåƒ¹æ ¼è³¼è²·ä¸åŒé€²å£åœ‹çš„ç‡ƒæ–™ã€‚");
                } else if(this.tutorialStep === 7) {
                    ui.switchTab('build', true);
                    ui.highlightElement('#next-btn', "ã€ä¸‹ä¸€å¹´åº¦ã€‘\næº–å‚™å¥½å¾Œï¼Œé»æ“Šæ­¤è™•æ¨é€²æ™‚é–“ä¸¦ç²å¾—ç¨…æ”¶ã€‚");
                } else {
                    ui.clearHighlight();
                }
            },

            // === éšæ®µè§£é–æ•™å­¸ ===
            startStageTutorial(type) {
                this.stageTutorialType = type; // 'gas' or 'green'
                this.stageTutorialStep = 1;
                this.updateStageTutorial();
            },

            nextStageTutorialStep() {
                if (this.stageTutorialStep > 0) {
                    this.stageTutorialStep++;
                    this.updateStageTutorial();
                }
            },

            updateStageTutorial() {
                ui.clearHighlight();

                if (this.stageTutorialType === 'gas') {
                    if (this.stageTutorialStep === 1) {
                        ui.renderDeck();
                        ui.switchTab('build', true);
                        setTimeout(() => {
                            const gasCard = document.querySelector('#build-deck .pixel-card:nth-child(2)');
                            if (gasCard) gasCard.id = 'highlight-gas-card';
                            ui.highlightElement('#highlight-gas-card', "ã€ğŸ”¥ ç‡ƒæ°£ç™¼é›»ã€‘\næ–°è§£é–ï¼ç‡ƒæ°£ç™¼é›»æ•ˆç‡é«˜ä¸”è¼ƒç’°ä¿ã€‚\nä½†éœ€å…ˆå»ºé€ æ¥æ”¶ç«™æ‰èƒ½èˆˆå»ºã€‚");
                        }, 100);
                    } else if (this.stageTutorialStep === 2) {
                        ui.switchTab('market', true);
                        ui.setMarketTab('gas');
                        setTimeout(() => {
                            ui.highlightElement('#mt-gas', "ã€ğŸ”¥ ç‡ƒæ°£å¸‚å ´ã€‘\né»æ“Šæ­¤åˆ†é å¯è³¼è²·å¤©ç„¶æ°£ç‡ƒæ–™ï¼Œ\nä¹Ÿå¯åœ¨æ­¤å»ºé€ æ¥æ”¶ç«™ä¾†å„²å­˜å¤©ç„¶æ°£ã€‚");
                        }, 100);
                    } else {
                        this.stageTutorialStep = 0;
                        this.stageTutorialType = null;
                        ui.clearHighlight();
                        ui.switchTab('build', true);
                    }
                } else if (this.stageTutorialType === 'green') {
                    if (this.stageTutorialStep === 1) {
                        ui.renderDeck();
                        ui.switchTab('build', true);
                        setTimeout(() => {
                            const cards = document.querySelectorAll('#build-deck .pixel-card');
                            // é¢¨é›»å’Œå¤ªé™½èƒ½æ˜¯æ–°å¢çš„æœ€å¾Œå…©å¼µå¡
                            cards.forEach(card => {
                                const name = card.querySelector('.card-name');
                                if (name && name.textContent === 'é¢¨é›»') card.id = 'highlight-wind-card';
                                if (name && name.textContent === 'å¤ªé™½èƒ½') card.id = 'highlight-solar-card';
                            });
                            ui.highlightElement('#highlight-wind-card', "ã€ğŸŒ€ é¢¨åŠ›ç™¼é›»ã€‘\næ–°è§£é–ï¼åˆ©ç”¨å°ç£æµ·å³½çš„é ‚ç´šé¢¨å ´ï¼Œ\nä¸éœ€ç‡ƒæ–™ï¼Œæ˜¯è‡ªæœ‰èƒ½æºçš„é—œéµï¼");
                        }, 100);
                    } else if (this.stageTutorialStep === 2) {
                        ui.switchTab('build', true);
                        setTimeout(() => {
                            ui.highlightElement('#highlight-solar-card', "ã€â˜€ï¸ å¤ªé™½èƒ½ç™¼é›»ã€‘\næ–°è§£é–ï¼æˆæœ¬ä½å»‰çš„å†ç”Ÿèƒ½æºï¼Œ\nä¸éœ€ç‡ƒæ–™ï¼Œå¯å¿«é€Ÿä½ˆå»ºæå‡ç¶ èƒ½å æ¯”ã€‚");
                        }, 100);
                    } else {
                        this.stageTutorialStep = 0;
                        this.stageTutorialType = null;
                        ui.clearHighlight();
                        ui.switchTab('build', true);
                    }
                } else {
                    this.stageTutorialStep = 0;
                    this.stageTutorialType = null;
                    ui.clearHighlight();
                }
            },
            
            restart() {
                this.resetVariables();
                this.counts.coal = 0; this.cap.coal = 3000;
                this.updateMarketPrices();
                ui.renderDeck(); ui.renderMarket(); ui.updateAll();
                ui.closeModal();
                setTimeout(() => ui.showModal("éŠæˆ²é‡å•Ÿ", "ä¸€åˆ‡å›åˆ°åŸé»ï¼Œè«‹é‡æ–°è¦åŠƒèƒ½æºæ”¿ç­–ï¼", () => {
                     ui.closeModal();
                     game.startTutorial();
                }), 300);
            },

            selectCard(key) {
                if (this.tutorialStep !== 0 || this.stageTutorialStep !== 0) return;

                if(this.selected === key) { this.selected = null; }
                else { this.selected = key; this.tryBuild(); }
                ui.renderDeck();
            },

            tryBuild() {
                if (this.tutorialStep !== 0 || this.stageTutorialStep !== 0) return;
                
                if (!this.selected) return;
                const p = PLANTS[this.selected];
                
                if (this.selected === 'nuclear') {
                    if (this.isNukePermanentlyBanned) {
                        ui.floatText('â›” æ ¸èƒ½å·²æ°¸ä¹…å»¢æ­¢', 'bad'); this.selected = null; return;
                    }
                }

                if (this.funds < p.cost) {
                    ui.floatText('ğŸ’¸ è³‡é‡‘ä¸è¶³', 'bad'); this.selected = null; return;
                }
                if (this.selected === 'gas' && this.counts.terminal === 0) {
                    ui.floatText('âš ï¸ éœ€å»ºæ¥æ”¶ç«™', 'bad'); this.selected = null; return;
                }

                this.funds -= p.cost;
                this.counts[this.selected]++;
                
                if (this.selected === 'coal') this.cap.coal += 1500; 
                if (this.selected === 'terminal') this.cap.gas += 1500;
                
                ui.floatText(`å»ºè¨­${p.name} -$${p.cost}`, 'good');
                this.placeBuilding(this.selected);
                this.selected = null;
                ui.renderDeck(); ui.updateAll();
                
                if(this.tutorialStep === 1) {
                    this.tutorialStep = 2;
                    this.updateTutorial();
                }
            },

            buildTerminal() {
                if (this.tutorialStep !== 0 || this.stageTutorialStep !== 0) return;

                const p = PLANTS.terminal;
                if (this.funds < p.cost) {
                    ui.floatText('ğŸ’¸ è³‡é‡‘ä¸è¶³', 'bad'); return;
                }
                this.funds -= p.cost;
                this.counts.terminal++;
                this.cap.gas += 1500;
                ui.floatText(`å»ºè¨­æ¥æ”¶ç«™ -$${p.cost}`, 'good');
                this.placeBuilding('terminal');
                ui.updateAll();
            },

            placeBuilding(type) {
                const pInfo = PLANTS[type];
                const el = document.createElement('div');
                el.innerText = pInfo.emoji;
                el.style.position = 'absolute';
                el.style.fontSize = '18px';
                el.style.animation = 'dropIn 0.3s';
                let x, y;
                switch(pInfo.type) {
                    case 'sea': x = 10 + Math.random() * 50; y = 100 + Math.random() * 300; break;
                    case 'coast': x = 60 + Math.random() * 20; y = 50 + Math.random() * 300; break;
                    case 'land': x = 100 + Math.random() * 100; y = 50 + Math.random() * 350; break;
                }
                el.style.left = x + 'px'; el.style.top = y + 'px';
            },

            buyFuel(type, countryId) {
                if (this.tutorialStep !== 0 || this.stageTutorialStep !== 0) return;

                if (this.blockade) { ui.floatText('ğŸš« å°é–ä¸­', 'bad'); return; }
                const basePrice = this.marketPrices[`${type}_${countryId}`];
                const surge = this.purchaseCounts[type][countryId] || 0;
                const finalCost = basePrice + surge;

                if (this.funds < finalCost) { ui.floatText('ğŸ’¸ è³‡é‡‘ä¸è¶³', 'bad'); return; }
                if (this.fuel[type] + 100 > this.cap[type]) {
                    ui.floatText('ğŸ“¦ å€‰åº«å·²æ»¿', 'bad');
                    if(type==='gas' && this.counts.terminal===0) ui.floatText('âš ï¸ éœ€æ¥æ”¶ç«™', 'bad');
                    return;
                }
                this.funds -= finalCost;
                this.fuel[type] += 100;
                if (!this.purchaseCounts[type][countryId]) this.purchaseCounts[type][countryId] = 0;
                this.purchaseCounts[type][countryId]++;
                if (!this.importStats[type][countryId]) this.importStats[type][countryId] = 0;
                this.importStats[type][countryId] += 100;
                
                const fuelName = type === 'coal' ? 'ç…¤ç‚­' : 'å¤©ç„¶æ°£';
                ui.floatText(`${fuelName}åº«å­˜ +100`, 'good');
                ui.updateAll();
            },

            updateMarketPrices() {
                this.purchaseCounts = { coal: {}, gas: {} };
                ['coal', 'gas'].forEach(type => {
                    MARKET_SOURCES[type].forEach(src => {
                        const fluc = 0.8 + Math.random() * 0.5;
                        let price = Math.floor(src.base * fluc);
                        
                        if (game.stageIdx === 1 && type === 'coal') {
                            price *= 2;
                        }
                        
                        this.marketPrices[`${type}_${src.id}`] = price;
                    });
                });
            },

            calcIncome() {
                let baseIncome = 500;
                if (game.stageIdx === 1) baseIncome = 1000;
                if (game.stageIdx >= 2) baseIncome = 2000;
                const powerBonus = Math.floor(this.calcPower(true) * 0.4); 
                return baseIncome + powerBonus;
            },
            
            getNukeRisk() {
                const cnt = this.counts.nuclear;
                if(cnt >= NUKE_RISK_MAP.length) return 50;
                return NUKE_RISK_MAP[cnt];
            },

            checkNuclearDisaster() {
                if (this.counts.nuclear > 0) {
                    const risk = this.getNukeRisk();
                    if (Math.random() * 100 < risk) {
                        this.nukeDisasterCount++;
                        let loss = Math.max(5000, Math.floor(this.funds / 2));
                        this.funds -= loss;
                        this.funds -= 2000;
                        if(this.funds < 0) { 
                            this.comp -= 15; 
                        }
                        this.counts.nuclear--;
                        this.nukeShutdownTimer = 2;
                        this.comp -= 30;
                        
                        let msg = "â˜¢ï¸ æ ¸ç½çˆ†ç™¼ï¼ç«¶çˆ­åŠ›-30";
                        if(this.funds < 0) msg += "ï¼Œåœ‹å®¶ç ´ç”¢ -15";
                        
                        if(this.nukeDisasterCount >= 3) {
                            this.isNukePermanentlyBanned = true;
                            this.counts.nuclear = 0; 
                            return "â˜¢ï¸ æ ¸ç½3æ¬¡ï¼šæ ¸èƒ½æ°¸ä¹…å»¢æ­¢ï¼";
                        } else {
                            return msg;
                        }
                        ui.renderDeck();
                    }
                }
                return null;
            },

            nextTurn() {
                if (this.stageTutorialStep !== 0) return;
                if (this.blockade) { this.handleBlockade(); return; }
                this.year++; 
                if (this.nukeShutdownTimer > 0) this.nukeShutdownTimer--;

                const pOil = this.oilOutput;
                const pCoal = this.calcCoalOutput();
                const pGas = this.calcGasOutput();
                const pNuke = this.calcNukeOutput();
                const pGreen = (this.counts.green * PLANTS.green.output) + (this.counts.solar * PLANTS.solar.output);
                
                this.history.push({
                    year: this.year,
                    oil: pOil,
                    coal: pCoal,
                    gas: pGas,
                    nuclear: pNuke,
                    green: pGreen
                });

                let turnEvents = [];
                const nukeMsg = this.checkNuclearDisaster();
                if(nukeMsg) turnEvents.push(nukeMsg);

                const income = this.calcIncome();
                this.funds += income; 
                
                this.demand += 1200;
                this.updateMarketPrices();
                
                this.consumeFuel(); 
                
                let compBonus = 0;
                let compChanges = [];

                const power = this.calcPower();
                if (power < this.demand) {
                    this.comp -= 15;
                    compChanges.push("ç¼ºé›» -15");
                } else {
                    compBonus += 5;
                    this.comp = Math.min(100, this.comp + 5);
                    compChanges.push("ä¾›é›»ç©©å®š +5");
                }

                const cDays = this.getCoalDays();
                const gDays = this.getGasDays();
                const hasCoalPlant = this.counts.coal > 0;
                const hasGasPlant = this.counts.gas > 0;
                const coalFail = hasCoalPlant && cDays === 0;
                const gasFail = hasGasPlant && gDays === 0;

                if (coalFail && gasFail) {
                    this.comp = -100;
                    ui.showGameOver("èƒ½æºæ¯ç«­ï¼šç…¤æ°£å­˜é‡æ­¸é›¶ï¼<br>å…¨åœ‹å¤§åœé›»å°è‡´æ”¿åºœå®å°ã€‚");
                    return;
                }

                if (this.stageIdx >= 2) {
                    if (cDays !== null && cDays < 7) {
                        this.comp -= 10;
                        compChanges.push("ç¼ºç…¤ -10");
                    }
                    if (gDays !== null && gDays < 7) {
                        this.comp -= 10;
                        compChanges.push("ç¼ºæ°£ -10");
                    }
                }
                
                // Blockade Check (Random trigger removed as per user request)

                if (this.comp <= 0) { ui.showGameOver(); return; }
                
                ui.renderMarket(); ui.updateAll();
                
                if (!this.isFreePlay) {
                    const stage = STAGES[this.stageIdx];
                    if (stage && stage.goals.every(g => g.check(this))) {
                        if (this.stageIdx < STAGES.length - 1) {
                            const clearedIdx = this.stageIdx;
                            this.stageIdx++;
                            ui.updateAll(); 
                            
                            const s = STAGES[this.stageIdx];
                            const newStageIdx = this.stageIdx;
                            ui.showStageComplete(clearedIdx, s,
                                () => {
                                    ui.closeModal();
                                    if (newStageIdx === 1) {
                                        game.startStageTutorial('gas');
                                    }
                                    else if (newStageIdx === 3) {
                                        game.startStageTutorial('green');
                                    }
                                }
                            );
                            return;
                        } else {
                            ui.showVictory();
                            return; 
                        }
                    }
                }

                if (!this.blockade) {
                    this.checkFuelZeroWarning();
                    ui.showTurnReport(this.year, income, compChanges, this.funds, this.comp, turnEvents);
                    
                    // è‹¥æœ‰ç‡ƒæ–™æ­¸é›¶è­¦å‘Šï¼Œè¦†å¯«é—œé–‰æŒ‰éˆ•è¡Œç‚º
                    if (this.pendingFuelWarning) {
                        const btn = document.getElementById('modal-btn');
                        btn.onclick = () => {
                            ui.closeModal();
                            game.showFuelZeroWarning();
                        };
                    }
                }
                
                if(this.tutorialStep === 3) {
                    this.tutorialStep = 0;
                    ui.clearHighlight();
                    ui.switchTab('build', true); 
                }
                
                this.tutorialStep = 0;
            },

            consumeFuel() {
                const cNeed = this.counts.coal * PLANTS.coal.fuel;
                const gNeed = this.counts.gas * PLANTS.gas.fuel;
                if (this.fuel.coal >= cNeed) this.fuel.coal -= cNeed;
                else { this.fuel.coal = 0; }
                if (this.fuel.gas >= gNeed) this.fuel.gas -= gNeed;
                else { this.fuel.gas = 0; }
            },

            calcNukeOutput() {
                if (this.nukeShutdownTimer > 0) return 0;
                return this.counts.nuclear * PLANTS.nuclear.output;
            },

            calcCoalOutput() {
                if (this.counts.coal === 0) return 0;
                const cUse = this.counts.coal * PLANTS.coal.fuel;
                if (this.fuel.coal < cUse) return 0; // å­˜é‡ä¸è¶³ä¸€å¤©ï¼Œç™¼é›»æ­¸é›¶
                return this.counts.coal * PLANTS.coal.output;
            },

            calcGasOutput() {
                if (this.counts.gas === 0) return 0;
                const gUse = this.counts.gas * PLANTS.gas.fuel;
                if (this.fuel.gas < gUse) return 0; // å­˜é‡ä¸è¶³ä¸€å¤©ï¼Œç™¼é›»æ­¸é›¶
                return this.counts.gas * PLANTS.gas.output;
            },

            calcPower(ignoreShutdown = false) { 
                let nukeOut = this.calcNukeOutput();
                if (ignoreShutdown) nukeOut = this.counts.nuclear * PLANTS.nuclear.output;
                return this.oilOutput +
                       this.calcCoalOutput() + 
                       this.calcGasOutput() + 
                       (this.counts.green * PLANTS.green.output) + 
                       (this.counts.solar * PLANTS.solar.output) + 
                       nukeOut;
            },
            
            getGreenPct() {
                const total = this.calcPower();
                if (total === 0) return 0;
                const green = (this.counts.green * PLANTS.green.output) + (this.counts.solar * PLANTS.solar.output);
                return Math.floor((green / total) * 100);
            },

            getGasPct() {
                const total = this.calcPower();
                if (total === 0) return 0;
                const gas = this.calcGasOutput();
                return Math.floor((gas / total) * 100);
            },

            getSafetyDays() {
                const cDay = this.getCoalDays();
                const gDay = this.getGasDays();
                if (cDay === null && gDay === null) return null;
                const cVal = cDay === null ? 9999 : cDay;
                const gVal = gDay === null ? 9999 : gDay;
                return Math.min(cVal, gVal);
            },
            
            getCoalDays() {
                 if (this.counts.coal === 0) return null;
                 const cUse = this.counts.coal * PLANTS.coal.fuel;
                 return Math.floor(this.fuel.coal / cUse);
            },
            
            getGasDays() {
                 if (this.counts.gas === 0) return null;
                 const gUse = this.counts.gas * PLANTS.gas.fuel;
                 return Math.floor(this.fuel.gas / gUse);
            },

            startBlockade() {
                this.blockade = true; this.bDays = 11;
                document.body.classList.add('crisis-mode');
                ui.showModal("âš ï¸ ç´…è‰²è­¦å ±", "æµ·å³½å°é–é–‹å§‹ï¼é€²å£ä¸­æ–·ï¼Œè«‹æ’é 11 å¤©ã€‚", () => ui.closeModal());
            },

            handleBlockade() {
                this.bDays--; this.consumeFuel();
                ui.floatText(`å‰© ${this.bDays} å¤©`, 'bad');
                if (this.bDays <= 0) {
                    this.blockade = false; document.body.classList.remove('crisis-mode');
                    ui.showModal("ğŸ³ï¸ å±æ©Ÿè§£é™¤", "å°é–çµæŸï¼Œå°ç£å­˜æ´»ï¼", () => ui.closeModal());
                }
                ui.updateAll();
            }
        };

        const ui = {
            switchTab(tab, isSystem = false) {
                if(game.tutorialStep !== 0 && !isSystem && game.year === 1 && game.tutorialStep !== 3) return;

                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.pixel-btn').forEach(el => el.classList.remove('active'));
                document.getElementById(`tab-${tab}`).classList.add('active');
                
                const btnId = tab === 'build' ? 'tab-btn-build' : 'tab-btn-market';
                document.getElementById(btnId).classList.add('active');
                
                if(game.tutorialStep === 4 && tab === 'market') {
                    setTimeout(() => ui.highlightElement('.buy-btn-mini:first-child', 'é»æ“Šè³¼è²·ï¼'), 100);
                }
            },

            highlightElement(selector, text) {
                const overlay = document.getElementById('tutorial-overlay');
                overlay.style.display = 'block';
                
                const el = document.querySelector(selector);
                if(el) {
                    el.classList.add('highlight-target');
                    
                    const bottomPanel = el.closest('#bottom-panel');
                    if (bottomPanel) {
                        bottomPanel.style.zIndex = '2001'; 
                    }

                    const hud = el.closest('#hud');
                    if(hud) {
                        hud.style.zIndex = '2001';
                    }

                    const tooltip = document.getElementById('tutorial-tooltip');
                    document.getElementById('tut-text').innerHTML = `<div class='tut-title'>éŠæˆ²èªªæ˜</div>${text.replace(/\n/g, '<br>')}`;
                    tooltip.style.display = 'block';
                }
            },

            clearHighlight() {
                document.getElementById('tutorial-overlay').style.display = 'none';
                document.getElementById('tutorial-tooltip').style.display = 'none';
                document.querySelectorAll('.highlight-target').forEach(el => el.classList.remove('highlight-target'));
                
                const bottomPanel = document.getElementById('bottom-panel');
                if(bottomPanel) bottomPanel.style.zIndex = ''; 
                
                const hud = document.getElementById('hud');
                if(hud) hud.style.zIndex = '100';
            },

            setMarketTab(tab) {
                if (tab === 'gas' && game.stageIdx < 1) return; 

                game.marketTab = tab;
                document.querySelectorAll('.market-sub-tab').forEach(el => el.classList.remove('active'));
                document.getElementById('mt-' + tab).classList.add('active');
                ui.renderMarket();
            },

            renderDeck() {
                const stageFilter = {
                    coal: 0,     // éšæ®µä¸€èµ·
                    nuclear: 0,  // éšæ®µä¸€èµ·
                    gas: 1,      // éšæ®µäºŒèµ·
                    green: 3,    // éšæ®µå››èµ·
                    solar: 3     // éšæ®µå››èµ·
                };
                const buildable = Object.entries(PLANTS)
                    .filter(([k,v]) => k !== 'terminal')
                    .filter(([k]) => game.stageIdx >= (stageFilter[k] || 0));

                document.getElementById('build-deck').innerHTML = buildable.map(([k, v]) => {
                    let locked = false;
                    let lockReason = '';
                    let riskHtml = '';
                    if (k === 'nuclear') {
                        if (game.isNukePermanentlyBanned) { locked = true; lockReason = 'â›” æ°¸ä¹…å»¢æ­¢'; }
                        else {
                            const risk = game.getNukeRisk();
                            riskHtml = `<div class="nuke-risk">â˜¢ï¸ æ ¸ç½ +${risk}%</div>`;
                        }
                    }
                    const count = game.counts[k];
                    
                    return `
                    <div class="pixel-card ${game.selected === k ? 'selected' : ''} ${locked ? 'disabled' : ''}" onclick="game.selectCard('${k}')">
                        <div class="card-badge">${count}</div>
                        ${locked ? `<div class="lock-overlay">${lockReason}</div>` : ''}
                        
                        <div class="card-emoji">${v.emoji}</div>
                        <div class="card-name" style="color:${v.color}">${v.name}</div>
                        <div class="card-divider"></div>
                        <div class="card-label">ç™¼é›»é‡</div>
                        <div class="card-val">+${v.output.toLocaleString()}MW</div>
                        
                        <div class="card-bottom">
                            <div class="card-cost">$${v.cost.toLocaleString()}</div>
                            ${riskHtml}
                        </div>
                    </div>
                `}).join('');
            },

            renderMarket() {
                const tab = game.marketTab; 
                const sources = MARKET_SOURCES[tab];
                
                if(game.stageIdx >= 1) {
                    document.getElementById('mt-gas').style.display = 'block';
                }

                let content = '';

                if (tab === 'gas') {
                     const term = PLANTS.terminal;
                     content += `
                    <div class="pixel-card market-card" onclick="game.buildTerminal()">
                        <div class="card-badge" style="background:var(--accent-blue)">${game.counts.terminal}</div>
                        <div class="card-emoji">${term.emoji}</div>
                        <div class="card-name" style="color:${term.color}">${term.name}</div>
                        <div class="card-divider"></div>
                        <div class="card-label">å„²æ°£å®¹é‡</div>
                        <div class="card-val">+1,500</div>
                        <div class="card-bottom">
                            <div class="card-cost">$${term.cost.toLocaleString()}</div>
                        </div>
                    </div>`;
                }

                content += sources.map(src => {
                    const base = game.marketPrices[tab + '_' + src.id] || src.base;
                    const surge = game.purchaseCounts[tab][src.id] || 0;
                    const price = base + surge;
                    const fuelLabel = tab === 'coal' ? 'ç‡ƒç…¤' : 'å¤©ç„¶æ°£';
                    return `
                    <div class="pixel-card market-card" onclick="game.buyFuel('${tab}', '${src.id}')">
                        <div class="card-emoji">${src.flag}</div>
                        <div class="card-name">${src.name}</div>
                        <div class="card-divider"></div>
                        <div class="card-label">${fuelLabel}</div>
                        <div class="card-val">+100</div>
                        <div class="card-bottom">
                            <div class="card-cost">$${price}</div>
                        </div>
                    </div>`;
                }).join('');
                
                document.getElementById('market-deck').innerHTML = content;
            },

            updatePieChart() {
                const pOil = game.oilOutput;
                const pCoal = game.calcCoalOutput();
                const pGas = game.calcGasOutput();
                const pGreen = (game.counts.green * PLANTS.green.output) + (game.counts.solar * PLANTS.solar.output);
                const pNuke = game.calcNukeOutput(); 
                const total = pOil + pCoal + pGas + pGreen + pNuke;

                const chartContainer = document.getElementById('power-pie-chart');
                chartContainer.innerHTML = ''; 

                if (total === 0) {
                    chartContainer.style.background = '#444';
                    return;
                }

                const degOil = (pOil / total) * 360;
                const degCoal = (pCoal / total) * 360;
                const degGas = (pGas / total) * 360;
                const degGreen = (pGreen / total) * 360;
                const degNuke = (pNuke / total) * 360;

                chartContainer.style.background = `conic-gradient(
                    var(--color-oil) 0deg ${degOil}deg,
                    var(--color-coal) ${degOil}deg ${degOil + degCoal}deg,
                    var(--color-gas) ${degOil + degCoal}deg ${degOil + degCoal + degGas}deg,
                    var(--color-nuclear) ${degOil + degCoal + degGas}deg ${degOil + degCoal + degGas + degNuke}deg,
                    var(--color-green) ${degOil + degCoal + degGas + degNuke}deg 360deg
                )`;

                const addLabel = (name, val, startAngle, sliceAngle) => {
                    if (sliceAngle < 15) return; 

                    const midAngle = startAngle + sliceAngle / 2;
                    const rad = (midAngle - 90) * (Math.PI / 180);
                    const r = 45;
                    const x = 75 + r * Math.cos(rad);
                    const y = 75 + r * Math.sin(rad);

                    const label = document.createElement('div');
                    label.className = 'chart-label';
                    label.style.left = `${x}px`;
                    label.style.top = `${y}px`;
                    
                    const pct = (val / total * 100).toFixed(1);
                    label.innerHTML = `<span>${name}</span>${pct}%`;
                    chartContainer.appendChild(label);
                };

                let currentAngle = 0;
                if (pOil > 0) {
                    const slice = (pOil / total) * 360;
                    addLabel('æ²¹', pOil, currentAngle, slice);
                    currentAngle += slice;
                }
                if (pCoal > 0) {
                    const slice = (pCoal / total) * 360;
                    addLabel('ç…¤', pCoal, currentAngle, slice);
                    currentAngle += slice;
                }
                if (pGas > 0) {
                    const slice = (pGas / total) * 360;
                    addLabel('æ°£', pGas, currentAngle, slice);
                    currentAngle += slice;
                }
                if (pNuke > 0) {
                    const slice = (pNuke / total) * 360;
                    addLabel('æ ¸', pNuke, currentAngle, slice);
                    currentAngle += slice;
                }
                if (pGreen > 0) {
                    const slice = (pGreen / total) * 360;
                    addLabel('å†ç”Ÿ', pGreen, currentAngle, slice);
                    currentAngle += slice;
                }
            },

            updateAll() {
                document.getElementById('map-year-display').innerText = "ç¬¬ " + game.year + " å¹´";
                document.getElementById('hud-funds').innerText = game.funds.toLocaleString();
                document.getElementById('hud-comp').innerText = game.comp + '%';
                
                const days = game.getSafetyDays();
                if (days === null || days > 999) {
                     document.getElementById('hud-days').innerText = "--";
                     document.getElementById('hud-days').className = `stat-val`;
                } else {
                     document.getElementById('hud-days').innerText = (days > 99 ? 'å……è¶³' : days + 'å¤©');
                     document.getElementById('hud-days').className = `stat-val ${days < 14 ? 'red' : ''}`;
                }

                document.getElementById('stat-supply').innerText = game.calcPower().toLocaleString() + " MW";
                document.getElementById('stat-demand').innerText = game.demand.toLocaleString() + " MW";
                
                const cDays = game.getCoalDays();
                document.getElementById('stat-coal-days').innerText = (cDays === null ? '--' : (cDays > 99 ? 'âˆ' : cDays + 'å¤©'));
                
                const gDays = game.getGasDays();
                document.getElementById('stat-gas-days').innerText = (gDays === null ? '--' : (gDays > 99 ? 'âˆ' : gDays + 'å¤©'));

                if (!game.isFreePlay) {
                    const s = STAGES[game.stageIdx];
                    document.getElementById('story-text').innerText = s.short;
                    document.getElementById('goal-list').innerHTML = s.goals.map(g => `
                        <div class="bar-goal-item"><span class="goal-check ${g.check(game) ? 'done' : ''}">${g.check(game) ? 'âœ…' : 'â¬œ'}</span> <span>${g.txt}</span></div>
                    `).join('');
                } else {
                    document.getElementById('story-text').innerText = "è‡ªç”±åŸ·æ”¿æ¨¡å¼";
                    document.getElementById('goal-list').innerHTML = "<div class='bar-goal-item'>ç¶­æŒç«¶çˆ­åŠ› > 0%</div>";
                }

                if (game.blockade) {
                    document.getElementById('next-btn').innerHTML = `æ’ä½<br>${game.bDays}å¤©`;
                    document.getElementById('next-btn').style.background = '#000';
                } else {
                    document.getElementById('next-btn').innerHTML = `ä¸‹ä¸€<br>å¹´åº¦`;
                    document.getElementById('next-btn').style.background = 'var(--accent-red)';
                }
                
                this.updatePieChart();
                this.renderMarket();
                this.renderDeck();
            },

            floatText(txt, type) {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                el.className = `toast-msg ${type || ''}`;
                
                if(type === 'good') el.innerHTML = `<span>${txt}</span> <span>ğŸ’°</span>`;
                if(type === 'bad') el.innerHTML = `<span>${txt}</span> <span>âš ï¸</span>`;
                if(!type) el.innerText = txt; 

                container.prepend(el);

                if (container.children.length > 6) {
                     const oldest = container.lastElementChild;
                     if(oldest) oldest.remove(); 
                }

                setTimeout(() => {
                    el.classList.add('hiding'); 
                    el.addEventListener('transitionend', () => el.remove()); 
                }, 1200); 
            },

            swapModal(title, desc, callback) {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-content-area').innerHTML = `<p id="modal-desc" style="font-size:14px; line-height:1.6; color:#ddd; margin:15px 0;">${desc}</p>`;
                
                const btn = document.getElementById('modal-btn');
                btn.innerText = "ç¢º å®š";
                btn.onclick = callback ? callback : ui.closeModal;
                
                document.getElementById('modal-overlay').style.display = 'flex';
            },

            showTurnReport(year, income, compDetails, totalFunds, totalComp, events) {
                document.getElementById('modal-title').innerText = `ğŸ“… å¹´åº¦å ±å‘Š (${year})`;
                
                let compHtml = compDetails.map(d => {
                    const isNeg = d.includes('-');
                    return `<div class="comp-row" style="color:${isNeg ? '#e74c3c' : '#2ecc71'}"><span>${d.split(' ')[0]}</span><span>${d.split(' ')[1]}</span></div>`;
                }).join('');
                
                let eventHtml = '';
                if(events && events.length > 0) {
                    eventHtml = `
                    <div class="report-card" style="border-color:var(--accent-red); background:rgba(231,76,60,0.1);">
                        <div class="report-header" style="color:var(--accent-red)">âš ï¸ é‡å¤§çªç™¼äº‹ä»¶</div>
                        ${events.map(e => `<div style="color:#fff; font-size:13px; font-weight:bold;">${e}</div>`).join('')}
                    </div>`;
                }

                const html = `
                    <div class="report-grid">
                        ${eventHtml}
                        <div class="report-card">
                            <div class="report-header">ğŸ’° è²¡æ”¿æ”¶æ”¯çµç®—</div>
                            <div class="report-flex">
                                <span class="report-label">æœ¬æœŸå·¥æ¥­ç¨…æ”¶</span>
                                <span class="report-big" style="color:var(--accent-gold)">+$${income.toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="report-card">
                            <div class="report-header">ğŸ“Š åœ‹å®¶ç«¶çˆ­åŠ›è©•ä¼°</div>
                            <div class="comp-list">
                                <div class="report-label" style="margin-bottom:4px;">æœ¬å¹´åº¦è®Šå‹•åˆ†æ</div>
                                ${compHtml || '<div class="comp-row" style="color:#888"><span>å¹³ç©©é‹è¡Œ</span><span>-</span></div>'}
                            </div>
                            <div class="report-flex">
                                <span class="report-label">æœ€æ–°ç«¶çˆ­åŠ›æŒ‡æ•¸</span>
                                <span class="report-big" style="color:var(--accent-blue)">${totalComp}%</span>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('modal-content-area').innerHTML = html;
                const btn = document.getElementById('modal-btn');
                btn.innerText = "ç¢º å®š";
                btn.onclick = ui.closeModal;
                btn.className = 'retro-btn';
                document.getElementById('modal-overlay').style.display = 'flex';
            },

            showModal(title, desc, callback) {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-content-area').innerHTML = `<p id="modal-desc" style="font-size:14px; line-height:1.6; color:#ddd; margin:15px 0;">${desc}</p>`;
                
                const btn = document.getElementById('modal-btn');
                btn.innerText = "ç¢º å®š";
                btn.onclick = callback ? callback : ui.closeModal;
                btn.className = 'retro-btn';
                document.getElementById('modal-overlay').style.display = 'flex';
            },
            
            showCompHelp() {
                let stockRule = '';
                if (game.stageIdx >= 2) {
                    stockRule = `<div class="rule-item"><span>ğŸ“‰ ä½åº«å­˜(&lt;7å¤©)</span><span style="color:#e74c3c">æ¯é …-10%</span></div>`;
                }
                ui.showModal("ç«¶çˆ­åŠ›èªªæ˜", `
                    <div class="rule-list">
                        <div class="rule-title">è©•åˆ†è¦å‰‡</div>
                        <div class="rule-item"><span>âš¡ ä¾›é›»å……è¶³</span><span style="color:#2ecc71">+5%</span></div>
                        <div class="rule-item"><span>âš¡ ä¾›é›»ä¸è¶³</span><span style="color:#e74c3c">-15%</span></div>
                        ${stockRule}
                        <div class="rule-item"><span>â˜ ï¸ åº«å­˜è€—ç›¡(0å¤©)</span><span style="color:#e74c3c">ç›´æ¥å¤±æ•—</span></div>
                    </div>
                `);
            },

            showFundsHelp() {
                ui.showModal("å·¥æ¥­ç¨…æ”¶èªªæ˜", `
                    <div class="rule-list">
                        <div class="rule-title">è¨ˆç®—å…¬å¼</div>
                        <div class="rule-item"><span>ğŸ’° åŸºç¤ç¨…æ”¶</span><span>$${game.stageIdx===0?500:(game.stageIdx===1?1000:2000)}</span></div>
                        <div class="rule-item"><span>âš¡ å·¥æ¥­ç¨…æ”¶</span><span>+$${Math.floor(game.calcPower(true)*0.4).toLocaleString()}</span></div>
                        <div class="rule-item" style="border-top:1px solid #fff; margin-top:5px; padding-top:5px;">
                            <span>é è¨ˆä¸‹å¹´æ”¶å…¥</span><span style="color:#f1c40f">$${game.calcIncome().toLocaleString()}</span>
                        </div>
                        <div style="font-size:10px; color:#888; margin-top:5px;">(å…¬å¼ï¼šç™¼é›»é‡ x 0.4 + åŸºç¤ç¨…)</div>
                    </div>
                `);
            },

            showStockHelp() {
                const cDays = game.getCoalDays();
                const gDays = game.getGasDays();
                ui.showModal("å­˜é‡èªªæ˜", `
                    <div class="rule-list">
                        <div class="rule-title">ç›®å‰å¯æ”¯æ’å¤©æ•¸</div>
                        <div class="rule-item"><span>ğŸª¨ ç…¤ç‚­</span><span>${cDays===null?'--':(cDays>99?'âˆ':cDays+' å¤©')}</span></div>
                        <div class="rule-item"><span>ğŸ”¥ å¤©ç„¶æ°£</span><span>${gDays===null?'--':(gDays>99?'âˆ':gDays+' å¤©')}</span></div>
                        <div style="margin-top:10px; font-size:11px; color:#aaa; line-height:1.4;">
                            æ¶ˆè€—å…¬å¼ï¼š<br>
                            ç‡ƒç…¤æ¶ˆè€— = é›»å» æ•¸ x ${PLANTS.coal.fuel}<br>
                            ç‡ƒæ°£æ¶ˆè€— = é›»å» æ•¸ x ${PLANTS.gas.fuel}<br>
                            å¤©æ•¸ = åº«å­˜ / å¹´æ¶ˆè€—<br>
                        </div>
                    </div>
                `);
            },

            showGameOver(reason) {
                document.getElementById('modal-title').innerText = "åœ‹å®¶ç ´ç”¢";
                document.getElementById('modal-content-area').innerHTML = `<p style="color:#e74c3c">${reason || 'é›»åŠ›ä¸ç©©å°è‡´ç”¢æ¥­å¤–ç§»ï¼Œç«¶çˆ­åŠ›æ­¸é›¶ã€‚'}</p>`;
                const btn = document.getElementById('modal-btn');
                btn.innerText = "ğŸ”„ é‡æ–°é–‹å§‹";
                btn.classList.add('restart');
                btn.onclick = () => game.restart();
                document.getElementById('modal-overlay').style.display = 'flex';
            },

            showVictory() {
                document.getElementById('modal-title').innerText = "ğŸ† èƒ½æºè½‰å‹æˆåŠŸï¼";
                let maxPower = 0;
                game.history.forEach(h => {
                    const total = (h.oil||0) + h.coal + h.gas + h.nuclear + h.green;
                    if(total > maxPower) maxPower = total;
                });
                const startYear = game.history[0].year;
                const duration = game.history.length - 1;
                let paths = { oil: "M0,200 ", coal: "M0,200 ", gas: "M0,200 ", nuke: "M0,200 ", green: "M0,200 " };
                const lastH = game.history[game.history.length-1];
                const lastTotal = (lastH.oil||0) + lastH.coal + lastH.gas + lastH.nuclear + lastH.green;
                const pcts = {
                    oil: Math.round((lastH.oil||0)/lastTotal*100),
                    coal: Math.round(lastH.coal/lastTotal*100),
                    gas: Math.round(lastH.gas/lastTotal*100),
                    nuke: Math.round(lastH.nuclear/lastTotal*100),
                    green: Math.round(lastH.green/lastTotal*100)
                };
                game.history.forEach((h, i) => {
                    const x = (i / duration) * 400;
                    const hOil = ((h.oil||0)) / maxPower * 180;
                    const hCoal = ((h.oil||0) + h.coal) / maxPower * 180;
                    const hGas = ((h.oil||0) + h.coal + h.gas) / maxPower * 180;
                    const hNuke = ((h.oil||0) + h.coal + h.gas + h.nuclear) / maxPower * 180;
                    const hGreen = ((h.oil||0) + h.coal + h.gas + h.nuclear + h.green) / maxPower * 180;
                    paths.oil += `L${x},${200 - hOil} `;
                    paths.coal += `L${x},${200 - hCoal} `;
                    paths.gas += `L${x},${200 - hGas} `;
                    paths.nuke += `L${x},${200 - hNuke} `;
                    paths.green += `L${x},${200 - hGreen} `;
                });
                const closePath = `L400,200 L0,200 Z`;
                let xAxisLabels = "";
                for(let i=0; i <= duration; i++) {
                    const currentY = startYear + i;
                    if(currentY % 5 === 0 || i === 0 || i === duration) {
                        const x = (i / duration) * 400;
                        let textAnchor = "middle";
                        if(i===0) textAnchor = "start";
                        if(i===duration) textAnchor = "end";
                        xAxisLabels += `<text x="${x}" y="215" fill="#aaa" font-size="12" text-anchor="${textAnchor}">${currentY}</text>`;
                    }
                }
                const getRank = (obj) => Object.entries(obj)
                    .sort((a,b) => b[1] - a[1])
                    .map(e => {
                        const name = MARKET_SOURCES.coal.find(x=>x.id==e[0])?.name || MARKET_SOURCES.gas.find(x=>x.id==e[0])?.name || e[0];
                        const flag = MARKET_SOURCES.coal.find(x=>x.id==e[0])?.flag || MARKET_SOURCES.gas.find(x=>x.id==e[0])?.flag || '';
                        return `<div class="rank-item"><span>${flag} ${name}</span><span>${e[1]}00å™¸</span></div>`;
                    }).join('');
                const finalHTML = `
                    <p style="color:#2ecc71; margin-bottom:10px;">æ‚¨å»ºç«‹äº†é«˜éŸŒæ€§çš„é›»åŠ›ç³»çµ±ï¼</p>
                    <div class="chart-container">
                        <div class="chart-title">ğŸ“ˆ ç™¼é›»çµæ§‹å †ç–Šåœ– (ç¸½: ${game.calcPower().toLocaleString()} MW)</div>
                        <svg viewBox="0 0 400 220" style="background:#222; width:100%; height:auto;">
                            <path d="${paths.green + closePath}" fill="#2ecc71" />
                            <path d="${paths.nuke + closePath}" fill="#8e44ad" />
                            <path d="${paths.gas + closePath}" fill="#d35400" />
                            <path d="${paths.coal + closePath}" fill="#7f8c8d" />
                            <path d="${paths.oil + closePath}" fill="#1a1a2e" />
                            ${xAxisLabels}
                        </svg>
                        <div class="chart-legend">
                            <div class="legend-item"><span class="color-box" style="background:#1a1a2e"></span>æ²¹ ${pcts.oil}%</div>
                            <div class="legend-item"><span class="color-box" style="background:#7f8c8d"></span>ç…¤ ${pcts.coal}%</div>
                            <div class="legend-item"><span class="color-box" style="background:#d35400"></span>æ°£ ${pcts.gas}%</div>
                            <div class="legend-item"><span class="color-box" style="background:#8e44ad"></span>æ ¸ ${pcts.nuke}%</div>
                            <div class="legend-item"><span class="color-box" style="background:#2ecc71"></span>ç¶  ${pcts.green}%</div>
                        </div>
                    </div>
                `;
                document.getElementById('modal-content-area').innerHTML = finalHTML;
                const btn = document.getElementById('modal-btn');
                btn.innerText = "ç¹¼çºŒåŸ·æ”¿";
                btn.className = 'retro-btn victory';
                btn.onclick = () => {
                    game.isFreePlay = true;
                    ui.closeModal();
                };
                document.getElementById('modal-overlay').style.display = 'flex';
            },

            showStageComplete(clearedStageIdx, nextStage, callback) {
                const clearedStage = STAGES[clearedStageIdx];
                const stageNum = clearedStageIdx + 1;
                const nextNum = clearedStageIdx + 2;

                const goalsHtml = clearedStage.goals.map(g => 
                    `<div class="stage-clear-goal-item">âœ… ${g.txt}</div>`
                ).join('');

                const nextGoalsHtml = nextStage.goals.map(g => 'ğŸ”¹ ' + g.txt).join('<br>');

                document.getElementById('modal-title').innerText = '';
                document.getElementById('modal-content-area').innerHTML = `
                    <div class="stage-clear-banner">ğŸ‰ éšæ®µ ${stageNum} é€šé—œï¼</div>
                    <div class="stage-clear-sub">${clearedStage.title} â€” ä»»å‹™å®Œæˆ</div>
                    <div class="stage-clear-goals">${goalsHtml}</div>
                    <hr class="stage-clear-divider">
                    <div style="text-align:left; padding:0 5px; line-height:1.6;">
                        <div style="font-size:15px; font-weight:900; color:var(--accent-gold); margin-bottom:6px;">
                            â–¶ ä¸‹ä¸€éšæ®µï¼š${nextStage.title}
                        </div>
                        ${nextStage.desc}<br><br>
                        <span style="color:var(--accent-blue)">ğŸ† æœ¬éšæ®µç›®æ¨™ï¼š</span><br>${nextGoalsHtml}
                    </div>
                `;

                const dialog = document.querySelector('.retro-dialog');
                dialog.classList.add('stage-clear-dialog');

                const btn = document.getElementById('modal-btn');
                btn.innerText = "ğŸš€ é–‹å§‹æŒ‘æˆ°";
                btn.className = 'retro-btn stage-clear';
                btn.onclick = callback ? callback : ui.closeModal;
                document.getElementById('modal-overlay').style.display = 'flex';
            },

            closeModal() { 
                document.getElementById('modal-overlay').style.display = 'none'; 
                document.getElementById('modal-content-area').innerHTML = '<p id="modal-desc" style="font-size:14px; line-height:1.6; color:#ddd; margin:15px 0;">CONTENT</p>';
                const dialog = document.querySelector('.retro-dialog');
                dialog.classList.remove('stage-clear-dialog');
                const btn = document.getElementById('modal-btn');
                btn.className = 'retro-btn';
                const restartBtn = document.querySelector('.retro-btn.restart');
                if(restartBtn) restartBtn.remove();
            }
        };

        game.init();
    </script>
</body>
</html>
