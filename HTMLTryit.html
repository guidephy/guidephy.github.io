<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Guidephy's HTML Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- CodeMirror æ ¸å¿ƒ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.css">

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #e5e7eb;
    }

    header {
      padding: 0.75rem 1.5rem;
      background: #111827;
      color: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header h1 {
      margin: 0;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .brand-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: inherit;
      text-decoration: none;
    }

    .brand-link:hover {
      opacity: 0.9;
    }

    .home-icon {
      width: 20px;
      height: 20px;
      border-radius: 6px;
      background: #e5e7eb;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #4b5563;
      font-size: 14px;
      font-weight: 700;
    }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    button {
      border: none;
      padding: 0.45rem 0.9rem;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.9rem;
      background: #2563eb;
      color: #f9fafb;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    button.secondary {
      background: #374151;
    }

    button:active {
      transform: translateY(1px);
    }

    /* â­ æ”¹æˆ min-heightï¼Œè®“ä¸‹é¢åœ–ç‰‡å€æœ‰ç©ºé–“é•·å‡ºä¾† */
    main {
      min-height: calc(100vh - 56px);
      display: flex;
      flex-direction: column;
    }

    .split {
      flex: 1;
      display: flex;
      border-top: 1px solid #e5e7eb;
    }

    .pane {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .pane-header {
      padding: 0.5rem 0.9rem;
      background: #e5e7eb;
      border-bottom: 1px solid #d1d5db;
      font-size: 0.85rem;
      color: #111827;
    }

    .pane-body {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    /* CodeMirror å°ºå¯¸ */
    .CodeMirror {
      height: 100%;
      font-size: 0.9rem;
    }

    .cm-s-gpt-dark.CodeMirror {
      background: #2e3842;
      color: #e5e7eb;
      padding: 0.75rem;
    }

    .cm-s-gpt-dark .CodeMirror-gutters {
      background: #0a0f1a;
      border-right: 1px solid #1e293b;
      color: #64748b;
    }

    .cm-s-gpt-dark .CodeMirror-linenumber {
      color: #64748b;
    }

    .cm-s-gpt-dark .CodeMirror-cursor {
      border-left: 1px solid #e5e7eb;
    }

    .cm-s-gpt-dark .CodeMirror-selected {
      background: #1e293b;
    }

    .cm-s-gpt-dark .CodeMirror-activeline-background {
      background: #020617;
    }

    .cm-s-gpt-dark span.cm-tag {
      color: #ff4d4f;
    }

    .cm-s-gpt-dark span.cm-bracket {
      color: #ff4d4f;
    }

    .cm-s-gpt-dark span.cm-attribute {
      color: #c4b5fd;
    }

    .cm-s-gpt-dark span.cm-string {
      color: #bef264;
    }

    .cm-s-gpt-dark span.cm-comment {
      color: #6b7280;
      font-style: italic;
    }

    .cm-s-gpt-dark span.cm-keyword {
      color: #f472b6;
    }

    .cm-s-gpt-dark span.cm-def {
      color: #7dd3fc;
    }

    .cm-s-gpt-dark span.cm-number {
      color: #facc15;
    }

    .cm-s-gpt-dark span.cm-atom {
      color: #f97316;
    }

    .cm-s-gpt-dark span.cm-builtin {
      color: #38bdf8;
    }

    .cm-s-gpt-dark span.cm-meta {
      color: #a5b4fc;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: white;
    }

    .status-bar {
      position: absolute;
      bottom: 0.4rem;
      right: 0.7rem;
      font-size: 0.75rem;
      background: rgba(17, 24, 39, 0.8);
      color: white;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      pointer-events: none;
    }

    /* ===== åœ–ç‰‡æŠ“å–å€ ===== */

    .image-section {
      max-width: 1200px;
      margin: 1.5rem auto 3rem auto;
      padding: 0 1.5rem;
      color: #111827;
      display: none;
    }

    .image-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .image-section h2 {
      font-size: 1rem;
      font-weight: 600;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #111827;
    }

    .image-section h2 span {
      font-size: 0.75rem;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      background: #e5e7eb;
      color: #374151;
    }

    .image-minimize-btn {
      background: #e5e7eb;
      color: #111827;
      border: 1px solid #d1d5db;
      font-size: 0.8rem;
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      cursor: pointer;
    }

    .image-minimize-btn:hover {
      background: #d1d5db;
    }

    .image-status {
      margin-bottom: 0.75rem;
      font-size: 0.9rem;
    }

    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
    }

    .image-card {
      background: #ffffff;
      border-radius: 0.75rem;
      border: 1px solid #d1d5db;
      overflow: hidden;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.1);
      display: flex;
      flex-direction: column;
    }

    .image-card img {
      width: 100%;
      height: 150px;
      object-fit: contain;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
    }

    .image-card-body {
      padding: 0.75rem 0.9rem 0.9rem 0.9rem;
      font-size: 0.8rem;
    }

    .image-card-body input {
      width: 100%;
      padding: 0.35rem 0.45rem;
      font-size: 0.75rem;
      border-radius: 0.4rem;
      border: 1px solid #d1d5db;
      margin-bottom: 0.4rem;
    }

    .image-card-body a {
      display: inline-block;
      font-size: 0.75rem;
      color: #2563eb;
      text-decoration: underline;
      margin-bottom: 0.45rem;
      word-break: break-all;
    }

    .image-card-body button {
      width: 100%;
      font-size: 0.75rem;
      padding: 0.35rem 0.45rem;
      border-radius: 999px;
      background: #bfdbfe;
      color: #1e3a8a;
      border: 1px solid #60a5fa;
      text-align: center;
      justify-content: center;
    }

    .image-card-body button:hover {
      background: #93c5fd;
    }

    .image-toggle-btn {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 60;
      background: #111827;
      color: #f9fafb;
      border-radius: 999px;
      padding: 0.45rem 0.9rem;
      font-size: 0.85rem;
      border: 1px solid #1f2937;
      display: none;
      box-shadow: 0 12px 20px rgba(15, 23, 42, 0.4);
      cursor: pointer;
    }

    .image-toggle-btn:hover {
      background: #1f2937;
    }

    .loader {
      border: 3px solid #e5e7eb;
      border-top: 3px solid #22d3ee;
      border-radius: 50%;
      width: 26px;
      height: 26px;
      animation: spin 1s linear infinite;
      margin: 0 auto 0.5rem auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal {
      background: #f9fafb;
      border-radius: 1rem;
      padding: 1.25rem 1.5rem;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 25px 60px rgba(15,23,42,0.35);
      color: #111827;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .modal-header h2 {
      font-size: 1rem;
      margin: 0;
      font-weight: 600;
    }

    .modal-close {
      background: transparent;
      border: none;
      color: #6b7280;
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0;
      line-height: 1;
    }

    .modal-body {
      font-size: 0.9rem;
    }

    .modal-body label {
      display: block;
      margin-bottom: 0.25rem;
      font-weight: 500;
    }

    .modal-body input[type="url"] {
      width: 100%;
      padding: 0.6rem 0.7rem;
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
      margin-bottom: 0.6rem;
    }

    .modal-body small {
      display: block;
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 0.8rem;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .modal-footer button {
      font-size: 0.85rem;
      padding: 0.4rem 0.9rem;
      border-radius: 999px;
    }

    .btn-secondary-light {
      background: #e5e7eb;
      color: #111827;
      border: 1px solid #d1d5db;
    }

    .btn-primary {
      background: #2563eb;
      color: #f9fafb;
      border: 1px solid #1d4ed8;
    }

    @media (max-width: 900px) {
      .split {
        flex-direction: column;
      }
      .pane {
        height: 50vh;
      }
    }
  </style>
</head>

<body>
  <header>
    <h1>
      <a class="brand-link" href="https://guidephy.github.io/" target="_blank" rel="noopener noreferrer">
        <span class="home-icon">âŒ‚</span>
        <span>Guidephy's HTML Studio</span>
      </a>
    </h1>
    <div class="toolbar">
      <button id="runBtn">åŸ·è¡Œ</button>
      <button id="imageBtn" class="secondary">
        <span class="btn-icon">ğŸ“·</span>
        åœ–ç‰‡æŠ“å–
      </button>
      <button id="downloadBtn" class="secondary">ä¸‹è¼‰ HTML</button>
    </div>
  </header>

  <main>
    <div class="split">
      <section class="pane">
        <div class="pane-header">HTML ç¨‹å¼ç¢¼</div>
        <div class="pane-body">
          <textarea id="code"></textarea>
          <div class="status-bar" id="status">å°±ç·’</div>
        </div>
      </section>

      <section class="pane">
        <div class="pane-header">é è¦½</div>
        <div class="pane-body">
          <iframe id="preview"></iframe>
        </div>
      </section>
    </div>
  </main>

  <section id="image-section" class="image-section">
    <div class="image-section-header">
      <h2>
        Google æ–‡ä»¶åœ–ç‰‡æŠ“å–çµæœ
        <span id="image-count-badge">0 å¼µ</span>
      </h2>
      <button id="image-minimize-btn" class="image-minimize-btn">ç¸®å°</button>
    </div>
    <div id="image-status" class="image-status"></div>
    <div id="image-grid" class="image-grid"></div>
  </section>

  <button id="image-toggle-btn" class="image-toggle-btn">å±•é–‹åœ–ç‰‡</button>

  <div id="image-modal-backdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h2>å¾ Google æ–‡ä»¶æŠ“å–åœ–ç‰‡</h2>
        <button class="modal-close" id="image-modal-close" aria-label="é—œé–‰">Ã—</button>
      </div>
      <div class="modal-body">
        <label for="gdoc-url">å…±ç”¨é€£çµï¼ˆå»ºè­°ä½¿ç”¨ã€Œç™¼ä½ˆåˆ°ç¶²è·¯ã€çš„ç¶²å€ï¼‰</label>
        <input type="url" id="gdoc-url" placeholder="https://docs.google.com/document/d/e/.../pub">
        <small>è²¼ä¸Š Google æ–‡ä»¶çš„å…±ç”¨é€£çµï¼ŒæŒ‰ã€Œé–‹å§‹æŠ“å–ã€å¾Œï¼Œä¸‹æ–¹æœƒé¡¯ç¤ºæ‰€æœ‰åœ–ç‰‡èˆ‡ç¶²å€ã€‚</small>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary-light" id="image-modal-cancel">å–æ¶ˆ</button>
        <button class="btn-primary" id="image-modal-submit">é–‹å§‹æŠ“å–</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/htmlmixed/htmlmixed.min.js"></script>

  <script>
    const defaultCode =
`<!DOCTYPE html>
<html>
<head>
<title>Page Title</title>
</head>
<body>

<h1>This is a Heading</h1>
<p>This is a paragraph.</p>

</body>
</html>`;

    const textarea    = document.getElementById("code");
    const iframe      = document.getElementById("preview");
    const runBtn      = document.getElementById("runBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const statusEl    = document.getElementById("status");

    textarea.value = defaultCode;

    const editor = CodeMirror.fromTextArea(textarea, {
      mode: "text/html",
      lineNumbers: true,
      theme: "gpt-dark",
      tabSize: 2,
      indentUnit: 2,
      lineWrapping: true
    });

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    function runCode() {
      const html = editor.getValue();
      const doc = iframe.contentDocument || iframe.contentWindow.document;
      doc.open();
      doc.write(html);
      doc.close();
      setStatus("å·²åŸ·è¡Œé è¦½");
    }

    function downloadHtml() {
      let filename = prompt("è«‹è¼¸å…¥æª”åï¼ˆä¸éœ€ .htmlï¼‰", "my_page");
      if (filename === null) {
        setStatus("å–æ¶ˆä¸‹è¼‰");
        return;
      }
      filename = filename.trim().replace(/[\\/:*?\"<>|]/g, "");
      if (filename === "") filename = "my_page";

      const blob = new Blob([editor.getValue()], { type: "text/html;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = filename + ".html";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      setStatus("å·²ä¸‹è¼‰ï¼š" + filename + ".html");
    }

    runBtn.addEventListener("click", runCode);
    downloadBtn.addEventListener("click", downloadHtml);

    const imageBtn           = document.getElementById("imageBtn");
    const imageModalBackdrop = document.getElementById("image-modal-backdrop");
    const imageModalClose    = document.getElementById("image-modal-close");
    const imageModalCancel   = document.getElementById("image-modal-cancel");
    const imageModalSubmit   = document.getElementById("image-modal-submit");
    const gdocUrlInput       = document.getElementById("gdoc-url");

    const imageSection       = document.getElementById("image-section");
    const imageStatusEl      = document.getElementById("image-status");
    const imageGridEl        = document.getElementById("image-grid");
    const imageCountBadge    = document.getElementById("image-count-badge");

    const imageMinimizeBtn   = document.getElementById("image-minimize-btn");
    const imageToggleBtn     = document.getElementById("image-toggle-btn");

    let extractedImageUrls = [];

    function openImageModal() {
      imageModalBackdrop.style.display = "flex";
      setTimeout(() => gdocUrlInput.focus(), 50);
    }

    function closeImageModal() {
      imageModalBackdrop.style.display = "none";
    }

    imageBtn.addEventListener("click", openImageModal);
    imageModalClose.addEventListener("click", closeImageModal);
    imageModalCancel.addEventListener("click", closeImageModal);

    imageModalSubmit.addEventListener("click", () => {
      const url = gdocUrlInput.value.trim();
      if (!url) {
        alert("è«‹å…ˆè¼¸å…¥ Google æ–‡ä»¶çš„å…±ç”¨é€£çµ");
        return;
      }
      closeImageModal();
      extractImagesFromGDoc(url);
    });

    gdocUrlInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        imageModalSubmit.click();
      }
    });

    function showImageSection() {
      imageSection.style.display = "block";
      imageToggleBtn.style.display = "none";
    }

    function minimizeImageSection() {
      imageSection.style.display = "none";
      imageToggleBtn.style.display = "inline-flex";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    imageMinimizeBtn.addEventListener("click", minimizeImageSection);
    imageToggleBtn.addEventListener("click", () => {
      showImageSection();
      scrollToImageSection();
    });

    function scrollToImageSection() {
      const top = imageSection.offsetTop - 16; // ä¸Šæ–¹ç•™ä¸€é»ç©ºç™½
      window.scrollTo({
        top,
        behavior: "smooth"
      });
    }

    function setImageStatusLoading() {
      showImageSection();
      imageStatusEl.innerHTML = `
        <div class="loader"></div>
        <div style="text-align:center; font-size:0.9rem;">æ­£åœ¨å¾ Google æ–‡ä»¶æŠ“å–åœ–ç‰‡...</div>
      `;
      scrollToImageSection();
    }

    function setImageStatusMessage(message, type) {
      showImageSection();
      let color = "#111827";
      if (type === "error") color = "#b91c1c";
      else if (type === "success") color = "#166534";
      imageStatusEl.innerHTML = '<div style="font-size:0.9rem; color:' + color + ';">' + message + '</div>';
    }

    function clearImageResults() {
      imageGridEl.innerHTML = "";
      extractedImageUrls = [];
      imageCountBadge.textContent = "0 å¼µ";
    }

    async function extractImagesFromGDoc(url) {
      clearImageResults();
      setImageStatusLoading();

      const proxyUrl = "https://corsproxy.io/?" + encodeURIComponent(url);

      try {
        const response = await fetch(proxyUrl);
        if (!response.ok) {
          throw new Error("ç¶²è·¯éŒ¯èª¤: " + response.status + " " + response.statusText);
        }

        const htmlText = await response.text();
        const parser   = new DOMParser();
        const doc      = parser.parseFromString(htmlText, "text/html");
        const images   = doc.querySelectorAll("img");

        if (!images || images.length === 0) {
          setImageStatusMessage("é€™å€‹é€£çµè£¡æ‰¾ä¸åˆ°ä»»ä½•åœ–ç‰‡å–”ã€‚", "info");
          return;
        }

        let count = 0;
        images.forEach(img => {
          const src = img.src;
          if (src && src.includes("googleusercontent.com")) {
            count++;
            extractedImageUrls.push(src);
            createImageCard(src);
          }
        });

        imageCountBadge.textContent = count + " å¼µ";

        if (count === 0) {
          setImageStatusMessage("æœ‰åœ–ç‰‡ï¼Œä½†ä¸æ˜¯ Google æ–‡ä»¶çš„åœ–æª”ï¼ˆæ²’æœ‰ googleusercontent.comï¼‰ã€‚", "info");
        } else {
          setImageStatusMessage("æˆåŠŸæŠ“åˆ° " + count + " å¼µåœ–ç‰‡ï¼", "success");
        }

      } catch (err) {
        console.error(err);
        setImageStatusMessage("æŠ“å–å¤±æ•—ï¼Œè«‹ç¢ºèªé€£çµæ˜¯å¦æ­£ç¢ºï¼Œä¸”æ–‡ä»¶å·²å°å¤–é–‹æ”¾æˆ–ã€Œç™¼ä½ˆåˆ°ç¶²è·¯ã€ã€‚", "error");
      }
    }

    function createImageCard(src) {
      const card = document.createElement("div");
      card.className = "image-card";

      const img = document.createElement("img");
      img.src = src;
      img.alt = "æå–åœ–ç‰‡";
      img.loading = "lazy";

      const body = document.createElement("div");
      body.className = "image-card-body";

      const input = document.createElement("input");
      input.type = "text";
      input.value = src;
      input.readOnly = true;

      const link = document.createElement("a");
      link.href = src;
      link.target = "_blank";
      link.rel = "noopener noreferrer";
      link.textContent = "åœ¨æ–°åˆ†é é–‹å•Ÿåœ–ç‰‡";

      const btn = document.createElement("button");
      btn.textContent = "è¤‡è£½ç¶²å€";

      btn.addEventListener("click", async () => {
        btn.disabled = true;
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(src);
          } else {
            input.select();
            document.execCommand("copy");
          }
          btn.textContent = "å·²è¤‡è£½ï¼";
          btn.style.background = "#4ade80";
          btn.style.color = "#064e3b";
        } catch (e) {
          btn.textContent = "è¤‡è£½å¤±æ•—";
          btn.style.background = "#fecaca";
          btn.style.color = "#7f1d1d";
        } finally {
          setTimeout(() => {
            btn.textContent = "è¤‡è£½ç¶²å€";
            btn.style.background = "#bfdbfe";
            btn.style.color = "#1e3a8a";
            btn.disabled = false;
          }, 1800);
        }
      });

      body.appendChild(input);
      body.appendChild(link);
      body.appendChild(btn);

      card.appendChild(img);
      card.appendChild(body);
      imageGridEl.appendChild(card);
    }
  </script>
</body>
</html>
